import"./main.Bpw1vKk_.js";import"./index.D3NeDxPh.js";import{i as b,s as G,a as I,j as te,k as re,d as F,f as V,l as N,n as se,o as ie,p as ae,q as le,r as ne,t as ue,v as S,w as U,E as D}from"./eo-dash.BCjMEFJP.js";import{p as m,an as q,h as A,v as X,c as ce,o as pe,j as z,N as H,k as R,x as Y,q as ye}from"./framework.D4jZKuzb.js";import"./lit-element.Deg-YTNa.js";import"./Group.B92TqkVs.js";import"./extent.dxdZqxc7.js";import"./WMTS.CEIOrrZ9.js";import"./GeoJSON.DV_SCRZg.js";import"./getElement.DO5DovG0.js";import"./WKT.jUG4JRb1.js";import"./commonjsHelpers.BosuxZz1.js";import"./item.MHEAG8UX.js";const Z=async(e,s,a)=>{N.debug("Creating layers config",e,s,a);const o=[],i={type:"Group",properties:{id:"AnalysisGroup",title:"Data Layers",layerControlExpand:!0},layers:[]};for(const l of s){let y;a?y=await l.createLayersJson(new Date(a)):y=await l.createLayersJson(),y.forEach(n=>{n.properties.layerControlExpand=!0,n.properties.layerControlToolsExpand=!0}),i.layers.push(...y)}o.push(i);const c=await D.getIndicatorLayers(e),d=D.getObservationPointsLayer(s);d&&i.layers.unshift(d);const u={type:"Group",properties:{id:"BaseLayersGroup",title:"Base Layers"},layers:[]},r=c.filter(l=>l.properties.group==="baselayer");if(r.length){let l=0,y=0;for(let n=0;n<r.length;n++){const f=r[n];"visible"in f.properties||(f.properties.visible=!1),f.properties.visible&&(l++,y=n)}l===0&&(r[0].properties.visible=!0),l>0&&r.forEach((n,f)=>{f!==y?n.properties.visible=!1:n.properties.visible=!0}),u.layers.push(...r),u.layers.forEach(n=>{n.properties.layerControlExclusive=!0})}else u.layers.push({type:"Tile",properties:{id:"osm",title:"Background",layerControlExclusive:!0},source:{type:"OSM"}});u.layers.length&&o.push(u);const g={type:"Group",properties:{id:"OverlayGroup",title:"Overlay Layers"},layers:[]},p=c.filter(l=>l.properties.group==="overlay");return p.length&&(g.layers.push(...p),o.unshift(g)),o};let J=null;const ve=(e,s)=>{const a=o=>{var u;const i=o.map,c=(u=e.value)==null?void 0:u.lonLatCenter,d=i==null?void 0:i.getView().getZoom();c&&!Number.isNaN(c[0])&&!Number.isNaN(c[1])&&!Number.isNaN(d)&&(s.value=[c[0],c[1],d])};X(()=>{var o,i;(i=(o=e.value)==null?void 0:o.map)==null||i.on("moveend",a)}),Y(()=>{var o,i;(i=(o=e.value)==null?void 0:o.map)==null||i.un("moveend",a)})},W=(e,s,a,o,i,c,d)=>{N.debug("InitMap",e.value,s.value,a.values,o.value);const u=ye([s,o],async([r,g],[p,l])=>{var y,n,f,T,L,_,h,x,P,v,O,C,k,j;if(r){N.debug("Selected Indicator watch triggered",r,g),((y=e==null?void 0:e.value)==null?void 0:y.id)==="main"&&J!==null&&((n=e==null?void 0:e.value)==null||n.map.setView(J),J=null);let w=[];const $=(r==null?void 0:r.id)===(p==null?void 0:p.id)&&g!==l,{selectedCompareStac:E}=G(I());if(((f=e==null?void 0:e.value)==null?void 0:f.id)==="main"?await ue(r):E.value!==null&&(J=((T=e==null?void 0:e.value)==null?void 0:T.map.getView())??null,e.value.sync=c.value),$){w=await Z(r,a,g),N.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(w))),i.value=w,S("time:updated",e.value,w);return}w=await Z(r,a,o.value);let M=null;const B=(_=(L=r==null?void 0:r.extent)==null?void 0:L.temporal)==null?void 0:_.interval;if(B&&B.length>0&&B[0].length>1&&(M=new Date(B[0][1]),N.debug("Indicator load: found stac extent, setting time to latest value",M)),M!==null&&M.toISOString()!==o.value&&!U.value&&(o.value=M.toISOString()),d&&((h=e==null?void 0:e.value)==null?void 0:h.id)==="main"&&(x=r.extent)!=null&&x.spatial.bbox&&!(U.value&&((P=b.value)!=null&&P[0])&&((v=b.value)!=null&&v[1]))){const t=(O=r.extent)==null?void 0:O.spatial.bbox[0],ee=[(t==null?void 0:t[0])>-180?t==null?void 0:t[0]:-180,(t==null?void 0:t[1])>-90?t==null?void 0:t[1]:-90,(t==null?void 0:t[2])<180?t==null?void 0:t[2]:180,(t==null?void 0:t[3])<90?t==null?void 0:t[3]:90],oe=(j=e.value)==null?void 0:j.transformExtent(ee,"EPSG:4326",(k=(C=e.value)==null?void 0:C.map)==null?void 0:k.getView().getProjection());e.value.zoomExtent=oe}N.debug("Assigned layers",JSON.parse(JSON.stringify(w))),i.value=w,await S("layers:updated",e.value,i.value)}},{immediate:!0});Y(()=>{u()})},K=(e,s)=>{se(async()=>{const a=[];for(const o of e)a.push(...await o.getToolTipProperties());s.value=a,N.debug("Updated tooltip properties",s.value)})};function fe(e){return 3*e*e-2*e*e*e}const de=[".enabled"],ge=[".center",".zoom",".layers"],he=[".propertyTransform"],xe=[".layers"],Ce=[".propertyTransform"];var Q;const Je={__name:"index",props:{enableCompare:{type:Boolean,default:!1},center:{type:Array,default:()=>{var e,s;return[((e=b.value)==null?void 0:e[0])??15,((s=b.value)==null?void 0:s[1])??48]}},zoom:{type:Number,default:((Q=b.value)==null?void 0:Q[2])??4},zoomToExtent:{type:Boolean,default:!0}},setup(e){var _;const s=e,a=m([]),o=m([]),i={Attribution:{collapsible:!0}},c=q(s.center),d=q(((_=b.value)==null?void 0:_[2])??s.zoom),u=m([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),r=m([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),g={duration:1200,easing:fe},p=m(null),l=m(null),{selectedCompareStac:y}=G(I()),n=A(()=>s.enableCompare&&y.value?"":"first");ve(p,b),X(()=>{const{selectedCompareStac:h,selectedStac:x}=G(I());te.value=p.value,s.enableCompare&&(re.value=l.value),s.enableCompare&&(W(l,h,ne,F,r,p,!1),K(V,o)),W(p,x,V,F,u,l,s.zoomToExtent)}),K(V,a);const f=A(()=>({visibility:a.value.length?"visible":"hidden"})),T=A(()=>({visibility:o.value.length?"visible":"hidden"})),L=h=>{const x=h==="main"?a:o,P=h=="main"?ae:le;return v=>{const O=JSON.parse(ie.render(JSON.stringify(x.value),{...P.value??{}})),C=O==null?void 0:O.find(k=>k.id===v.key);if(C)return typeof v.value=="object"&&(v.value=JSON.stringify(v.value)),isNaN(Number(v.value))||(v.value=Number(v.value).toFixed(4).toString()),{key:C.title||C.id,value:v.value+" "+(C.appendix||"")}}};return(h,x)=>(pe(),ce("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":n.value},[z("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:p,id:"main",".animationOptions":g,".center":R(c),".zoom":R(d),".layers":u.value,".controls":i},[z("eox-map-tooltip",{style:H(f.value),".propertyTransform":L("main")},null,44,he)],40,ge),z("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:l,".layers":r.value},[z("eox-map-tooltip",{style:H(T.value),".propertyTransform":L("compare")},null,44,Ce)],40,xe)],40,de))}};export{Je as default};
