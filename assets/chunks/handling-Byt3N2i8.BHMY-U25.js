import{d as R,a0 as h,U as W,$ as O,a as F,a1 as X,l as L,a2 as Y,a3 as Z,j as G,G as ee,E as C,H as V,a4 as te,a5 as ne,a6 as j,a7 as re,g as ae}from"./eo-dash.C6HHCnkX.js";import{g as U,e as oe,s as B,c as q,p as se,a as ie}from"./async-B_arT0e1.YxRXNnEC.js";function le(n,t,r){if(!n)return;const e=n.filter(s=>s.rel==="service"&&s.type==="image/png"),a=[];for(const s of e)a.push({type:"Image",properties:{id:s.id+"_process",title:"Results "+s.id},source:{type:"ImageStatic",imageExtent:r,url:C.render(s.href,{...t??{}})}});return a}async function ce(n,t,r){if(!n)return;const e=[],a=n.filter(i=>i.rel==="service"&&i.type==="application/geo+json");if(a.length===0)return e;let s=null;for(const i of a){"eox:flatstyle"in(i??{})&&(s=await h.get(i["eox:flatstyle"]).then(c=>c.data));let o,l;if(s){const c=te(r??"",s);o=c.layerConfig,l=c.style}const u={type:"Vector",source:{type:"Vector",url:C.render(i.href,{...t??{}}),format:"GeoJSON"},properties:{id:i.id+"_process",title:"Results "+r,...o&&{...o}},...l&&{style:l}};e.push(u)}return e}async function ue({links:n,jsonformValue:t,specUrl:r,customEndpointsHandler:e,jsonformSchema:a,selectedStac:s,isPolling:i}){if(!r||!n)return[null,null];const o=await h.get(r).then(f=>f.data);if(!o.data)return console.error("[eodash] Make sure the Vega spec definition has a data property"),[null,null];const l={},[u,c]=B(n,"service",void 0),d=e&&t&&await e({jsonformSchema:a,jsonformValue:t,links:c,selectedStac:s,isPolling:i});if(d&&d.length)return o.data.values=d,[o,l];const p=u.filter(f=>f.rel==="service");e:for(const f of p??[])switch(f.type){case void 0:continue;case"application/json":await de(o,{url:f.href,jsonformValue:t,link:f,flatstyleUrl:f["eox:flatstyle"]});break e;case"text/csv":await fe(o,{url:f.href,jsonformValue:t,flatstyleUrl:f["eox:flatstyle"]});break e}return[o,l]}async function de(n,{url:t,jsonformValue:r,link:e,flatstyleUrl:a}){if(n.data){if(e.method=="GET"){const s=await M(t,r,a);n.data.values=await h.get(s).then(i=>i.data)}else if(e.method=="POST"){if(!e.body)return console.error("[eodash] Inline data POST request requires a body template"),n;const s=await h.get(e.body,{responseType:"text"}).then(o=>o.data),i=JSON.parse(C.render(s,{...r??{}}));n.data.values=await h.post(t,i).then(o=>o.data)}return n}}async function fe(n,{url:t,jsonformValue:r,flatstyleUrl:e}){if(!n.data){console.error("[eodash] Make sure the Vega spec definition has a data property");return}const a=await M(t,r,e);return n.data.url=a,n}async function M(n,t,r){let e={};return r&&(e=await h.get(r).then(a=>a.data)),C.render(n,{...t??{},...e})}async function pe({links:n,jsonformValue:t,layerId:r,isPolling:e,projection:a,selectedStac:s,jsonformSchema:i,customEndpointsHandler:o}){if(!n)return;const[l,u]=B(n,"service","image/tiff"),c=o&&t&&await o({jsonformValue:t,links:u,selectedStac:s,isPolling:e,jsonformSchema:i});if(c&&c.length)return c;if(!l.length)return;let d=[],p="";for(const v of l??[])d.push(C.render(v.href,{...t??{}}));return l.map(v=>q(v,r,d,a,p))}async function he(n,t){const r=n.find(a=>a.rel==="service"&&a.type=="application/json; profile=collection"&&a.endpoint==="STAC");if(!r)return;let e=C.render(r.href,{...t??{}});V.value&&(V.value=!1),await F().loadSelectedSTAC(e,!0)}async function ge({links:n,jsonformValue:t,isPolling:r,selectedStac:e}){var s;if(!r)return;const a=n.filter(i=>i.rel==="service"&&i.endpoint==="eoxhub_workspaces");for(const i of a){const o=await h.get(i.body,{responseType:"text"}).then(u=>u.data),l=JSON.parse(C.render(o,{...t??{}}));try{const u=await h.post(i.href,l,{headers:{"Content-Type":"application/json"}}),c=JSON.parse(localStorage.getItem(O.value)||"[]");c.push(u.headers.location),localStorage.setItem(O.value,JSON.stringify(c));const{processId:d,urls:p}=await se({processUrl:u.headers.location,isPolling:r}).then(f=>{const v=f==null?void 0:f.urls;return v!=null&&v.length?{processId:f==null?void 0:f.id,urls:v}:{processId:"",urls:[]}}).catch(f=>(f instanceof Error?console.error("Polling failed:",f.message):console.error("Unknown error occurred during polling:",f),{processId:"",urls:[]}));return p.length?await q(i,(e==null?void 0:e.id)??"",p,((s=e==null?void 0:e["eodash:mapProjection"])==null?void 0:s.name)??void 0,d):void 0}catch(u){u instanceof Error?console.error("Error sending POST request:",u.message):console.error("Unknown error occurred:",u)}}}const ve=ye([ge]);function ye(n){return async t=>await Promise.all(n.map(r=>r(t))).then(r=>r.filter(e=>e&&me(e)))}function me(n){var t;return n&&n.source&&n.source.type==="GeoTIFF"&&((t=n.source.sources)==null?void 0:t.length)}async function be({links:n,jsonformValue:t,jsonformSchema:r,selectedStac:e}){const a=n.find(d=>d.rel==="service"&&d.endpoint==="sentinelhub");if(!a)return;const s=await xe(e);if(!s){console.error("[eodash] evalscript link for sentinel hub not found in indicator",s);return}if(!a)return;const i=a.href,o=U(r),l=t[o],u=await we();if(!u){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const c=ie(e.extent.temporal.interval[0],[t.start_date,t.end_date],t.distribution);return await Promise.all(c.map(([d,p])=>ke({url:i,bearer:u,bbox:l,from:p,to:d,exampleLink:s}).catch(f=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",f)))).then(d=>d.flat().map(p=>p.outputs.data))}async function we(n,t){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function ke({url:n,bearer:t,bbox:r,from:e,to:a,timeout:s=2e4,exampleLink:i}){if(!i){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!e||!a||new Date(e)>new Date(a)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",e,a);return}const o=await h.get(i.href,{responseType:"text"}).then(c=>c.data);if(!o||o.error){console.error("[eodash] Error (sentinelhub): evalscript not found",o);return}const l={input:{bounds:{bbox:r},data:[{dataFilter:{},type:i.dataId}]},aggregation:{evalscript:o,timeRange:{from:e,to:a},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},u={headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:s};return await h.post(n,l,u).then(c=>{const d=c.data.data;return d.forEach(p=>{p.outputs.data.date=e}),d}).catch(c=>{var d,p;if(((d=c.response)==null?void 0:d.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(p=c.response)==null?void 0:p.data),[]})}async function xe(n){const t=n.links.find(r=>r.rel==="example"&&r.title==="evalscript");if(t)return t;for(const r of ne(n,j.value)){const e=h.get(r).then(a=>a.data.links.find(s=>s.rel==="example"&&s.title==="evalscript"));if(e)return e}}async function Ee({links:n,jsonformSchema:t,jsonformValue:r,selectedStac:e}){const a=n.find(u=>u.rel==="service"&&u.endpoint==="veda");if(!a)return;const s=a==null?void 0:a.href,i=U(t),o=JSON.parse(r[i]),l=await Pe(e);return await Promise.all(l.map(({endpoint:u,datetime:c})=>h.post(s+`?url=${u}`,{type:"Feature",properties:{},geometry:o}).then(d=>{const p=d.data.properties.statistics;return p.date=c,p}).catch(d=>console.error("[eodash] Error while fetching data from veda endpoint:",d))))}async function Pe(n){const t=n.links.filter(o=>o.rel=="child"),r=[];t.length?r.push(...await Promise.all(t.map(o=>h.get(re(o.href,j.value)).then(l=>l.data)))):r.push(n);const e=[];for(const o of r){const l=ae(o.links);let u=o.links.filter(c=>c.rel=="item");e.push(...u.map(c=>({endpoint:c.cog_href,datetime:c[l]})))}e.sort((o,l)=>new Date(o.datetime).getTime()-new Date(l.datetime).getTime());const a=50;if(e.length<=a)return e;const s=e.length,i=[];for(let o=0;o<a;o++){const l=Math.floor(o*(s-1)/(a-1));i.push(e[l])}return i}const Ce=Te([be,Ee]);function Te(n){return async t=>{for(const r of n){const e=await r(t);if(L.debug("Custom endpoint data:",e,"for callback:",r.name,"inputs:",t),!(!e||!e.length||e.some(s=>!s)))return e}return null}}async function Ge({selectedStac:n,jsonformEl:t,jsonformSchema:r,chartSpec:e,isProcessed:a,processResults:s,loading:i,isPolling:o}){var u;let l=null;if(n.value["eodash:jsonform"]&&(l=await h.get(n.value["eodash:jsonform"]).then(c=>c.data)),!l&&W.value){r.value=null;return}Oe({loading:i,isProcessed:a,chartSpec:e,jsonformSchema:r,isPolling:o,processResults:s}),await((u=t.value)==null?void 0:u.editor.destroy()),l&&(r.value=l)}async function Le({loading:n,selectedStac:t,jsonformEl:r,jsonformSchema:e,chartSpec:a,chartData:s,isPolling:i,processResults:o}){var l,u,c,d,p,f,v,I,S,D,J,N;if(!(!r.value||!e.value||!t.value)){L.debug("Processing..."),n.value=!0;try{const k=(u=(l=t.value)==null?void 0:l.links)==null?void 0:u.filter(y=>y.rel==="service"),$=U(e.value),P=(c=r.value)==null?void 0:c.value;oe(P,e.value);const z=P[$],K=(d=t.value)==null?void 0:d["eodash:vegadefinition"],A=((p=t.value)==null?void 0:p.id)??"";[a.value,s.value]=await ue({links:k,jsonformValue:{...P??{}},jsonformSchema:e.value,selectedStac:t.value,specUrl:K,isPolling:i,customEndpointsHandler:Ce}),Object.keys(s.value??{}).length&&o.value.push(s.value),(I=(v=(f=a.value)==null?void 0:f.data)==null?void 0:v.values)!=null&&I.length&&o.value.push((S=a.value)==null?void 0:S.data.values),a.value&&!("background"in a.value)&&(a.value.background="transparent"),await he(k,P);const x=await pe({links:k,jsonformValue:P,layerId:A,isPolling:i,projection:((J=(D=t.value)==null?void 0:D["eodash:mapProjection"])==null?void 0:J.name)??null,jsonformSchema:e.value,selectedStac:t.value,customEndpointsHandler:ve});x==null||x.forEach(y=>{var m,E,g;y&&((m=y.source)!=null&&m.sources.length)&&o.value.push(...((g=(E=y.source)==null?void 0:E.sources)==null?void 0:g.map(T=>T.url))??[])});const b=await ce(k,P,A);b!=null&&b.length&&o.value.push(...b.map(y=>{var m;return(m=y.source)==null?void 0:m.url}));const w=le(k,P,z);if(w!=null&&w.length&&o.value.push(...w.map(y=>{var m;return(m=y.source)==null?void 0:m.url})),L.debug("rendered layers after processing:",x,b,w),x!=null&&x.length||b!=null&&b.length||w!=null&&w.length){const y=[...x??[],...b??[],...w??[]];let m=[...Y()],E=m.find(g=>{var T;return(T=g.properties)==null?void 0:T.id.includes("AnalysisGroup")});if(!E)return;for(const g of y)E.layers.find(Q=>{var _,H;return((_=Q.properties)==null?void 0:_.id)===((H=g.properties)==null?void 0:H.id)})?E.layers=Z(E.layers,((N=g.properties)==null?void 0:N.id)??"",[g]):E.layers.unshift(g);if(G.value){const g=[...m];ee("process:updated",G.value,g),G.value.layers=g}}n.value=!1}catch(k){throw console.error("[eodash] Error while running process:",k),n.value=!1,k}}}function Oe({loading:n,isProcessed:t,chartSpec:r,jsonformSchema:e,processResults:a,isPolling:s}){n.value=!1,t.value=!1,s.value=!1,r.value=null,a.value=[],e.value=null}const Ue=n=>{var a,s;const t=(a=n.target)==null?void 0:a.spec;if(!t)return;const r=Object.keys(t.encoding??{}).find(i=>{var o;return((o=t.encoding)==null?void 0:o[i].type)==="temporal"});if(!r)return;const e=(s=t.encoding)==null?void 0:s[r].field;if(e)try{const i=n.detail.item,o=new Date(i.datum.datum[e]);R.value=o.toISOString()}catch(i){console.warn("[eodash] Error while setting datetime from eox-chart:",i)}},De=()=>{var r;O.value||(O.value=new URLSearchParams(window.location.search).get("indicator")??"");const n=F(),t=(r=n.stac)==null?void 0:r.find(e=>X(e)===O.value);n.loadSelectedSTAC(t==null?void 0:t.href)};export{Le as h,Ge as i,De as l,Ue as o};
