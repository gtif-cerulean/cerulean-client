import{d as R,r as C,a as G,F as U,G as _,t as S,H as Q,I as g,l as H,w,z as D,J as $,K as q,L as F,M as W,N as V,O as X,g as Y}from"./eo-dash.DdK4KFKg.js";import{a as Z,g as I,e as j,b as ee,s as O,c as te,p as re,f as ae,u as N,h as ne,i as oe}from"./async-BfuTAJue.BQyAW_lZ.js";import{t as T}from"./item.CC2Khh23.js";async function se({links:e,jsonformValue:a,specUrl:n,customEndpointsHandler:t,jsonformSchema:r,selectedStac:s,isPolling:f,jobs:d,enableCompare:i=!1}){if(!n||!e)return[null,null];const c=await g.get(n).then(p=>p.data),o={},[l,u]=O(e,"service",void 0),h=t&&a&&await t({jsonformSchema:r,jsonformValue:a,links:u,selectedStac:s,isPolling:f,jobs:d,enableCompare:i});if(h&&h.length)return c.data.values=h,[c,o];const v=l.filter(p=>p.rel==="service");try{e:for(const p of v??[])switch(p.type){case void 0:continue;case"application/json":await ie(c,{url:p.href,jsonformValue:a,link:p,flatstyleUrl:p["eox:flatstyle"],jsonformSchema:r});break e;case"text/csv":await ce(c,{url:p.href,jsonformValue:a,flatstyleUrl:p["eox:flatstyle"]});break e}}catch(p){console.error("[eodash] Error while injecting Vega data",p)}return[c,o]}async function ie(e,{url:a,jsonformValue:n,link:t,flatstyleUrl:r,jsonformSchema:s}){var f;if(e.data){if(t.method=="GET"){const d=(f=s==null?void 0:s.options)==null?void 0:f.multiQuery,i=Object.keys(n??{}).filter(o=>Array.isArray(d)?d.includes(o):d===o);if(i.length>0&&n){const o=[];for(const l of i)if(Array.isArray(n[l]))for(const u of n[l]){const h=await P(a,{...n,[l]:u},r);o.push(await g.get(h).then(v=>v.data))}else{const u=await P(a,n,r);o.push(await g.get(u).then(h=>h.data))}return e.data.values=o.flat(),e}const c=await P(a,n,r);e.data.values=await g.get(c).then(o=>o.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const d=await g.get(t.body,{responseType:"text"}).then(c=>c.data),i=JSON.parse(w.render(d,{...n??{}}));e.data.values=await g.post(a,i).then(c=>c.data)}return e}}async function ce(e,{url:a,jsonformValue:n,flatstyleUrl:t}){if(!e.data)return;const r=await P(a,n,t);return e.data.url=r,e}async function P(e,a,n){let t={};return n&&(t=await g.get(n).then(r=>r.data)),w.render(e,{...a??{},...t})}async function le({links:e,jsonformValue:a,layerId:n,projection:t}){if(!e)return;const[r,s]=O(e,"service","image/tiff");if(!r.length)return;let f=[],d="";for(const c of r??[])f.push(w.render(c.href,{...a??{}}));return await Promise.all(r.map(c=>te(c,n,f,t,d))).then(c=>c.filter(o=>!!o))}function ue(e,a,n){if(!e)return;const t=e.filter(s=>s.rel==="service"&&s.type==="image/png"),r=[];for(const s of t)r.push({type:"Image",properties:{id:s.id+"_process",title:"Results "+s.id},source:{type:"ImageStatic",imageExtent:n,url:w.render(s.href,{...a??{}})}});return r}async function de(e,a,n){if(!e)return;const t=[],r=e.filter(f=>f.rel==="service"&&f.type==="application/geo+json");if(!r.length)return t;let s=null;for(const f of r){"eox:flatstyle"in(f??{})&&(s=await g.get(f["eox:flatstyle"]).then(o=>o.data));let d,i;if(s){const o=$(n??"",s);d=o.layerConfig,i=o.style}const c={type:"Vector",source:{type:"Vector",url:w.render(f.href,{...a??{}}),format:"GeoJSON"},properties:{id:f.id+"_process",title:"Results "+n,...d&&{...d}},...i&&{style:i}};t.push(c)}return t}async function fe({links:e,jsonformValue:a,layerId:n,projection:t,origBbox:r,isPolling:s,selectedStac:f,jsonformSchema:d,jobs:i,customLayersHandler:c,enableCompare:o=!1}){if(!e)return[];const l=[],[u,h]=O(e,"service",void 0);if(c&&a&&f&&d&&h.length>0){const m=await c({jsonformValue:a,links:h,selectedStac:f,isPolling:s,jsonformSchema:d,jobs:i,enableCompare:o});m.length&&l.push(...m)}const v=await de(u,a,n),p=ue(u,a,r),k=await le({links:u,jsonformValue:a,layerId:n,projection:t});return l.push(...v??[],...p??[],...k??[]),l}async function he(e,a,n=!1){const t=e.find(d=>d.rel==="service"&&d.type=="application/json; profile=collection"&&d.endpoint==="STAC");if(!t)return;let r=w.render(t.href,{...a??{}});D.value&&(D.value=!1);const s=G();await(n?s.loadSelectedCompareSTAC:s.loadSelectedSTAC)(r,!0)}async function pe({links:e,jsonformValue:a,isPolling:n,selectedStac:t,jobs:r,enableCompare:s=!1}){if(!n)return;const f=e.filter(i=>i.rel==="service"&&i.endpoint==="eoxhub_workspaces"),d=[];for(const i of f){const c=await g.get(i.body,{responseType:"text"}).then(u=>u.data),o=JSON.parse(w.render(c,{...a??{}})),l=s?S:C;try{const u=await g.post(i.href,o,{headers:{"Content-Type":"application/json"}}),h=JSON.parse(localStorage.getItem(l.value)||"[]");h.push(u.headers.location),localStorage.setItem(l.value,JSON.stringify(h));const v=await re({jobs:r,processUrl:u.headers.location,isPolling:n,enableCompare:s}).then(p=>ae(p)).catch(p=>(p instanceof Error?console.error("Polling failed:",p.message):console.error("Unknown error occurred during polling:",p),[]));await N(r,l.value),d.push(...await ne(v,i,t))}catch(u){await N(r,l.value),u instanceof Error?console.error("Error sending POST request:",u.message):console.error("Unknown error occurred:",u)}}return d}const ge=ve([pe]);function ve(e){return async a=>await Promise.all(e.map(n=>n(a))).then(n=>{const t=[];for(const r of n)t.push(...(r==null?void 0:r.filter(ye))??[]);return t})}function ye(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function we({links:e,jsonformValue:a,jsonformSchema:n,selectedStac:t,enableCompare:r=!1}){const s=e.find(u=>u.rel==="service"&&u.endpoint==="sentinelhub");if(!s)return;const f=await xe(t,r?q.value:F.value);if(!f){console.error("[eodash] evalscript link for sentinel hub not found in indicator",f);return}if(!s)return;const d=s.href,i=I(n),c=a[i],o=await be();if(!o){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const l=oe(t.extent.temporal.interval[0],[a.start_date,a.end_date],a.distribution);return await Promise.all(l.map(([u,h])=>me({url:d,bearer:o,bbox:c,from:h,to:u,exampleLink:f}).catch(v=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",v)))).then(u=>u.flat().map(h=>h.outputs.data))}async function be(e,a){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function me({url:e,bearer:a,bbox:n,from:t,to:r,timeout:s=2e4,exampleLink:f}){if(!f){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!n){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!r||new Date(t)>new Date(r)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,r);return}const d=await g.get(f.href,{responseType:"text"}).then(o=>o.data);if(!d||d.error){console.error("[eodash] Error (sentinelhub): evalscript not found",d);return}const i={input:{bounds:{bbox:n},data:[{dataFilter:{},type:f.dataId}]},aggregation:{evalscript:d,timeRange:{from:t,to:r},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},c={headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:s};return await g.post(e,i,c).then(o=>{const l=o.data.data;return l.forEach(u=>{u.outputs.data.date=t}),l}).catch(o=>{var l,u;if(((l=o.response)==null?void 0:l.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(u=o.response)==null?void 0:u.data),[]})}async function xe(e,a){const n=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(n)return n;for(const t of W(e,a)){const r=g.get(t).then(s=>s.data.links.find(f=>f.rel==="example"&&f.title==="evalscript"));if(r)return r}}async function ke({links:e,jsonformSchema:a,jsonformValue:n,selectedStac:t,enableCompare:r=!1}){const s=e.find(o=>o.rel==="service"&&o.endpoint==="veda");if(!s)return;const f=s==null?void 0:s.href,d=I(a),i=JSON.parse(n[d]),c=await Ce(t,r?q.value:F.value);return await Promise.all(c.map(({endpoint:o,datetime:l})=>g.post(f+`?url=${o}`,{type:"Feature",properties:{},geometry:i}).then(u=>{const h=u.data.properties.statistics;return h.date=l,h}).catch(u=>console.error("[eodash] Error while fetching data from veda endpoint:",u))))}async function Ce(e,a){const n=e.links.filter(i=>i.rel=="child"),t=[];n.length?t.push(...await Promise.all(n.map(i=>g.get(T(i.href,a)).then(c=>c.data).then(async c=>{const o=Object.values(c.assets??{}).find(l=>{var u;return l.type==="application/vnd.apache.parquet"&&((u=l.roles)==null?void 0:u.includes("collection-mirror"))});if(o){const l=T(o.href,T(i.href,a));await V(l).then(u=>{c.links.push(...X(u))})}return c})))):t.push(e);const r=[];for(const i of t){const c=Y(i.links),o=i.links.filter(l=>l.rel=="item");r.push(...o.map(l=>({endpoint:l.cog_href,datetime:l[c]})))}r.sort((i,c)=>new Date(i.datetime).getTime()-new Date(c.datetime).getTime());const s=50;if(r.length<=s)return r;const f=r.length,d=[];for(let i=0;i<s;i++){const c=Math.floor(i*(f-1)/(s-1));d.push(r[c])}return d}const Pe=Le([we,ke]);function Le(e){return async a=>{for(const n of e){const t=await n(a);if(H.debug("Custom endpoint data:",t,"for callback:",n.name,"inputs:",a),!(!t||!t.length||t.some(s=>!s)))return t}return null}}async function Ae({selectedStac:e,jsonformEl:a,jsonformSchema:n,chartSpec:t,isProcessed:r,processResults:s,loading:f,isPolling:d,enableCompare:i}){var l,u;const c=i?!!_.value:!!Q.value;let o=null;if((l=e.value)!=null&&l["eodash:jsonform"]&&(o=await g.get(e.value["eodash:jsonform"]).then(h=>h.data)),!o&&c){n.value=null;return}Te({loading:f,isProcessed:r,chartSpec:t,jsonformSchema:n,isPolling:d,processResults:s}),await((u=a.value)==null?void 0:u.editor.destroy()),o&&(i&&(o=Z(o)),n.value=o)}async function Ee({loading:e,selectedStac:a,jsonformEl:n,jsonformSchema:t,chartSpec:r,chartData:s,isPolling:f,processResults:d,mapElement:i,jobs:c}){var o,l,u,h,v,p,k,m,A,E,J;if(!(!n.value||!t.value||!a.value)){H.debug("Processing..."),e.value=!0;try{const b=(l=(o=a.value)==null?void 0:o.links)==null?void 0:l.filter(y=>y.rel==="service"),B=I(t.value),x=(u=n.value)==null?void 0:u.value;j(x,t.value);const z=x[B],K=(h=a.value)==null?void 0:h["eodash:vegadefinition"],M=((v=a.value)==null?void 0:v.id)??"";[r.value,s.value]=await se({links:b,jsonformValue:{...x??{}},jsonformSchema:t.value,enableCompare:(i==null?void 0:i.id)==="compare",selectedStac:a.value,specUrl:K,isPolling:f,jobs:c,customEndpointsHandler:Pe}),Object.keys(s.value??{}).length&&d.value.push(s.value),(m=(k=(p=r.value)==null?void 0:p.data)==null?void 0:k.values)!=null&&m.length&&d.value.push((A=r.value)==null?void 0:A.data.values),r.value&&!("background"in r.value)&&(r.value.background="transparent"),await he(b,x,(i==null?void 0:i.id)==="compare");const L=await fe({isPolling:f,links:b,jsonformValue:{...x??{}},jsonformSchema:t.value,selectedStac:a.value,enableCompare:(i==null?void 0:i.id)==="compare",layerId:M,origBbox:z,jobs:c,customLayersHandler:ge,projection:(E=a.value["eodash:mapProjection"])==null?void 0:E.name});if(L.length)for(const y of L)y.type==="WebGLTile"&&((J=y.source)==null?void 0:J.type)==="GeoTIFF"?d.value.push(...y.source.sources??[]):y.source&&"url"in y.source&&d.value.push(y.source.url);ee(i,L),e.value=!1}catch(b){throw console.error("[eodash] Error while running process:",b),e.value=!1,b}}}function Te({loading:e,isProcessed:a,chartSpec:n,jsonformSchema:t,processResults:r,isPolling:s}){e.value=!1,a.value=!1,s.value=!1,n.value=null,r.value=[],t.value=null}const Je=e=>{var r,s,f,d,i,c;const a=(r=e.target)==null?void 0:r.spec;if(!a||!((f=(s=e.detail)==null?void 0:s.item)!=null&&f.datum)||!((i=(d=e.detail)==null?void 0:d.item)!=null&&i.datum.datum))return;const n=Object.keys(a.encoding??{}).find(o=>{var l;return((l=a.encoding)==null?void 0:l[o].type)==="temporal"});if(!n)return;const t=(c=a.encoding)==null?void 0:c[n].field;if(t)try{const o=e.detail.item;let l="";o.datum&&o.datum.datum?l=o.datum.datum[t]:l=o.datum[t];const u=new Date(l);R.value=u.toISOString()}catch(o){console.warn("[eodash] Error while setting datetime from eox-chart:",o)}},Ue=()=>{var n,t;C.value||(C.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=G(),a=(n=e.stac)==null?void 0:n.find(r=>U(r)===C.value);if(e.loadSelectedSTAC(a==null?void 0:a.href),_.value)if(S.value){const r=(t=e.stac)==null?void 0:t.find(s=>U(s)===S.value);e.loadSelectedCompareSTAC(r==null?void 0:r.href).catch(s=>{console.error("[eodash] Error loading compare STAC:",s)})}else e.resetSelectedCompareSTAC()};export{Ee as h,Ae as i,Ue as l,Je as o};
