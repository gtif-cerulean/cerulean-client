import{d as F,J as h,G as B,K as y,a as J,L as j,l as U,o as v,w as O,M as q,N as K,O as N,g as M}from"./eo-dash.BCjMEFJP.js";import{g as L,e as R,a as z,s as E,c as $,p as W,b as Q,u as I,j as D,d as X,f as Y}from"./async-CaeVWeay.4BgDsChC.js";import{t as Z}from"./item.MHEAG8UX.js";async function ee({links:n,jsonformValue:t,specUrl:r,customEndpointsHandler:e,jsonformSchema:a,selectedStac:i,isPolling:l}){if(!r||!n)return[null,null];const o=await h.get(r).then(p=>p.data),u={},[s,c]=E(n,"service",void 0),d=e&&t&&await e({jsonformSchema:a,jsonformValue:t,links:c,selectedStac:i,isPolling:l});if(d&&d.length)return o.data.values=d,[o,u];const f=s.filter(p=>p.rel==="service");try{e:for(const p of f??[])switch(p.type){case void 0:continue;case"application/json":await te(o,{url:p.href,jsonformValue:t,link:p,flatstyleUrl:p["eox:flatstyle"]});break e;case"text/csv":await ne(o,{url:p.href,jsonformValue:t,flatstyleUrl:p["eox:flatstyle"]});break e;default:break}}catch(p){console.error("[eodash] Error while injecting Vega data",p)}return[o,u]}async function te(n,{url:t,jsonformValue:r,link:e,flatstyleUrl:a}){if(n.data){if(e.method=="GET"){const i=await A(t,r,a);n.data.values=await h.get(i).then(l=>l.data)}else if(e.method=="POST"){if(!e.body)return console.error("[eodash] Inline data POST request requires a body template"),n;const i=await h.get(e.body,{responseType:"text"}).then(o=>o.data),l=JSON.parse(v.render(i,{...r??{}}));n.data.values=await h.post(t,l).then(o=>o.data)}return n}}async function ne(n,{url:t,jsonformValue:r,flatstyleUrl:e}){if(!n.data)return;const a=await A(t,r,e);return n.data.url=a,n}async function A(n,t,r){let e={};return r&&(e=await h.get(r).then(a=>a.data)),v.render(n,{...t??{},...e})}async function re({links:n,jsonformValue:t,layerId:r,projection:e}){if(!n)return;const[a,i]=E(n,"service","image/tiff");if(!a.length)return;let l=[],o="";for(const s of a??[])l.push(v.render(s.href,{...t??{}}));return await Promise.all(a.map(s=>$(s,r,l,e,o))).then(s=>s.filter(c=>!!c))}function ae(n,t,r){if(!n)return;const e=n.filter(i=>i.rel==="service"&&i.type==="image/png"),a=[];for(const i of e)a.push({type:"Image",properties:{id:i.id+"_process",title:"Results "+i.id},source:{type:"ImageStatic",imageExtent:r,url:v.render(i.href,{...t??{}})}});return a}async function oe(n,t,r){if(!n)return;const e=[],a=n.filter(l=>l.rel==="service"&&l.type==="application/geo+json");if(!a.length)return e;let i=null;for(const l of a){"eox:flatstyle"in(l??{})&&(i=await h.get(l["eox:flatstyle"]).then(c=>c.data));let o,u;if(i){const c=q(r??"",i);o=c.layerConfig,u=c.style}const s={type:"Vector",source:{type:"Vector",url:v.render(l.href,{...t??{}}),format:"GeoJSON"},properties:{id:l.id+"_process",title:"Results "+r,...o&&{...o}},...u&&{style:u}};e.push(s)}return e}async function se({links:n,jsonformValue:t,layerId:r,projection:e,origBbox:a,isPolling:i,selectedStac:l,jsonformSchema:o,customLayersHandler:u}){if(!n)return[];const s=[],[c,d]=E(n,"service",void 0);if(u&&t&&l&&o&&d.length>0){const b=await u({jsonformValue:t,links:d,selectedStac:l,isPolling:i,jsonformSchema:o});b.length&&s.push(...b)}const f=await oe(c,t,r),p=ae(c,t,a),k=await re({links:c,jsonformValue:t,layerId:r,projection:e});return s.push(...f??[],...p??[],...k??[]),s}async function ie(n,t){const r=n.find(a=>a.rel==="service"&&a.type=="application/json; profile=collection"&&a.endpoint==="STAC");if(!r)return;let e=v.render(r.href,{...t??{}});O.value&&(O.value=!1),await J().loadSelectedSTAC(e,!0)}async function le({links:n,jsonformValue:t,isPolling:r,selectedStac:e}){if(!r)return;const a=n.filter(l=>l.rel==="service"&&l.endpoint==="eoxhub_workspaces"),i=[];for(const l of a){const o=await h.get(l.body,{responseType:"text"}).then(s=>s.data),u=JSON.parse(v.render(o,{...t??{}}));try{const s=await h.post(l.href,u,{headers:{"Content-Type":"application/json"}}),c=JSON.parse(localStorage.getItem(y.value)||"[]");c.push(s.headers.location),localStorage.setItem(y.value,JSON.stringify(c));const d=await W({processUrl:s.headers.location,isPolling:r}).then(f=>Q(f)).catch(f=>(f instanceof Error?console.error("Polling failed:",f.message):console.error("Unknown error occurred during polling:",f),[]));await I(D,y.value),i.push(...await X(d,l,e))}catch(s){await I(D,y.value),s instanceof Error?console.error("Error sending POST request:",s.message):console.error("Unknown error occurred:",s)}}return i}const ce=ue([le]);function ue(n){return async t=>await Promise.all(n.map(r=>r(t))).then(r=>{const e=[];for(const a of r)e.push(...(a==null?void 0:a.filter(de))??[]);return e})}function de(n){return!!n&&!!n.type&&(!!n.source||!!n.layers)}async function fe({links:n,jsonformValue:t,jsonformSchema:r,selectedStac:e}){const a=n.find(d=>d.rel==="service"&&d.endpoint==="sentinelhub");if(!a)return;const i=await ge(e);if(!i){console.error("[eodash] evalscript link for sentinel hub not found in indicator",i);return}if(!a)return;const l=a.href,o=L(r),u=t[o],s=await pe();if(!s){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const c=Y(e.extent.temporal.interval[0],[t.start_date,t.end_date],t.distribution);return await Promise.all(c.map(([d,f])=>he({url:l,bearer:s,bbox:u,from:f,to:d,exampleLink:i}).catch(p=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",p)))).then(d=>d.flat().map(f=>f.outputs.data))}async function pe(n,t){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function he({url:n,bearer:t,bbox:r,from:e,to:a,timeout:i=2e4,exampleLink:l}){if(!l){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!e||!a||new Date(e)>new Date(a)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",e,a);return}const o=await h.get(l.href,{responseType:"text"}).then(c=>c.data);if(!o||o.error){console.error("[eodash] Error (sentinelhub): evalscript not found",o);return}const u={input:{bounds:{bbox:r},data:[{dataFilter:{},type:l.dataId}]},aggregation:{evalscript:o,timeRange:{from:e,to:a},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},s={headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:i};return await h.post(n,u,s).then(c=>{const d=c.data.data;return d.forEach(f=>{f.outputs.data.date=e}),d}).catch(c=>{var d,f;if(((d=c.response)==null?void 0:d.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(f=c.response)==null?void 0:f.data),[]})}async function ge(n){const t=n.links.find(r=>r.rel==="example"&&r.title==="evalscript");if(t)return t;for(const r of K(n,N.value)){const e=h.get(r).then(a=>a.data.links.find(i=>i.rel==="example"&&i.title==="evalscript"));if(e)return e}}async function ye({links:n,jsonformSchema:t,jsonformValue:r,selectedStac:e}){const a=n.find(s=>s.rel==="service"&&s.endpoint==="veda");if(!a)return;const i=a==null?void 0:a.href,l=L(t),o=JSON.parse(r[l]),u=await ve(e);return await Promise.all(u.map(({endpoint:s,datetime:c})=>h.post(i+`?url=${s}`,{type:"Feature",properties:{},geometry:o}).then(d=>{const f=d.data.properties.statistics;return f.date=c,f}).catch(d=>console.error("[eodash] Error while fetching data from veda endpoint:",d))))}async function ve(n){const t=n.links.filter(o=>o.rel=="child"),r=[];t.length?r.push(...await Promise.all(t.map(o=>h.get(Z(o.href,N.value)).then(u=>u.data)))):r.push(n);const e=[];for(const o of r){const u=M(o.links);let s=o.links.filter(c=>c.rel=="item");e.push(...s.map(c=>({endpoint:c.cog_href,datetime:c[u]})))}e.sort((o,u)=>new Date(o.datetime).getTime()-new Date(u.datetime).getTime());const a=50;if(e.length<=a)return e;const i=e.length,l=[];for(let o=0;o<a;o++){const u=Math.floor(o*(i-1)/(a-1));l.push(e[u])}return l}const me=be([fe,ye]);function be(n){return async t=>{for(const r of n){const e=await r(t);if(U.debug("Custom endpoint data:",e,"for callback:",r.name,"inputs:",t),!(!e||!e.length||e.some(i=>!i)))return e}return null}}async function Ee({selectedStac:n,jsonformEl:t,jsonformSchema:r,chartSpec:e,isProcessed:a,processResults:i,loading:l,isPolling:o}){var s;let u=null;if(n.value["eodash:jsonform"]&&(u=await h.get(n.value["eodash:jsonform"]).then(c=>c.data)),!u&&B.value){r.value=null;return}we({loading:l,isProcessed:a,chartSpec:e,jsonformSchema:r,isPolling:o,processResults:i}),await((s=t.value)==null?void 0:s.editor.destroy()),u&&(r.value=u)}async function Pe({loading:n,selectedStac:t,jsonformEl:r,jsonformSchema:e,chartSpec:a,chartData:i,isPolling:l,processResults:o}){var u,s,c,d,f,p,k,b,P,C,S,T;if(!(!r.value||!e.value||!t.value)){U.debug("Processing..."),n.value=!0;try{const m=(s=(u=t.value)==null?void 0:u.links)==null?void 0:s.filter(g=>g.rel==="service"),G=L(e.value),w=(c=r.value)==null?void 0:c.value;R(w,e.value);const _=w[G],H=(d=t.value)==null?void 0:d["eodash:vegadefinition"],V=((f=t.value)==null?void 0:f.id)??"";[a.value,i.value]=await ee({links:m,jsonformValue:{...w??{}},jsonformSchema:e.value,selectedStac:t.value,specUrl:H,isPolling:l,customEndpointsHandler:me}),Object.keys(i.value??{}).length&&o.value.push(i.value),(b=(k=(p=a.value)==null?void 0:p.data)==null?void 0:k.values)!=null&&b.length&&o.value.push((P=a.value)==null?void 0:P.data.values),a.value&&!("background"in a.value)&&(a.value.background="transparent"),await ie(m,w);const x=await se({isPolling:l,links:m,jsonformValue:{...w??{}},jsonformSchema:e.value,selectedStac:t.value,layerId:V,origBbox:_,customLayersHandler:ce,projection:(S=(C=t.value)==null?void 0:C["eodash:mapProjection"])==null?void 0:S.name});if(x.length)for(const g of x)g.type==="WebGLTile"&&((T=g.source)==null?void 0:T.type)==="GeoTIFF"?o.value.push(...g.source.sources??[]):g.source&&"url"in g.source&&o.value.push(g.source.url);z(x),n.value=!1}catch(m){throw console.error("[eodash] Error while running process:",m),n.value=!1,m}}}function we({loading:n,isProcessed:t,chartSpec:r,jsonformSchema:e,processResults:a,isPolling:i}){n.value=!1,t.value=!1,i.value=!1,r.value=null,a.value=[],e.value=null}const Ce=n=>{var a,i,l,o,u;const t=(a=n.target)==null?void 0:a.spec;if(!t||!((o=(l=(i=n.detail)==null?void 0:i.item)==null?void 0:l.datum)!=null&&o.datum))return;const r=Object.keys(t.encoding??{}).find(s=>{var c;return((c=t.encoding)==null?void 0:c[s].type)==="temporal"});if(!r)return;const e=(u=t.encoding)==null?void 0:u[r].field;if(e)try{const s=n.detail.item;let c="";s.datum&&s.datum.datum?c=s.datum.datum[e]:c=s.datum[e];const d=new Date(c);F.value=d.toISOString()}catch(s){console.warn("[eodash] Error while setting datetime from eox-chart:",s)}},Se=()=>{var r;y.value||(y.value=new URLSearchParams(window.location.search).get("indicator")??"");const n=J(),t=(r=n.stac)==null?void 0:r.find(e=>j(e)===y.value);n.loadSelectedSTAC(t==null?void 0:t.href)};export{Pe as h,Ee as i,Se as l,Ce as o};
