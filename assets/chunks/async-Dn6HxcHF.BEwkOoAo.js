import{a9 as d,l as D,S as b,aa as O,ab as P,ac as T,ad as R,ae as v,w as J,R as g,K as _,L as $}from"./eo-dash.ydmeqy8l.js";import{i as k}from"./utils.DZj92Qv1.js";function M(e){return Object.keys((e==null?void 0:e.properties)??{}).find(r=>(e==null?void 0:e.properties[r].format)==="bounding-box")}function m(e){return Object.keys((e==null?void 0:e.properties)??{}).filter(r=>(e==null?void 0:e.properties[r].type)==="geojson")}function B(e,r){const t=m(r);for(const o of t)e[o]&&(k(r==null?void 0:r.properties[o])?e[o]=e[o].features.map(s=>JSON.stringify(s.geometry)):e[o]=JSON.stringify(e[o].geometry))}async function K(e,r,t,o,s){let i=null;"eox:flatstyle"in(e??{})&&(i=await g.get(e["eox:flatstyle"]).then(n=>n.data));let l,a;if(i){const n=b(r??"",i);l=n.layerConfig,a=n.style}t=t.sort();const c=t.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!a,sources:t.map(n=>({url:n}))},properties:{id:e.id+"_process"+s,title:"Results "+r,...l&&{layerConfig:l},layerControlToolsExpand:!0},...a&&{style:a}}:void 0;return o&&c&&(c.source.projection=o),c}const C=(e,r)=>{if(!r)return;let t=r;if(typeof r=="object"){r=JSON.stringify(r);const s=new Blob([r],{type:"text"});t=URL.createObjectURL(s)}const o=document.createElement("a");confirm(`Would you like to download ${e}?`)&&(o.href=t,o.download=e,o.click()),URL.revokeObjectURL(t),o.remove()};function W(e,r,t){let o="",s="";[o,s]=r??["",""];const[i,l]=e??["",""];try{if(o&&s?(o=new Date(o),s=new Date(s)):(o=new Date(i),s=new Date(l)),(o<new Date(i)||o>new Date(l))&&(console.warn("[eodash] warn: start date is outside of the collection temporal extent and will be clamped",`
provided start date:${o.toISOString()}`,`
collection start date:${i}`),o=new Date(i)),(s>new Date(l)||s<new Date(i))&&(console.warn("[eodash] warn: end date is outside of the collection temporal extent and will be clamped",`
provided end date:${s.toISOString()}`,`
collection end date:${l}`),s=new Date(l)),o>s)return console.error("[eodash] Error: start date is greater than end date",o,s),[]}catch(y){return console.error("[eodash] Invalid date:",y.message),[]}const a=o.toISOString(),c=s.toISOString();if(!a||!c)return[];const n=[];let u=new Date(c);const f=new Date(a),p=24*60*60*1e3,w=t==="daily"?p:t==="weekly"?p*7:t==="monthly"?p*30:t==="yearly"?p*365:p;for(;u>=f&&n.length<31;)n.push(new Date(u)),u.setTime(u.getTime()-w);const h=[];for(let y=0;y<n.length-1;y++)h.push([n[y].toISOString(),n[y+1].toISOString()]);return h}function z(e,r,t){if(!e)return[[],[]];const o=[],s=[];for(const i of e){const l=i.rel===r,a=t?i.type===t:!0;l&&a&&(i.endpoint?s.push(i):o.push(i))}return[o,s]}async function L(e,r,t,o=""){var l;const s=[],i=await N(r);for(const a of e){const c=U(a,i);let n,u;if(c){const p=b((t==null?void 0:t.id)??"",c);u=p.layerConfig,n=p.style}let f=O(t);switch(a.type){case"image/tiff":{s.push({type:"WebGLTile",properties:{id:r.id+"_process"+a.id+o,title:"Results "+((t==null?void 0:t.id)??"")+" "+(a.id??""),layerControlToolsExpand:!0,...u&&{layerConfig:u},...f},source:{type:"GeoTIFF",normalize:!n,sources:a.urls.map(p=>({url:p})),...((l=t["eodash:mapProjection"])==null?void 0:l.name)&&{projection:t["eodash:mapProjection"].name}},...n&&{style:n}});break}case"application/geo+json":{const p=await P(a.urls);s.push({type:"Vector",source:{type:"Vector",format:"GeoJSON",...p&&{url:p}},properties:{id:r.id+"_process_"+a.id+o,title:"Results "+((t==null?void 0:t.id)??"")+" "+(a.id??""),...u&&{layerConfig:{...u,style:n}},...f},...!(n!=null&&n.variables)&&{style:n},interactions:[]});break}case"application/vnd.flatgeobuf":{a.urls.forEach((p,w)=>{s.push({type:"Vector",source:{type:"FlatGeoBuf",url:p},properties:{id:r.id+"_process_"+a.id+o+`_${w}`,title:"Results "+((t==null?void 0:t.id)??"")+" "+(a.id??""),layerControlToolsExpand:!0,...u&&{layerConfig:{...u,style:n}},...f}})});break}default:console.warn(`[eodash] Unsupported result type "${a.type}" for ${a.id} layer creation.`);break}}return s}async function N(e){let r=null;return e["eox:flatstyle"]&&(typeof e["eox:flatstyle"]=="string"?r=await g.get(e["eox:flatstyle"]).then(t=>t.data):Array.isArray(e["eox:flatstyle"])&&e["eox:flatstyle"].length?(r={multipleStyles:!0},await Promise.all(e["eox:flatstyle"].map(async t=>{r[t.id]=await g.get(t.url).then(o=>o.data)}))):(r={multipleStyles:!0},await Promise.all(Object.keys(e["eox:flatstyle"]??{}).map(t=>{r[t]=g.get(e["eox:flatstyle"][t]).then(o=>o.data)})))),r}function U(e,r){if(!r)return;if(!("multipleStyles"in r))return r;const t=e.id;if(!(!t||!(t in r)))return r[t]}function G(e){if(!e)return[];if("urls"in e&&Array.isArray(e.urls))return[{id:"",urls:e.urls,type:"image/tiff"}];const r=[];for(const t in e)t!=="id"&&r.push({id:t,urls:e[t].urls,type:e[t].mimetype});return r}const E=(e,r)=>{var i;if(!r.length||!e)return;const o=[...(e.id==="compare"?T:R)()];let s=o.find(l=>{var a;return(a=l.properties)==null?void 0:a.id.includes("AnalysisGroup")});if(s){for(const l of r)s.layers.find(c=>{var n,u;return((n=c.properties)==null?void 0:n.id)===((u=l.properties)==null?void 0:u.id)})?s.layers=v(s.layers,((i=l.properties)==null?void 0:i.id)??"",[l]):s.layers.unshift(l);if(e){const l=[...o],a=e.id==="compare"?"compareProcess:updated":"process:updated";J(a,e,l),e.layers=l}}};function q(e){if(!e)return e;const r=JSON.stringify(e).replaceAll("eox-map#main","eox-map#compare");return JSON.parse(r)}async function H({jobs:e,processUrl:r,isPolling:t,pollInterval:o=1e4,maxRetries:s=560,enableCompare:i=!1}){let l=0;for(t.value=!0,setTimeout(()=>{x(e,i?_.value:$.value)},500);l<s&&t.value;){try{const a=new Date().getTime(),n=(await d.get(`${r}?t=${a}`)).data;if(n.status==="successful"){console.log("Process completed successfully. Fetching result item...");const u=n.links[1].href;if(!u)throw new Error("Result links not found in the process report.");const f=await d.get(u);return console.log("Result file fetched successfully:",f.data),f.data}if(n.status==="failed")throw t.value=!1,new Error("Process failed.",n);console.log(`Status: ${n.status}. Retrying in ${o/1e3} seconds...`)}catch(a){a instanceof Error?console.error("Error while polling process status:",a.message):console.error("Unknown error occurred:",a)}await new Promise(a=>setTimeout(a,o)),l++}if(!t.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function x(e,r){const t=JSON.parse(localStorage.getItem(r)||"[]"),o=await Promise.all(t.map(s=>d.get(s,{params:{t:Date.now()}}).then(i=>i.data)));o.sort((s,i)=>new Date(i.job_start_datetime).getTime()-new Date(s.job_start_datetime).getTime()),e.value=o}const Q=async(e,r,t)=>{const s=JSON.parse(localStorage.getItem(t)||"[]").filter(i=>!i.includes(r.jobID));localStorage.setItem(t,JSON.stringify(s)),await x(e,t)},X=async(e,r)=>{const t=[],o=e.links.find(s=>s.rel.includes("results")&&s.type=="application/json");o&&(await d.get(o.href).then(s=>s.data).then(s=>{t.push(...s.urls)}),t.forEach(s=>{if(!s)return;let i="";typeof s=="string"?(i=s.includes("/")?s.split("/").pop()??"":s,i=i.includes("?")?i.split("?")[0]:i):i=(r==null?void 0:r.id)+"_process_results.json",C(i,s)}))},Y=async(e,r,t)=>{const o=await d.get(e.links[1].href).then(s=>s.data);await F({selectedStac:r,results:o,jobId:e.jobID,mapElement:t})};async function F({selectedStac:e,results:r,jobId:t,mapElement:o}){const s=e==null?void 0:e.links.find(a=>a.rel==="service"&&a.endpoint=="eoxhub_workspaces");if(!s)return;const i=G(r),l=await L(i,s,e,t);D.debug("rendered layers after loading previous process:",l),E(o,l)}export{q as a,E as b,K as c,C as d,B as e,G as f,M as g,L as h,W as i,X as j,Q as k,Y as l,H as p,z as s,x as u};
