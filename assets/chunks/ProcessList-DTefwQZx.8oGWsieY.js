import{a as T,V as b,aU as P,aV as C,aW as O,aX as R,aY as B,aZ as x,a_ as f,J as D,K as J,Q as L,as as N,N as U,l as E,aO as $,i as k,$ as F,aj as V,an as G,a1 as I,Z as M}from"./eo-dash.D_7lCkWe.js";import{g as W}from"./utils.KQWJcE3U.js";import{T as v}from"./index-4CT7Tz83.CGbJTc_W.js";import{p as z,al as A,v as H,c as w,o as g,b as K,e as Z,k as d,w as Q,j as l,F as X,B as Y,t as m,as as h,G as p}from"./framework.BD9sBbGn.js";import"./commonjsHelpers.BosuxZz1.js";import"./index.KH_2m63C.js";import"./VTooltip-CfeefrXI.CQH0sud9.js";import"./VOverlay-BzOdRu9h.D2EbwVNO.js";import"./forwardRefs-Bon_Kku1.DBcCEjqf.js";import"./transition-C5I57hn6.Bul_ogsM.js";function xe(e){return Object.keys((e==null?void 0:e.properties)??{}).find(t=>(e==null?void 0:e.properties[t].format)==="bounding-box")}function q(e){return Object.keys((e==null?void 0:e.properties)??{}).filter(t=>(e==null?void 0:e.properties[t].type)==="geojson")}function _e(e,t){const o=q(t);for(const s of o)e[s]&&(W(t==null?void 0:t.properties[s])?e[s]=e[s].features.map(a=>JSON.stringify(a.geometry)):e[s]=JSON.stringify(e[s].geometry))}async function j(e,t,o,s,a){let r=null;"eox:flatstyle"in(e??{})&&(r=await R.get(e["eox:flatstyle"]).then(c=>c.data));let u,i;if(r){const c=B(t??"",r);u=c.layerConfig,i=c.style}o=o.sort();const n=o.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!i,sources:o.map(c=>({url:c}))},properties:{id:t+"_geotiff_process"+a,title:"Results "+t,...u&&{layerConfig:u},layerControlToolsExpand:!0},...i&&{style:i}}:void 0;return s&&n&&(n.source.projection=s),n}const S=(e,t)=>{if(!t)return;let o=t;if(typeof t=="object"){t=JSON.stringify(t);const a=new Blob([t],{type:"text"});o=URL.createObjectURL(a)}const s=document.createElement("a");confirm(`Would you like to download ${e}?`)&&(s.href=o,s.download=e,s.click()),URL.revokeObjectURL(o),s.remove()},y=z([]);async function ke({processUrl:e,isPolling:t,pollInterval:o=1e4,maxRetries:s=560}){let a=0;for(t.value=!0,setTimeout(()=>{_(y,f)},500);a<s&&t.value;){try{const r=new Date().getTime(),i=(await x.get(`${e}?t=${r}`)).data;if(i.status==="successful"){console.log("Process completed successfully. Fetching result item...");const n=i.links[1].href;if(!n)throw new Error("Result links not found in the process report.");const c=await x.get(n);return console.log("Result file fetched successfully:",c.data),c.data}if(i.status==="failed")throw t.value=!1,new Error("Process failed.",i);console.log(`Status: ${i.status}. Retrying in ${o/1e3} seconds...`)}catch(r){r instanceof Error?console.error("Error while polling process status:",r.message):console.error("Unknown error occurred:",r)}await new Promise(r=>setTimeout(r,o)),a++}if(!t.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function _(e,t){const o=JSON.parse(localStorage.getItem(t.value)||"[]"),s=await Promise.all(o.map(a=>fetch(a).then(r=>r.json())));s.sort((a,r)=>new Date(r.job_start_datetime).getTime()-new Date(a.job_start_datetime).getTime()),e.value=s}const ee=async e=>{const o=JSON.parse(localStorage.getItem(f.value)||"[]").filter(s=>!s.includes(e.jobID));localStorage.setItem(f.value,JSON.stringify(o)),_(y,f)},te=async(e,t)=>{const o=[];await fetch(e.links[1].href).then(s=>s.json()).then(s=>{o.push(...s.urls)}),o.forEach(s=>{if(!s)return;let a="";typeof s=="string"?(a=s.includes("/")?s.split("/").pop()??"":s,a=a.includes("?")?a.split("?")[0]:a):a=(t==null?void 0:t.id)+"_process_results.json",S(a,s)})},se=async(e,t)=>{const o=[];await x.get(e.links[1].href).then(s=>o.push(s.data)),await oe({selectedStac:t,results:o,jobId:e.jobID})};async function oe({selectedStac:e,results:t,jobId:o}){var r;const s=e==null?void 0:e.links.filter(u=>u.rel==="service"&&u.type==="image/tiff"),a=await j(s==null?void 0:s[0],(e==null?void 0:e.id)??"",t==null?void 0:t[0].urls,((r=e==null?void 0:e["eodash:mapProjection"])==null?void 0:r.name)??null,o);if(E.debug("rendered layers after loading previous process:",a),a){const u=[...a?[a]:[]];let i=[...$()],n=i.find(c=>c.properties.id.includes("AnalysisGroup"));n==null||n.layers.push(...u),k.value&&(k.value.layers=[...i])}}const ae=J({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...I(),...G(),...V(),...F()},"VTable"),re=D()({name:"VTable",props:ae(),setup(e,t){let{slots:o,emit:s}=t;const{themeClasses:a}=L(e),{densityClasses:r}=N(e);return U(()=>p(e.tag,{class:["v-table",{"v-table--fixed-height":!!e.height,"v-table--fixed-header":e.fixedHeader,"v-table--fixed-footer":e.fixedFooter,"v-table--has-top":!!o.top,"v-table--has-bottom":!!o.bottom,"v-table--hover":e.hover},a.value,r.value,e.class],style:e.style},{default:()=>{var u,i,n;return[(u=o.top)==null?void 0:u.call(o),o.default?p("div",{class:"v-table__wrapper",style:{height:M(e.height)}},[p("table",null,[o.default()])]):(i=o.wrapper)==null?void 0:i.call(o),(n=o.bottom)==null?void 0:n.call(o)]}})),{}}}),ie={style:{padding:"0px"}},ne={style:{padding:"0px"}},le={style:{padding:"0px"}},ue={__name:"ProcessList",setup(e){const{selectedStac:t}=A(T());return H(()=>_(y,f)),(o,s)=>(g(),w("div",null,[d(y).length?(g(),K(re,{key:0,density:"compact",style:{"background-color":"transparent"}},{default:Q(()=>[s[0]||(s[0]=l("thead",null,[l("tr",null,[l("th",{class:"text-left"},"Executed on"),l("th",{class:"text-left"},"Status"),l("th",{class:"text-left"}),l("th",{class:"text-left"}),l("th",{class:"text-left"})])],-1)),l("tbody",null,[(g(!0),w(X,null,Y(d(y),a=>(g(),w("tr",{key:a.date},[l("td",null,m(new Date(a.job_start_datetime).toISOString().slice(0,16)),1),l("td",null,m(a.status),1),l("td",ie,[h(p(b,{disabled:a.status!=="successful",color:"primary",onClick:r=>d(se)(a,d(t)),icon:[d(P)],variant:"text"},null,8,["disabled","onClick","icon"]),[[v,"Load results to map"]])]),l("td",ne,[h(p(b,{disabled:a.status!=="successful",color:"primary",onClick:r=>d(te)(a,d(t)),icon:[d(C)],variant:"text"},null,8,["disabled","onClick","icon"]),[[v,"Download results"]])]),l("td",le,[h(p(b,{color:"#ff5252",onClick:r=>d(ee)(a),icon:[d(O)],variant:"text"},null,8,["onClick","icon"]),[[v,"Remove job"]])])]))),128))])]),_:1})):Z("v-if",!0)]))}},me=Object.freeze(Object.defineProperty({__proto__:null,default:ue},Symbol.toStringTag,{value:"Module"}));export{me as P,ue as _,j as c,S as d,_e as e,xe as g,y as j,ke as p,_ as u};
