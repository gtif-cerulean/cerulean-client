const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/raw.DxtaBMev.js","assets/chunks/basedecoder.B2c5_Eok.js","assets/chunks/lzw.BikwkTY2.js","assets/chunks/jpeg.CbvpOiPg.js","assets/chunks/deflate.B4_27dB1.js","assets/chunks/pako.esm.BkaqWuDM.js","assets/chunks/packbits.D6Qr5eNi.js","assets/chunks/lerc.C-kgCxfD.js","assets/chunks/commonjsHelpers.BosuxZz1.js","assets/chunks/GeoJSON.DV_SCRZg.js","assets/chunks/extent.dxdZqxc7.js","assets/chunks/WMTS.CEIOrrZ9.js","assets/chunks/Group.B92TqkVs.js","assets/chunks/WKT.jUG4JRb1.js","assets/chunks/framework.D4jZKuzb.js","assets/chunks/item.MHEAG8UX.js","assets/chunks/webimage.CU41Mh7j.js"])))=>i.map(i=>d[i]);
var Qc=Object.defineProperty;var eu=(i,e,t)=>e in i?Qc(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var J=(i,e,t)=>eu(i,typeof e!="symbol"?e+"":e,t);import{W as tu,a as et,q as se,t as Oe,ao as ru,ap as iu,aq as Fn,M as Hi,b as jr,c as ns,P as Zi,L as Et,d as ct,ar as ss,as as nu,H as su,a3 as ou,F as au,G as Nr,S as Eo,am as lu,ag as xi,ah as Dr,at as xo,al as mi,f as Pe,e as os,aj as cu,ai as bo,au as uu,ak as as,A as $a,h as xt,R as hu,ae as fu,a7 as Va,m as Ur,a8 as du,av as Br,af as gu,B as pu,g as mu,aw as To,_ as wo,N as ls,v as On,p as ja,U as _u,s as yu,ax as So}from"./GeoJSON.DV_SCRZg.js";import{P as Eu,a5 as bi,K as Ti,_ as Xa,c as Ze,a as cs,$ as us,z as xu,ah as bu,ar as Tu,f as ut,Y as Gr,L as Yi,v as Pt,I as or,h as Ae,d as me,k as ar,aa as rr,g as ae,W as Wa,e as wu,T as Su,E as De,al as Ru,af as vu,R as Pu,n as Xr,l as mt,a0 as hs,u as wi,a7 as Ha,q as Je,b as Za,N as Au,a4 as Mn,ak as Ro,ai as Lu,Q as Iu,C as Cu,a1 as Fu,a3 as Ou,an as vo,m as Mu,a8 as Nu}from"./extent.dxdZqxc7.js";import{a9 as qi,aa as B,ab as U,ac as C,ad as Si,ae as Du,af as At,ag as j,ah as b,ai as de,aj as je,ak as q,al as dr,am as Rt,an as zr,ao as Ya,ap as Ri,aq as vi,ar as F,as as x,at as I,au as Ki,av as ye,aw as Fe,ax as qa,ay as Pi,az as Dt,aA as Uu,aB as fs,aC as le,aD as Ke,aE as lt,o as Bu,K as Gu,aF as zu,aG as ku,v as Ka,a7 as Ai,a6 as _i,aH as Po,a8 as Li,h as Bt,w as Ji,aI as $u,aJ as Z,aK as ds,aL as Qe,aM as Vu,aN as gs,aO as Nn,aP as Dn,aQ as It,aR as ju,R as pn,aS as Xu,aT as Un,aU as Ja,aV as Qt,aW as Wr,aX as Wu,aY as Hu,aZ as te,a_ as Qi,a$ as kr,b0 as Ge,b1 as Ct,b2 as gr,b3 as Zu,b4 as X,b5 as Qa,b6 as el,b7 as Yu,b8 as qu,x as vt,m as Ft,B as en,b9 as tl,ba as Gt,bb as Ku,bc as Ju,bd as Qu,be as eh,L as ps,bf as th,bg as rh,bh as ih,bi as nh,bj as sh,bk as oh,$ as ms,a3 as Hr,bl as Zr,bm as ah,bn as lh,bo as mn,bp as tn,O as pr,I as Vt,F as _s,bq as Tt,br as rl,bs as ch,bt as uh,t as hh,Z as ys,a1 as fh,U as il,X as Ii,Y as dh,bu as nl,_ as gh,Q as ph,S as Bn,q as mh,p as _h,bv as Es,bw as Gn,bx as sl,by as Ci,bz as ol,bA as Ao,bB as yh,bC as al,T as Eh,bD as xs,bE as xh,bF as bh,bG as Th,bH as wh,bI as Sh,bJ as Rh,bK as vh,bL as Ph}from"./WMTS.CEIOrrZ9.js";import{T as ll,W as Ah}from"./WKT.jUG4JRb1.js";import{C as Lh,b as zn,L as Ih}from"./Group.B92TqkVs.js";import{g as cl}from"./commonjsHelpers.BosuxZz1.js";import{a0 as Mt}from"./framework.D4jZKuzb.js";import{S as Ch,a as Fh,u as bs,b as ul,C as hl,I as Ts,M as Oh,A as ai,c as Ht,d as Mh,f as Nh,g as Lo,i as Dh}from"./item.MHEAG8UX.js";class ws extends Ch{constructor(e,t=null,r={},n=[]){super(e,t,r,n)}getAll(){return[]}}class Uh extends Fh{constructor(e,t=null){super(e,t)}}class Bh extends ws{constructor(e,t=null){const r={collections:n=>n.map(s=>new hl(s))};super(e,t,r)}getObjectType(){return"CollectionCollection"}getAll(){return this.collections}isCollectionCollection(){return!0}toGeoJSON(){return{type:"FeatureCollection",features:this.collections.map(t=>t.toGeoJSON()).filter(t=>t!==null)}}getBoundingBox(){return bs(this.getBoundingBoxes())}getBoundingBoxes(){return this.collections.map(e=>e.getBoundingBox())}getTemporalExtent(){return ul(this.getTemporalExtents())}getTemporalExtents(){return this.collections.map(e=>e.getTemporalExtent())}}class fl extends ws{constructor(e,t=null){const r={features:n=>n.map(s=>new Ts(s))};super(e,t,r)}getObjectType(){return"ItemCollection"}getAll(){return this.features}toGeoJSON(){return this.toJSON()}getBoundingBox(){return bs(this.getBoundingBoxes())}getBoundingBoxes(){return this.features.map(e=>e.getBoundingBox())}getTemporalExtent(){return ul(this.getTemporalExtents())}getTemporalExtents(){return this.features.map(e=>e.getTemporalExtent())}}function li(i,e=!0,t=!1){return e&&(i=Oh.stac(i,t)),i.type==="Feature"?new Ts(i):i.type==="FeatureCollection"?new fl(i):i.type==="Collection"||!i.type&&typeof i.extent<"u"&&typeof i.license<"u"?new hl(i):!i.type&&Array.isArray(i.collections)?new Bh(i):new Uh(i)}const Gh={Point:Vh,LineString:jh,Polygon:Zh,MultiPoint:Wh,MultiLineString:Xh,MultiPolygon:Hh},zh={Point:Yh,LineString:qh,Polygon:Kh,MultiPoint:Qh,MultiLineString:Jh,MultiPolygon:ef};class kh extends tu{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,r){const n=e,s=Io(n.geometry,t),o=new et;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),n.attributes){o.setProperties(n.attributes,!0);const a=n.attributes[r];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const r=e,n=[],s=r.features;for(let o=0,a=s.length;o<a;++o)n.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return n}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return Io(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const r=e.spatialReference.wkid;return se("EPSG:"+r)}return null}writeGeometryObject(e,t){return Co(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const r={};if(!e.hasProperties())return r.attributes={},r;const n=e.getProperties(),s=e.getGeometry();if(s){r.geometry=Co(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(r.geometry.spatialReference={wkid:Number(se(o).getCode().split(":").pop())}),delete n[e.getGeometryName()]}return Eu(n)?r.attributes={}:r.attributes=n,r}writeFeaturesObject(e,t){t=this.adaptOptions(t);const r=[];for(let n=0,s=e.length;n<s;++n)r.push(this.writeFeatureObject(e[n],t));return{features:r}}}function Io(i,e){if(!i)return null;let t;if(typeof i.x=="number"&&typeof i.y=="number")t="Point";else if(i.points)t="MultiPoint";else if(i.paths)i.paths.length===1?t="LineString":t="MultiLineString";else if(i.rings){const n=i,s=mr(n),o=$h(n.rings,s);o.length===1?(t="Polygon",i=Object.assign({},i,{rings:o[0]})):(t="MultiPolygon",i=Object.assign({},i,{rings:o}))}const r=Gh[t];return Oe(r(i),!1,e)}function $h(i,e){const t=[],r=[],n=[];let s,o;for(s=0,o=i.length;s<o;++s)t.length=0,ru(t,0,i[s],e.length),iu(t,0,t.length,e.length)?r.push([i[s]]):n.push(i[s]);for(;n.length;){const a=n.shift();let l=!1;for(s=r.length-1;s>=0;s--){const c=r[s][0];if(bi(new Fn(c).getExtent(),new Fn(a).getExtent())){r[s].push(a),l=!0;break}}l||r.push([a.reverse()])}return r}function Vh(i){let e;return i.m!==void 0&&i.z!==void 0?e=new ct([i.x,i.y,i.z,i.m],"XYZM"):i.z!==void 0?e=new ct([i.x,i.y,i.z],"XYZ"):i.m!==void 0?e=new ct([i.x,i.y,i.m],"XYM"):e=new ct([i.x,i.y]),e}function jh(i){const e=mr(i);return new Et(i.paths[0],e)}function Xh(i){const e=mr(i);return new jr(i.paths,e)}function mr(i){let e="XY";return i.hasZ===!0&&i.hasM===!0?e="XYZM":i.hasZ===!0?e="XYZ":i.hasM===!0&&(e="XYM"),e}function Wh(i){const e=mr(i);return new ns(i.points,e)}function Hh(i){const e=mr(i);return new Hi(i.rings,e)}function Zh(i){const e=mr(i);return new Zi(i.rings,e)}function Yh(i,e){const t=i.getCoordinates();let r;const n=i.getLayout();if(n==="XYZ")r={x:t[0],y:t[1],z:t[2]};else if(n==="XYM")r={x:t[0],y:t[1],m:t[2]};else if(n==="XYZM")r={x:t[0],y:t[1],z:t[2],m:t[3]};else if(n==="XY")r={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return r}function Yr(i){const e=i.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function qh(i,e){const t=Yr(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:[i.getCoordinates()]}}function Kh(i,e){const t=Yr(i);return{hasZ:t.hasZ,hasM:t.hasM,rings:i.getCoordinates(!1)}}function Jh(i,e){const t=Yr(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:i.getCoordinates()}}function Qh(i,e){const t=Yr(i);return{hasZ:t.hasZ,hasM:t.hasM,points:i.getCoordinates()}}function ef(i,e){const t=Yr(i),r=i.getCoordinates(!1),n=[];for(let s=0;s<r.length;s++)for(let o=r[s].length-1;o>=0;o--)n.push(r[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:n}}function Co(i,e){const t=zh[i.getType()];return t(Oe(i,!0,e),e)}const yt="http://www.opengis.net/gml",tf=/^\s*$/;class M extends qi{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:U(this.readFeaturesInternal),featureMembers:B(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const r=e.localName;let n=null;if(r=="FeatureCollection")n=C([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(r=="featureMembers"||r=="featureMember"||r=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const l="p",c="p0";if(!o&&e.childNodes){o=[],a={};for(let f=0,g=e.childNodes.length;f<g;++f){const d=e.childNodes[f];if(d.nodeType===1){const p=d.nodeName.split(":").pop();if(!o.includes(p)){let m="",y=0;const _=d.namespaceURI;for(const E in a){if(a[E]===_){m=E;break}++y}m||(m=l+y,a[m]=_),o.push(m+":"+p)}}}r!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const f=a;a={},a[c]=f}const u={},h=Array.isArray(o)?o:[o];for(const f in a){const g={};for(let d=0,p=h.length;d<p;++d)(h[d].includes(":")?h[d].split(":")[0]:c)===f&&(g[h[d].split(":").pop()]=r=="featureMembers"?U(this.readFeatureElement,this):B(this.readFeatureElement,this));u[a[f]]=g}r=="featureMember"||r=="member"?n=C(void 0,u,e,t):n=C([],u,e,t)}return n===null&&(n=[]),n}readGeometryOrExtent(e,t){const r=t[0];return r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),C(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?ss(n,r):void 0}readGeometryElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?Oe(n,!1,r):void 0}readFeatureElementInternal(e,t,r){let n;const s={};for(let l=e.firstElementChild;l;l=l.nextElementSibling){let c;const u=l.localName;l.childNodes.length===0||l.childNodes.length===1&&(l.firstChild.nodeType===3||l.firstChild.nodeType===4)?(c=Si(l,!1),tf.test(c)&&(c=void 0)):(r&&(c=u==="boundedBy"?this.readExtentElement(l,t):this.readGeometryElement(l,t)),c?u!=="boundedBy"&&(n=u):c=this.readFeatureElementInternal(l,t,!1));const h=l.attributes.length;if(h>0&&!(c instanceof nu)){c={_content_:c};for(let f=0;f<h;f++){const g=l.attributes[f].name;c[g]=l.attributes[f].value}}s[u]?(s[u]instanceof Array||(s[u]=[s[u]]),s[u].push(c)):s[u]=c}if(!r)return s;const o=new et(s);n&&o.setGeometryName(n);const a=e.getAttribute("fid")||Du(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new ct(r,"XYZ")}readMultiPoint(e,t){const r=C([],this.MULTIPOINT_PARSERS,e,t,this);if(r)return new ns(r)}readMultiLineString(e,t){const r=C([],this.MULTILINESTRING_PARSERS,e,t,this);if(r)return new jr(r)}readMultiPolygon(e,t){const r=C([],this.MULTIPOLYGON_PARSERS,e,t,this);if(r)return new Hi(r)}pointMemberParser(e,t){At(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){At(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){At(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Et(r,"XYZ")}readFlatLinearRing(e,t){const r=C(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(r)return r}readLinearRing(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Fn(r,"XYZ")}readPolygon(e,t){const r=C([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)Ti(n,r[o]),s.push(n.length);return new Zi(n,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return C(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const r=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return r||null}readFeaturesFromNode(e,t){const r={featureType:this.featureType,featureNS:this.featureNS};return r&&Object.assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r])||[]}readProjectionFromNode(e){return se(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}M.prototype.namespace=yt;M.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};M.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};M.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};M.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:U(M.prototype.pointMemberParser),pointMembers:U(M.prototype.pointMemberParser)}};M.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:U(M.prototype.lineStringMemberParser),lineStringMembers:U(M.prototype.lineStringMemberParser)}};M.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:U(M.prototype.polygonMemberParser),polygonMembers:U(M.prototype.polygonMemberParser)}};M.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:U(M.prototype.readFlatCoordinatesFromNode)}};M.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:U(M.prototype.readLineString)}};M.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:U(M.prototype.readPolygon)}};M.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:B(M.prototype.readFlatLinearRing)}};const rf=yt+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",nf={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class Y extends M{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[yt].featureMember=U(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:rf}readFlatCoordinates(e,t){const r=Si(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const c=se(s);c&&(o=c.getAxisOrientation())}const a=r.trim().split(/\s+/),l=[];for(let c=0,u=a.length;c<u;c++){const h=a[c].split(/,+/),f=parseFloat(h[0]),g=parseFloat(h[1]),d=h.length===3?parseFloat(h[2]):0;o.startsWith("en")?l.push(f,g,d):l.push(g,f,d)}return l}readBox(e,t){const r=C([null],this.BOX_PARSERS_,e,t,this);return Xa(r[1][0],r[1][1],r[1][3],r[1][4])}innerBoundaryIsParser(e,t){const r=C(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}outerBoundaryIsParser(e,t){const r=C(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="MultiLineString"&&a===!0&&(r="MultiCurve")),j("http://www.opengis.net/gml",r)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const g=h[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=b(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=b(q)))}}const u=Object.assign({},s);u.node=e,de(u,s.serializers,je(void 0,o),c,r,l)}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}else if(e.nodeName==="Curve"){const o=j(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();de({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=ss(t,n):o=Oe(t,!0,n),de(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}createCoordinatesNode_(e){const t=j(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=t.getCoordinates(),l=a.length,c=new Array(l);for(let u=0;u<l;++u){const h=a[u];c[u]=this.getCoords_(h,o,s)}q(e,c.join(" "))}writeCurveSegments_(e,t,r){const n=j(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();de({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=j(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),j(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,r){const n=j(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeRing(e,t,r){const n=j(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}getCoords_(e,t,r){let s=(t?se(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(r){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const l=t.getCoordinates(),c=this.getCoords_(l,o,s);q(a,c)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();de({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,je("pointMember"),a,r,void 0,this)}writePointMember(e,t,r){const n=j(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();de({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];de({node:e},this.ENVELOPE_SERIALIZERS,dr,a,r,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return j("http://www.opengis.net/gml",nf[n.nodeName])}}Y.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:B(Y.prototype.readFlatCoordinates)}};Y.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:Y.prototype.innerBoundaryIsParser,outerBoundaryIs:Y.prototype.outerBoundaryIsParser}};Y.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:U(Y.prototype.readFlatCoordinates)}};Y.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:B(M.prototype.readPoint),MultiPoint:B(M.prototype.readMultiPoint),LineString:B(M.prototype.readLineString),MultiLineString:B(M.prototype.readMultiLineString),LinearRing:B(M.prototype.readLinearRing),Polygon:B(M.prototype.readPolygon),MultiPolygon:B(M.prototype.readMultiPolygon),Box:B(Y.prototype.readBox)}};Y.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:b(Y.prototype.writeCurveOrLineString),MultiCurve:b(Y.prototype.writeMultiCurveOrLineString),Point:b(Y.prototype.writePoint),MultiPoint:b(Y.prototype.writeMultiPoint),LineString:b(Y.prototype.writeCurveOrLineString),MultiLineString:b(Y.prototype.writeMultiCurveOrLineString),LinearRing:b(Y.prototype.writeLinearRing),Polygon:b(Y.prototype.writeSurfaceOrPolygon),MultiPolygon:b(Y.prototype.writeMultiSurfaceOrPolygon),Surface:b(Y.prototype.writeSurfaceOrPolygon),MultiSurface:b(Y.prototype.writeMultiSurfaceOrPolygon),Envelope:b(Y.prototype.writeEnvelope)}};Y.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:b(Y.prototype.writeLineStringOrCurveMember),curveMember:b(Y.prototype.writeLineStringOrCurveMember)}};Y.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:b(Y.prototype.writeRing),innerBoundaryIs:b(Y.prototype.writeRing)}};Y.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:b(Y.prototype.writePointMember)}};Y.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:b(Y.prototype.writeSurfaceOrPolygonMember),polygonMember:b(Y.prototype.writeSurfaceOrPolygonMember)}};Y.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:b(q),upperCorner:b(q)}};const sf=yt+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",of={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class P extends M{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:sf,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const r=C([],this.MULTICURVE_PARSERS,e,t,this);if(r)return new jr(r)}readFlatCurveRing(e,t){const r=C([],this.MULTICURVE_PARSERS,e,t,this),n=[];for(let s=0,o=r.length;s<o;++s)Ti(n,r[s].getFlatCoordinates());return n}readMultiSurface(e,t){const r=C([],this.MULTISURFACE_PARSERS,e,t,this);if(r)return new Hi(r)}curveMemberParser(e,t){At(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){At(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return C([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return C([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return C([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return C([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const r=C(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}exteriorParser(e,t){const r=C(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}readSurface(e,t){const r=C([null],this.SURFACE_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)Ti(n,r[o]),s.push(n.length);return new Zi(n,"XYZ",s)}}readCurve(e,t){const r=C([null],this.CURVE_PARSERS,e,t,this);if(r)return new Et(r,"XYZ")}readEnvelope(e,t){const r=C([null],this.ENVELOPE_PARSERS,e,t,this);return Xa(r[1][0],r[1][1],r[2][0],r[2][1])}readFlatPos(e,t){let r=Si(e,!1);const n=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=n.exec(r);)s.push(parseFloat(o[1])),r=r.substr(o[0].length);if(r!=="")return;const l=t[0].srsName;if((l?se(l).getAxisOrientation():"enu")==="neu")for(let h=0,f=s.length;h<f;h+=3){const g=s[h],d=s[h+1];s[h]=d,s[h+1]=g}const u=s.length;if(u==2&&s.push(0),u!==0)return s}readFlatPosList(e,t){const r=Si(e,!1).replace(/^\s*|\s*$/g,""),n=t[0],s=n.srsName,o=n.srsDimension,a=s?se(s).getAxisOrientation():"enu",l=r.split(/\s+/);let c=2;e.getAttribute("srsDimension")?c=Rt(e.getAttribute("srsDimension")):e.getAttribute("dimension")?c=Rt(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?c=Rt(e.parentNode.getAttribute("srsDimension")):o&&(c=Rt(o));const u=a.startsWith("en");let h,f,g;const d=[];for(let p=0,m=l.length;p<m;p+=c)h=parseFloat(l[p]),f=parseFloat(l[p+1]),g=c===3?parseFloat(l[p+2]):0,u?d.push(h,f,g):d.push(f,h,g);return d}writePos_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=a?se(a).getAxisOrientation():"enu",c=t.getCoordinates();let u=l.startsWith("en")?c[0]+" "+c[1]:c[1]+" "+c[0];if(s){const h=c[2]||0;u+=" "+h}q(e,u)}getCoords_(e,t,r){let s=(t?se(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(r){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=t.getCoordinates(),c=l.length,u=new Array(c);let h;for(let f=0;f<c;++f)h=l[f],u[f]=this.getCoords_(h,a,s);q(e,u.join(" "))}writePoint(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=j(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,r)}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];de({node:e},this.ENVELOPE_SERIALIZERS,dr,a,r,o,this)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=j(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),j(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();de({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=j(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=j(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}else if(e.nodeName==="Curve"){const o=j(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();de({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.srsName,o=n.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();de({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,je("pointMember"),a,r,void 0,this)}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();de({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeRing(e,t,r){const n=j(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writePointMember(e,t,r){const n=j(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeSurfacePatches_(e,t,r){const n=j(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeCurveSegments_(e,t,r){const n=j(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=ss(t,n):o=Oe(t,!0,n),de(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const g=h[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=b(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=b(q)))}}const u=Object.assign({},s);u.node=e,de(u,s.serializers,je(void 0,o),c,r,l)}writeFeatureMembers_(e,t,r){const n=r[r.length-1],s=n.featureType,o=n.featureNS,a={};a[o]={},a[o][s]=b(this.writeFeatureElement,this);const l=Object.assign({},n);l.node=e,de(l,a,je(s,o),t,r)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return j(this.namespace,of[n.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.curve,l=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="LineString"&&a===!0?r="Curve":r==="MultiLineString"&&l===!0&&(r="MultiCurve")),j(this.namespace,r)}writeGeometryNode(e,t){t=this.adaptOptions(t);const r=j(this.namespace,"geom"),n={node:r,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(n,t),this.writeGeometryElement(r,e,[n]),r}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=j(this.namespace,"featureMembers");r.setAttributeNS(zr,"xsi:schemaLocation",this.schemaLocation);const n={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(n,t),this.writeFeatureMembers_(r,e,[n]),r}}P.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:B(P.prototype.readFlatPos),posList:B(P.prototype.readFlatPosList),coordinates:B(Y.prototype.readFlatCoordinates)}};P.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:P.prototype.interiorParser,exterior:P.prototype.exteriorParser}};P.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:B(M.prototype.readPoint),MultiPoint:B(M.prototype.readMultiPoint),LineString:B(M.prototype.readLineString),MultiLineString:B(M.prototype.readMultiLineString),LinearRing:B(M.prototype.readLinearRing),Polygon:B(M.prototype.readPolygon),MultiPolygon:B(M.prototype.readMultiPolygon),Surface:B(P.prototype.readSurface),MultiSurface:B(P.prototype.readMultiSurface),Curve:B(P.prototype.readCurve),MultiCurve:B(P.prototype.readMultiCurve),Envelope:B(P.prototype.readEnvelope)}};P.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:U(P.prototype.curveMemberParser),curveMembers:U(P.prototype.curveMemberParser)}};P.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:U(P.prototype.surfaceMemberParser),surfaceMembers:U(P.prototype.surfaceMemberParser)}};P.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:U(M.prototype.readLineString),Curve:U(P.prototype.readCurve)}};P.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:U(M.prototype.readPolygon),Surface:U(P.prototype.readSurface)}};P.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:B(P.prototype.readPatch)}};P.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:B(P.prototype.readSegment)}};P.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:U(P.prototype.readFlatPosList),upperCorner:U(P.prototype.readFlatPosList)}};P.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:B(P.prototype.readPolygonPatch)}};P.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:Ya(P.prototype.readLineStringSegment)}};M.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:B(M.prototype.readFlatLinearRing),Ring:B(P.prototype.readFlatCurveRing)}};P.prototype.writeFeatures;P.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:b(P.prototype.writeRing),interior:b(P.prototype.writeRing)}};P.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:b(q),upperCorner:b(q)}};P.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:b(P.prototype.writeSurfaceOrPolygonMember),polygonMember:b(P.prototype.writeSurfaceOrPolygonMember)}};P.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:b(P.prototype.writePointMember)}};P.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:b(P.prototype.writeLineStringOrCurveMember),curveMember:b(P.prototype.writeLineStringOrCurveMember)}};P.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:b(P.prototype.writeCurveOrLineString),MultiCurve:b(P.prototype.writeMultiCurveOrLineString),Point:b(P.prototype.writePoint),MultiPoint:b(P.prototype.writeMultiPoint),LineString:b(P.prototype.writeCurveOrLineString),MultiLineString:b(P.prototype.writeMultiCurveOrLineString),LinearRing:b(P.prototype.writeLinearRing),Polygon:b(P.prototype.writeSurfaceOrPolygon),MultiPolygon:b(P.prototype.writeMultiSurfaceOrPolygon),Surface:b(P.prototype.writeSurfaceOrPolygon),MultiSurface:b(P.prototype.writeMultiSurfaceOrPolygon),Envelope:b(P.prototype.writeEnvelope)}};const Ss=P;Ss.prototype.writeFeatures;Ss.prototype.writeFeaturesNode;const pe=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],af="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",lf={rte:dl,trk:gl,wpt:pl},cf=F(pe,{rte:U(dl),trk:U(gl),wpt:U(pl)}),uf=F(pe,{text:x(I,"linkText"),type:x(I,"linkType")}),hf=F(pe,{name:x(I),email:Bf,link:qr}),ff=F(pe,{name:x(I),desc:x(I),author:x(Nf),copyright:x(Df),link:qr,time:x(Ki),keywords:x(I),bounds:Uf,extensions:rn}),df=F(pe,{year:x(ye),license:x(I)}),gf=F(pe,{rte:b($f),trk:b(Vf),wpt:b(Xf)});class pf extends qi{constructor(e){super(),e=e||{},this.dataProjection=se("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,r=e.length;t<r;++t){const n=e[t];if(this.readExtensions_){const s=n.get("extensionsNode_")||null;this.readExtensions_(n,s)}n.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(Ri(e)):vi(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const r=this.readMetadataFromNode(t);if(r)return r}return null}readMetadataFromNode(e){if(!pe.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(pe.includes(t.namespaceURI)&&t.localName==="metadata")return C({},ff,t,[]);return null}readFeatureFromNode(e,t){if(!pe.includes(e.namespaceURI))return null;const r=lf[e.localName];if(!r)return null;const n=r(e,[this.getReadOptions(e,t)]);return n?(this.handleReadExtensions_([n]),n):null}readFeaturesFromNode(e,t){if(!pe.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const r=C([],cf,e,[this.getReadOptions(e,t)]);return r?(this.handleReadExtensions_(r),r):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=j("http://www.topografix.com/GPX/1/1","gpx");return r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",zr),r.setAttributeNS(zr,"xsi:schemaLocation",af),r.setAttribute("version","1.1"),r.setAttribute("creator","OpenLayers"),de({node:r},gf,Mf,e,[t]),r}}const mf=F(pe,{name:x(I),cmt:x(I),desc:x(I),src:x(I),link:qr,number:x(ye),extensions:rn,type:x(I),rtept:Gf}),_f=F(pe,{ele:x(Fe),time:x(Ki)}),yf=F(pe,{name:x(I),cmt:x(I),desc:x(I),src:x(I),link:qr,number:x(ye),type:x(I),extensions:rn,trkseg:kf}),Ef=F(pe,{trkpt:zf}),xf=F(pe,{ele:x(Fe),time:x(Ki)}),bf=F(pe,{ele:x(Fe),time:x(Ki),magvar:x(Fe),geoidheight:x(Fe),name:x(I),cmt:x(I),desc:x(I),src:x(I),link:qr,sym:x(I),type:x(I),fix:x(I),sat:x(ye),hdop:x(Fe),vdop:x(Fe),pdop:x(Fe),ageofdgpsdata:x(Fe),dgpsid:x(ye),extensions:rn}),Tf=["text","type"],wf=F(pe,{text:b(q),type:b(q)}),Sf=F(pe,["name","cmt","desc","src","link","number","type","rtept"]),Rf=F(pe,{name:b(q),cmt:b(q),desc:b(q),src:b(q),link:b(Ps),number:b(Pi),type:b(q),rtept:qa(b(As))}),vf=F(pe,["ele","time"]),Pf=F(pe,["name","cmt","desc","src","link","number","type","trkseg"]),Af=F(pe,{name:b(q),cmt:b(q),desc:b(q),src:b(q),link:b(Ps),number:b(Pi),type:b(q),trkseg:qa(b(jf))}),Lf=je("trkpt"),If=F(pe,{trkpt:b(As)}),Cf=F(pe,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),Ff=F(pe,{ele:b(Dt),time:b(Uu),magvar:b(Dt),geoidheight:b(Dt),name:b(q),cmt:b(q),desc:b(q),src:b(q),link:b(Ps),sym:b(q),type:b(q),fix:b(q),sat:b(Pi),hdop:b(Dt),vdop:b(Dt),pdop:b(Dt),ageofdgpsdata:b(Dt),dgpsid:b(Pi)}),Of={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function Mf(i,e,t){const r=i.getGeometry();if(r){const n=Of[r.getType()];if(n){const s=e[e.length-1].node;return j(s.namespaceURI,n)}}}function Rs(i,e,t,r){return i.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in r?(i.push(r.ele),delete r.ele,e.hasZ=!0):i.push(0),"time"in r?(i.push(r.time),delete r.time,e.hasM=!0):i.push(0),i}function vs(i,e,t){let r="XY",n=2;if(i.hasZ&&i.hasM?(r="XYZM",n=4):i.hasZ?(r="XYZ",n=3):i.hasM&&(r="XYM",n=3),n!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*n]=e[s*4],e[s*n+1]=e[s*4+1],i.hasZ&&(e[s*n+2]=e[s*4+2]),i.hasM&&(e[s*n+2]=e[s*4+3]);if(e.length=e.length/4*n,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*n}return r}function Nf(i,e){const t=C({},hf,i,e);if(t)return t}function Df(i,e){const t=C({},df,i,e);if(t){const r=i.getAttribute("author");return r!==null&&(t.author=r),t}}function Uf(i,e){const t=e[e.length-1],r=i.getAttribute("minlat"),n=i.getAttribute("minlon"),s=i.getAttribute("maxlat"),o=i.getAttribute("maxlon");n!==null&&r!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(n),parseFloat(r)],[parseFloat(o),parseFloat(s)]])}function Bf(i,e){const t=e[e.length-1],r=i.getAttribute("id"),n=i.getAttribute("domain");r!==null&&n!==null&&(t.email=`${r}@${n}`)}function qr(i,e){const t=e[e.length-1],r=i.getAttribute("href");r!==null&&(t.link=r),At(uf,i,e)}function rn(i,e){const t=e[e.length-1];t.extensionsNode_=i}function Gf(i,e){const t=C({},_f,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;Rs(n,s,i,t)}}function zf(i,e){const t=C({},xf,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;Rs(n,s,i,t)}}function kf(i,e){const t=e[e.length-1];At(Ef,i,e);const r=t.flatCoordinates;t.ends.push(r.length)}function dl(i,e){const t=e[0],r=C({flatCoordinates:[],layoutOptions:{}},mf,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.layoutOptions;delete r.layoutOptions;const o=vs(s,n),a=new Et(n,o);Oe(a,!1,t);const l=new et(a);return l.setProperties(r,!0),l}function gl(i,e){const t=e[0],r=C({flatCoordinates:[],ends:[],layoutOptions:{}},yf,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.ends;delete r.ends;const o=r.layoutOptions;delete r.layoutOptions;const a=vs(o,n,s),l=new jr(n,a,s);Oe(l,!1,t);const c=new et(l);return c.setProperties(r,!0),c}function pl(i,e){const t=e[0],r=C({},bf,i,e);if(!r)return;const n={},s=Rs([],n,i,r),o=vs(n,s),a=new ct(s,o);Oe(a,!1,t);const l=new et(a);return l.setProperties(r,!0),l}function Ps(i,e,t){i.setAttribute("href",e);const n=t[t.length-1].properties,s=[n.linkText,n.linkType];de({node:i},wf,dr,s,t,Tf)}function As(i,e,t){const r=t[t.length-1],s=r.node.namespaceURI,o=r.properties;switch(i.setAttributeNS(null,"lat",String(e[1])),i.setAttributeNS(null,"lon",String(e[0])),r.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const l=i.nodeName=="rtept"?vf[s]:Cf[s],c=fs(o,l);de({node:i,properties:o},Ff,dr,c,t,l)}function $f(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="LineString"){const u=Oe(o,!0,r);s.geometryLayout=u.getLayout(),n.rtept=u.getCoordinates()}const a=t[t.length-1].node,l=Sf[a.namespaceURI],c=fs(n,l);de(s,Rf,dr,c,t,l)}function Vf(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const u=Oe(o,!0,r);n.trkseg=u.getLineStrings()}const a=t[t.length-1].node,l=Pf[a.namespaceURI],c=fs(n,l);de(s,Af,dr,c,t,l)}function jf(i,e,t){const r={node:i};r.geometryLayout=e.getLayout(),r.properties={},de(r,If,Lf,e.getCoordinates(),t)}function Xf(i,e,t){const r=t[0],n=t[t.length-1];n.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=Oe(s,!0,r);n.geometryLayout=o.getLayout(),As(i,o.getCoordinates(),t)}}const Wf=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,Hf=/^H.([A-Z]{3}).*?:(.*)/,Zf=/^HFDTE(\d{2})(\d{2})(\d{2})/,Yf=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,qf=/\r\n|\r|\n/;class Kf extends ll{constructor(e){super(),e=e||{},this.dataProjection=se("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const r=this.altitudeMode_,n=e.split(qf),s={},o=[];let a=2e3,l=0,c=1,u=-1,h,f;for(h=0,f=n.length;h<f;++h){const m=n[h];let y;if(m.charAt(0)=="B"){if(y=Wf.exec(m),y){const _=parseInt(y[1],10),E=parseInt(y[2],10),w=parseInt(y[3],10);let S=parseInt(y[4],10)+parseInt(y[5],10)/6e4;this.lad_&&(S+=parseInt(m.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),y[6]=="S"&&(S=-S);let T=parseInt(y[7],10)+parseInt(y[8],10)/6e4;if(this.lod_&&(T+=parseInt(m.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),y[9]=="W"&&(T=-T),o.push(T,S),r!="none"){let A;r=="gps"?A=parseInt(y[11],10):r=="barometric"?A=parseInt(y[12],10):A=0,o.push(A)}let v=Date.UTC(a,l,c,_,E,w);v<u&&(v=Date.UTC(a,l,c+1,_,E,w)),o.push(v/1e3),u=v}}else if(m.charAt(0)=="H")y=Yf.exec(m),y?(c=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=Zf.exec(m),y?(c=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=Hf.exec(m),y&&(s[y[1]]=y[2].trim())));else if(m.charAt(0)=="I"){const _=parseInt(m.slice(1,3),10);for(let E=0;E<_;E++){const w=m.slice(7+E*7,10+E*7);if(w==="LAD"||w==="LOD"){const S=parseInt(m.slice(3+E*7,5+E*7),10)-1,T=parseInt(m.slice(5+E*7,7+E*7),10);w==="LAD"?(this.lad_=!0,this.ladStart_=S,this.ladStop_=T):w==="LOD"&&(this.lod_=!0,this.lodStart_=S,this.lodStop_=T)}}}}if(o.length===0)return null;const g=r=="none"?"XYM":"XYZM",d=new Et(o,g),p=new et(Oe(d,!1,t));return p.setProperties(s,!0),p}readFeaturesFromText(e,t){const r=this.readFeatureFromText(e,t);return r?[r]:[]}}const be={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},kt={};kt[be.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};kt[be.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};kt[be.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};kt.none={none:{supports:[],formats:[],qualities:[]}};const Jf=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,Fo=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,Qf=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function ed(i){let e=i.getComplianceLevelSupportedFeatures();return e===void 0&&(e=kt[be.VERSION1].level0),{url:i.imageInfo["@id"]===void 0?void 0:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,i.imageInfo.formats===void 0?[]:i.imageInfo.formats],qualities:[...e.qualities,i.imageInfo.qualities===void 0?[]:i.imageInfo.qualities],resolutions:i.imageInfo.scale_factors,tileSize:i.imageInfo.tile_width!==void 0?i.imageInfo.tile_height!==void 0?[i.imageInfo.tile_width,i.imageInfo.tile_height]:[i.imageInfo.tile_width,i.imageInfo.tile_width]:i.imageInfo.tile_height!=null?[i.imageInfo.tile_height,i.imageInfo.tile_height]:void 0}}function td(i){const e=i.getComplianceLevelSupportedFeatures(),t=Array.isArray(i.imageInfo.profile)&&i.imageInfo.profile.length>1,r=t&&i.imageInfo.profile[1].supports?i.imageInfo.profile[1].supports:[],n=t&&i.imageInfo.profile[1].formats?i.imageInfo.profile[1].formats:[],s=t&&i.imageInfo.profile[1].qualities?i.imageInfo.profile[1].qualities:[];return{url:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(o){return o.width})[0],i.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...r],formats:[...e.formats,...n],qualities:[...e.qualities,...s]}}function rd(i){const e=i.getComplianceLevelSupportedFeatures(),t=i.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...i.imageInfo.extraFormats],r=i.imageInfo.preferredFormats!==void 0&&Array.isArray(i.imageInfo.preferredFormats)&&i.imageInfo.preferredFormats.length>0?i.imageInfo.preferredFormats.filter(function(n){return["jpg","png","gif"].includes(n)}).reduce(function(n,s){return n===void 0&&t.includes(s)?s:n},void 0):void 0;return{url:i.imageInfo.id,sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(n){return[n.width,n.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(n){return n.width})[0],i.imageInfo.tiles.map(function(n){return n.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(n){return n.scaleFactors})[0],supports:i.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...i.imageInfo.extraFeatures],formats:t,qualities:i.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...i.imageInfo.extraQualities],preferredFormat:r}}const nn={};nn[be.VERSION1]=ed;nn[be.VERSION2]=td;nn[be.VERSION3]=rd;class id{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return be.VERSION1;case"http://iiif.io/api/image/2/context.json":return be.VERSION2;case"http://iiif.io/api/image/3/context.json":return be.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(be.VERSION1)&&this.imageInfo.identifier)return be.VERSION1;break}Ze(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case be.VERSION1:if(Jf.test(this.imageInfo.profile))return this.imageInfo.profile;break;case be.VERSION3:if(Qf.test(this.imageInfo.profile))return this.imageInfo.profile;break;case be.VERSION2:if(typeof this.imageInfo.profile=="string"&&Fo.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&Fo.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const r=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(r)?r[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?kt.none.none:kt[e][t]}getTileSourceOptions(e){const t=e||{},r=this.getImageApiVersion();if(r===void 0)return;const n=r===void 0?void 0:nn[r](this);if(n!==void 0)return{url:n.url,version:r,size:[this.imageInfo.width,this.imageInfo.height],sizes:n.sizes,format:t.format!==void 0&&n.formats.includes(t.format)?t.format:n.preferredFormat!==void 0?n.preferredFormat:"jpg",supports:n.supports,quality:t.quality&&n.qualities.includes(t.quality)?t.quality:n.qualities.includes("native")?"native":"default",resolutions:Array.isArray(n.resolutions)?n.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:n.tileSize}}}class Ls{read(e){if(!e)return null;if(typeof e=="string"){const t=Ri(e);return this.readFromDocument(t)}return vi(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){cs()}}const nd="http://www.w3.org/1999/xlink";function _r(i){return i.getAttributeNS(nd,"href")}const ze=[null,"http://www.opengis.net/ows/1.1"],sd=F(ze,{ServiceIdentification:x(Ld),ServiceProvider:x(Cd),OperationsMetadata:x(Pd)});class ml extends Ls{constructor(){super()}readFromNode(e){const t=C({},sd,e,[]);return t||null}}const od=F(ze,{DeliveryPoint:x(I),City:x(I),AdministrativeArea:x(I),PostalCode:x(I),Country:x(I),ElectronicMailAddress:x(I)}),ad=F(ze,{Value:le(Fd)}),ld=F(ze,{AllowedValues:x(xd)}),cd=F(ze,{Phone:x(Ad),Address:x(Ed)}),ud=F(ze,{HTTP:x(Rd)}),hd=F(ze,{Get:le(Sd),Post:void 0}),fd=F(ze,{DCP:x(wd)}),dd=F(ze,{Operation:vd}),gd=F(ze,{Voice:x(I),Facsimile:x(I)}),pd=F(ze,{Constraint:le(bd)}),md=F(ze,{IndividualName:x(I),PositionName:x(I),ContactInfo:x(Td)}),_d=F(ze,{Abstract:x(I),AccessConstraints:x(I),Fees:x(I),Title:x(I),ServiceTypeVersion:x(I),ServiceType:x(I)}),yd=F(ze,{ProviderName:x(I),ProviderSite:x(_r),ServiceContact:x(Id)});function Ed(i,e){return C({},od,i,e)}function xd(i,e){return C({},ad,i,e)}function bd(i,e){const t=i.getAttribute("name");if(t)return C({name:t},ld,i,e)}function Td(i,e){return C({},cd,i,e)}function wd(i,e){return C({},ud,i,e)}function Sd(i,e){const t=_r(i);if(t)return C({href:t},pd,i,e)}function Rd(i,e){return C({},hd,i,e)}function vd(i,e){const t=i.getAttribute("name"),r=C({},fd,i,e);if(!r)return;const n=e[e.length-1];n[t]=r}function Pd(i,e){return C({},dd,i,e)}function Ad(i,e){return C({},gd,i,e)}function Ld(i,e){return C({},_d,i,e)}function Id(i,e){return C({},md,i,e)}function Cd(i,e){return C({},yd,i,e)}function Fd(i,e){return I(i)}function Oo(i,e,t,r,n,s){n!==void 0?(n=n,s=s!==void 0?s:0):(n=[],s=0);let o=e;for(;o<t;){const a=i[o++];n[s++]=i[o++],n[s++]=a;for(let l=2;l<r;++l)n[s++]=i[o++]}return n.length=s,n}class Od extends ll{constructor(e){super(),e=e||{},this.dataProjection=se("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t);return new et(r)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const r=su(this.geometryLayout_),n=Nd(e,r,this.factor_);Oo(n,0,n.length,r,n);const s=ou(n,0,n.length,r),o=new Et(s,this.geometryLayout_);return Oe(o,!1,this.adaptOptions(t))}writeFeatureText(e,t){const r=e.getGeometry();if(r)return this.writeGeometryText(r,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=Oe(e,!0,this.adaptOptions(t));const r=e.getFlatCoordinates(),n=e.getStride();return Oo(r,0,r.length,n,r),Md(r,n,this.factor_)}}function Md(i,e,t){t=t||1e5;let r;const n=new Array(e);for(r=0;r<e;++r)n[r]=0;for(let s=0,o=i.length;s<o;)for(r=0;r<e;++r,++s){const a=i[s],l=a-n[r];n[r]=a,i[s]=l}return Dd(i,t)}function Nd(i,e,t){t=t||1e5;let r;const n=new Array(e);for(r=0;r<e;++r)n[r]=0;const s=Ud(i,t);for(let o=0,a=s.length;o<a;)for(r=0;r<e;++r,++o)n[r]+=s[o],s[o]=n[r];return s}function Dd(i,e){e=e||1e5;for(let t=0,r=i.length;t<r;++t)i[t]=Math.round(i[t]*e);return Bd(i)}function Ud(i,e){e=e||1e5;const t=Gd(i);for(let r=0,n=t.length;r<n;++r)t[r]/=e;return t}function Bd(i){for(let e=0,t=i.length;e<t;++e){const r=i[e];i[e]=r<0?~(r<<1):r<<1}return zd(i)}function Gd(i){const e=kd(i);for(let t=0,r=e.length;t<r;++t){const n=e[t];e[t]=n&1?~(n>>1):n>>1}return e}function zd(i){let e="";for(let t=0,r=i.length;t<r;++t)e+=$d(i[t]);return e}function kd(i){const e=[];let t=0,r=0;for(let n=0,s=i.length;n<s;++n){const o=i.charCodeAt(n)-63;t|=(o&31)<<r,o<32?(e.push(t),t=0,r=0):r+=5}return e}function $d(i){let e,t="";for(;i>=32;)e=(32|i&31)+63,t+=String.fromCharCode(e),i>>=5;return e=i+63,t+=String.fromCharCode(e),t}class ee extends P{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,r){const n=r[r.length-1];r[r.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},n),super.writeGeometryElement(e,t,r)}}ee.prototype.namespace="http://www.opengis.net/gml/3.2";ee.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:B(P.prototype.readFlatPos),posList:B(P.prototype.readFlatPosList),coordinates:B(Y.prototype.readFlatCoordinates)}};ee.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:P.prototype.interiorParser,exterior:P.prototype.exteriorParser}};ee.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:B(M.prototype.readPoint),MultiPoint:B(M.prototype.readMultiPoint),LineString:B(M.prototype.readLineString),MultiLineString:B(M.prototype.readMultiLineString),LinearRing:B(M.prototype.readLinearRing),Polygon:B(M.prototype.readPolygon),MultiPolygon:B(M.prototype.readMultiPolygon),Surface:B(ee.prototype.readSurface),MultiSurface:B(P.prototype.readMultiSurface),Curve:B(ee.prototype.readCurve),MultiCurve:B(P.prototype.readMultiCurve),Envelope:B(ee.prototype.readEnvelope)}};ee.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:U(P.prototype.curveMemberParser),curveMembers:U(P.prototype.curveMemberParser)}};ee.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:U(P.prototype.surfaceMemberParser),surfaceMembers:U(P.prototype.surfaceMemberParser)}};ee.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:U(M.prototype.readLineString),Curve:U(P.prototype.readCurve)}};ee.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:U(M.prototype.readPolygon),Surface:U(P.prototype.readSurface)}};ee.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:B(P.prototype.readPatch)}};ee.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:B(P.prototype.readSegment)}};ee.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:U(P.prototype.readFlatPosList),upperCorner:U(P.prototype.readFlatPosList)}};ee.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:B(P.prototype.readPolygonPatch)}};ee.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:Ya(P.prototype.readLineStringSegment)}};ee.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:U(M.prototype.pointMemberParser),pointMembers:U(M.prototype.pointMemberParser)}};ee.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:U(M.prototype.lineStringMemberParser),lineStringMembers:U(M.prototype.lineStringMemberParser)}};ee.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:U(M.prototype.polygonMemberParser),polygonMembers:U(M.prototype.polygonMemberParser)}};ee.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:U(M.prototype.readFlatCoordinatesFromNode)}};ee.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:U(M.prototype.readLineString)}};ee.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:U(M.prototype.readPolygon)}};ee.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:B(M.prototype.readFlatLinearRing),Ring:B(ee.prototype.readFlatCurveRing)}};ee.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:b(P.prototype.writeRing),interior:b(P.prototype.writeRing)}};ee.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:b(q),upperCorner:b(q)}};ee.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:b(P.prototype.writeSurfaceOrPolygonMember),polygonMember:b(P.prototype.writeSurfaceOrPolygonMember)}};ee.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:b(P.prototype.writePointMember)}};ee.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:b(P.prototype.writeLineStringOrCurveMember),curveMember:b(P.prototype.writeLineStringOrCurveMember)}};ee.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:b(P.prototype.writeCurveOrLineString),MultiCurve:b(P.prototype.writeMultiCurveOrLineString),Point:b(ee.prototype.writePoint),MultiPoint:b(P.prototype.writeMultiPoint),LineString:b(P.prototype.writeCurveOrLineString),MultiLineString:b(P.prototype.writeMultiCurveOrLineString),LinearRing:b(P.prototype.writeLinearRing),Polygon:b(P.prototype.writeSurfaceOrPolygon),MultiPolygon:b(P.prototype.writeMultiSurfaceOrPolygon),Surface:b(P.prototype.writeSurfaceOrPolygon),MultiSurface:b(P.prototype.writeMultiSurfaceOrPolygon),Envelope:b(P.prototype.writeEnvelope)}};class _l{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class Vd extends _l{constructor(e,t){super(e),this.conditions=t,Ze(this.conditions.length>=2,"At least 2 conditions are required")}}class jd extends Vd{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class Xd extends _l{constructor(e,t,r){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=r}}function Wd(i){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(jd,e))}function Hd(i,e,t){return new Xd(i,e,t)}const Mo={"http://www.opengis.net/gml":{boundedBy:x(M.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:U(M.prototype.readFeaturesInternal)}},Zd={"http://www.opengis.net/wfs":{totalInserted:x(ye),totalUpdated:x(ye),totalDeleted:x(ye)},"http://www.opengis.net/wfs/2.0":{totalInserted:x(ye),totalUpdated:x(ye),totalDeleted:x(ye)}},Yd={"http://www.opengis.net/wfs":{TransactionSummary:x(Do,"transactionSummary"),InsertResults:x(Bo,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:x(Do,"transactionSummary"),InsertResults:x(Bo,"insertIds")}},qd={"http://www.opengis.net/wfs":{PropertyName:b(q)},"http://www.opengis.net/wfs/2.0":{PropertyName:b(q)}},yl={"http://www.opengis.net/wfs":{Insert:b(Go),Update:b(ko),Delete:b(zo),Property:b($o),Native:b(Vo)},"http://www.opengis.net/wfs/2.0":{Insert:b(Go),Update:b(ko),Delete:b(zo),Property:b($o),Native:b(Vo)}},El="feature",Is="http://www.w3.org/2000/xmlns/",Cs={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},kn={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},Fs={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},No={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},Os={"2.0.0":ee,"1.1.0":P,"1.0.0":Y},Kd="1.1.0";class Jd extends qi{constructor(e){super(),e=e||{},this.version_=e.version?e.version:Kd,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new Os[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:No[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const r={node:e};Object.assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(r,this.getReadOptions(e,t||{}));const n=[r];let s;this.version_==="2.0.0"?s=Mo:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=C([],s,e,n,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=Ri(e);return this.readTransactionResponseFromDocument(t)}return vi(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=Ri(e);return this.readFeatureCollectionMetadataFromDocument(t)}return vi(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},r=Rt(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,C(t,Mo,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return C({},Yd,e,[])}writeGetFeature(e){const t=j(kn[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS(zr,"xsi:schemaLocation",this.schemaLocation_);const r={node:t};if(Object.assign(r,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),Ze(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let n=e.filter;e.bbox&&(Ze(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),n=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,n)),Object.assign(r,{geometryName:e.geometryName,filter:n}),Qo(t,e.featureTypes,[r])}else e.featureTypes.forEach(n=>{const s=this.combineBboxAndFilter(n.geometryName,n.bbox,e.srsName,e.filter);Object.assign(r,{geometryName:n.geometryName,filter:s}),Qo(t,[n.name],[r])});return t}combineBboxAndFilter(e,t,r,n){const s=Hd(e,t,r);return n?Wd(n,s):s}writeTransaction(e,t,r,n){const s=[],o=n.version?n.version:this.version_,a=j(kn[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let l;n&&(l=n.gmlOptions?n.gmlOptions:{},n.handle&&a.setAttribute("handle",n.handle)),a.setAttributeNS(zr,"xsi:schemaLocation",No[o]);const c=Qd(a,l,o,n);return e&&ci("Insert",e,s,c),t&&ci("Update",t,s,c),r&&ci("Delete",r,s,c),n.nativeElements&&ci("Native",n.nativeElements,s,c),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const r=[{}];return this.gmlFormat_.readGeometryElement(t,r),se(r.pop().srsName)}}return null}}function Qd(i,e,t,r){const n=r.featurePrefix?r.featurePrefix:El;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:i},{version:t,featureNS:r.featureNS,featureType:r.featureType,featurePrefix:n,gmlVersion:s,hasZ:r.hasZ,srsName:r.srsName},e)}function ci(i,e,t,r){de(r,yl,je(i),e,t)}function Do(i,e){return C({},Zd,i,e)}const eg={"http://www.opengis.net/ogc":{FeatureId:U(function(i,e){return i.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:U(function(i,e){return i.getAttribute("fid")})}};function Uo(i,e){At(eg,i,e)}const tg={"http://www.opengis.net/wfs":{Feature:Uo},"http://www.opengis.net/wfs/2.0":{Feature:Uo}};function Bo(i,e){return C([],tg,i,e)}function Go(i,e,t){const r=t[t.length-1],n=r.featureType,s=r.featureNS,o=r.gmlVersion,a=j(s,n);i.appendChild(a),o===2?Y.prototype.writeFeatureElement(a,e,t):o===3?P.prototype.writeFeatureElement(a,e,t):ee.prototype.writeFeatureElement(a,e,t)}function xl(i,e,t){const n=t[t.length-1].version,s=Cs[n],o=j(s,"Filter"),a=j(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),i.appendChild(o)}function Ms(i,e){i=i||El;const t=i+":";return e.startsWith(t)?e:t+e}function zo(i,e,t){const r=t[t.length-1];Ze(e.getId()!==void 0,"Features must have an id set");const n=r.featureType,s=r.featurePrefix,o=r.featureNS,a=Ms(s,n);i.setAttribute("typeName",a),i.setAttributeNS(Is,"xmlns:"+s,o);const l=e.getId();l!==void 0&&xl(i,l,t)}function ko(i,e,t){const r=t[t.length-1];Ze(e.getId()!==void 0,"Features must have an id set");const n=r.version,s=r.featureType,o=r.featurePrefix,a=r.featureNS,l=Ms(o,s),c=e.getGeometryName();i.setAttribute("typeName",l),i.setAttributeNS(Is,"xmlns:"+o,a);const u=e.getId();if(u!==void 0){const h=e.getKeys(),f=[];for(let g=0,d=h.length;g<d;g++){const p=e.get(h[g]);if(p!==void 0){let m=h[g];p&&typeof p.getSimplifiedGeometry=="function"&&(m=c),f.push({name:m,value:p})}}de({version:n,gmlVersion:r.gmlVersion,node:i,hasZ:r.hasZ,srsName:r.srsName},yl,je("Property"),f,t),xl(i,u,t)}}function $o(i,e,t){const r=t[t.length-1],n=r.version,s=kn[n],a=j(s,n==="2.0.0"?"ValueReference":"Name"),l=r.gmlVersion;if(i.appendChild(a),q(a,e.name),e.value!==void 0&&e.value!==null){const c=j(s,"Value");i.appendChild(c),e.value&&typeof e.value.getSimplifiedGeometry=="function"?l===2?Y.prototype.writeGeometryElement(c,e.value,t):l===3?P.prototype.writeGeometryElement(c,e.value,t):ee.prototype.writeGeometryElement(c,e.value,t):q(c,e.value)}}function Vo(i,e,t){e.vendorId&&i.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&i.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&q(i,e.value)}const sn={"http://www.opengis.net/wfs":{Query:b(jo)},"http://www.opengis.net/wfs/2.0":{Query:b(jo)},"http://www.opengis.net/ogc":{During:b(Ho),And:b(ui),Or:b(ui),Not:b(Zo),BBOX:b(Xo),Contains:b(wt),Intersects:b(wt),Within:b(wt),DWithin:b(Wo),PropertyIsEqualTo:b(Xe),PropertyIsNotEqualTo:b(Xe),PropertyIsLessThan:b(Xe),PropertyIsLessThanOrEqualTo:b(Xe),PropertyIsGreaterThan:b(Xe),PropertyIsGreaterThanOrEqualTo:b(Xe),PropertyIsNull:b(Yo),PropertyIsBetween:b(qo),PropertyIsLike:b(Ko)},"http://www.opengis.net/fes/2.0":{During:b(Ho),And:b(ui),Or:b(ui),Not:b(Zo),BBOX:b(Xo),Contains:b(wt),Disjoint:b(wt),Intersects:b(wt),ResourceId:b(ig),Within:b(wt),DWithin:b(Wo),PropertyIsEqualTo:b(Xe),PropertyIsNotEqualTo:b(Xe),PropertyIsLessThan:b(Xe),PropertyIsLessThanOrEqualTo:b(Xe),PropertyIsGreaterThan:b(Xe),PropertyIsGreaterThanOrEqualTo:b(Xe),PropertyIsNull:b(Yo),PropertyIsBetween:b(qo),PropertyIsLike:b(Ko)}};function jo(i,e,t){const r=t[t.length-1],n=r.version,s=r.featurePrefix,o=r.featureNS,a=r.propertyNames,l=r.srsName;let c;s?c=Ms(s,e):c=e;let u;n==="2.0.0"?u="typeNames":u="typeName",i.setAttribute(u,c),l&&i.setAttribute("srsName",l),o&&i.setAttributeNS(Is,"xmlns:"+s,o);const h=Object.assign({},r);h.node=i,de(h,qd,je("PropertyName"),a,t);const f=r.filter;if(f){const g=j(on(n),"Filter");i.appendChild(g),rg(g,f,t)}}function rg(i,e,t){const r=t[t.length-1],n={node:i};Object.assign(n,{context:r}),de(n,sn,je(e.getTagName()),[e],t)}function Xo(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Os[s];yr(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.extent,t)}function ig(i,e,t){i.setAttribute("rid",e.rid)}function wt(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Os[s];yr(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.geometry,t)}function Wo(i,e,t){const s=t[t.length-1].context.version;wt(i,e,t);const o=j(on(s),"Distance");q(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),i.appendChild(o)}function Ho(i,e,t){const s=t[t.length-1].context.version;Fi(Fs[s],"ValueReference",i,e.propertyName);const o=j(yt,"TimePeriod");i.appendChild(o);const a=j(yt,"begin");o.appendChild(a),Jo(a,e.begin);const l=j(yt,"end");o.appendChild(l),Jo(l,e.end)}function ui(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.conditions;for(let a=0,l=o.length;a<l;++a){const c=o[a];de(s,sn,je(c.getTagName()),[c],t)}}function Zo(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.condition;de(s,sn,je(o.getTagName()),[o],t)}function Xe(i,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),yr(s,i,e.propertyName),Oi(s,i,""+e.expression)}function Yo(i,e,t){const s=t[t.length-1].context.version;yr(s,i,e.propertyName)}function qo(i,e,t){const s=t[t.length-1].context.version,o=on(s);yr(s,i,e.propertyName);const a=j(o,"LowerBoundary");i.appendChild(a),Oi(s,a,""+e.lowerBoundary);const l=j(o,"UpperBoundary");i.appendChild(l),Oi(s,l,""+e.upperBoundary)}function Ko(i,e,t){const s=t[t.length-1].context.version;i.setAttribute("wildCard",e.wildCard),i.setAttribute("singleChar",e.singleChar),i.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),yr(s,i,e.propertyName),Oi(s,i,""+e.pattern)}function Fi(i,e,t,r){const n=j(i,e);q(n,r),t.appendChild(n)}function Oi(i,e,t){Fi(on(i),"Literal",e,t)}function yr(i,e,t){i==="2.0.0"?Fi(Fs[i],"ValueReference",e,t):Fi(Cs[i],"PropertyName",e,t)}function Jo(i,e){const t=j(yt,"TimeInstant");i.appendChild(t);const r=j(yt,"timePosition");t.appendChild(r),q(r,e)}function Qo(i,e,t){const r=t[t.length-1],n=Object.assign({},r);n.node=i,de(n,sn,je("Query"),e,t)}function on(i){let e;return i==="2.0.0"?e=Fs[i]:e=Cs[i],e}const ue={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class ea{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readLineString());return t}readWkbHeader(e){const r=this.readUint8()>0,n=this.readUint32(r),s=Math.floor((n&268435455)/1e3),o=!!(n&2147483648)||s===1||s===3,a=!!(n&1073741824)||s===2||s===3,l=!!(n&536870912),c=(n&268435455)%1e3,u=["XY",o?"Z":"",a?"M":""].join(""),h=l?this.readUint32(r):null;if(e!==void 0&&e!==c)throw new Error("Unexpected WKB geometry type "+c);if(this.initialized_){if(this.isLittleEndian_!==r)throw new Error("Inconsistent endian");if(this.layout_!==u)throw new Error("Inconsistent geometry layout");if(h&&this.srid_!==h)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=r,this.hasZ_=o,this.hasM_=a,this.layout_=u,this.srid_=h,this.initialized_=!0;return c}readWkbPayload(e){switch(e){case ue.POINT:return this.readPoint();case ue.LINE_STRING:return this.readLineString();case ue.POLYGON:case ue.TRIANGLE:return this.readPolygon();case ue.MULTI_POINT:return this.readMultiPoint();case ue.MULTI_LINE_STRING:return this.readMultiLineString();case ue.MULTI_POLYGON:case ue.POLYHEDRAL_SURFACE:case ue.TIN:return this.readMultiPolygon();case ue.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const r=this.readUint32(),n=[];for(let s=0;s<r;s++){const o=e.call(this,t);o&&n.push(o)}return n}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,ue.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,ue.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,ue.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case ue.POINT:return new ct(t,this.layout_);case ue.LINE_STRING:return new Et(t,this.layout_);case ue.POLYGON:case ue.TRIANGLE:return new Zi(t,this.layout_);case ue.MULTI_POINT:return new ns(t,this.layout_);case ue.MULTI_LINE_STRING:return new jr(t,this.layout_);case ue.MULTI_POLYGON:case ue.POLYHEDRAL_SURFACE:case ue.TIN:return new Hi(t,this.layout_);case ue.GEOMETRY_COLLECTION:return new Nr(t);default:return null}}getSrid(){return this.srid_}}class ng{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const r=Object.assign.apply(null,t.split("").map((n,s)=>({[n]:e[s]})));for(const n of this.layout_)this.writeDouble(n in r?r[n]:this.nodata_[n])}writeLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writePoint(e[r],t)}writePolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeLineString(e[r],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(1),this.writePoint(e[r],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(2),this.writeLineString(e[r],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(3),this.writePolygon(e[r],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const r=(n,s)=>n===s?n:n==="XYZM"?s:s==="XYZM"?n:"XY";if(e instanceof Eo)return r(e.getLayout(),t);if(e instanceof Nr){const n=e.getGeometriesArray();for(let s=0;s<n.length&&t!=="XY";s++)t=this.findMinimumLayout(n[s],t)}return t}writeGeometry(e,t){const r={Point:ue.POINT,LineString:ue.LINE_STRING,Polygon:ue.POLYGON,MultiPoint:ue.MULTI_POINT,MultiLineString:ue.MULTI_LINE_STRING,MultiPolygon:ue.MULTI_POLYGON,GeometryCollection:ue.GEOMETRY_COLLECTION},n=e.getType(),s=r[n];if(!s)throw new Error("GeometryType "+n+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof Eo?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[n].call(this,e.getCoordinates(),e.getLayout()):e instanceof Nr&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),r=new DataView(t);let n=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:r.setUint8(n,s[1]);break;case 4:r.setUint32(n,s[1],this.isLittleEndian_);break;case 8:r.setFloat64(n,s[1],this.isLittleEndian_);break}n+=s[0]}),t}}class sg extends au{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new et({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let r=[];const n=this.readGeometry(e,t);return this.splitCollection&&n instanceof Nr?r=n.getGeometriesArray():r=[n],r.map(s=>new et({geometry:s}))}readGeometry(e,t){const r=ta(e);if(!r)return null;const s=new ea(r).readGeometry();return this.viewCache_=r,t=this.getReadOptions(e,t),this.viewCache_=null,Oe(s,!1,t)}readProjection(e){const t=this.viewCache_||ta(e);if(!t)return;const r=new ea(t);return r.readWkbHeader(),r.getSrid()&&se("EPSG:"+r.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new Nr(e.map(r=>r.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const r=new ng({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let n=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&se(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(n=Number(a.substring(5)))}}r.writeGeometry(Oe(e,!0,t),n);const s=r.getBuffer();return this.hex_?og(s):s}}function og(i){const e=new Uint8Array(i);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function ag(i){const e=new Uint8Array(i.length/2);for(let t=0;t<i.length/2;t++)e[t]=parseInt(i.substr(t*2,2),16);return new DataView(e.buffer)}function ta(i){return typeof i=="string"?ag(i):ArrayBuffer.isView(i)?i instanceof DataView?i:new DataView(i.buffer,i.byteOffset,i.byteLength):i instanceof ArrayBuffer?new DataView(i):null}const Te=[null,"http://www.opengis.net/wms"];function Er(i){return lu(i[0].version,"1.3")>=0}const lg=F(Te,{Service:x(Cg),Capability:x(Ig)}),bl={Request:x(zg),Exception:x(Ng),Layer:x(Dg)},cg=F(Te,{...bl,UserDefinedSymbolization:x(Ag)}),ug=F(Te,bl);class hg extends Ls{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=C({version:this.version},lg,e,[]);return t||null}}const Tl={Name:x(I),Title:x(I),Abstract:x(I),KeywordList:x(Al),OnlineResource:x(_r),ContactInformation:x(Fg),Fees:x(I),AccessConstraints:x(I)},fg=F(Te,Tl),dg=F(Te,{...Tl,LayerLimit:x(ye),MaxWidth:x(ye),MaxHeight:x(ye)}),gg=F(Te,{ContactPersonPrimary:x(Og),ContactPosition:x(I),ContactAddress:x(Mg),ContactVoiceTelephone:x(I),ContactFacsimileTelephone:x(I),ContactElectronicMailAddress:x(I)}),pg=F(Te,{ContactPerson:x(I),ContactOrganization:x(I)}),mg=F(Te,{AddressType:x(I),Address:x(I),City:x(I),StateOrProvince:x(I),PostCode:x(I),Country:x(I)}),_g=F(Te,{Format:U(I)}),wl={Name:x(I),Title:x(I),Abstract:x(I),KeywordList:x(Al),BoundingBox:le(vl),Dimension:le(Ug),Attribution:x(Pg),AuthorityURL:le(Vg),Identifier:le(I),MetadataURL:le(jg),DataURL:le(bt),FeatureListURL:le(bt),Style:le(Xg),Layer:le(an)},Sl=F(Te,{...wl,SRS:le(I),Extent:x(Bg),ScaleHint:le(Gg),LatLonBoundingBox:x((i,e)=>vl(i,e,!1)),Layer:le(an)}),Rl=F(Te,{...wl,CRS:le(I),EX_GeographicBoundingBox:x(Lg),MinScaleDenominator:x(Fe),MaxScaleDenominator:x(Fe),Layer:le(an)}),yg=F(Te,{Title:x(I),OnlineResource:x(_r),LogoURL:x(Pl)}),Eg=F(Te,{westBoundLongitude:x(Fe),eastBoundLongitude:x(Fe),southBoundLatitude:x(Fe),northBoundLatitude:x(Fe)}),xg=F(Te,{GetCapabilities:x(_n),GetMap:x(_n),GetFeatureInfo:x(_n)}),bg=F(Te,{Format:le(I),DCPType:le(kg)}),Tg=F(Te,{HTTP:x($g)}),wg=F(Te,{Get:x(bt),Post:x(bt)}),Sg=F(Te,{Name:x(I),Title:x(I),Abstract:x(I),LegendURL:le(Pl),StyleSheetURL:x(bt),StyleURL:x(bt)}),Rg=F(Te,{Format:x(I),OnlineResource:x(_r)}),vg=F(Te,{Keyword:U(I)});function Pg(i,e){return C({},yg,i,e)}function Ag(i,e){return{SupportSLD:!!Ke(i.getAttribute("UserDefinedSymbolization")),UserLayer:!!Ke(i.getAttribute("UserLayer")),UserStyle:!!Ke(i.getAttribute("UserStyle")),RemoteWFS:!!Ke(i.getAttribute("RemoteWFS"))}}function vl(i,e,t=!0){const r=[lt(i.getAttribute("minx")),lt(i.getAttribute("miny")),lt(i.getAttribute("maxx")),lt(i.getAttribute("maxy"))],n=[lt(i.getAttribute("resx")),lt(i.getAttribute("resy"))],s={extent:r,res:n};return t&&(Er(e)?s.crs=i.getAttribute("CRS"):s.srs=i.getAttribute("SRS")),s}function Lg(i,e){const t=C({},Eg,i,e);if(!t)return;const r=t.westBoundLongitude,n=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(r===void 0||n===void 0||s===void 0||o===void 0))return[r,n,s,o]}function Ig(i,e){return C({},Er(e)?ug:cg,i,e)}function Cg(i,e){return C({},Er(e)?dg:fg,i,e)}function Fg(i,e){return C({},gg,i,e)}function Og(i,e){return C({},pg,i,e)}function Mg(i,e){return C({},mg,i,e)}function Ng(i,e){return C([],_g,i,e)}function Dg(i,e){const t=C({},Er(e)?Rl:Sl,i,e);return t.Layer===void 0?Object.assign(t,an(i,e)):t}function an(i,e){const t=Er(e),r=e[e.length-1],n=C({},t?Rl:Sl,i,e);if(!n)return;let s=Ke(i.getAttribute("queryable"));s===void 0&&(s=r.queryable),n.queryable=s!==void 0?s:!1;let o=Rt(i.getAttribute("cascaded"));o===void 0&&(o=r.cascaded),n.cascaded=o;let a=Ke(i.getAttribute("opaque"));a===void 0&&(a=r.opaque),n.opaque=a!==void 0?a:!1;let l=Ke(i.getAttribute("noSubsets"));l===void 0&&(l=r.noSubsets),n.noSubsets=l!==void 0?l:!1;let c=lt(i.getAttribute("fixedWidth"));c||(c=r.fixedWidth),n.fixedWidth=c;let u=lt(i.getAttribute("fixedHeight"));u||(u=r.fixedHeight),n.fixedHeight=u;const h=["Style","AuthorityURL"];t?h.push("CRS"):h.push("SRS","Dimension"),h.forEach(function(g){if(g in r){const d=n[g]||[];n[g]=d.concat(r[g])}});const f=["BoundingBox","Attribution"];return t?f.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):f.push("LatLonBoundingBox","ScaleHint","Extent"),f.forEach(function(g){if(!(g in n)){const d=r[g];n[g]=d}}),n}function Ug(i,e){const t={name:i.getAttribute("name"),units:i.getAttribute("units"),unitSymbol:i.getAttribute("unitSymbol")};return Er(e)&&Object.assign(t,{default:i.getAttribute("default"),multipleValues:Ke(i.getAttribute("multipleValues")),nearestValue:Ke(i.getAttribute("nearestValue")),current:Ke(i.getAttribute("current")),values:I(i)}),t}function Bg(i,e){return{name:i.getAttribute("name"),default:i.getAttribute("default"),nearestValue:Ke(i.getAttribute("nearestValue"))}}function Gg(i,e){return{min:lt(i.getAttribute("min")),max:lt(i.getAttribute("max"))}}function bt(i,e){return C({},Rg,i,e)}function zg(i,e){return C({},xg,i,e)}function kg(i,e){return C({},Tg,i,e)}function $g(i,e){return C({},wg,i,e)}function _n(i,e){return C({},bg,i,e)}function Pl(i,e){const t=bt(i,e);if(t){const r=[Rt(i.getAttribute("width")),Rt(i.getAttribute("height"))];return t.size=r,t}}function Vg(i,e){const t=bt(i,e);if(t)return t.name=i.getAttribute("name"),t}function jg(i,e){const t=bt(i,e);if(t)return t.type=i.getAttribute("type"),t}function Xg(i,e){return C({},Sg,i,e)}function Al(i,e){return C([],vg,i,e)}const Wg="_feature",Hg="_layer";class Zg extends qi{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new Y,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const r=e.localName;let n=[];if(e.childNodes.length===0)return n;if(r=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const l=a,c=t[0],u=Hg,h=l.localName.replace(u,"");if(this.layers_&&!this.layers_.includes(h))continue;const f=h+Wg;c.featureType=f,c.featureNS=this.featureNS_;const g={};g[f]=U(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const d=F([c.featureNS,null],g);l.setAttribute("namespaceURI",this.featureNS_);const p=C([],d,l,t,this.gmlFormat_);p&&Ti(n,p)}if(r=="FeatureCollection"){const s=C([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(n=s)}return n}readFeaturesFromNode(e,t){const r={};return t&&Object.assign(r,this.getReadOptions(e,t)),this.readFeatures_(e,[r])}}const ht=[null,"http://www.opengis.net/wmts/1.0"],xr=[null,"http://www.opengis.net/ows/1.1"],Yg=F(ht,{Contents:x(sp)});let Ns=class extends Ls{constructor(){super(),this.owsParser_=new ml}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let r=this.owsParser_.readFromNode(e);return r?(r.version=t,r=C(r,Yg,e,[]),r||null):null}};const qg=F(ht,{Layer:le(op),TileMatrixSet:le(ap)}),Kg=F(ht,{Style:le(lp),Format:le(I),TileMatrixSetLink:le(cp),Dimension:le(up),ResourceURL:le(hp)},F(xr,{Title:x(I),Abstract:x(I),WGS84BoundingBox:x(Il),BoundingBox:le(fp),Identifier:x(I)})),Jg=F(ht,{LegendURL:le(dp)},F(xr,{Title:x(I),Identifier:x(I)})),Qg=F(ht,{TileMatrixSet:x(I),TileMatrixSetLimits:x(pp)}),ep=F(ht,{TileMatrixLimits:U(mp)}),tp=F(ht,{TileMatrix:x(I),MinTileRow:x(ye),MaxTileRow:x(ye),MinTileCol:x(ye),MaxTileCol:x(ye)}),rp=F(ht,{Default:x(I),Value:le(I)},F(xr,{Identifier:x(I)})),Ll=F(xr,{LowerCorner:U($n),UpperCorner:U($n)}),ip=F(ht,{WellKnownScaleSet:x(I),TileMatrix:le(gp)},F(xr,{SupportedCRS:x(I),Identifier:x(I),BoundingBox:x(Il)})),np=F(ht,{TopLeftCorner:x($n),ScaleDenominator:x(Fe),TileWidth:x(ye),TileHeight:x(ye),MatrixWidth:x(ye),MatrixHeight:x(ye)},F(xr,{Identifier:x(I)}));function sp(i,e){return C({},qg,i,e)}function op(i,e){return C({},Kg,i,e)}function ap(i,e){return C({},ip,i,e)}function lp(i,e){const t=C({},Jg,i,e);if(!t)return;const r=i.getAttribute("isDefault")==="true";return t.isDefault=r,t}function cp(i,e){return C({},Qg,i,e)}function up(i,e){return C({},rp,i,e)}function hp(i,e){const t=i.getAttribute("format"),r=i.getAttribute("template"),n=i.getAttribute("resourceType"),s={};return t&&(s.format=t),r&&(s.template=r),n&&(s.resourceType=n),s}function Il(i,e){const t=C([],Ll,i,e);if(t.length==2)return us(t)}function fp(i,e){const t=i.getAttribute("crs"),r=C([],Ll,i,e);if(r.length==2)return{extent:us(r),crs:t}}function dp(i,e){const t={};return t.format=i.getAttribute("format"),t.href=_r(i),t}function $n(i,e){const t=I(i).split(/\s+/);if(!t||t.length!=2)return;const r=+t[0],n=+t[1];if(!(isNaN(r)||isNaN(n)))return[r,n]}function gp(i,e){return C({},np,i,e)}function pp(i,e){return C([],ep,i,e)}function mp(i,e){return C({},tp,i,e)}window.eoxMapAdvancedOlFormats={EsriJSON:kh,GML:Ss,GPX:pf,IGC:Kf,IIIFInfo:id,KML:Gu,OWS:ml,Polyline:Od,TopoJSON:Bu,WFS:Jd,WKB:sg,WKT:Ah,WMSCapabilities:hg,WMSGetFeatureInfo:Zg,WMTSCapabilities:Ns};function Cl(i,e,t){const r=[];let n=i(0),s=i(1),o=e(n),a=e(s);const l=[s,n],c=[a,o],u=[1,0],h={};let f=1e5,g,d,p,m,y,_;for(;--f>0&&u.length>0;)p=u.pop(),n=l.pop(),o=c.pop(),_=p.toString(),_ in h||(r.push(o[0],o[1]),h[_]=!0),m=u.pop(),s=l.pop(),a=c.pop(),y=(p+m)/2,g=i(y),d=e(g),xu(d[0],d[1],o[0],o[1],a[0],a[1])<t?(r.push(a[0],a[1]),_=m.toString(),h[_]=!0):(u.push(m,y,y,p),c.push(a,d,d,o),l.push(s,g,g,n));return r}function _p(i,e,t,r,n){const s=se("EPSG:4326");return Cl(function(o){return[i,e+(t-e)*o]},xi(s,r),n)}function yp(i,e,t,r,n){const s=se("EPSG:4326");return Cl(function(o){return[e+(t-e)*o,i]},xi(s,r),n)}function Ep(i){if(!(i.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=i.inversePixelTransform[0],t=i.inversePixelTransform[1],r=Math.sqrt(e*e+t*t),n=i.frameState,s=Dr(i.inversePixelTransform.slice(),n.coordinateToPixelTransform),o=zu(n.viewState.resolution,r);let a;return new ku(i.context,r,n.extent,s,n.viewState.rotation,o,a)}const xp=new Ai({color:"rgba(0,0,0,0.2)"}),bp=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class Tp extends Ka{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:xp,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?xo.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?xo.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new _i({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new Po({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new Li({color:"rgba(0,0,0,1)"}),stroke:new Ai({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=r=>{const n=r.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(n),this.lonLabelStyleBase_},this.latLabelStyleBase_=new _i({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new Po({font:"12px Calibri,sans-serif",textAlign:"right",fill:new Li({color:"rgba(0,0,0,1)"}),stroke:new Ai({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=r=>{const n=r.get("graticule_label");return this.latLabelStyleBase_.getText().setText(n),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(Bt.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:bp,this.setSource(new Ji({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new Lh,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new _i({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let r=e.slice();return this.projection_&&this.getSource().getWrapX()&&bu(r,this.projection_),this.loadedExtent_&&(Tu(this.loadedExtent_,r,t)?r=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[r]}loaderFunction(e,t,r){this.loadedExtent_=e;const n=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=ut(s,e);if(this.renderedExtent_&&Gr(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,Yi(o)))return;const a=Pt(o),l=t*t/4;(!this.projection_||!mi(this.projection_,r))&&this.updateProjectionInfo_(r),this.createGraticule_(o,a,t,l);let u=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(u+=this.meridians_.length),this.parallelsLabels_&&(u+=this.parallels_.length);let h;for(;u>this.featurePool_.length;)h=new et,this.featurePool_.push(h);const f=n.getFeaturesCollection();f.clear();let g=0,d,p;for(d=0,p=this.meridians_.length;d<p;++d)h=this.featurePool_[g++],h.setGeometry(this.meridians_[d]),h.setStyle(this.lineStyle_),f.push(h);for(d=0,p=this.parallels_.length;d<p;++d)h=this.featurePool_[g++],h.setGeometry(this.parallels_[d]),h.setStyle(this.lineStyle_),f.push(h)}addMeridian_(e,t,r,n,s,o){const a=this.getMeridian_(e,t,r,n,o);if(or(a.getExtent(),s)){if(this.meridiansLabels_){const l=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=l:this.meridiansLabels_[o]={geom:new ct([]),text:l}}this.meridians_[o++]=a}return o}addParallel_(e,t,r,n,s,o){const a=this.getParallel_(e,t,r,n,o);if(or(a.getExtent(),s)){if(this.parallelsLabels_){const l=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=l:this.parallelsLabels_[o]={geom:new ct([]),text:l}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,r=e.frameState.viewState.resolution,n=e.frameState.size,s=e.frameState.extent,o=Pt(s);let a=s;if(t){const d=n[0]*r,p=n[1]*r;a=[o[0]-d/2,o[1]-p/2,o[0]+d/2,o[1]+p/2]}let l=0,c=0,u=this.latLabelPosition_<.5;const h=this.projection_.getExtent(),f=Ae(h);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!bi(h,s)){l=Math.floor((s[0]-h[0])/f),c=Math.ceil((s[2]-h[2])/f);const d=Math.abs(t)>Math.PI/2;u=u!==d}const g=Ep(e);for(let d=l;d<=c;++d){let p=this.meridians_.length+this.parallels_.length,m,y,_,E;if(this.meridiansLabels_)for(y=0,_=this.meridiansLabels_.length;y<_;++y){const w=this.meridians_[y];if(!t&&d===0)E=this.getMeridianPoint_(w,s,y);else{const S=w.clone();S.translate(d*f,0),S.rotate(-t,o),E=this.getMeridianPoint_(S,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.meridiansLabels_[y].text),g.drawFeature(m,this.lonLabelStyle_(m))}if(this.parallelsLabels_&&(d===l&&u||d===c&&!u))for(y=0,_=this.parallels_.length;y<_;++y){const w=this.parallels_[y];if(!t&&d===0)E=this.getParallelPoint_(w,s,y);else{const S=w.clone();S.translate(d*f,0),S.rotate(-t,o),E=this.getParallelPoint_(S,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.parallelsLabels_[y].text),g.drawFeature(m,this.latLabelStyle_(m))}}}createGraticule_(e,t,r,n){const s=this.getInterval_(r);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),l=Ae(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!bi(a,e)&&(Ae(e)>=l?(e[0]=a[0],e[2]=a[2]):o=!0);const c=[me(t[0],this.minX_,this.maxX_),me(t[1],this.minY_,this.maxY_)],u=this.toLonLatTransform_(c);isNaN(u[1])&&(u[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let h=me(u[0],this.minLon_,this.maxLon_),f=me(u[1],this.minLat_,this.maxLat_);const g=this.maxLines_;let d,p,m,y,_=e;o||(_=[me(e[0],this.minX_,this.maxX_),me(e[1],this.minY_,this.maxY_),me(e[2],this.minX_,this.maxX_),me(e[3],this.minY_,this.maxY_)]);const E=ar(_,this.toLonLatTransform_,void 0,8);let w=E[3],S=E[2],T=E[1],v=E[0];if(o||(rr(_,this.bottomLeft_)&&(v=this.minLon_,T=this.minLat_),rr(_,this.bottomRight_)&&(S=this.maxLon_,T=this.minLat_),rr(_,this.topLeft_)&&(v=this.minLon_,w=this.maxLat_),rr(_,this.topRight_)&&(S=this.maxLon_,w=this.maxLat_),w=me(w,f,this.maxLat_),S=me(S,h,this.maxLon_),T=me(T,this.minLat_,f),v=me(v,this.minLon_,h)),h=Math.floor(h/s)*s,y=me(h,this.minLon_,this.maxLon_),p=this.addMeridian_(y,T,w,n,e,0),d=0,o)for(;(y-=s)>=v&&d++<g;)p=this.addMeridian_(y,T,w,n,e,p);else for(;y!=this.minLon_&&d++<g;)y=Math.max(y-s,this.minLon_),p=this.addMeridian_(y,T,w,n,e,p);if(y=me(h,this.minLon_,this.maxLon_),d=0,o)for(;(y+=s)<=S&&d++<g;)p=this.addMeridian_(y,T,w,n,e,p);else for(;y!=this.maxLon_&&d++<g;)y=Math.min(y+s,this.maxLon_),p=this.addMeridian_(y,T,w,n,e,p);for(this.meridians_.length=p,this.meridiansLabels_&&(this.meridiansLabels_.length=p),f=Math.floor(f/s)*s,m=me(f,this.minLat_,this.maxLat_),p=this.addParallel_(m,v,S,n,e,0),d=0;m!=this.minLat_&&d++<g;)m=Math.max(m-s,this.minLat_),p=this.addParallel_(m,v,S,n,e,p);for(m=me(f,this.minLat_,this.maxLat_),d=0;m!=this.maxLat_&&d++<g;)m=Math.min(m+s,this.maxLat_),p=this.addParallel_(m,v,S,n,e,p);this.parallels_.length=p,this.parallelsLabels_&&(this.parallelsLabels_.length=p)}getInterval_(e){const t=this.projectionCenterLonLat_[0],r=this.projectionCenterLonLat_[1];let n=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let l=0,c=this.intervals_.length;l<c;++l){const u=me(this.intervals_[l]/2,0,90),h=me(r,-90+u,90-u);if(o[0]=t-u,o[1]=h-u,a[0]=t+u,a[1]=h+u,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;n=this.intervals_[l]}return n}getMeridian_(e,t,r,n,s){const o=_p(e,t,r,this.projection_,n);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new Et(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,r){const n=e.getFlatCoordinates();let s=1,o=n.length-1;n[s]>n[o]&&(s=o,o=1);const a=Math.max(t[1],n[s]),l=Math.min(t[3],n[o]),c=me(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,l),h=[n[s-1]+(n[o-1]-n[s-1])*(c-n[s])/(n[o]-n[s]),c],f=this.meridiansLabels_[r].geom;return f.setCoordinates(h),f}getMeridians(){return this.meridians_}getParallel_(e,t,r,n,s){const o=yp(e,t,r,this.projection_,n);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new Et(o,"XY"),a}getParallelPoint_(e,t,r){const n=e.getFlatCoordinates();let s=0,o=n.length-2;n[s]>n[o]&&(s=o,o=0);const a=Math.max(t[0],n[s]),l=Math.min(t[2],n[o]),c=me(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,l),u=n[s+1]+(n[o+1]-n[s+1])*(c-n[s])/(n[o]-n[s]),h=[c,u],f=this.parallelsLabels_[r].geom;return f.setCoordinates(h),f}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=se("EPSG:4326"),r=e.getWorldExtent();this.maxLat_=r[3],this.maxLon_=r[2],this.minLat_=r[1],this.minLon_=r[0];const n=xi(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=n;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,l,c){c=c||2;const u=n(a,l,c);for(let h=0,f=u.length;h<f;h+=c)u[h]<o&&(u[h]+=360);return u}}this.fromLonLatTransform_=xi(t,e);const s=ar([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(Pt(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}function jt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Mi(i,e){return i[0]=e[0],i[1]=e[1],i[4]=e[2],i[5]=e[3],i[12]=e[4],i[13]=e[5],i}function Vn(i,e,t,r,n,s,o){o=o??jt();const a=1/(i-e),l=1/(t-r),c=1/(n-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*c,o[11]=0,o[12]=(i+e)*a,o[13]=(r+t)*l,o[14]=(s+n)*c,o[15]=1,o}function ra(i,e,t,r,n){return n=n??jt(),n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e,n[4]=i[4]*t,n[5]=i[5]*t,n[6]=i[6]*t,n[7]=i[7]*t,n[8]=i[8]*r,n[9]=i[9]*r,n[10]=i[10]*r,n[11]=i[11]*r,n[12]=i[12],n[13]=i[13],n[14]=i[14],n[15]=i[15],n}function wp(i,e,t,r,n){n=n??jt();let s,o,a,l,c,u,h,f,g,d,p,m;return i===n?(n[12]=i[0]*e+i[4]*t+i[8]*r+i[12],n[13]=i[1]*e+i[5]*t+i[9]*r+i[13],n[14]=i[2]*e+i[6]*t+i[10]*r+i[14],n[15]=i[3]*e+i[7]*t+i[11]*r+i[15]):(s=i[0],o=i[1],a=i[2],l=i[3],c=i[4],u=i[5],h=i[6],f=i[7],g=i[8],d=i[9],p=i[10],m=i[11],n[0]=s,n[1]=o,n[2]=a,n[3]=l,n[4]=c,n[5]=u,n[6]=h,n[7]=f,n[8]=g,n[9]=d,n[10]=p,n[11]=m,n[12]=s*e+c*t+g*r+i[12],n[13]=o*e+u*t+d*r+i[13],n[14]=a*e+h*t+p*r+i[14],n[15]=l*e+f*t+m*r+i[15]),n}function Sp(i,e,t,r){return r=r??jt(),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=i,r[13]=e,r[14]=t,r[15]=1,r}const Kr=34962,Jr=34963,Ds=35044,Ni=35048,Rp=5121,vp=5123,Pp=5125,Fl=5126,ia=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function Ap(i,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!$u},e);const t=ia.length;for(let r=0;r<t;++r)try{const n=i.getContext(ia[r],e);if(n)return n}catch{}return null}const Lp={STATIC_DRAW:Ds};class lr{constructor(e,t){this.array_=null,this.type_=e,Ze(e===Kr||e===Jr,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:Lp.STATIC_DRAW}ofSize(e){return this.array_=new(hi(this.type_))(e),this}fromArray(e){return this.array_=hi(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(hi(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=hi(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function hi(i){switch(i){case Kr:return Float32Array;case Jr:return Uint32Array;default:return Float32Array}}const fi={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},Ip=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,Cp=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class na{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||Ip),t.compileShader(r);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||Cp),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const n=0,s=t.RGBA,o=0,a=t.RGBA,l=t.UNSIGNED_BYTE,c=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,n,s,r[0],r[1],o,a,l,c),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const l=ae(s.canvas);if(!e.renderTargets[l]){const c=s.getContextAttributes();c&&c.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[l]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,n=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,n++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const at={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},xe={UNSIGNED_BYTE:Rp,UNSIGNED_SHORT:vp,UNSIGNED_INT:Pp,FLOAT:Fl},Di={};function sa(i){return"shared/"+i}let oa=0;function Fp(){const i="unique/"+oa;return oa+=1,i}function Op(i){let e=Di[i];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:Ap(t)},Di[i]=e}return e.users+=1,e.context}function Mp(i){const e=Di[i];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const n=t.canvas;n.width=1,n.height=1,delete Di[i]}class Np extends Wa{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?sa(e.canvasCacheKey):Fp(),this.gl_=Op(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(fi.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(fi.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=Pe(),this.offsetScaleMatrix_=Pe(),this.tmpMat4_=jt(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new na({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new na({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===sa(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=ae(e);let n=this.bufferCache_[r];if(!n){const s=t.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[r]=n}t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=ae(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(fi.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(fi.RESTORED,this.boundHandleWebGLContextRestored_),Mp(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const n=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let l=this.postProcessPasses_.length-1;l>=0;l--)this.postProcessPasses_[l].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,t?n.ZERO:n.ONE_MINUS_SRC_ALPHA),r?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const n=this.gl_;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const n=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);n.enableVertexAttribArray(s),n.vertexAttribPointer(s,r,n.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,n){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,r?s.ZERO:s.ONE_MINUS_SRC_ALPHA),n?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const n=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,n,a)}finalizeDraw(e,t,r){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,t,r):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue(at.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(at.ZOOM,e.viewState.zoom),this.setUniformFloatValue(at.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(at.PIXEL_RATIO,n),this.setUniformFloatVec2(at.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(at.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(at.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(at.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,n=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=r):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,n,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&o&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),n++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,Mi(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,n=r.createShader(t);return r.shaderSource(n,e),r.compileShader(n),n}getProgram(e,t){const r=this.gl_,n=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,n),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(n,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(n)}`;throw new Error(a)}if(r.deleteShader(n),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=ae(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=ae(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return os(t,0,0,2/(s*r[0]),2/(s*r[1]),-n,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,n,s){const o=this.getAttributeLocation(e);o<0||(this.gl_.enableVertexAttribArray(o),this.gl_.vertexAttribPointer(o,t,r,!1,n,s))}enableAttributes(e){const t=Dp(e);let r=0;for(let n=0;n<e.length;n++){const s=e[n];this.enableAttributeArray_(s.name,s.size,s.type||Fl,t,r),r+=s.size*Ol(s.type)}}handleWebGLContextLost(e){wu(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,n){const s=this.gl_;r=r||s.createTexture();const o=n?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,l=s.RGBA,c=0,u=s.RGBA,h=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,u,h,t):t?s.texImage2D(s.TEXTURE_2D,a,l,u,h,t):s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,u,h,null),r}}function Dp(i){let e=0;for(let t=0;t<i.length;t++){const r=i[t];e+=r.size*Ol(r.type)}return e}function Ol(i){switch(i){case xe.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case xe.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case xe.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case xe.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class Up extends Su{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(De.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===Z.LOADED,this.loaded)this.uploadTile();else{if(e instanceof ds){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(De.CHANGE,this.handleTileChange_)}}uploadTile(){cs()}setReady(){this.ready=!0,this.dispatchEvent(De.CHANGE)}handleTileChange_(){this.tile.getState()===Z.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(De.CHANGE,this.handleTileChange_)}}function Ml(i,e,t){const r=t?i.LINEAR:i.NEAREST;i.bindTexture(i.TEXTURE_2D,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r)}function Bp(i,e,t,r){Ml(i,e,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t)}function aa(i,e,t,r,n,s){const o=i.getGL();let a,l;t instanceof Float32Array?(a=o.FLOAT,i.getExtension("OES_texture_float"),l=i.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,l=!0),Ml(o,e,s&&l);const c=t.byteLength/r[1];let u=1;c%8===0?u=8:c%4===0?u=4:c%2===0&&(u=2);let h;switch(n){case 1:{h=o.LUMINANCE;break}case 2:{h=o.LUMINANCE_ALPHA;break}case 3:{h=o.RGB;break}case 4:{h=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,u),o.texImage2D(o.TEXTURE_2D,0,h,r[0],r[1],0,h,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let er=null;function Gp(){er=It(1,1,void 0,{willReadFrequently:!0})}class zp extends Up{constructor(e){super(e),this.textures=[],this.renderSize_=Qe(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new lr(Kr,Ds);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var r;const t=(r=this.helper)==null?void 0:r.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let n=0;n<this.textures.length;++n)t.deleteTexture(this.textures[n])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let n;r instanceof ds||r instanceof Vu?n=r.getImage():n=r.getData();const s=Dn(n);if(s){const _=t.createTexture();this.textures.push(_),this.bandCount=4,Bp(t,_,s,r.interpolate),this.setReady();return}n=Nn(n);const o=r.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],l=n instanceof Float32Array,c=a[0]*a[1],u=l?Float32Array:Uint8Array,h=u.BYTES_PER_ELEMENT,f=n.byteLength/a[1];this.bandCount=Math.floor(f/h/a[0]);const g=Math.ceil(this.bandCount/4);if(g===1){const _=t.createTexture();this.textures.push(_),aa(e,_,n,a,this.bandCount,r.interpolate),this.setReady();return}const d=new Array(g);for(let _=0;_<g;++_){const E=t.createTexture();this.textures.push(E);const w=_<g-1?4:(this.bandCount-1)%4+1;d[_]=new u(c*w)}let p=0,m=0;const y=a[0]*this.bandCount;for(let _=0;_<a[1];++_){for(let E=0;E<y;++E){const w=n[m+E],S=Math.floor(p/this.bandCount),T=E%this.bandCount,v=Math.floor(T/4),A=d[v],L=A.length/c,R=T%4;A[S*L+R]=w,++p}m+=f/h}for(let _=0;_<g;++_){const E=this.textures[_],w=d[_],S=w.length/c;aa(e,E,w,a,S,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const n=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];er||Gp(),er.clearRect(0,0,1,1);const a=e.width,l=e.height,c=a-2*n,u=l-2*n,h=n+Math.floor(c*(t/s)),f=n+Math.floor(u*(r/o));let g;try{er.drawImage(e,h,f,1,1,0,0,1,1),g=er.getImageData(0,0,1,1).data}catch{return er=null,null}return g}getArrayPixelData_(e,t,r,n){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],l=t[0],c=t[1],u=l+2*s,h=c+2*s,f=s+Math.floor(l*(r/o)),g=s+Math.floor(c*(n/a));if(e instanceof DataView){const p=e.byteLength/(u*h),m=p*(g*u+f),y=e.buffer.slice(m,m+p);return new DataView(y)}const d=this.bandCount*(g*u+f);return e.slice(d,d+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof gs){const r=this.tile.getData(),n=Nn(r);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,t)}return this.getImagePixelData_(Dn(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class Qr extends ju{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=Pe(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(zn.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(Bt.PRECOMPOSE)){const n=new pn(Bt.PRECOMPOSE,void 0,t,e);r.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(Bt.POSTCOMPOSE)){const n=new pn(Bt.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const l=e.layerStatesArray[o].layer,c=l.getRenderer();if(!(c instanceof Qr)){t=!0;continue}const u=l.getClassName();if((t||u!==n)&&(r+=1,t=!1),n=u,c===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Np({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(zn.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const n=this.getLayer();if(n.hasListener(e)){os(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new pn(e,this.inversePixelTransform_,r,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(Bt.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(Bt.POSTRENDER,e,t)}}const kp={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function la(i){return 1/(i+2)}function $p(){return{tileIds:new Set,representationsByZ:{}}}function ca(i,e){return i.tileIds.has(ae(e))}function ua(i,e,t){const r=i.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),i.tileIds.add(ae(e.tile))}function yn(i,e){const t=i.layerStatesArray[i.layerIndex];t.extent&&(e=ut(e,$a(t.extent,i.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const n=r.getTileGridForProjection(i.viewState.projection).getExtent();n&&(e=ut(e,n))}return e}function jn(i,e){return`${i.getKey()},${i.getRevision()},${Qt(e)}`}class Vp extends Qr{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=Pe(),this.tempMat4=jt(),this.tempTileRange_=new Xu(0,0,0,0),this.tempTileCoord_=Un(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new Ja(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||Yi(yn(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return cs()}enqueueTiles(e,t,r,n,s){const o=e.viewState,a=this.getLayer(),l=a.getRenderSource(),c=l.getTileGridForProjection(o.projection),u=l.getGutterForProjection(o.projection),h=ae(l);h in e.wantedTiles||(e.wantedTiles[h]={});const f=e.wantedTiles[h],g=this.tileRepresentationCache,d=a.getMapInternal(),p=Math.max(r-s,c.getMinZoom(),c.getZForResolution(Math.min(a.getMaxResolution(),d?d.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):c.getResolution(0)),l.zDirection)),m=o.rotation,y=m?Ru(o.center,o.resolution,m,e.size):void 0;for(let _=r;_>=p;--_){const E=c.getTileRangeForExtentAndZ(t,_,this.tempTileRange_),w=c.getResolution(_);for(let S=E.minX;S<=E.maxX;++S)for(let T=E.minY;T<=E.maxY;++T){if(m&&!c.tileCoordIntersectsViewport([_,S,T],y))continue;const v=Un(_,S,T,this.tempTileCoord_),A=jn(l,v);let L,R;if(g.containsKey(A)&&(L=g.get(A),R=L.tile),(!L||L.tile.key!==l.getKey())&&(R=l.getTile(_,S,T,e.pixelRatio,o.projection),!R)||ca(n,R))continue;L?L.setTile(R):(L=this.createTileRepresentation({tile:R,grid:c,helper:this.helper,gutter:u}),g.set(A,L)),ua(n,L,_);const N=R.getKey();f[N]=!0,R.getState()===Z.IDLE&&(e.tileQueue.isKeyQueued(N)||e.tileQueue.enqueue([R,h,c.getTileCoordCenter(v),w]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,n,s,o,a,l,c,u,h){}renderTileMask(e,t,r,n){}drawTile_(e,t,r,n,s,o,a){if(!t.ready)return;const c=t.tile.tileCoord,u=Qt(c),h=u in o?o[u]:1,f=a.getResolution(r),g=Qe(a.getTileSize(r),this.tempSize_),d=a.getOrigin(r),p=a.getTileCoordExtent(c),m=h<1?-1:la(r);h<1&&(e.animate=!0);const y=e.viewState,_=y.center[0],E=y.center[1],w=g[0]+2*n,S=g[1]+2*n,T=w/S,v=(_-d[0])/(g[0]*f),A=(d[1]-E)/(g[1]*f),L=y.resolution/f,R=c[1],N=c[2];cu(this.tileTransform_),bo(this.tileTransform_,2/(e.size[0]*L/w),-2/(e.size[1]*L/w)),uu(this.tileTransform_,y.rotation),bo(this.tileTransform_,1,1/T),as(this.tileTransform_,(g[0]*(R-v)-n)/w,(g[1]*(N-A)-n)/S),this.renderTile(t,this.tileTransform_,e,s,f,g,d,p,m,n,h)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),l=yn(e,e.extent),c=o.getZForResolution(r.resolution,s.zDirection),u=$p(),h=n.getPreload();if(e.nextExtent){const E=o.getZForResolution(r.nextResolution,s.zDirection),w=yn(e,e.nextExtent);this.enqueueTiles(e,w,E,u,h)}this.enqueueTiles(e,l,c,u,0),h>0&&setTimeout(()=>{this.enqueueTiles(e,l,c-1,u,h-1)},0);const f={};let g=!1;const d=u.representationsByZ;if(c in d){const E=ae(this),w=e.time;for(const S of d[c]){const T=S.tile;if(T.getState()===Z.EMPTY)continue;const v=T.tileCoord;if(S.ready){const R=T.getAlpha(E,w);if(R===1){T.endTransition(E);continue}g=!0;const N=Qt(v);f[N]=R}if(this.renderComplete=!1,this.findAltTiles_(o,v,c+1,u))continue;const L=o.getMinZoom();for(let R=c-1;R>=L&&!this.findAltTiles_(o,v,R,u);--R);}}const p=Object.keys(d).map(Number).sort(vu);if(this.beforeTilesMaskRender(e))for(let E=0,w=p.length;E<w;++E){const S=p[E];for(const T of d[S]){const v=T.tile.tileCoord;if(Qt(v)in f)continue;const L=o.getTileCoordExtent(v);this.renderTileMask(T,S,L,la(S))}}this.beforeTilesRender(e,g);for(let E=0,w=p.length;E<w;++E){const S=p[E];for(const T of d[S]){const v=T.tile.tileCoord;Qt(v)in f||this.drawTile_(e,T,S,a,l,f,o)}}if(c in d)for(const E of d[c]){const w=E.tile.tileCoord;Qt(w)in f&&this.drawTile_(e,E,c,a,l,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const y=this.helper.getCanvas(),_=this.tileRepresentationCache;for(;_.canExpireCache();)_.pop().dispose();return this.postRender(t,e),y}beforeFinalize(e){}findAltTiles_(e,t,r,n){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,l=this.getLayer().getRenderSource();for(let c=s.minX;c<=s.maxX;++c)for(let u=s.minY;u<=s.maxY;++u){const h=jn(l,[r,c,u]);let f=!1;if(a.containsKey(h)){const g=a.get(h);g.ready&&!ca(n,g.tile)&&(ua(n,g,r),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const V={...kp,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},yi={TEXTURE_COORD:"a_textureCoord"},jp=[{name:yi.TEXTURE_COORD,size:2,type:xe.FLOAT}];class Xp extends Vp{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new lr(Jr,Ds),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new zp(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,n,s,o,a,l,c,u,h){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(jp);let g=0;for(;g<e.textures.length;){const T=`${V.TILE_TEXTURE_ARRAY}[${g}]`;this.helper.bindTexture(e.textures[g],g,T),++g}for(let T=0;T<this.paletteTextures_.length;++T){const v=this.paletteTextures_[T],A=v.getTexture(f);this.helper.bindTexture(A,g,v.name),++g}const d=r.viewState,p=o[0]+2*u,m=o[1]+2*u,_=e.tile.tileCoord,E=_[1],w=_[2];this.helper.setUniformMatrixValue(V.TILE_TRANSFORM,Mi(this.tempMat4,t)),this.helper.setUniformFloatValue(V.TRANSITION_ALPHA,h),this.helper.setUniformFloatValue(V.DEPTH,c);let S=n;u>0&&(S=l,ut(S,n,S)),this.helper.setUniformFloatVec4(V.RENDER_EXTENT,S),this.helper.setUniformFloatValue(V.RESOLUTION,d.resolution),this.helper.setUniformFloatValue(V.ZOOM,d.zoom),this.helper.setUniformFloatValue(V.TEXTURE_PIXEL_WIDTH,p),this.helper.setUniformFloatValue(V.TEXTURE_PIXEL_HEIGHT,m),this.helper.setUniformFloatValue(V.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(V.TEXTURE_ORIGIN_X,a[0]+E*o[0]*s-u*s),this.helper.setUniformFloatValue(V.TEXTURE_ORIGIN_Y,a[1]-w*o[1]*s+u*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const n=this.getLayer(),s=xt(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=n.getExtent();if(a&&!rr($a(a,o.projection),s))return null;const l=n.getSources(us([s]),o.resolution);let c,u,h;for(c=l.length-1;c>=0;--c)if(u=l[c],u.getState()==="ready"){if(h=u.getTileGridForProjection(o.projection),u.getWrapX())break;const g=h.getExtent();if(!g||rr(g,s))break}if(c<0)return null;const f=this.tileRepresentationCache;for(let g=h.getZForResolution(o.resolution);g>=h.getMinZoom();--g){const d=h.getTileCoordForCoordAndZ(s,g),p=jn(u,d);if(!f.containsKey(p))continue;const m=f.get(p);if(m.tile.getState()===Z.EMPTY)return null;if(!m.loaded)continue;const _=h.getOrigin(g),E=Qe(h.getTileSize(g)),w=h.getResolution(g),S=(s[0]-_[0])/w-d[1]*E[0],T=(_[1]-s[1])/w-d[2]*E[1];return m.getPixelData(S,T)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class Wp{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function Hp(i,e){return`operator_${i}_${Object.keys(e.functions).length}`}function Lt(i){const e=i.toString();return e.includes(".")?e:e+".0"}function Us(i){if(i.length<2||i.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${i.length}(${i.map(Lt).join(", ")})`}function Ei(i){const e=Wr(i),t=e.length>3?e[3]:1;return Us([e[0]/255,e[1]/255,e[2]/255,t])}function Zp(i){const e=Qe(i);return Us(e)}const En={};let Yp=0;function cr(i){return i in En||(En[i]=Yp++),En[i]}function pt(i){return Lt(cr(i))}function ln(i){return"u_var_"+i}function Bs(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const xn="getBandValue",Nl="u_paletteTextures",Dl="featureId",Ul="geometryType",Xn=-9999999;function qp(i,e,t,r){const n=Wu(i,e,t);return Gs(n,e,r)}function ne(i){return(e,t,r)=>{const n=t.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=Gs(t.args[o],r,e);return i(s,e)}}const Kp={[X.Get]:(i,e)=>{const r=e.args[0].value;return r in i.properties||(i.properties[r]={name:r,type:e.type}),"a_prop_"+r},[X.Id]:i=>(i.featureId=!0,"a_"+Dl),[X.GeometryType]:i=>(i.geometryType=!0,"a_"+Ul),[X.LineMetric]:()=>"currentLineMetric",[X.Var]:(i,e)=>{const r=e.args[0].value;return r in i.variables||(i.variables[r]={name:r,type:e.type}),ln(r)},[X.Has]:(i,e)=>{const r=e.args[0].value;return r in i.properties||(i.properties[r]={name:r,type:e.type}),`(a_prop_${r} != ${Lt(Xn)})`},[X.Resolution]:()=>"u_resolution",[X.Zoom]:()=>"u_zoom",[X.Time]:()=>"u_time",[X.Any]:ne(i=>`(${i.join(" || ")})`),[X.All]:ne(i=>`(${i.join(" && ")})`),[X.Not]:ne(([i])=>`(!${i})`),[X.Equal]:ne(([i,e])=>`(${i} == ${e})`),[X.NotEqual]:ne(([i,e])=>`(${i} != ${e})`),[X.GreaterThan]:ne(([i,e])=>`(${i} > ${e})`),[X.GreaterThanOrEqualTo]:ne(([i,e])=>`(${i} >= ${e})`),[X.LessThan]:ne(([i,e])=>`(${i} < ${e})`),[X.LessThanOrEqualTo]:ne(([i,e])=>`(${i} <= ${e})`),[X.Multiply]:ne(i=>`(${i.join(" * ")})`),[X.Divide]:ne(([i,e])=>`(${i} / ${e})`),[X.Add]:ne(i=>`(${i.join(" + ")})`),[X.Subtract]:ne(([i,e])=>`(${i} - ${e})`),[X.Clamp]:ne(([i,e,t])=>`clamp(${i}, ${e}, ${t})`),[X.Mod]:ne(([i,e])=>`mod(${i}, ${e})`),[X.Pow]:ne(([i,e])=>`pow(${i}, ${e})`),[X.Abs]:ne(([i])=>`abs(${i})`),[X.Floor]:ne(([i])=>`floor(${i})`),[X.Ceil]:ne(([i])=>`ceil(${i})`),[X.Round]:ne(([i])=>`floor(${i} + 0.5)`),[X.Sin]:ne(([i])=>`sin(${i})`),[X.Cos]:ne(([i])=>`cos(${i})`),[X.Atan]:ne(([i,e])=>e!==void 0?`atan(${i}, ${e})`:`atan(${i})`),[X.Sqrt]:ne(([i])=>`sqrt(${i})`),[X.Match]:ne(i=>{const e=i[0],t=i[i.length-1];let r=null;for(let n=i.length-3;n>=1;n-=2){const s=i[n],o=i[n+1];r=`(${e} == ${s} ? ${o} : ${r||t})`}return r}),[X.Between]:ne(([i,e,t])=>`(${i} >= ${e} && ${i} <= ${t})`),[X.Interpolate]:ne(([i,e,...t])=>{let r="";for(let n=0;n<t.length-2;n+=2){const s=t[n],o=r||t[n+1],a=t[n+2],l=t[n+3];let c;i===Lt(1)?c=`(${e} - ${s}) / (${a} - ${s})`:c=`(pow(${i}, (${e} - ${s})) - 1.0) / (pow(${i}, (${a} - ${s})) - 1.0)`,r=`mix(${o}, ${l}, clamp(${c}, 0.0, 1.0))`}return r}),[X.Case]:ne(i=>{const e=i[i.length-1];let t=null;for(let r=i.length-3;r>=0;r-=2){const n=i[r],s=i[r+1];t=`(${n} ? ${s} : ${t||e})`}return t}),[X.In]:ne(([i,...e],t)=>{const r=Hp("in",t),n=[];for(let s=0;s<e.length;s+=1)n.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${n.join(`
`)}
  return false;
}`,`${r}(${i})`}),[X.Array]:ne(i=>`vec${i.length}(${i.join(", ")})`),[X.Color]:ne(i=>{if(i.length===1)return`vec4(vec3(${i[0]} / 255.0), 1.0)`;if(i.length===2)return`vec4(vec3(${i[0]} / 255.0), ${i[1]})`;const e=i.slice(0,3).map(r=>`${r} / 255.0`);if(i.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=i[3];return`vec4(${e.join(", ")}, ${t})`}),[X.Band]:ne(([i,e,t],r)=>{if(!(xn in r.functions)){let n="";const s=r.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let l=o%4;o===s-1&&l===1&&(l=3);const c=`${V.TILE_TEXTURE_ARRAY}[${a}]`;n+=`  if (band == ${o+1}.0) {
    return texture2D(${c}, v_textureCoord + vec2(dx, dy))[${l}];
  }
`}r.functions[xn]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${V.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${V.TEXTURE_PIXEL_HEIGHT};
${n}
}`}return`${xn}(${i}, ${e??"0.0"}, ${t??"0.0"})`}),[X.Palette]:(i,e)=>{const[t,...r]=e.args,n=r.length,s=new Uint8Array(n*4);for(let c=0;c<r.length;c++){const u=r[c].value,h=Wr(u),f=c*4;s[f]=h[0],s[f+1]=h[1],s[f+2]=h[2],s[f+3]=h[3]*255}i.paletteTextures||(i.paletteTextures=[]);const o=`${Nl}[${i.paletteTextures.length}]`,a=new Wp(o,s);i.paletteTextures.push(a);const l=Gs(t,te,i);return`texture2D(${o}, vec2((${l} + 0.5) / ${n}.0, 0.5))`}};function Gs(i,e,t){if(i instanceof Hu){const r=Kp[i.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(i.operator)}`);return r(t,i,e)}if((i.type&te)>0)return Lt(i.value);if((i.type&Qi)>0)return i.value.toString();if((i.type&kr)>0)return pt(i.value.toString());if((i.type&Ge)>0)return Ei(i.value);if((i.type&Ct)>0)return Us(i.value);if((i.type&gr)>0)return Zp(i.value);throw new Error(`Unexpected expression ${i.value} (expected type ${Zu(e)})`)}function Jp(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const ha=.985,Zt=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders
`,Yt=Jp();class Bl{constructor(){this.uniforms_=[],this.attributes_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${Lt(Yt["circle-radius"])} + ${Lt(Yt["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=Ei(Yt["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=Lt(Yt["stroke-width"]),this.strokeColorExpression_=Ei(Yt["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=pt("round"),this.strokeJoinExpression_=pt("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.hasFill_=!1,this.fillColorExpression_=Ei(Yt["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e){return this.uniforms_.push(e),this}addAttribute(e,t,r,n){return this.attributes_.push({name:e,type:t,varyingName:e.replace(/^a_/,"v_"),varyingType:n??t,varyingExpression:r??e}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){return this.vertexShaderFunctions_.includes(e)?this:(this.vertexShaderFunctions_.push(e),this)}addFragmentShaderFunction(e){return this.fragmentShaderFunctions_.includes(e)?this:(this.fragmentShaderFunctions_.push(e),this)}getSymbolVertexShader(){return this.hasSymbol_?`${Zt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
attribute vec2 a_position;
attribute float a_index;
attribute vec4 a_hitColor;

varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx;
  if (a_index == 0.0) {
    offsetPx -= halfSizePx;
  } else if (a_index == 1.0) {
    offsetPx += halfSizePx * vec2(1., -1.);
  } else if (a_index == 2.0) {
    offsetPx += halfSizePx;
  } else {
    offsetPx += halfSizePx * vec2(-1., 1.);
  }
  float angle = ${this.symbolRotationExpression_};
  ${this.symbolRotateWithView_?"angle += u_rotation;":""}
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = a_index == 0.0 || a_index == 3.0 ? texCoord.s : texCoord.p;
  float v = a_index == 2.0 || a_index == 3.0 ? texCoord.t : texCoord.q;
  v_texCoord = vec2(u, v);
  v_hitColor = a_hitColor;
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y); 
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${Zt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${Zt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_parameters;
attribute float a_distance;
attribute vec2 a_joinAngles;
attribute vec4 a_hitColor;

varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float vertexNumber = floor(abs(a_parameters) / 10000. + 0.5);
  currentLineMetric = vertexNumber < 1.5 ? a_measureStart : a_measureEnd;
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)
  float angleTangentSum = fract(abs(a_parameters) / 10000.) * 10000. * sign(a_parameters);

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);
  
  // compute current vertex position
  float normalDir = vertexNumber < 0.5 || (vertexNumber > 1.5 && vertexNumber < 2.5) ? 1.0 : -1.0;
  float tangentDir = vertexNumber < 1.5 ? 1.0 : -1.0;
  float angle = vertexNumber < 1.5 ? v_angleStart : v_angleEnd;
  vec2 joinDirection;
  vec2 positionPx = vertexNumber < 1.5 ? segmentStartPx : segmentEndPx;
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${ha} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStart = segmentStartPx;
  v_segmentEnd = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = a_hitColor;
  v_distanceOffsetPx = a_distance / u_resolution - (lineOffsetPx * angleTangentSum);
  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${Zt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${ha}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${pt("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${pt("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${pt("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${pt("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

float distanceFromSegment(vec2 point, vec2 start, vec2 end) {
  vec2 tangent = end - start;
  vec2 startToPoint = point - start;
  // inspire by capsule fn in https://iquilezles.org/articles/distfunctions/
  float h = clamp(dot(startToPoint, tangent) / dot(tangent, tangent), 0.0, 1.0);
  return length(startToPoint - tangent * h);
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
      
  vec2 currentPoint = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPoint);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLength = length(v_segmentEnd - v_segmentStart);
  vec2 segmentTangent = (v_segmentEnd - v_segmentStart) / segmentLength;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPoint = currentPoint - v_segmentStart;
  float lengthToPoint = max(0., min(dot(segmentTangent, startToPoint), segmentLength));
  float currentLengthPx = lengthToPoint + v_distanceOffsetPx;
  float currentRadiusPx = distanceFromSegment(currentPoint, v_segmentStart, v_segmentEnd);
  float currentRadiusRatio = dot(segmentNormal, startToPoint) * 2. / v_width;
  currentLineMetric = mix(v_measureStart, v_measureEnd, lengthToPoint / segmentLength);

  if (${this.discardExpression_}) { discard; }

  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPoint, v_segmentStart, v_segmentEnd, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPoint, v_segmentEnd, v_segmentStart, v_width, v_angleEnd, capType, joinType);
  float distanceField = max(
    segmentDistanceField(currentPoint, v_segmentStart, v_segmentEnd, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distanceField = max(distanceField, ${this.strokeDistanceFieldExpression_});

  vec4 color = ${this.strokeColorExpression_};
  color.a *= smoothstep(0.5, -0.5, distanceField);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${Zt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
attribute vec2 a_position;
attribute vec4 a_hitColor;

varying vec4 v_hitColor;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = a_hitColor;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${Zt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
varying vec4 v_hitColor;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}function G(i,e,t){const r=Qa();return qp(e,t,r,i)}function Qp(i){const e=Wr(i),t=e[0]*256,r=e[1],n=e[2]*256,s=Math.round(e[3]*255);return[t+r,n+s]}const em=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    fract(floor(packedColor[0] / 256.0) / 256.0),
    fract(packedColor[0] / 256.0),
    fract(floor(packedColor[1] / 256.0) / 256.0),
    fract(packedColor[1] / 256.0)
  );
}`;function zs(i){return i===Ge||i===gr?2:i===Ct?4:1}function Wn(i){const e=zs(i);return e>1?`vec${e}`:"float"}function Gl(i,e){for(const t in e.variables){const r=e.variables[t],n=ln(r.name);let s=Wn(r.type);r.type===Ge&&(s="vec4"),i.addUniform(`${s} ${n}`)}for(const t in e.properties){const r=e.properties[t],n=Wn(r.type),s=`a_prop_${r.name}`;r.type===Ge?(i.addAttribute(s,n,`unpackColor(${s})`,"vec4"),i.addVertexShaderFunction(em)):i.addAttribute(s,n)}for(const t in e.functions)i.addVertexShaderFunction(e.functions[t]),i.addFragmentShaderFunction(e.functions[t])}function zl(i,e){const t={};for(const r in i.variables){const n=i.variables[r],s=ln(n.name);t[s]=()=>{const o=e[n.name];return typeof o=="number"?o:typeof o=="boolean"?o?1:0:n.type===Ge?Wr(o||"#eee"):typeof o=="string"?cr(o):o}}return t}function kl(i){const e={};for(const t in i.properties){const r=i.properties[t],n=s=>{const o=s.get(r.name);return r.type===Ge?Qp([...Wr(o||"#eee")]):typeof o=="string"?cr(o):typeof o=="boolean"?o?1:0:o};e[`prop_${r.name}`]={size:zs(r.type),callback:n}}return e}class Ui{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let r=0;r<e.length;r++)this.addFeature(e[r],t)}addFeature(e,t){let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}clearFeatureEntryInPointBatch_(e){const t=ae(e),r=this.pointBatch.entries[t];if(r)return this.pointBatch.geometriesCount-=r.flatCoordss.length,delete this.pointBatch.entries[t],r}clearFeatureEntryInLineStringBatch_(e){const t=ae(e),r=this.lineStringBatch.entries[t];if(r)return this.lineStringBatch.verticesCount-=r.verticesCount,this.lineStringBatch.geometriesCount-=r.flatCoordss.length,delete this.lineStringBatch.entries[t],r}clearFeatureEntryInPolygonBatch_(e){const t=ae(e),r=this.polygonBatch.entries[t];if(r)return this.polygonBatch.verticesCount-=r.verticesCount,this.polygonBatch.ringsCount-=r.ringsCount,this.polygonBatch.geometriesCount-=r.flatCoordss.length,delete this.polygonBatch.entries[t],r}addGeometry_(e,t){var n;const r=e.getType();switch(r){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEndss(),t,ae(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,ae(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,ae(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,ae(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,ae(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(r,s.getFlatCoordinates(),null,t,ae(t),o,(n=s.getLayout)==null?void 0:n.call(s));break}}}addCoordinates_(e,t,r,n,s,o,a){let l;switch(e){case"MultiPolygon":{const c=r;for(let u=0,h=c.length;u<h;u++){let f=c[u];const g=u>0?c[u-1]:null,d=g?g[g.length-1]:0,p=f[f.length-1];f=d>0?f.map(m=>m-d):f,this.addCoordinates_("Polygon",t.slice(d,p),f,n,s,o,a)}break}case"MultiLineString":{const c=r;for(let u=0,h=c.length;u<h;u++){const f=u>0?c[u-1]:0;this.addCoordinates_("LineString",t.slice(f,c[u]),null,n,s,o,a)}break}case"MultiPoint":for(let c=0,u=t.length;c<u;c+=o)this.addCoordinates_("Point",t.slice(c,c+2),null,n,s,null,null);break;case"Polygon":{const c=r;if(n instanceof hu){const f=fu(t,c);if(f.length>1){this.addCoordinates_("MultiPolygon",t,f,n,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),l=t.length/o;const u=r.length,h=r.map((f,g,d)=>g>0?(f-d[g-1])/o:f/o);this.polygonBatch.verticesCount+=l,this.polygonBatch.ringsCount+=u,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push(tm(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(h),this.polygonBatch.entries[s].verticesCount+=l,this.polygonBatch.entries[s].ringsCount+=u;for(let f=0,g=c.length;f<g;f++){const d=f>0?c[f-1]:0;this.addCoordinates_("LinearRing",t.slice(d,c[f]),null,n,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0})),l=t.length/o,this.lineStringBatch.verticesCount+=l,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push(rm(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=l;break}}addRefToEntry_(e,t){const r=this.uidToRef_.get(e),n=r||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=n,r||(this.refToFeature_.set(n,t.feature),this.uidToRef_.set(e,n)),t}removeRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e){if(!this.uidToRef_.get(ae(e)))return;this.removeFeature(e);const t=e.getGeometry();t&&this.addGeometry_(t,e)}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.removeRef_(t.ref,ae(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new Ui;t.globalCounter_=this.globalCounter_,t.uidToRef_=this.uidToRef_,t.refToFeature_=this.refToFeature_;let r=!0;for(const n of this.refToFeature_.values())e(n)&&(t.addFeature(n),r=!1);return r?new Ui:t}}function tm(i,e){return e===2?i:i.filter((t,r)=>r%e<2)}function rm(i,e,t){return e===3&&t==="XYM"?i:e===4?i.filter((r,n)=>n%e!==2):e===3?i.map((r,n)=>n%e!==2?r:0):new Array(i.length*1.5).fill(0).map((r,n)=>n%3===2?0:i[Math.round(n/1.5)])}function $l(){const i='function t(t,n,x=2){const o=n&&n.length,i=o?n[0]*x:t.length;let u=e(t,0,i,x,!0);const l=[];if(!u||u.next===u.prev)return l;let c,h,y;if(o&&(u=function(t,n,r,x){const o=[];for(let r=0,i=n.length;r<i;r++){const u=e(t,n[r]*x,r<i-1?n[r+1]*x:t.length,x,!1);u===u.next&&(u.steiner=!0),o.push(a(u))}o.sort(f);for(let t=0;t<o.length;t++)r=s(o[t],r);return r}(t,n,u,x)),t.length>80*x){c=1/0,h=1/0;let e=-1/0,n=-1/0;for(let r=x;r<i;r+=x){const x=t[r],o=t[r+1];x<c&&(c=x),o<h&&(h=o),x>e&&(e=x),o>n&&(n=o)}y=Math.max(e-c,n-h),y=0!==y?32767/y:0}return r(u,l,x,c,h,y,0),l}function e(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=w(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=w(x/r|0,t[x],t[x+1],o);return o&&g(o,o.next)&&(A(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!g(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(A(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function r(t,e,f,s,l,a,h){if(!t)return;!h&&a&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=c(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,u=0;for(let t=0;t<n&&(u++,i=i.nextZ,i);t++);let f=n;for(;u>0||f>0&&i;)0!==u&&(0===f||!i||x.z<=i.z)?(r=x,x=x.nextZ,u--):(r=i,i=i.nextZ,f--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,s,l,a);let y=t;for(;t.prev!==t.next;){const c=t.prev,p=t.next;if(a?o(t,s,l,a):x(t))e.push(c.i,t.i,p.i),A(t),t=p.next,y=p.next;else if((t=p)===y){h?1===h?r(t=i(n(t),e),e,f,s,l,a,2):2===h&&u(t,e,f,s,l,a):r(n(t),e,f,s,l,a,1);break}}}function x(t){const e=t.prev,n=t,r=t.next;if(v(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,u=e.y,f=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(u,f,s),a=Math.max(x,o,i),h=Math.max(u,f,s);let p=r.next;for(;p!==e;){if(p.x>=l&&p.x<=a&&p.y>=c&&p.y<=h&&y(x,u,o,f,i,s,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,e,n,r){const x=t.prev,o=t,i=t.next;if(v(x,o,i)>=0)return!1;const u=x.x,f=o.x,s=i.x,l=x.y,a=o.y,h=i.y,p=Math.min(u,f,s),g=Math.min(l,a,h),b=Math.max(u,f,s),M=Math.max(l,a,h),m=c(p,g,e,n,r),Z=c(b,M,e,n,r);let d=t.prevZ,w=t.nextZ;for(;d&&d.z>=m&&w&&w.z<=Z;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;d&&d.z>=m;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;w&&w.z<=Z;){if(w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function i(t,e){let r=t;do{const n=r.prev,x=r.next.next;!g(n,x)&&b(n,r,r.next,x)&&Z(n,x)&&Z(x,n)&&(e.push(n.i,r.i,x.i),A(r),A(r.next),r=t=x),r=r.next}while(r!==t);return n(r)}function u(t,e,x,o,i,u){let f=t;do{let t=f.next.next;for(;t!==f.prev;){if(f.i!==t.i&&p(f,t)){let s=d(f,t);return f=n(f,f.next),s=n(s,s.next),r(f,e,x,o,i,u,0),void r(s,e,x,o,i,u,0)}t=t.next}f=f.next}while(f!==t)}function f(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function s(t,e){const r=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(g(t,n))return n;do{if(g(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const u=o,f=o.x,s=o.y;let c=1/0;n=o;do{if(r>=n.x&&n.x>=f&&r!==n.x&&h(x<s?r:i,x,f,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);Z(n,t)&&(e<c||e===c&&(n.x>o.x||n.x===o.x&&l(o,n)))&&(o=n,c=e)}n=n.next}while(n!==u);return o}(t,e);if(!r)return e;const x=d(r,t);return n(x,x.next),n(r,r.next)}function l(t,e){return v(t.prev,t,e.prev)<0&&v(e.next,t,t.next)<0}function c(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function a(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function h(t,e,n,r,x,o,i,u){return(x-i)*(e-u)>=(t-i)*(o-u)&&(t-i)*(r-u)>=(n-i)*(e-u)&&(n-i)*(o-u)>=(x-i)*(r-u)}function y(t,e,n,r,x,o,i,u){return!(t===i&&e===u)&&h(t,e,n,r,x,o,i,u)}function p(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&b(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Z(t,e)&&Z(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(v(t.prev,t,e.prev)||v(t,e.prev,e))||g(t,e)&&v(t.prev,t,t.next)>0&&v(e.prev,e,e.next)>0)}function v(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function g(t,e){return t.x===e.x&&t.y===e.y}function b(t,e,n,r){const x=m(v(t,e,n)),o=m(v(t,e,r)),i=m(v(n,r,t)),u=m(v(n,r,e));return x!==o&&i!==u||(!(0!==x||!M(t,n,e))||(!(0!==o||!M(t,r,e))||(!(0!==i||!M(n,t,r))||!(0!==u||!M(n,e,r)))))}function M(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function m(t){return t>0?1:t<0?-1:0}function Z(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function d(t,e){const n=E(t.i,t.x,t.y),r=E(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function w(t,e,n,r){const x=E(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function A(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function E(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function I(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function z(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],u=e[3],f=e[4],s=e[5];return t[0]=u/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-u*f)/n,t[5]=-(x*s-o*f)/n,t}new Array(6);const F=[],P={vertexPosition:0,indexPosition:0};function B(t,e,n,r,x){t[e+0]=n,t[e+1]=r,t[e+2]=x}function N(t,e,n,r,x,o){const i=3+x,u=t[e+0],f=t[e+1],s=F;s.length=x;for(let n=0;n<s.length;n++)s[n]=t[e+2+n];let l=o?o.vertexPosition:0,c=o?o.indexPosition:0;const a=l/i;return B(n,l,u,f,0),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,1),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,2),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,3),s.length&&n.set(s,l+3),l+=i,r[c++]=a,r[c++]=a+1,r[c++]=a+3,r[c++]=a+1,r[c++]=a+2,r[c++]=a+3,P.vertexPosition=l,P.indexPosition=c,P}function R(t,e,n,r,x,o,i,u,f,s,l){const c=10+u.length,a=o.length/c,h=[t[e+0],t[e+1]],y=[t[n],t[n+1]],p=t[e+2],v=t[n+2],g=I(f,[...h]),b=I(f,[...y]);function M(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),u=[(n[0]-t[0])/i,(n[1]-t[1])/i],f=0===r||0===i?0:Math.acos((s=u[0]*x[0]+u[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;return u[0]*o[0]+u[1]*o[1]>0?f:2*Math.PI-f}let m=-1,Z=-1,d=l;const w=null!==x;if(null!==r){m=M(g,b,I(f,[...[t[r],t[r+1]]])),Math.cos(m)<=.985&&(d+=Math.tan((m-Math.PI)/2))}if(w){Z=M(b,g,I(f,[...[t[x],t[x+1]]])),Math.cos(Z)<=.985&&(d+=Math.tan((Math.PI-Z)/2))}function A(t,e){return 0===e?1e4*t:Math.sign(e)*(1e4*t+Math.abs(e))}return o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(0,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(1,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(2,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(3,l)),o.push(...u),i.push(a,a+1,a+2,a+1,a+3,a+2),{length:s+Math.sqrt((b[0]-g[0])*(b[0]-g[0])+(b[1]-g[1])*(b[1]-g[1])),angle:d}}function S(e,n,r,x,o){const i=2+o;let u=n;const f=e.slice(u,u+o);u+=o;const s=e[u++];let l=0;const c=new Array(s-1);for(let t=0;t<s;t++)l+=e[u++],t<s-1&&(c[t]=l);const a=e.slice(u,u+2*l),h=t(a,c,2);for(let t=0;t<h.length;t++)x.push(h[t]+r.length/i);for(let t=0;t<a.length;t+=2)r.push(a[t],a[t+1],...f);return u+2*l}const T="GENERATE_POLYGON_BUFFERS",_="GENERATE_POINT_BUFFERS",O="GENERATE_LINE_STRING_BUFFERS",U=self;U.onmessage=t=>{const e=t.data;switch(e.type){case _:{const t=3,n=2,r=e.customAttributesSize,x=n+r,o=new Float32Array(e.renderInstructions),i=o.length/x,u=4*i*(r+t),f=new Uint32Array(6*i),s=new Float32Array(u);let l;for(let t=0;t<o.length;t+=x)l=N(o,t,s,f,r,l);const c=Object.assign({vertexBuffer:s.buffer,indexBuffer:f.buffer,renderInstructions:o.buffer},e);U.postMessage(c,[s.buffer,f.buffer,o.buffer]);break}case O:{const t=[],n=[],r=e.customAttributesSize,x=3,o=new Float32Array(e.renderInstructions);let i=0;const u=[1,0,0,1,0,0];let f,s;for(z(u,e.renderInstructionsTransform);i<o.length;){s=Array.from(o.slice(i,i+r)),i+=r,f=o[i++];const e=i,l=i+(f-1)*x,c=o[e]===o[l]&&o[e+1]===o[l+1];let a=0,h=0;for(let r=0;r<f-1;r++){let y=null;r>0?y=i+(r-1)*x:c&&(y=l-x);let p=null;r<f-2?p=i+(r+2)*x:c&&(p=e+x);const v=R(o,i+r*x,i+(r+1)*x,y,p,t,n,s,u,a,h);a=v.length,h=v.angle}i+=f*x}const l=Uint32Array.from(n),c=Float32Array.from(t),a=Object.assign({vertexBuffer:c.buffer,indexBuffer:l.buffer,renderInstructions:o.buffer},e);U.postMessage(a,[c.buffer,l.buffer,o.buffer]);break}case T:{const t=[],n=[],r=e.customAttributesSize,x=new Float32Array(e.renderInstructions);let o=0;for(;o<x.length;)o=S(x,o,t,n,r);const i=Uint32Array.from(n),u=Float32Array.from(t),f=Object.assign({vertexBuffer:u.buffer,indexBuffer:i.buffer,renderInstructions:x.buffer},e);U.postMessage(f,[u.buffer,i.buffer,x.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(i,"binary").toString("base64"):URL.createObjectURL(new Blob([i],{type:"application/javascript"})))}const Ir={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"};function Vl(i,e){e=e||[];const t=256,r=t-1;return e[0]=Math.floor(i/t/t/t)/r,e[1]=Math.floor(i/t/t)%t/r,e[2]=Math.floor(i/t)%t/r,e[3]=i%t/r,e}function jl(i){let e=0;const t=256,r=t-1;return e+=Math.round(i[0]*t*t*t*r),e+=Math.round(i[1]*t*t*r),e+=Math.round(i[2]*t*r),e+=Math.round(i[3]*r),e}function ks(i,e,t,r){let n=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);let l=(a==null?void 0:a[0])??a;l===Xn&&console.warn('The "has" operator might return false positives.'),l===void 0?l=Xn:l===null&&(l=0),i[r+n++]=l,!(!o.size||o.size===1)&&(i[r+n++]=a[1],!(o.size<3)&&(i[r+n++]=a[2],!(o.size<4)&&(i[r+n++]=a[3])))}return n}function cn(i){return Object.keys(i).reduce((e,t)=>e+(i[t].size||1),0)}function im(i,e,t,r){const n=(2+cn(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,u=l.flatCoordss.length;c<u;c++)s[0]=l.flatCoordss[c][0],s[1]=l.flatCoordss[c][1],xt(r,s),e[o++]=s[0],e[o++]=s[1],o+=ks(e,t,l,o)}return e}function nm(i,e,t,r){const n=3*i.verticesCount+(1+cn(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,u=l.flatCoordss.length;c<u;c++){s.length=l.flatCoordss[c].length,Va(l.flatCoordss[c],0,s.length,3,r,s,3),o+=ks(e,t,l,o),e[o++]=s.length/3;for(let h=0,f=s.length;h<f;h+=3)e[o++]=s[h],e[o++]=s[h+1],e[o++]=s[h+2]}}return e}function sm(i,e,t,r){const n=2*i.verticesCount+(1+cn(t))*i.geometriesCount+i.ringsCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,u=l.flatCoordss.length;c<u;c++){s.length=l.flatCoordss[c].length,Va(l.flatCoordss[c],0,s.length,2,r,s),o+=ks(e,t,l,o),e[o++]=l.ringsVerticesCounts[c].length;for(let h=0,f=l.ringsVerticesCounts[c].length;h<f;h++)e[o++]=l.ringsVerticesCounts[c][h];for(let h=0,f=s.length;h<f;h+=2)e[o++]=s[h],e[o++]=s[h+1]}}return e}function Bi(i){return(JSON.stringify(i).split("").reduce((t,r)=>(t<<5)-t+r.charCodeAt(0),0)>>>0).toString()}function $s(i,e,t,r){if(`${r}radius`in i&&r!=="icon-"){let n=G(t,i[`${r}radius`],te);if(`${r}radius2`in i){const s=G(t,i[`${r}radius2`],te);n=`max(${n}, ${s})`}`${r}stroke-width`in i&&(n=`(${n} + ${G(t,i[`${r}stroke-width`],te)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${n} * 2. + 0.5)`)}if(`${r}scale`in i){const n=G(t,i[`${r}scale`],gr);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${n}`)}`${r}displacement`in i&&e.setSymbolOffsetExpression(G(t,i[`${r}displacement`],Ct)),`${r}rotation`in i&&e.setSymbolRotationExpression(G(t,i[`${r}rotation`],te)),`${r}rotate-with-view`in i&&e.setSymbolRotateWithView(!!i[`${r}rotate-with-view`])}function Xl(i,e,t,r,n){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&r!==null){const l=`smoothstep(-${r} + 0.63, -${r} - 0.58, ${i})`;s=`mix(${t}, ${s}, ${l})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${i}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return n!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${n})`),a}function Vs(i,e,t,r,n){const s=new Image;s.crossOrigin=i[`${r}cross-origin`]===void 0?"anonymous":i[`${r}cross-origin`],Ze(typeof i[`${r}src`]=="string",`WebGL layers do not support expressions for the ${r}src style property`),s.src=i[`${r}src`],t[`u_texture${n}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`vec2 u_texture${n}_size`);const o=`u_texture${n}_size`;return t[`u_texture${n}`]=s,e.addUniform(`sampler2D u_texture${n}`),o}function js(i,e,t,r,n){let s=G(t,i[`${e}offset`],Ct);if(`${e}offset-origin`in i)switch(i[`${e}offset-origin`]){case"top-right":s=`vec2(${r}.x, 0.) + ${n} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${r}.y) + ${n} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${r} - ${n} - ${s}`;break}return s}function om(i,e,t,r){r.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,$s(i,e,r,"circle-");let n=null;"circle-opacity"in i&&(n=G(r,i["circle-opacity"],te));let s="coordsPx";"circle-scale"in i&&(s=`coordsPx / ${G(r,i["circle-scale"],gr)}`);let o=null;"circle-fill-color"in i&&(o=G(r,i["circle-fill-color"],Ge));let a=null;"circle-stroke-color"in i&&(a=G(r,i["circle-stroke-color"],Ge));let l=G(r,i["circle-radius"],te),c=null;"circle-stroke-width"in i&&(c=G(r,i["circle-stroke-width"],te),l=`(${l} + ${c} * 0.5)`);const u=`circleDistanceField(${s}, ${l})`,h=Xl(u,o,a,c,n);e.setSymbolColorExpression(h)}function am(i,e,t,r){r.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,r.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,r.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,$s(i,e,r,"shape-");let n=null;"shape-opacity"in i&&(n=G(r,i["shape-opacity"],te));let s="coordsPx";"shape-scale"in i&&(s=`coordsPx / ${G(r,i["shape-scale"],gr)}`);let o=null;"shape-fill-color"in i&&(o=G(r,i["shape-fill-color"],Ge));let a=null;"shape-stroke-color"in i&&(a=G(r,i["shape-stroke-color"],Ge));let l=null;"shape-stroke-width"in i&&(l=G(r,i["shape-stroke-width"],te));const c=G(r,i["shape-points"],te);let u="0.";"shape-angle"in i&&(u=G(r,i["shape-angle"],te));let h,f=G(r,i["shape-radius"],te);if(l!==null&&(f=`${f} + ${l} * 0.5`),"shape-radius2"in i){let d=G(r,i["shape-radius2"],te);l!==null&&(d=`${d} + ${l} * 0.5`),h=`starDistanceField(${s}, ${c}, ${f}, ${d}, ${u})`}else h=`regularDistanceField(${s}, ${c}, ${f}, ${u})`;const g=Xl(h,o,a,l,n);e.setSymbolColorExpression(g)}function lm(i,e,t,r){let n="vec4(1.0)";"icon-color"in i&&(n=G(r,i["icon-color"],Ge)),"icon-opacity"in i&&(n=`${n} * vec4(1.0, 1.0, 1.0, ${G(r,i["icon-opacity"],te)})`);const s=Bi(i["icon-src"]),o=Vs(i,e,t,"icon-",s);if(e.setSymbolColorExpression(`${n} * texture2D(u_texture${s}, v_texCoord)`).setSymbolSizeExpression(o),"icon-width"in i&&"icon-height"in i&&e.setSymbolSizeExpression(`vec2(${G(r,i["icon-width"],te)}, ${G(r,i["icon-height"],te)})`),"icon-offset"in i&&"icon-size"in i){const a=G(r,i["icon-size"],Ct),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(a);const c=js(i,"icon-",r,"v_quadSizePx",a);e.setTextureCoordinateExpression(`(vec4((${c}).xyxy) + vec4(0., 0., ${a})) / (${l}).xyxy`)}if($s(i,e,r,"icon-"),"icon-anchor"in i){const a=G(r,i["icon-anchor"],Ct);let l="1.0";"icon-scale"in i&&(l=G(r,i["icon-scale"],gr));let c;i["icon-anchor-x-units"]==="pixels"&&i["icon-anchor-y-units"]==="pixels"?c=`${a} * ${l}`:i["icon-anchor-x-units"]==="pixels"?c=`${a} * vec2(vec2(${l}).x, v_quadSizePx.y)`:i["icon-anchor-y-units"]==="pixels"?c=`${a} * vec2(v_quadSizePx.x, vec2(${l}).x)`:c=`${a} * v_quadSizePx`;let u=`v_quadSizePx * vec2(0.5, -0.5) + ${c} * vec2(-1., 1.)`;if("icon-anchor-origin"in i)switch(i["icon-anchor-origin"]){case"top-right":u=`v_quadSizePx * -0.5 + ${c}`;break;case"bottom-left":u=`v_quadSizePx * 0.5 - ${c}`;break;case"bottom-right":u=`v_quadSizePx * vec2(-0.5, 0.5) + ${c} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${u}`)}}function cm(i,e,t,r){if("stroke-color"in i&&e.setStrokeColorExpression(G(r,i["stroke-color"],Ge)),"stroke-pattern-src"in i){const n=Bi(i["stroke-pattern-src"]),s=Vs(i,e,t,"stroke-pattern-",n);let o=s,a="vec2(0.)";"stroke-pattern-offset"in i&&"stroke-pattern-size"in i&&(o=G(r,i["stroke-pattern-size"],Ct),a=js(i,"stroke-pattern-",r,s,o));let l="0.";"stroke-pattern-spacing"in i&&(l=G(r,i["stroke-pattern-spacing"],te)),r.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = currentLengthPx * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord);
}`;const c=`u_texture${n}`;let u="1.";"stroke-color"in i&&(u=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${u} * sampleStrokePattern(${c}, ${s}, ${a}, ${o}, ${l}, currentLengthPx, currentRadiusRatio, v_width)`)}if("stroke-width"in i&&e.setStrokeWidthExpression(G(r,i["stroke-width"],te)),"stroke-offset"in i&&e.setStrokeOffsetExpression(G(r,i["stroke-offset"],te)),"stroke-line-cap"in i&&e.setStrokeCapExpression(G(r,i["stroke-line-cap"],kr)),"stroke-line-join"in i&&e.setStrokeJoinExpression(G(r,i["stroke-line-join"],kr)),"stroke-miter-limit"in i&&e.setStrokeMiterLimitExpression(G(r,i["stroke-miter-limit"],te)),"stroke-line-dash"in i){r.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType, float lineWidth) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${pt("square")}) {
    distanceSegment -= lineWidth * 0.5;
  } else if (capType == ${pt("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - lineWidth * 0.5);
  }
  return distanceSegment;
}`;let n=i["stroke-line-dash"].map(f=>G(r,f,te));n.length%2===1&&(n=[...n,...n]);let s="0.";"stroke-line-dash-offset"in i&&(s=G(r,i["stroke-line-dash-offset"],te));const a=`dashDistanceField_${Bi(i["stroke-line-dash"])}`,l=n.map((f,g)=>`float dashLength${g} = ${f};`),c=n.map((f,g)=>`dashLength${g}`).join(" + ");let u="0.",h=`getSingleDashDistance(distance, radius, ${u}, dashLength0, totalDashLength, capType, lineWidth)`;for(let f=2;f<n.length;f+=2)u=`${u} + dashLength${f-2} + dashLength${f-1}`,h=`min(${h}, getSingleDashDistance(distance, radius, ${u}, dashLength${f}, totalDashLength, capType, lineWidth))`;r.functions[a]=`float ${a}(float distance, float radius, float capType, float lineWidth) {
  ${l.join(`
  `)}
  float totalDashLength = ${c};
  return ${h};
}`,e.setStrokeDistanceFieldExpression(`${a}(currentLengthPx + ${s}, currentRadiusPx, capType, v_width)`)}}function um(i,e,t,r){if("fill-color"in i&&e.setFillColorExpression(G(r,i["fill-color"],Ge)),"fill-pattern-src"in i){const n=Bi(i["fill-pattern-src"]),s=Vs(i,e,t,"fill-pattern-",n);let o=s,a="vec2(0.)";"fill-pattern-offset"in i&&"fill-pattern-size"in i&&(o=G(r,i["fill-pattern-size"],Ct),a=js(i,"fill-pattern-",r,s,o)),r.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${n}`;let c="1.";"fill-color"in i&&(c=e.getFillColorExpression()),e.setFillColorExpression(`${c} * sampleFillPattern(${l}, ${s}, ${a}, ${o}, pxOrigin, pxPos)`)}}function Wl(i,e,t){const r=Bs(),n=new Bl,s={};if("icon-src"in i?lm(i,n,s,r):"shape-points"in i?am(i,n,s,r):"circle-radius"in i&&om(i,n,s,r),cm(i,n,s,r),um(i,n,s,r),t){const l=G(r,t,Qi);n.setFragmentDiscardExpression(`!${l}`)}const o={};function a(l,c,u,h){if(!r[l])return;const f=Wn(u),g=zs(u);n.addAttribute(`a_${c}`,f),o[c]={size:g,callback:h}}return a("geometryType",Ul,kr,l=>cr(el(l.getGeometry()))),a("featureId",Dl,kr|te,l=>{const c=l.getId()??null;return typeof c=="string"?cr(c):c}),Gl(n,r),{builder:n,attributes:{...o,...kl(r)},uniforms:{...s,...zl(r,e)}}}function hm(i){const e=Array.isArray(i)?i:[i];if("style"in e[0]){const t=[],r=e,n=[];for(const s of r){const o=Array.isArray(s.style)?s.style:[s.style];let a=s.filter;s.else&&n.length&&(a=["all",...n.map(c=>["!",c])],s.filter&&a.push(s.filter),a.length<3&&(a=a[1])),s.filter&&n.push(s.filter);const l=o.map(c=>({style:c,...a&&{filter:a}}));t.push(...l)}return t}return"builder"in e[0]?e:e.map(t=>({style:t}))}const fm=[];let bn;function dm(){return bn||(bn=$l()),bn}let gm=0;const rt={POSITION:"a_position",INDEX:"a_index",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",PARAMETERS:"a_parameters",JOIN_ANGLES:"a_joinAngles",DISTANCE:"a_distance"};class pm{constructor(e,t,r,n,s){this.helper_,this.hitDetectionEnabled_=!!n;let o=e;if(!("builder"in e)){const u=e,h=Wl(u.style,t,u.filter);o={builder:h.builder,attributes:h.attributes,uniforms:h.uniforms}}this.fillProgram_,this.strokeProgram_,this.symbolProgram_,this.hasFill_=!!o.builder.getFillVertexShader(),this.hasFill_&&(this.fillVertexShader_=o.builder.getFillVertexShader(),this.fillFragmentShader_=o.builder.getFillFragmentShader()),this.hasStroke_=!!o.builder.getStrokeVertexShader(),this.hasStroke_&&(this.strokeVertexShader_=o.builder.getStrokeVertexShader(),this.strokeFragmentShader_=o.builder.getStrokeFragmentShader()),this.hasSymbol_=!!o.builder.getSymbolVertexShader(),this.hasSymbol_&&(this.symbolVertexShader_=o.builder.getSymbolVertexShader(),this.symbolFragmentShader_=o.builder.getSymbolFragmentShader()),this.featureFilter_=null,s&&(this.featureFilter_=this.computeFeatureFilter(s));const l=this.hitDetectionEnabled_?{hitColor:{callback(){return Vl(this.ref,fm)},size:4}}:{};this.customAttributes_=Object.assign({},l,o.attributes),this.uniforms_=o.uniforms;const c=Object.entries(this.customAttributes_).map(([u,h])=>({name:`a_${u}`,size:h.size||1,type:xe.FLOAT}));this.polygonAttributesDesc_=[{name:rt.POSITION,size:2,type:xe.FLOAT},...c],this.lineStringAttributesDesc_=[{name:rt.SEGMENT_START,size:2,type:xe.FLOAT},{name:rt.MEASURE_START,size:1,type:xe.FLOAT},{name:rt.SEGMENT_END,size:2,type:xe.FLOAT},{name:rt.MEASURE_END,size:1,type:xe.FLOAT},{name:rt.JOIN_ANGLES,size:2,type:xe.FLOAT},{name:rt.DISTANCE,size:1,type:xe.FLOAT},{name:rt.PARAMETERS,size:1,type:xe.FLOAT},...c],this.pointAttributesDesc_=[{name:rt.POSITION,size:2,type:xe.FLOAT},{name:rt.INDEX,size:1,type:xe.FLOAT},...c],this.setHelper(r)}computeFeatureFilter(e){const t=Qa();let r;try{r=Yu(e,Qi,t)}catch{return null}if(t.mapState||t.variables.size>0)return null;const n=qu();return s=>{if(n.properties=s.getPropertiesInternal(),t.featureId){const o=s.getId();o!==void 0?n.featureId=o:n.featureId=null}return n.geometryType=el(s.getGeometry()),r(n)}}async generateBuffers(e,t){let r=e;if(this.featureFilter_&&(r=r.filter(this.featureFilter_),r.isEmpty()))return null;const n=this.generateRenderInstructions_(r,t),[s,o,a]=await Promise.all([this.generateBuffersForType_(n.polygonInstructions,"Polygon",t),this.generateBuffersForType_(n.lineStringInstructions,"LineString",t),this.generateBuffersForType_(n.pointInstructions,"Point",t)]),l=Ur(Pe(),t);return{polygonBuffers:s,lineStringBuffers:o,pointBuffers:a,invertVerticesTransform:l}}generateRenderInstructions_(e,t){const r=this.hasFill_?sm(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,n=this.hasStroke_?nm(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?im(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:r,lineStringInstructions:n,pointInstructions:s}}generateBuffersForType_(e,t,r){if(e===null)return null;const n=gm++;let s;switch(t){case"Polygon":s=Ir.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=Ir.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=Ir.GENERATE_POINT_BUFFERS;break}const o={id:n,type:s,renderInstructions:e.buffer,renderInstructionsTransform:r,customAttributesSize:cn(this.customAttributes_)},a=dm();return a.postMessage(o,[e.buffer]),e=null,new Promise(l=>{const c=u=>{const h=u.data;if(h.id!==n||(a.removeEventListener("message",c),!this.helper_.getGL()))return;const f=new lr(Kr,Ni).fromArrayBuffer(h.vertexBuffer),g=new lr(Jr,Ni).fromArrayBuffer(h.indexBuffer);this.helper_.flushBufferData(f),this.helper_.flushBufferData(g),l([g,f])};a.addEventListener("message",c)})}render(e,t,r){this.hasFill_&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],this.fillProgram_,this.polygonAttributesDesc_,t,r),this.hasStroke_&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],this.strokeProgram_,this.lineStringAttributesDesc_,t,r),this.hasSymbol_&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],this.symbolProgram_,this.pointAttributesDesc_,t,r)}renderInternal_(e,t,r,n,s,o){const a=e.getSize();a!==0&&(this.helper_.useProgram(r,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(n),o(),this.helper_.drawElements(0,a))}setHelper(e,t=null){this.helper_=e,this.hasFill_&&(this.fillProgram_=this.helper_.getProgram(this.fillFragmentShader_,this.fillVertexShader_)),this.hasStroke_&&(this.strokeProgram_=this.helper_.getProgram(this.strokeFragmentShader_,this.strokeVertexShader_)),this.hasSymbol_&&(this.symbolProgram_=this.helper_.getProgram(this.symbolFragmentShader_,this.symbolVertexShader_)),this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1])))}}const it=new Uint8Array(4);class Hl{constructor(e,t){this.helper_=e;const r=e.getGL();this.texture_=r.createTexture(),this.framebuffer_=r.createFramebuffer(),this.depthbuffer_=r.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){Pu(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return it[0]=0,it[1]=0,it[2]=0,it[3]=0,it;this.readAll();const r=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return it[0]=this.data_[r*4],it[1]=this.data_[r*4+1],it[2]=this.data_[r*4+2],it[3]=this.data_[r*4+3],it}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function Zl(i,e){const t=i.viewState.projection,n=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=i.extent,a=n?Ae(s):null,l=n?Math.ceil((o[2]-s[2])/a)+1:1;return[n?Math.floor((o[0]-s[0])/a):0,l,a]}const qt={...at,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class Yl extends Qr{constructor(e,t){const r={[qt.RENDER_EXTENT]:[0,0,0,0],[qt.PATTERN_ORIGIN]:[0,0],[qt.GLOBAL_ALPHA]:1};super(e,{uniforms:r,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=Xr(),this.currentTransform_=Pe(),this.tmpCoords_=[0,0],this.tmpTransform_=Pe(),this.tmpMat4_=jt(),this.currentFrameStateTransform_=Pe(),this.styleVariables_={},this.styles_=[],this.styleRenderers_=[],this.buffers_=[],this.applyOptions_(t),this.batch_=new Ui,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let r;this.batch_.addFeatures(t.getFeatures(),r),this.sourceListenKeys_=[mt(t,vt.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,r)),mt(t,vt.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),mt(t,vt.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),mt(t,vt.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.styles_=hm(e.style)}createRenderers_(){this.buffers_=[],this.styleRenderers_=this.styles_.map(e=>new pm(e,this.styleVariables_,this.helper,this.hitDetectionEnabled_,"filter"in e?e.filter:null))}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderers_.length?this.styleRenderers_.forEach((e,t)=>e.setHelper(this.helper,this.buffers_[t])):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new Hl(this.helper))}handleSourceFeatureAdded_(e,t){const r=t.feature;this.batch_.addFeature(r,e)}handleSourceFeatureChanged_(e){const t=e.feature;this.batch_.changeFeature(t)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){du(this.tmpTransform_,this.currentFrameStateTransform_),Dr(this.tmpTransform_,e),this.helper.setUniformMatrixValue(qt.PROJECTION_MATRIX,Mi(this.tmpMat4_,this.tmpTransform_)),Ur(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(qt.SCREEN_TO_WORLD_MATRIX,Mi(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,Ur(this.tmpTransform_,e),xt(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(qt.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=Zl(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[Ft.ANIMATING]&&!e.viewHints[Ft.INTERACTING],o=!Gr(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,u=t instanceof en?t.getRenderBuffer():0,h=hs(e.extent,u*c);r.loadFeatures(h,c,l),this.ready=!1;const f=this.helper.makeProjectionTransform(e,Pe()),g=this.styleRenderers_.map((d,p)=>d.generateBuffers(this.batch_,f).then(m=>{this.buffers_[p]&&this.disposeBuffers(this.buffers_[p]),this.buffers_[p]=m}));Promise.all(g).then(()=>{this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,r,n,s){let o=r;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do{this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),as(this.currentFrameStateTransform_,o*s,0);for(let a=0,l=this.styleRenderers_.length;a<l;a++){const c=this.styleRenderers_[a],u=this.buffers_[a];u&&c.render(u,e,()=>{this.applyUniforms_(u.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)})}}while(++o<n)}forEachFeatureAtCoordinate(e,t,r,n,s){if(Ze(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderers_.length||!this.hitDetectionEnabled_)return;const o=xt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=jl(l),u=this.batch_.getFeatureFromRef(c);if(u)return n(u,this.getLayer(),null)}disposeBuffers(e){const t=r=>{for(const n of r)n&&this.helper.deleteBuffer(n)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_.forEach(e=>{e&&this.disposeBuffers(e)}),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){wi(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}const dt={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},mm=["#00f","#0ff","#0f0","#ff0","#f00"];class _m extends en{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.filter_=e.filter??!0,this.styleVariables_=e.variables||{},this.gradient_=null,this.addChangeListener(dt.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:mm),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const r=e.weight?e.weight:"weight";this.weight_=r,this.setRenderOrder(null)}getBlur(){return this.get(dt.BLUR)}getGradient(){return this.get(dt.GRADIENT)}getRadius(){return this.get(dt.RADIUS)}handleGradientChanged_(){this.gradient_=ym(this.getGradient())}setBlur(e){const t=this.get(dt.BLUR);if(this.set(dt.BLUR,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setGradient(e){this.set(dt.GRADIENT,e)}setRadius(e){const t=this.get(dt.RADIUS);if(this.set(dt.RADIUS,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setFilter(e){this.filter_=e,this.changed(),this.clearRenderer()}setWeight(e){this.weight_=e,this.changed(),this.clearRenderer()}createRenderer(){const e=new Bl,t=Bs(),r=G(t,this.filter_,Qi);let n=G(t,this.getRadius(),te),s=G(t,this.getBlur(),te);const o={};typeof this.getBlur()=="number"&&(s="a_blur",o.a_blur=()=>this.getBlur(),e.addUniform("float a_blur")),typeof this.getRadius()=="number"&&(n="a_radius",o.a_radius=()=>this.getRadius(),e.addUniform("float a_radius"));const a={};let l=null;if(typeof this.weight_=="string"||typeof this.weight_=="function"){const h=typeof this.weight_=="string"?f=>f.get(this.weight_):this.weight_;a.prop_weight={size:1,callback:f=>{const g=h(f);return g!==void 0?me(g,0,1):1}},l="a_prop_weight",e.addAttribute("a_prop_weight","float")}else{const h=["clamp",this.weight_,0,1];l=G(t,h,te)}e.addFragmentShaderFunction(`float getBlurSlope() {
  float blur = max(1., ${s});
  float radius = ${n};
  return radius / blur;
}`).setSymbolSizeExpression(`vec2(${n} + ${s}) * 2.`).setSymbolColorExpression(`vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${l})`).setStrokeColorExpression(`vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${l})`).setStrokeWidthExpression(`(${n} + ${s}) * 2.`).setFillColorExpression(`vec4(${l})`).setFragmentDiscardExpression(`!${r}`),Gl(e,t);const c=kl(t),u=zl(t,this.styleVariables_);return new Yl(this,{className:this.getClassName(),variables:this.styleVariables_,style:{builder:e,attributes:{...c,...a},uniforms:{...u,...o}},disableHitDetection:!1,postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}renderDeclutter(){}}function ym(i){const r=It(1,256),n=r.createLinearGradient(0,0,1,256),s=1/(i.length-1);for(let o=0,a=i.length;o<a;++o)n.addColorStop(o*s,i[o]);return r.fillStyle=n,r.fillRect(0,0,1,256),r.canvas}class Xs extends tl{constructor(e,t,r,n,s){const o=s!==void 0?Gt.IDLE:Gt.LOADED;super(e,t,r,o),this.loader_=s!==void 0?s:null,this.canvas_=n,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=Gt.ERROR):this.state=Gt.LOADED,this.changed()}load(){this.state==Gt.IDLE&&(this.state=Gt.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class Em extends Ku{constructor(e){super(e),this.vectorRenderer_=new Ju(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=Pe(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=xt(this.coordinateToVectorPixelTransform_,xt(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){const t=e.pixelRatio,r=e.viewState,n=r.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),Ha(a,this.layerImageRatio_));const l=Ae(a)/n,c=Je(a)/n;if(!s[Ft.ANIMATING]&&!s[Ft.INTERACTING]&&!Yi(a)){o.useContainer(null,null);const u=o.context,h=e.layerStatesArray[e.layerIndex],f=Object.assign({},h,{opacity:1}),g=Object.assign({},e,{extent:a,size:[l,c],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[f],layerIndex:0,declutter:null}),d=this.getLayer().getDeclutter();d&&(g.declutter={[d]:new Qu(9)});const p=new Xs(a,n,t,u.canvas,function(m){o.prepareFrame(g)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(g,null),o.renderDeclutter(g),o.renderDeferred(g),m())});p.addEventListener(De.CHANGE,()=>{if(p.getState()!==Gt.LOADED)return;this.image=p;const m=p.getPixelRatio(),y=eh(p.getResolution())*t/m;this.renderedResolution=y,this.coordinateToVectorPixelTransform_=os(this.coordinateToVectorPixelTransform_,l/2,c/2,1/y,-1/y,0,-r.center[0],-r.center[1])}),p.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!this.getLayer().getSource().loading&&!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,r,n,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,r,n,s):super.forEachFeatureAtCoordinate(e,t,r,n,s)}}class xm extends en{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new Em(this)}}class bm extends Qr{constructor(e,t){const r=t.uniforms||{},n=Pe();r[at.PROJECTION_MATRIX]=n,super(e,{uniforms:r,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new lr(Kr,Ni),this.indicesBuffer_=new lr(Jr,Ni),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:xe.FLOAT}}):[];this.attributes=[{name:"a_position",size:2,type:xe.FLOAT},{name:"a_index",size:1,type:xe.FLOAT}],this.hitDetectionEnabled_&&(this.attributes.push({name:"a_hitColor",size:4,type:xe.FLOAT}),this.attributes.push({name:"a_featureUid",size:1,type:xe.FLOAT})),this.attributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=Xr(),this.currentTransform_=n,this.renderTransform_=Pe(),this.invertRenderTransform_=Pe(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=$l(),this.worker_.addEventListener("message",a=>{const l=a.data;if(l.type===Ir.GENERATE_POINT_BUFFERS){const c=l.projectionTransform;this.verticesBuffer_.fromArrayBuffer(l.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.fromArrayBuffer(l.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=c,Ur(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),l.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[mt(o,vt.ADDFEATURE,this.handleSourceFeatureAdded_,this),mt(o,vt.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),mt(o,vt.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),mt(o,vt.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const l=a.getGeometry();l&&l.getType()==="Point"&&(this.featureCache_[ae(a)]={feature:a,properties:a.getProperties(),flatCoordinates:l.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new Hl(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,r=t.getGeometry();r&&r.getType()==="Point"&&(this.featureCache_[ae(t)]={feature:t,properties:t.getProperties(),flatCoordinates:r.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,r=ae(t),n=this.featureCache_[r],s=t.getGeometry();n?s&&s.getType()==="Point"?(n.properties=t.getProperties(),n.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[r],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[r]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,r=ae(t);r in this.featureCache_&&(delete this.featureCache_[r],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=Zl(e,this.getLayer());return this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[Ft.ANIMATING]&&!e.viewHints[Ft.INTERACTING],o=!Gr(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,u=t instanceof en?t.getRenderBuffer():0,h=hs(e.extent,u*c);r.loadFeatures(h,c,l),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0}rebuildBuffers_(e){const t=Pe();this.helper.makeProjectionTransform(e,t);const n=(this.hitDetectionEnabled_?7:2)+this.customAttributes.length,s=n*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const l=[];let c=-1;e.viewState.projection;for(const h in this.featureCache_){const f=this.featureCache_[h];if(a[0]=f.flatCoordinates[0],a[1]=f.flatCoordinates[1],xt(t,a),o[++c]=a[0],o[++c]=a[1],this.hitDetectionEnabled_){const g=Vl(c+5,l);o[++c]=g[0],o[++c]=g[1],o[++c]=g[2],o[++c]=g[3],o[++c]=Number(h)}for(let g=0;g<this.customAttributes.length;g++){const d=this.customAttributes[g].callback(f.feature,f.properties);o[++c]=d}}const u={id:++this.lastSentId,type:Ir.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:n-2};u.projectionTransform=t,this.ready=!1,this.worker_.postMessage(u,[o.buffer])}forEachFeatureAtCoordinate(e,t,r,n,s){if(Ze(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=xt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=jl(l),u=this.renderInstructions_[c],h=Math.floor(u).toString(),g=this.getLayer().getSource().getFeatureByUid(h);if(g)return n(g,this.getLayer(),null)}renderWorlds(e,t,r,n,s){let o=r;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0)),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes);do{this.helper.makeProjectionTransform(e,this.currentTransform_),as(this.currentTransform_,o*s,0),Dr(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const a=this.indicesBuffer_.getSize();this.helper.drawElements(0,a)}while(++o<n)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){wi(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class Tm extends ps{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=Wl(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new bm(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function fa(i,e){const t=`
    attribute vec2 ${yi.TEXTURE_COORD};
    uniform mat4 ${V.TILE_TRANSFORM};
    uniform float ${V.TEXTURE_PIXEL_WIDTH};
    uniform float ${V.TEXTURE_PIXEL_HEIGHT};
    uniform float ${V.TEXTURE_RESOLUTION};
    uniform float ${V.TEXTURE_ORIGIN_X};
    uniform float ${V.TEXTURE_ORIGIN_Y};
    uniform float ${V.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${yi.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${V.TEXTURE_ORIGIN_X} + ${V.TEXTURE_RESOLUTION} * ${V.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${V.TEXTURE_ORIGIN_Y} - ${V.TEXTURE_RESOLUTION} * ${V.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${V.TILE_TRANSFORM} * vec4(${yi.TEXTURE_COORD}, ${V.DEPTH}, 1.0);
    }
  `,r={...Bs(),bandCount:e},n=[];if(i.color!==void 0){const h=G(r,i.color,Ge);n.push(`color = ${h};`)}if(i.contrast!==void 0){const h=G(r,i.contrast,te);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb - (${h} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.exposure!==void 0){const h=G(r,i.exposure,te);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.saturation!==void 0){const h=G(r,i.saturation,te);n.push(`
      float saturation = ${h} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(i.gamma!==void 0){const h=G(r,i.gamma,te);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${h}));`)}if(i.brightness!==void 0){const h=G(r,i.brightness,te);n.push(`color.rgb = clamp(color.rgb + ${h}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(r.variables).length;if(o>1&&!i.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let h=0;h<o;++h){const f=r.variables[Object.keys(r.variables)[h]];if(!(f.name in i.variables))throw new Error(`Missing '${f.name}' in style variables`);const g=ln(f.name);s[g]=function(){let d=i.variables[f.name];return typeof d=="string"&&(d=cr(d)),d!==void 0?d:-9999999}}const a=Object.keys(s).map(function(h){return`uniform float ${h};`}),l=Math.ceil(e/4);a.push(`uniform sampler2D ${V.TILE_TEXTURE_ARRAY}[${l}];`),r.paletteTextures&&a.push(`uniform sampler2D ${Nl}[${r.paletteTextures.length}];`);const c=Object.keys(r.functions).map(function(h){return r.functions[h]}),u=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${V.RENDER_EXTENT};
    uniform float ${V.TRANSITION_ALPHA};
    uniform float ${V.TEXTURE_PIXEL_WIDTH};
    uniform float ${V.TEXTURE_PIXEL_HEIGHT};
    uniform float ${V.RESOLUTION};
    uniform float ${V.ZOOM};

    ${a.join(`
`)}

    ${c.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${V.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${V.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${V.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${V.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${V.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${V.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:u,uniforms:s,paletteTextures:r.paletteTextures}}class Gi extends th{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(zn.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=fa(this.style_,this.getSourceBandCount_());return new Xp(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let n;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(n=r.renderFrame(e));return n}render(e,t){this.rendered=!0;const r=e.viewState,n=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,l=n.length;a<l;++a){const c=n[a],u=c.getState();if(u=="loading"){const h=()=>{c.getState()=="ready"&&(c.removeEventListener("change",h),this.changed())};c.addEventListener("change",h)}s=s&&u=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(l=>!n.includes(l));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=fa(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}Gi.prototype.dispose;class wm extends ps{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new Yl(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}var Ne=(i,e,t)=>new Promise((r,n)=>{var s=l=>{try{a(t.next(l))}catch(c){n(c)}},o=l=>{try{a(t.throw(l))}catch(c){n(c)}},a=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(i,e)).next())}),$e=Uint8Array,Cr=Uint16Array,Sm=Int32Array,ql=new $e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Kl=new $e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Rm=new $e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Jl=function(i,e){for(var t=new Cr(31),r=0;r<31;++r)t[r]=e+=1<<i[r-1];for(var n=new Sm(t[30]),r=1;r<30;++r)for(var s=t[r];s<t[r+1];++s)n[s]=s-t[r]<<5|r;return{b:t,r:n}},Ql=Jl(ql,2),ec=Ql.b,vm=Ql.r;ec[28]=258,vm[258]=28;var Pm=Jl(Kl,0),Am=Pm.b,tc=new Cr(32768);for(ce=0;ce<32768;++ce)gt=(ce&43690)>>1|(ce&21845)<<1,gt=(gt&52428)>>2|(gt&13107)<<2,gt=(gt&61680)>>4|(gt&3855)<<4,tc[ce]=((gt&65280)>>8|(gt&255)<<8)>>1;var gt,ce,Fr=function(i,e,t){for(var r=i.length,n=0,s=new Cr(e);n<r;++n)i[n]&&++s[i[n]-1];var o=new Cr(e);for(n=1;n<e;++n)o[n]=o[n-1]+s[n-1]<<1;var a;{a=new Cr(1<<e);var l=15-e;for(n=0;n<r;++n)if(i[n])for(var c=n<<4|i[n],u=e-i[n],h=o[i[n]-1]++<<u,f=h|(1<<u)-1;h<=f;++h)a[tc[h]>>l]=c}return a},ei=new $e(288);for(ce=0;ce<144;++ce)ei[ce]=8;var ce;for(ce=144;ce<256;++ce)ei[ce]=9;var ce;for(ce=256;ce<280;++ce)ei[ce]=7;var ce;for(ce=280;ce<288;++ce)ei[ce]=8;var ce,rc=new $e(32);for(ce=0;ce<32;++ce)rc[ce]=5;var ce,Lm=Fr(ei,9),Im=Fr(rc,5),Tn=function(i){for(var e=i[0],t=1;t<i.length;++t)i[t]>e&&(e=i[t]);return e},Ye=function(i,e,t){var r=e/8|0;return(i[r]|i[r+1]<<8)>>(e&7)&t},wn=function(i,e){var t=e/8|0;return(i[t]|i[t+1]<<8|i[t+2]<<16)>>(e&7)},Cm=function(i){return(i+7)/8|0},Fm=function(i,e,t){(t==null||t>i.length)&&(t=i.length);var r=new $e(t-e);return r.set(i.subarray(e,t)),r},Om=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],ke=function(i,e,t){var r=new Error(e||Om[i]);if(r.code=i,Error.captureStackTrace&&Error.captureStackTrace(r,ke),!t)throw r;return r},Ws=function(i,e,t,r){var n=i.length,s=0;if(!n||e.f&&!e.l)return t||new $e(0);var o=!t||e.i!=2,a=e.i;t||(t=new $e(n*3));var l=function(ft){var si=t.length;if(ft>si){var oi=new $e(Math.max(si*2,ft));oi.set(t),t=oi}},c=e.f||0,u=e.p||0,h=e.b||0,f=e.l,g=e.d,d=e.m,p=e.n,m=n*8;do{if(!f){c=Ye(i,u,1);var y=Ye(i,u+1,3);if(u+=3,y)if(y==1)f=Lm,g=Im,d=9,p=5;else if(y==2){var S=Ye(i,u,31)+257,T=Ye(i,u+10,15)+4,v=S+Ye(i,u+5,31)+1;u+=14;for(var A=new $e(v),L=new $e(19),R=0;R<T;++R)L[Rm[R]]=Ye(i,u+R*3,7);u+=T*3;for(var N=Tn(L),O=(1<<N)-1,k=Fr(L,N),R=0;R<v;){var $=k[Ye(i,u,O)];u+=$&15;var _=$>>4;if(_<16)A[R++]=_;else{var D=0,re=0;for(_==16?(re=3+Ye(i,u,3),u+=2,D=A[R-1]):_==17?(re=3+Ye(i,u,7),u+=3):_==18&&(re=11+Ye(i,u,127),u+=7);re--;)A[R++]=D}}var z=A.subarray(0,S),H=A.subarray(S);d=Tn(z),p=Tn(H),f=Fr(z,d),g=Fr(H,p)}else ke(1);else{var _=Cm(u)+4,E=i[_-4]|i[_-3]<<8,w=_+E;if(w>n){a&&ke(0);break}o&&l(h+E),t.set(i.subarray(_,w),h),e.b=h+=E,e.p=u=w*8,e.f=c;continue}if(u>m){a&&ke(0);break}}o&&l(h+131072);for(var Q=(1<<d)-1,ie=(1<<p)-1,he=u;;he=u){var D=f[wn(i,u)&Q],_e=D>>4;if(u+=D&15,u>m){a&&ke(0);break}if(D||ke(2),_e<256)t[h++]=_e;else if(_e==256){he=u,f=null;break}else{var fe=_e-254;if(_e>264){var R=_e-257,Ee=ql[R];fe=Ye(i,u,(1<<Ee)-1)+ec[R],u+=Ee}var Re=g[wn(i,u)&ie],we=Re>>4;Re||ke(3),u+=Re&15;var H=Am[we];if(we>3){var Ee=Kl[we];H+=wn(i,u)&(1<<Ee)-1,u+=Ee}if(u>m){a&&ke(0);break}o&&l(h+131072);var Ie=h+fe;if(h<H){var Xt=s-H,Wt=Math.min(H,Ie);for(Xt+h<0&&ke(3);h<Wt;++h)t[h]=r[Xt+h]}for(;h<Ie;h+=4)t[h]=t[h-H],t[h+1]=t[h+1-H],t[h+2]=t[h+2-H],t[h+3]=t[h+3-H];h=Ie}}e.l=f,e.p=he,e.b=h,e.f=c,f&&(c=1,e.m=d,e.d=g,e.n=p)}while(!c);return h==t.length?t:Fm(t,0,h)},Mm=new $e(0),Nm=function(i){(i[0]!=31||i[1]!=139||i[2]!=8)&&ke(6,"invalid gzip data");var e=i[3],t=10;e&4&&(t+=(i[10]|i[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!i[t++]);return t+(e&2)},Dm=function(i){var e=i.length;return(i[e-4]|i[e-3]<<8|i[e-2]<<16|i[e-1]<<24)>>>0},Um=function(i,e){return((i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31)&&ke(6,"invalid zlib data"),(i[1]>>5&1)==1&&ke(6,"invalid zlib data: "+(i[1]&32?"need":"unexpected")+" dictionary"),(i[1]>>3&4)+2};function Bm(i,e){return Ws(i,{i:2},e,e)}function Gm(i,e){var t=Nm(i);return t+8>i.length&&ke(6,"invalid gzip data"),Ws(i.subarray(t,-8),{i:2},new $e(Dm(i)),e)}function zm(i,e){return Ws(i.subarray(Um(i),-4),{i:2},e,e)}function Hn(i,e){return i[0]==31&&i[1]==139&&i[2]==8?Gm(i,e):(i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31?Bm(i,e):zm(i,e)}var km=typeof TextDecoder<"u"&&new TextDecoder,$m=0;try{km.decode(Mm,{stream:!0}),$m=1}catch{}var ic=(i,e)=>i*Math.pow(2,e),Sr=(i,e)=>Math.floor(i/Math.pow(2,e)),zi=(i,e)=>ic(i.getUint16(e+1,!0),8)+i.getUint8(e),nc=(i,e)=>ic(i.getUint32(e+2,!0),16)+i.getUint16(e,!0),Vm=(i,e,t,r,n)=>{if(i!=r.getUint8(n))return i-r.getUint8(n);const s=zi(r,n+1);if(e!=s)return e-s;const o=zi(r,n+4);return t!=o?t-o:0},jm=(i,e,t,r)=>{const n=sc(i,e|128,t,r);return n?{z:e,x:t,y:r,offset:n[0],length:n[1],is_dir:!0}:null},da=(i,e,t,r)=>{const n=sc(i,e,t,r);return n?{z:e,x:t,y:r,offset:n[0],length:n[1],is_dir:!1}:null},sc=(i,e,t,r)=>{let n=0,s=i.byteLength/17-1;for(;n<=s;){const o=s+n>>1,a=Vm(e,t,r,i,o*17);if(a>0)n=o+1;else if(a<0)s=o-1;else return[nc(i,o*17+7),i.getUint32(o*17+13,!0)]}return null},Xm=(i,e)=>i.is_dir&&!e.is_dir?1:!i.is_dir&&e.is_dir?-1:i.z!==e.z?i.z-e.z:i.x!==e.x?i.x-e.x:i.y-e.y,oc=(i,e)=>{const t=i.getUint8(e*17);return{z:t&127,x:zi(i,e*17+1),y:zi(i,e*17+4),offset:nc(i,e*17+7),length:i.getUint32(e*17+13,!0),is_dir:t>>7===1}},ga=i=>{const e=[],t=new DataView(i);for(let r=0;r<t.byteLength/17;r++)e.push(oc(t,r));return Wm(e)},Wm=i=>{i.sort(Xm);const e=new ArrayBuffer(17*i.length),t=new Uint8Array(e);for(let r=0;r<i.length;r++){const n=i[r];let s=n.z;n.is_dir&&(s=s|128),t[r*17]=s,t[r*17+1]=n.x&255,t[r*17+2]=n.x>>8&255,t[r*17+3]=n.x>>16&255,t[r*17+4]=n.y&255,t[r*17+5]=n.y>>8&255,t[r*17+6]=n.y>>16&255,t[r*17+7]=n.offset&255,t[r*17+8]=Sr(n.offset,8)&255,t[r*17+9]=Sr(n.offset,16)&255,t[r*17+10]=Sr(n.offset,24)&255,t[r*17+11]=Sr(n.offset,32)&255,t[r*17+12]=Sr(n.offset,48)&255,t[r*17+13]=n.length&255,t[r*17+14]=n.length>>8&255,t[r*17+15]=n.length>>16&255,t[r*17+16]=n.length>>24&255}return e},Hm=(i,e)=>{if(i.byteLength<17)return null;const t=i.byteLength/17,r=oc(i,t-1);if(r.is_dir){const n=r.z,s=e.z-n,o=Math.trunc(e.x/(1<<s)),a=Math.trunc(e.y/(1<<s));return{z:n,x:o,y:a}}return null};function Zm(i){return Ne(this,null,function*(){const e=yield i.getBytes(0,512e3),t=new DataView(e.data),r=t.getUint32(4,!0),n=t.getUint16(8,!0),s=new TextDecoder("utf-8"),o=JSON.parse(s.decode(new DataView(e.data,10,r)));let a=0;o.compression==="gzip"&&(a=2);let l=0;"minzoom"in o&&(l=+o.minzoom);let c=0;"maxzoom"in o&&(c=+o.maxzoom);let u=0,h=0,f=0,g=-180,d=-85,p=180,m=85;if(o.bounds){const _=o.bounds.split(",");g=+_[0],d=+_[1],p=+_[2],m=+_[3]}if(o.center){const _=o.center.split(",");u=+_[0],h=+_[1],f=+_[2]}return{specVersion:t.getUint16(2,!0),rootDirectoryOffset:10+r,rootDirectoryLength:n*17,jsonMetadataOffset:10,jsonMetadataLength:r,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:a,tileType:1,minZoom:l,maxZoom:c,minLon:g,minLat:d,maxLon:p,maxLat:m,centerZoom:f,centerLon:u,centerLat:h,etag:e.etag}})}function Ym(i,e,t,r,n,s,o){return Ne(this,null,function*(){let a=yield t.getArrayBuffer(e,i.rootDirectoryOffset,i.rootDirectoryLength,i);i.specVersion===1&&(a=ga(a));const l=da(new DataView(a),r,n,s);if(l){let h=(yield e.getBytes(l.offset,l.length,o)).data;const f=new DataView(h);return f.getUint8(0)==31&&f.getUint8(1)==139&&(h=Hn(new Uint8Array(h))),{data:h}}const c=Hm(new DataView(a),{z:r,x:n,y:s});if(c){const u=jm(new DataView(a),c.z,c.x,c.y);if(u){let h=yield t.getArrayBuffer(e,u.offset,u.length,i);i.specVersion===1&&(h=ga(h));const f=da(new DataView(h),r,n,s);if(f){let d=(yield e.getBytes(f.offset,f.length,o)).data;const p=new DataView(d);return p.getUint8(0)==31&&p.getUint8(1)==139&&(d=Hn(new Uint8Array(d))),{data:d}}}}})}var ac={getHeader:Zm,getZxy:Ym};function Kt(i,e){return(e>>>0)*4294967296+(i>>>0)}function qm(i,e){const t=e.buf;let r,n;if(n=t[e.pos++],r=(n&112)>>4,n<128||(n=t[e.pos++],r|=(n&127)<<3,n<128)||(n=t[e.pos++],r|=(n&127)<<10,n<128)||(n=t[e.pos++],r|=(n&127)<<17,n<128)||(n=t[e.pos++],r|=(n&127)<<24,n<128)||(n=t[e.pos++],r|=(n&1)<<31,n<128))return Kt(i,r);throw new Error("Expected varint not more than 10 bytes")}function Rr(i){const e=i.buf;let t,r;return r=e[i.pos++],t=r&127,r<128||(r=e[i.pos++],t|=(r&127)<<7,r<128)||(r=e[i.pos++],t|=(r&127)<<14,r<128)||(r=e[i.pos++],t|=(r&127)<<21,r<128)?t:(r=e[i.pos],t|=(r&15)<<28,qm(t,i))}function Km(i,e,t,r){if(r==0){t==1&&(e[0]=i-1-e[0],e[1]=i-1-e[1]);const n=e[0];e[0]=e[1],e[1]=n}}var Jm=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function Qm(i,e,t){if(i>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(e>Math.pow(2,i)-1||t>Math.pow(2,i)-1)throw Error("tile x/y outside zoom level bounds");const r=Jm[i],n=Math.pow(2,i);let s=0,o=0,a=0;const l=[e,t];let c=n/2;for(;c>0;)s=(l[0]&c)>0?1:0,o=(l[1]&c)>0?1:0,a+=c*c*(3*s^o),Km(c,l,s,o),c=c/2;return r+a}function lc(i,e){return Ne(this,null,function*(){if(e===1||e===0)return i;if(e===2){if(typeof globalThis.DecompressionStream>"u")return Hn(new Uint8Array(i));{let r=new Response(i).body.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(r).arrayBuffer()}}else throw Error("Compression method not supported")})}var tr=(i=>(i[i.Unknown=0]="Unknown",i[i.Mvt=1]="Mvt",i[i.Png=2]="Png",i[i.Jpeg=3]="Jpeg",i[i.Webp=4]="Webp",i[i.Avif=5]="Avif",i))(tr||{}),e_=127;function t_(i,e){let t=0,r=i.length-1;for(;t<=r;){const n=r+t>>1,s=e-i[n].tileId;if(s>0)t=n+1;else if(s<0)r=n-1;else return i[n]}return r>=0&&(i[r].runLength===0||e-i[r].tileId<i[r].runLength)?i[r]:null}var r_=class{constructor(i,e=new Headers){this.url=i,this.customHeaders=e}getKey(){return this.url}setHeaders(i){this.customHeaders=i}getBytes(i,e,t){return Ne(this,null,function*(){let r;t||(r=new AbortController,t=r.signal);const n=new Headers(this.customHeaders);n.set("Range","bytes="+i+"-"+(i+e-1));let s=yield fetch(this.url,{signal:t,headers:n});if(s.status===416&&i===0){const l=s.headers.get("Content-Range");if(!l||!l.startsWith("bytes */"))throw Error("Missing content-length on 416 response");const c=+l.substr(8);s=yield fetch(this.url,{signal:t,headers:{Range:"bytes=0-"+(c-1)}})}if(s.status>=300)throw Error("Bad response code: "+s.status);const o=s.headers.get("Content-Length");if(s.status===200&&(!o||+o>e))throw r&&r.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield s.arrayBuffer(),etag:s.headers.get("ETag")||void 0,cacheControl:s.headers.get("Cache-Control")||void 0,expires:s.headers.get("Expires")||void 0}})}};function qe(i,e){const t=i.getUint32(e+4,!0),r=i.getUint32(e+0,!0);return t*Math.pow(2,32)+r}function i_(i,e){const t=new DataView(i),r=t.getUint8(7);if(r>3)throw Error(`Archive is spec version ${r} but this library supports up to spec version 3`);return{specVersion:r,rootDirectoryOffset:qe(t,8),rootDirectoryLength:qe(t,16),jsonMetadataOffset:qe(t,24),jsonMetadataLength:qe(t,32),leafDirectoryOffset:qe(t,40),leafDirectoryLength:qe(t,48),tileDataOffset:qe(t,56),tileDataLength:qe(t,64),numAddressedTiles:qe(t,72),numTileEntries:qe(t,80),numTileContents:qe(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}function cc(i){const e={buf:new Uint8Array(i),pos:0},t=Rr(e),r=[];let n=0;for(let s=0;s<t;s++){const o=Rr(e);r.push({tileId:n+o,offset:0,length:0,runLength:1}),n+=o}for(let s=0;s<t;s++)r[s].runLength=Rr(e);for(let s=0;s<t;s++)r[s].length=Rr(e);for(let s=0;s<t;s++){const o=Rr(e);o===0&&s>0?r[s].offset=r[s-1].offset+r[s-1].length:r[s].offset=o-1}return r}function n_(i){const e=new DataView(i);return e.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):e.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var ir=class extends Error{};function s_(i,e,t,r){return Ne(this,null,function*(){const n=yield i.getBytes(0,16384);if(new DataView(n.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(n_(n.data)<3)return[yield ac.getHeader(i)];const o=n.data.slice(0,e_);let a=n.etag;r&&n.etag!=r&&(console.warn("ETag conflict detected; your HTTP server might not support content-based ETag headers. ETags disabled for "+i.getKey()),a=void 0);const l=i_(o,a);if(t){const c=n.data.slice(l.rootDirectoryOffset,l.rootDirectoryOffset+l.rootDirectoryLength),u=i.getKey()+"|"+(l.etag||"")+"|"+l.rootDirectoryOffset+"|"+l.rootDirectoryLength,h=cc(yield e(c,l.internalCompression));return[l,[u,h.length,h]]}return[l,void 0]})}function o_(i,e,t,r,n){return Ne(this,null,function*(){const s=yield i.getBytes(t,r);if(n.etag&&n.etag!==s.etag)throw new ir(s.etag);const o=yield e(s.data,n.internalCompression),a=cc(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}var a_=class{constructor(i=100,e=!0,t=lc){this.cache=new Map,this.maxCacheEntries=i,this.counter=1,this.prefetch=e,this.decompress=t}getHeader(i,e){return Ne(this,null,function*(){const t=i.getKey();if(this.cache.has(t))return this.cache.get(t).lastUsed=this.counter++,yield this.cache.get(t).data;const r=new Promise((n,s)=>{s_(i,this.decompress,this.prefetch,e).then(o=>{o[1]&&this.cache.set(o[1][0],{lastUsed:this.counter++,data:Promise.resolve(o[1][2])}),n(o[0]),this.prune()}).catch(o=>{s(o)})});return this.cache.set(t,{lastUsed:this.counter++,data:r}),r})}getDirectory(i,e,t,r){return Ne(this,null,function*(){const n=i.getKey()+"|"+(r.etag||"")+"|"+e+"|"+t;if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,yield this.cache.get(n).data;const s=new Promise((o,a)=>{o_(i,this.decompress,e,t,r).then(l=>{o(l),this.prune()}).catch(l=>{a(l)})});return this.cache.set(n,{lastUsed:this.counter++,data:s}),s})}getArrayBuffer(i,e,t,r){return Ne(this,null,function*(){const n=i.getKey()+"|"+(r.etag||"")+"|"+e+"|"+t;if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,yield this.cache.get(n).data;const s=new Promise((o,a)=>{i.getBytes(e,t).then(l=>{if(r.etag&&r.etag!==l.etag)throw new ir(l.etag);o(l.data),this.cache.has(n),this.prune()}).catch(l=>{a(l)})});return this.cache.set(n,{lastUsed:this.counter++,data:s}),s})}prune(){if(this.cache.size>=this.maxCacheEntries){let i=1/0,e;this.cache.forEach((t,r)=>{t.lastUsed<i&&(i=t.lastUsed,e=r)}),e&&this.cache.delete(e)}}invalidate(i,e){return Ne(this,null,function*(){this.cache.delete(i.getKey()),yield this.getHeader(i,e)})}},Hs=class{constructor(i,e,t){typeof i=="string"?this.source=new r_(i):this.source=i,t?this.decompress=t:this.decompress=lc,e?this.cache=e:this.cache=new a_}getHeader(){return Ne(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(i,e,t,r){return Ne(this,null,function*(){const n=Qm(i,e,t),s=yield this.cache.getHeader(this.source);if(s.specVersion<3)return ac.getZxy(s,this.source,this.cache,i,e,t,r);if(i<s.minZoom||i>s.maxZoom)return;let o=s.rootDirectoryOffset,a=s.rootDirectoryLength;for(let l=0;l<=3;l++){const c=yield this.cache.getDirectory(this.source,o,a,s),u=t_(c,n);if(u)if(u.runLength>0){const h=yield this.source.getBytes(s.tileDataOffset+u.offset,u.length,r);if(s.etag&&s.etag!==h.etag)throw new ir(h.etag);return{data:yield this.decompress(h.data,s.tileCompression),cacheControl:h.cacheControl,expires:h.expires}}else o=s.leafDirectoryOffset+u.offset,a=u.length;else return}throw Error("Maximum directory depth exceeded")})}getZxy(i,e,t,r){return Ne(this,null,function*(){try{return yield this.getZxyAttempt(i,e,t,r)}catch(n){if(n instanceof ir)return this.cache.invalidate(this.source,n.message),yield this.getZxyAttempt(i,e,t,r);throw n}})}getMetadataAttempt(){return Ne(this,null,function*(){const i=yield this.cache.getHeader(this.source),e=yield this.source.getBytes(i.jsonMetadataOffset,i.jsonMetadataLength);if(i.etag&&i.etag!==e.etag)throw new ir(e.etag);const t=yield this.decompress(e.data,i.internalCompression),r=new TextDecoder("utf-8");return JSON.parse(r.decode(t))})}getMetadata(){return Ne(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(i){if(i instanceof ir)return this.cache.invalidate(this.source,i.message),yield this.getMetadataAttempt();throw i}})}};class l_ extends Za{constructor(e){super(De.ERROR),this.error=e}}function Le(i){return(e,...t)=>c_(i,e,t)}function br(i,e){return Le(uc(i,e).get)}const{apply:c_,getOwnPropertyDescriptor:uc,getPrototypeOf:Zs,ownKeys:u_}=Reflect,{iterator:ti,toStringTag:h_}=Symbol,f_=Object,{create:Ys,defineProperty:d_}=f_,g_=Array,p_=g_.prototype,hc=p_[ti],m_=Le(hc),fc=ArrayBuffer,__=fc.prototype;br(__,"byteLength");const pa=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;pa&&br(pa.prototype,"byteLength");const dc=Zs(Uint8Array);dc.from;const Ue=dc.prototype;Ue[ti];Le(Ue.keys);Le(Ue.values);Le(Ue.entries);Le(Ue.set);Le(Ue.reverse);Le(Ue.fill);Le(Ue.copyWithin);Le(Ue.sort);Le(Ue.slice);Le(Ue.subarray);br(Ue,"buffer");br(Ue,"byteOffset");br(Ue,"length");br(Ue,h_);const y_=Uint8Array,gc=Uint16Array,qs=Uint32Array,E_=Float32Array,$r=Zs([][ti]()),pc=Le($r.next),x_=Le(function*(){}().next),b_=Zs($r),T_=DataView.prototype,w_=Le(T_.getUint16),Ks=WeakMap,mc=Ks.prototype,_c=Le(mc.get),S_=Le(mc.set),yc=new Ks,R_=Ys(null,{next:{value:function(){const e=_c(yc,this);return pc(e)}},[ti]:{value:function(){return this}}});function v_(i){if(i[ti]===hc&&$r.next===pc)return i;const e=Ys(R_);return S_(yc,e,m_(i)),e}const P_=new Ks,A_=Ys(b_,{next:{value:function(){const e=_c(P_,this);return x_(e)},writable:!0,configurable:!0}});for(const i of u_($r))i!=="next"&&d_(A_,i,uc($r,i));const Ec=new fc(4),L_=new E_(Ec),I_=new qs(Ec),nt=new gc(512),st=new y_(512);for(let i=0;i<256;++i){const e=i-127;e<-24?(nt[i]=0,nt[i|256]=32768,st[i]=24,st[i|256]=24):e<-14?(nt[i]=1024>>-e-14,nt[i|256]=1024>>-e-14|32768,st[i]=-e-1,st[i|256]=-e-1):e<=15?(nt[i]=e+15<<10,nt[i|256]=e+15<<10|32768,st[i]=13,st[i|256]=13):e<128?(nt[i]=31744,nt[i|256]=64512,st[i]=24,st[i|256]=24):(nt[i]=31744,nt[i|256]=64512,st[i]=13,st[i|256]=13)}const Js=new qs(2048);for(let i=1;i<1024;++i){let e=i<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,Js[i]=e|t}for(let i=1024;i<2048;++i)Js[i]=939524096+(i-1024<<13);const Tr=new qs(64);for(let i=1;i<31;++i)Tr[i]=i<<23;Tr[31]=1199570944;Tr[32]=2147483648;for(let i=33;i<63;++i)Tr[i]=2147483648+(i-32<<23);Tr[63]=3347054592;const xc=new gc(64);for(let i=1;i<64;++i)i!==32&&(xc[i]=1024);function C_(i){const e=i>>10;return I_[0]=Js[xc[e]+(i&1023)]+Tr[e],L_[0]}function bc(i,e,...t){return C_(w_(i,e,...v_(t)))}var Qs={exports:{}};function Tc(i,e,t){const r=t&&t.debug||!1;r&&console.log("[xml-utils] getting "+e+" in "+i);const n=typeof i=="object"?i.outer:i,s=n.slice(0,n.indexOf(">")+1),o=['"',"'"];for(let a=0;a<o.length;a++){const l=o[a],c=e+"\\="+l+"([^"+l+"]*)"+l;r&&console.log("[xml-utils] pattern:",c);const h=new RegExp(c).exec(s);if(r&&console.log("[xml-utils] match:",h),h)return h[1]}}Qs.exports=Tc;Qs.exports.default=Tc;var F_=Qs.exports;const Sn=cl(F_);var eo={exports:{}},to={exports:{}},ro={exports:{}};function wc(i,e,t){const n=new RegExp(e).exec(i.slice(t));return n?t+n.index:-1}ro.exports=wc;ro.exports.default=wc;var O_=ro.exports,io={exports:{}};function Sc(i,e,t){const n=new RegExp(e).exec(i.slice(t));return n?t+n.index+n[0].length-1:-1}io.exports=Sc;io.exports.default=Sc;var M_=io.exports,no={exports:{}};function Rc(i,e){const t=new RegExp(e,"g"),r=i.match(t);return r?r.length:0}no.exports=Rc;no.exports.default=Rc;var N_=no.exports;const D_=O_,Rn=M_,ma=N_;function vc(i,e,t){const r=t&&t.debug||!1,n=!(t&&typeof t.nested===!1),s=t&&t.startIndex||0;r&&console.log("[xml-utils] starting findTagByName with",e," and ",t);const o=D_(i,`<${e}[ 
>/]`,s);if(r&&console.log("[xml-utils] start:",o),o===-1)return;const a=i.slice(o+e.length);let l=Rn(a,"^[^<]*[ /]>",0);const c=l!==-1&&a[l-1]==="/";if(r&&console.log("[xml-utils] selfClosing:",c),c===!1)if(n){let g=0,d=1,p=0;for(;(l=Rn(a,"[ /]"+e+">",g))!==-1;){const m=a.substring(g,l+1);if(d+=ma(m,"<"+e+`[ 
	>]`),p+=ma(m,"</"+e+">"),p>=d)break;g=l}}else l=Rn(a,"[ /]"+e+">",0);const u=o+e.length+l+1;if(r&&console.log("[xml-utils] end:",u),u===-1)return;const h=i.slice(o,u);let f;return c?f=null:f=h.slice(h.indexOf(">")+1,h.lastIndexOf("<")),{inner:f,outer:h,start:o,end:u}}to.exports=vc;to.exports.default=vc;var U_=to.exports;const B_=U_;function Pc(i,e,t){const r=[],n=t&&t.debug||!1,s=t&&typeof t.nested=="boolean"?t.nested:!0;let o=t&&t.startIndex||0,a;for(;a=B_(i,e,{debug:n,startIndex:o});)s?o=a.start+1+e.length:o=a.end,r.push(a);return n&&console.log("findTagsByName found",r.length,"tags"),r}eo.exports=Pc;eo.exports.default=Pc;var G_=eo.exports;const z_=cl(G_),Or={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},ot={};for(const i in Or)Or.hasOwnProperty(i)&&(ot[Or[i]]=parseInt(i,10));const k_=[ot.BitsPerSample,ot.ExtraSamples,ot.SampleFormat,ot.StripByteCounts,ot.StripOffsets,ot.StripRowCounts,ot.TileByteCounts,ot.TileOffsets,ot.SubIFDs],vn={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},W={};for(const i in vn)vn.hasOwnProperty(i)&&(W[vn[i]]=parseInt(i,10));const Be={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},$_={Unspecified:0},jE={AddCompression:1},XE={None:0,Deflate:1,Zstandard:2},V_={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function j_(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<i.length;++o,a+=3)s=256-i[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function X_(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<i.length;++o,a+=3)s=i[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function W_(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3),s=e.length/3,o=e.length/3*2;for(let a=0,l=0;a<i.length;++a,l+=3){const c=i[a];n[l]=e[c]/65536*256,n[l+1]=e[c+s]/65536*256,n[l+2]=e[c+o]/65536*256}return n}function H_(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let n=0,s=0;n<i.length;n+=4,s+=3){const o=i[n],a=i[n+1],l=i[n+2],c=i[n+3];r[s]=255*((255-o)/256)*((255-c)/256),r[s+1]=255*((255-a)/256)*((255-c)/256),r[s+2]=255*((255-l)/256)*((255-c)/256)}return r}function Z_(i){const{width:e,height:t}=i,r=new Uint8ClampedArray(e*t*3);for(let n=0,s=0;n<i.length;n+=3,s+=3){const o=i[n],a=i[n+1],l=i[n+2];r[s]=o+1.402*(l-128),r[s+1]=o-.34414*(a-128)-.71414*(l-128),r[s+2]=o+1.772*(a-128)}return r}const Y_=.95047,q_=1,K_=1.08883;function J_(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let n=0,s=0;n<i.length;n+=3,s+=3){const o=i[n+0],a=i[n+1]<<24>>24,l=i[n+2]<<24>>24;let c=(o+16)/116,u=a/500+c,h=c-l/200,f,g,d;u=Y_*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),c=q_*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),h=K_*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),f=u*3.2406+c*-1.5372+h*-.4986,g=u*-.9689+c*1.8758+h*.0415,d=u*.0557+c*-.204+h*1.057,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,g=g>.0031308?1.055*g**(1/2.4)-.055:12.92*g,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,r[s]=Math.max(0,Math.min(1,f))*255,r[s+1]=Math.max(0,Math.min(1,g))*255,r[s+2]=Math.max(0,Math.min(1,d))*255}return r}const Ac=new Map;function Nt(i,e){Array.isArray(i)||(i=[i]),i.forEach(t=>Ac.set(t,e))}async function Lc(i){const e=Ac.get(i.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${i.Compression}`);const t=await e();return new t(i)}Nt([void 0,1],()=>Mt(()=>import("./raw.DxtaBMev.js"),__vite__mapDeps([0,1])).then(i=>i.default));Nt(5,()=>Mt(()=>import("./lzw.BikwkTY2.js"),__vite__mapDeps([2,1])).then(i=>i.default));Nt(6,()=>{throw new Error("old style JPEG compression is not supported.")});Nt(7,()=>Mt(()=>import("./jpeg.CbvpOiPg.js"),__vite__mapDeps([3,1])).then(i=>i.default));Nt([8,32946],()=>Mt(()=>import("./deflate.B4_27dB1.js"),__vite__mapDeps([4,5,1])).then(i=>i.default));Nt(32773,()=>Mt(()=>import("./packbits.D6Qr5eNi.js"),__vite__mapDeps([6,1])).then(i=>i.default));Nt(34887,()=>Mt(()=>import("./lerc.C-kgCxfD.js"),__vite__mapDeps([7,5,8,1,9,10,11,12,13,14,15])).then(async i=>(await i.zstd.init(),i)).then(i=>i.default));Nt(50001,()=>Mt(()=>import("./webimage.CU41Mh7j.js"),__vite__mapDeps([16,1])).then(i=>i.default));function un(i,e,t,r=1){return new(Object.getPrototypeOf(i)).constructor(e*t*r)}function Q_(i,e,t,r,n){const s=e/r,o=t/n;return i.map(a=>{const l=un(a,r,n);for(let c=0;c<n;++c){const u=Math.min(Math.round(o*c),t-1);for(let h=0;h<r;++h){const f=Math.min(Math.round(s*h),e-1),g=a[u*e+f];l[c*r+h]=g}}return l})}function nr(i,e,t){return(1-t)*i+t*e}function ey(i,e,t,r,n){const s=e/r,o=t/n;return i.map(a=>{const l=un(a,r,n);for(let c=0;c<n;++c){const u=o*c,h=Math.floor(u),f=Math.min(Math.ceil(u),t-1);for(let g=0;g<r;++g){const d=s*g,p=d%1,m=Math.floor(d),y=Math.min(Math.ceil(d),e-1),_=a[h*e+m],E=a[h*e+y],w=a[f*e+m],S=a[f*e+y],T=nr(nr(_,E,p),nr(w,S,p),u%1);l[c*r+g]=T}}return l})}function ty(i,e,t,r,n,s="nearest"){switch(s.toLowerCase()){case"nearest":return Q_(i,e,t,r,n);case"bilinear":case"linear":return ey(i,e,t,r,n);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function ry(i,e,t,r,n,s){const o=e/r,a=t/n,l=un(i,r,n,s);for(let c=0;c<n;++c){const u=Math.min(Math.round(a*c),t-1);for(let h=0;h<r;++h){const f=Math.min(Math.round(o*h),e-1);for(let g=0;g<s;++g){const d=i[u*e*s+f*s+g];l[c*r*s+h*s+g]=d}}}return l}function iy(i,e,t,r,n,s){const o=e/r,a=t/n,l=un(i,r,n,s);for(let c=0;c<n;++c){const u=a*c,h=Math.floor(u),f=Math.min(Math.ceil(u),t-1);for(let g=0;g<r;++g){const d=o*g,p=d%1,m=Math.floor(d),y=Math.min(Math.ceil(d),e-1);for(let _=0;_<s;++_){const E=i[h*e*s+m*s+_],w=i[h*e*s+y*s+_],S=i[f*e*s+m*s+_],T=i[f*e*s+y*s+_],v=nr(nr(E,w,p),nr(S,T,p),u%1);l[c*r*s+g*s+_]=v}}}return l}function ny(i,e,t,r,n,s,o="nearest"){switch(o.toLowerCase()){case"nearest":return ry(i,e,t,r,n,s);case"bilinear":case"linear":return iy(i,e,t,r,n,s);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function sy(i,e,t){let r=0;for(let n=e;n<t;++n)r+=i[n];return r}function Zn(i,e,t){switch(i){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function oy(i,e){return(i===1||i===2)&&e<=32&&e%8===0?!1:!(i===3&&(e===16||e===32||e===64))}function ay(i,e,t,r,n,s,o){const a=new DataView(i),l=t===2?o*s:o*s*r,c=t===2?1:r,u=Zn(e,n,l),h=parseInt("1".repeat(n),2);if(e===1){let f;t===1?f=r*n:f=n;let g=s*f;g&7&&(g=g+7&-8);for(let d=0;d<o;++d){const p=d*g;for(let m=0;m<s;++m){const y=p+m*c*n;for(let _=0;_<c;++_){const E=y+_*n,w=(d*s+m)*c+_,S=Math.floor(E/8),T=E%8;if(T+n<=8)u[w]=a.getUint8(S)>>8-n-T&h;else if(T+n<=16)u[w]=a.getUint16(S)>>16-n-T&h;else if(T+n<=24){const v=a.getUint16(S)<<8|a.getUint8(S+2);u[w]=v>>24-n-T&h}else u[w]=a.getUint32(S)>>32-n-T&h}}}}return u.buffer}class Ic{constructor(e,t,r,n,s,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=r,this.littleEndian=n,this.tiles=s?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,r=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(r<=8)return DataView.prototype.getUint8;if(r<=16)return DataView.prototype.getUint16;if(r<=32)return DataView.prototype.getUint32;break;case 2:if(r<=8)return DataView.prototype.getInt8;if(r<=16)return DataView.prototype.getInt16;if(r<=32)return DataView.prototype.getInt32;break;case 3:switch(r){case 16:return function(n,s){return bc(this,n,s)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const r=this.getSampleFormat(e),n=this.getBitsPerSample(e);return Zn(r,n,t)}async getTileOrStrip(e,t,r,n,s){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let l;const{tiles:c}=this;this.planarConfiguration===1?l=t*o+e:this.planarConfiguration===2&&(l=r*o*a+t*o+e);let u,h;this.isTiled?(u=this.fileDirectory.TileOffsets[l],h=this.fileDirectory.TileByteCounts[l]):(u=this.fileDirectory.StripOffsets[l],h=this.fileDirectory.StripByteCounts[l]);const f=(await this.source.fetch([{offset:u,length:h}],s))[0];let g;return c===null||!c[l]?(g=(async()=>{let d=await n.decode(this.fileDirectory,f);const p=this.getSampleFormat(),m=this.getBitsPerSample();return oy(p,m)&&(d=ay(d,p,this.planarConfiguration,this.getSamplesPerPixel(),m,this.getTileWidth(),this.getBlockHeight(t))),d})(),c!==null&&(c[l]=g)):g=c[l],{x:e,y:t,sample:r,data:await g}}async _readRaster(e,t,r,n,s,o,a,l,c){const u=this.getTileWidth(),h=this.getTileHeight(),f=this.getWidth(),g=this.getHeight(),d=Math.max(Math.floor(e[0]/u),0),p=Math.min(Math.ceil(e[2]/u),Math.ceil(f/u)),m=Math.max(Math.floor(e[1]/h),0),y=Math.min(Math.ceil(e[3]/h),Math.ceil(g/h)),_=e[2]-e[0];let E=this.getBytesPerPixel();const w=[],S=[];for(let A=0;A<t.length;++A)this.planarConfiguration===1?w.push(sy(this.fileDirectory.BitsPerSample,0,t[A])/8):w.push(0),S.push(this.getReaderForSample(t[A]));const T=[],{littleEndian:v}=this;for(let A=m;A<y;++A)for(let L=d;L<p;++L){let R;this.planarConfiguration===1&&(R=this.getTileOrStrip(L,A,0,s,c));for(let N=0;N<t.length;++N){const O=N,k=t[N];this.planarConfiguration===2&&(E=this.getSampleByteSize(k),R=this.getTileOrStrip(L,A,k,s,c));const $=R.then(D=>{const re=D.data,z=new DataView(re),H=this.getBlockHeight(D.y),Q=D.y*h,ie=D.x*u,he=Q+H,_e=(D.x+1)*u,fe=S[O],Ee=Math.min(H,H-(he-e[3]),g-Q),Re=Math.min(u,u-(_e-e[2]),f-ie);for(let we=Math.max(0,e[1]-Q);we<Ee;++we)for(let Ie=Math.max(0,e[0]-ie);Ie<Re;++Ie){const Xt=(we*u+Ie)*E,Wt=fe.call(z,Xt+w[O],v);let ft;n?(ft=(we+Q-e[1])*_*t.length+(Ie+ie-e[0])*t.length+O,r[ft]=Wt):(ft=(we+Q-e[1])*_+Ie+ie-e[0],r[O][ft]=Wt)}});T.push($)}}if(await Promise.all(T),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let A;return n?A=ny(r,e[2]-e[0],e[3]-e[1],o,a,t.length,l):A=ty(r,e[2]-e[0],e[3]-e[1],o,a,l),A.width=o,A.height=a,A}return r.width=o||e[2]-e[0],r.height=a||e[3]-e[1],r}async readRasters({window:e,samples:t=[],interleave:r,pool:n=null,width:s,height:o,resampleMethod:a,fillValue:l,signal:c}={}){const u=e||[0,0,this.getWidth(),this.getHeight()];if(u[0]>u[2]||u[1]>u[3])throw new Error("Invalid subsets");const h=u[2]-u[0],f=u[3]-u[1],g=h*f,d=this.getSamplesPerPixel();if(!t||!t.length)for(let _=0;_<d;++_)t.push(_);else for(let _=0;_<t.length;++_)if(t[_]>=d)return Promise.reject(new RangeError(`Invalid sample index '${t[_]}'.`));let p;if(r){const _=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,E=Math.max.apply(null,this.fileDirectory.BitsPerSample);p=Zn(_,E,g*t.length),l&&p.fill(l)}else{p=[];for(let _=0;_<t.length;++_){const E=this.getArrayForSample(t[_],g);Array.isArray(l)&&_<l.length?E.fill(l[_]):l&&!Array.isArray(l)&&E.fill(l),p.push(E)}}const m=n||await Lc(this.fileDirectory);return await this._readRaster(u,t,p,r,m,s,o,a,c)}async readRGB({window:e,interleave:t=!0,pool:r=null,width:n,height:s,resampleMethod:o,enableAlpha:a=!1,signal:l}={}){const c=e||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const u=this.fileDirectory.PhotometricInterpretation;if(u===Be.RGB){let y=[0,1,2];if(this.fileDirectory.ExtraSamples!==$_.Unspecified&&a){y=[];for(let _=0;_<this.fileDirectory.BitsPerSample.length;_+=1)y.push(_)}return this.readRasters({window:e,interleave:t,samples:y,pool:r,width:n,height:s,resampleMethod:o,signal:l})}let h;switch(u){case Be.WhiteIsZero:case Be.BlackIsZero:case Be.Palette:h=[0];break;case Be.CMYK:h=[0,1,2,3];break;case Be.YCbCr:case Be.CIELab:h=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const f={window:c,interleave:!0,samples:h,pool:r,width:n,height:s,resampleMethod:o,signal:l},{fileDirectory:g}=this,d=await this.readRasters(f),p=2**this.fileDirectory.BitsPerSample[0];let m;switch(u){case Be.WhiteIsZero:m=j_(d,p);break;case Be.BlackIsZero:m=X_(d,p);break;case Be.Palette:m=W_(d,g.ColorMap);break;case Be.CMYK:m=H_(d);break;case Be.YCbCr:m=Z_(d);break;case Be.CIELab:m=J_(d);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const y=new Uint8Array(m.length/3),_=new Uint8Array(m.length/3),E=new Uint8Array(m.length/3);for(let w=0,S=0;w<m.length;w+=3,++S)y[S]=m[w],_[S]=m[w+1],E[S]=m[w+2];m=[y,_,E]}return m.width=d.width,m.height=d.height,m}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const r=this.fileDirectory.GDAL_METADATA;let n=z_(r,"Item");e===null?n=n.filter(s=>Sn(s,"sample")===void 0):n=n.filter(s=>Number(Sn(s,"sample"))===e);for(let s=0;s<n.length;++s){const o=n[s];t[Sn(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(r)return r[1]===0&&r[4]===0?[r[0],-r[5],r[10]]:[Math.sqrt(r[0]*r[0]+r[4]*r[4]),-Math.sqrt(r[1]*r[1]+r[5]*r[5]),r[10]];if(e){const[n,s,o]=e.getResolution();return[n*e.getWidth()/this.getWidth(),s*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),r=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[n,s,o,a,l,c,u,h]=this.fileDirectory.ModelTransformation,g=[[0,0],[0,t],[r,0],[r,t]].map(([m,y])=>[a+n*m+s*y,h+l*m+c*y]),d=g.map(m=>m[0]),p=g.map(m=>m[1]);return[Math.min(...d),Math.min(...p),Math.max(...d),Math.max(...p)]}else{const n=this.getOrigin(),s=this.getResolution(),o=n[0],a=n[1],l=o+s[0]*r,c=a+s[1]*t;return[Math.min(o,l),Math.min(a,c),Math.max(o,l),Math.max(a,c)]}}}class ly{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const r=this.getUint32(e,t),n=this.getUint32(e+4,t);let s;if(t){if(s=r+2**32*n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*r+n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}getInt64(e,t){let r=0;const n=(this._dataView.getUint8(e+(t?7:0))&128)>0;let s=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));n&&(s?a!==0&&(a=~(a-1)&255,s=!1):a=~a&255),r+=a*256**o}return n&&(r=-r),r}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return bc(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class cy{constructor(e,t,r,n){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=r,this._bigTiff=n}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),r=this.readUint32(e+4);let n;if(this._littleEndian){if(n=t+2**32*r,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*t+r,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}readInt64(e){let t=0;const r=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let n=!0;for(let s=0;s<8;s++){let o=this._dataView.getUint8(e+(this._littleEndian?s:7-s));r&&(n?o!==0&&(o=~(o-1)&255,n=!1):o=~o&255),t+=o*256**s}return r&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const uy=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class hy{constructor(e=uy,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(r=>{Mt(()=>import("./decoder.tqM1uIvc.js"),[]).then(n=>{r(n.create)})}),this._awaitingDecoder.then(r=>{this._awaitingDecoder=null,this.workers=[];for(let n=0;n<e;n++)this.workers.push({worker:r(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?Lc(e).then(r=>r.decode(e,t)):new Promise(r=>{const n=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];n.idle=!1;const s=this.messageId++,o=a=>{a.data.id===s&&(n.idle=!0,r(a.data.decoded),n.worker.removeEventListener("message",o))};n.worker.addEventListener("message",o),n.worker.postMessage({fileDirectory:e,buffer:t,id:s},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const _a=`\r
\r
`;function Cc(i){if(typeof Object.fromEntries<"u")return Object.fromEntries(i);const e={};for(const[t,r]of i)e[t.toLowerCase()]=r;return e}function fy(i){const e=i.split(`\r
`).map(t=>{const r=t.split(":").map(n=>n.trim());return r[0]=r[0].toLowerCase(),r});return Cc(e)}function dy(i){const[e,...t]=i.split(";").map(n=>n.trim()),r=t.map(n=>n.split("="));return{type:e,params:Cc(r)}}function Yn(i){let e,t,r;return i&&([,e,t,r]=i.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),r=parseInt(r,10)),{start:e,end:t,total:r}}function gy(i,e){let t=null;const r=new TextDecoder("ascii"),n=[],s=`--${e}`,o=`${s}--`;for(let a=0;a<10;++a)r.decode(new Uint8Array(i,a,s.length))===s&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<i.byteLength;){const a=r.decode(new Uint8Array(i,t,Math.min(s.length+1024,i.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(s))throw new Error("Part does not start with boundary");const l=a.substr(s.length+2);if(l.length===0)break;const c=l.indexOf(_a),u=fy(l.substr(0,c)),{start:h,end:f,total:g}=Yn(u["content-range"]),d=t+s.length+c+_a.length,p=parseInt(f,10)+1-parseInt(h,10);n.push({headers:u,data:i.slice(d,d+p),offset:h,length:p,fileSize:g}),t=d+p+4}return n}class so{async fetch(e,t=void 0){return Promise.all(e.map(r=>this.fetchSlice(r,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class py extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield e)}for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const n=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:n}):this._set(e,{value:t,expiry:n}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;this.cache.has(n)||this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,n]of this.entriesAscending())e.call(t,n,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function my(i){return new Promise(e=>setTimeout(e,i))}function _y(i,e){const t=Array.isArray(i)?i:Array.from(i),r=Array.isArray(e)?e:Array.from(e);return t.map((n,s)=>[n,r[s]])}class ur extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,ur),this.name="AbortError"}}class yy extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const Ey=yy;class xy{constructor(e,t,r=null){this.offset=e,this.length=t,this.data=r}get top(){return this.offset+this.length}}class ya{constructor(e,t,r){this.offset=e,this.length=t,this.blockIds=r}}class by extends so{constructor(e,{blockSize:t=65536,cacheSize:r=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new py({maxSize:r,onEviction:(n,s)=>{this.evictedBlocks.set(n,s)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const r=[],n=[],s=[];this.evictedBlocks.clear();for(const{offset:f,length:g}of e){let d=f+g;const{fileSize:p}=this;p!==null&&(d=Math.min(d,p));const m=Math.floor(f/this.blockSize)*this.blockSize;for(let y=m;y<d;y+=this.blockSize){const _=Math.floor(y/this.blockSize);!this.blockCache.has(_)&&!this.blockRequests.has(_)&&(this.blockIdsToFetch.add(_),n.push(_)),this.blockRequests.has(_)&&r.push(this.blockRequests.get(_)),s.push(_)}}await my(),this.fetchBlocks(t);const o=[];for(const f of n)this.blockRequests.has(f)&&o.push(this.blockRequests.get(f));await Promise.allSettled(r),await Promise.allSettled(o);const a=[],l=s.filter(f=>this.abortedBlockIds.has(f)||!this.blockCache.has(f));if(l.forEach(f=>this.blockIdsToFetch.add(f)),l.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const f of l){const g=this.blockRequests.get(f);if(!g)throw new Error(`Block ${f} is not in the block requests`);a.push(g)}await Promise.allSettled(a)}if(t&&t.aborted)throw new ur("Request was aborted");const c=s.map(f=>this.blockCache.get(f)||this.evictedBlocks.get(f)),u=c.filter(f=>!f);if(u.length)throw new Ey(u,"Request failed");const h=new Map(_y(s,c));return this.readSliceData(e,h)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(t,e);for(let n=0;n<t.length;++n){const s=t[n];for(const o of s.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await r)[n],l=o*this.blockSize,c=l-a.offset,u=Math.min(c+this.blockSize,a.data.byteLength),h=a.data.slice(c,u),f=new xy(l,h.byteLength,h,o);this.blockCache.set(o,f),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let r=[],n=null;const s=[];for(const o of t)n===null||n+1===o?(r.push(o),n=o):(s.push(new ya(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[o],n=o);return s.push(new ya(r[0]*this.blockSize,r.length*this.blockSize,r)),s}readSliceData(e,t){return e.map(r=>{let n=r.offset+r.length;this.fileSize!==null&&(n=Math.min(this.fileSize,n));const s=Math.floor(r.offset/this.blockSize),o=Math.floor(n/this.blockSize),a=new ArrayBuffer(r.length),l=new Uint8Array(a);for(let c=s;c<=o;++c){const u=t.get(c),h=u.offset-r.offset,f=u.top-n;let g=0,d=0,p;h<0?g=-h:h>0&&(d=h),f<0?p=u.length-g:p=n-u.offset-g;const m=new Uint8Array(u.data,g,p);l.set(m,d)}return a})}}class oo{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class ao{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class Ty extends oo{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class wy extends ao{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const r=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new Ty(r)}}class Sy extends oo{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class Ry extends ao{constructRequest(e,t){return new Promise((r,n)=>{const s=new XMLHttpRequest;s.open("GET",this.url),s.responseType="arraybuffer";for(const[o,a]of Object.entries(e))s.setRequestHeader(o,a);s.onload=()=>{const o=s.response;r(new Sy(s,o))},s.onerror=n,s.onabort=()=>n(new ur("Request aborted")),s.send(),t&&(t.aborted&&s.abort(),t.addEventListener("abort",()=>s.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}const Pn={};class vy extends oo{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class Py extends ao{constructor(e){super(e),this.parsedUrl=Pn.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",Pn)}constructRequest(e,t){return new Promise((r,n)=>{const s=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(l=>{const c=[];o.on("data",u=>{c.push(u)}),o.on("end",()=>{const u=Buffer.concat(c).buffer;l(u)}),o.on("error",n)});r(new vy(o,a))});s.on("error",n),t&&(t.aborted&&s.destroy(new ur("Request aborted")),t.addEventListener("abort",()=>s.destroy(new ur("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class lo extends so{constructor(e,t,r,n){super(),this.client=e,this.headers=t,this.maxRanges=r,this.allowFullFile=n,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(r=>this.fetchSlice(r,t))))}async fetchSlices(e,t){const r=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:n,length:s})=>`${n}-${n+s}`).join(",")}`},signal:t});if(r.ok)if(r.status===206){const{type:n,params:s}=dy(r.getHeader("content-type"));if(n==="multipart/byteranges"){const h=gy(await r.getData(),s.boundary);return this._fileSize=h[0].fileSize||null,h}const o=await r.getData(),{start:a,end:l,total:c}=Yn(r.getHeader("content-range"));this._fileSize=c||null;const u=[{data:o,offset:a,length:l-a}];if(e.length>1){const h=await Promise.all(e.slice(1).map(f=>this.fetchSlice(f,t)));return u.concat(h)}return u}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const n=await r.getData();return this._fileSize=n.byteLength,[{data:n,offset:0,length:n.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:r,length:n}=e,s=await this.client.request({headers:{...this.headers,Range:`bytes=${r}-${r+n}`},signal:t});if(s.ok)if(s.status===206){const o=await s.getData(),{total:a}=Yn(s.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:r,length:n}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await s.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function co(i,{blockSize:e,cacheSize:t}){return e===null?i:new by(i,{blockSize:e,cacheSize:t})}function Ay(i,{headers:e={},credentials:t,maxRanges:r=0,allowFullFile:n=!1,...s}={}){const o=new wy(i,t),a=new lo(o,e,r,n);return co(a,s)}function Ly(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...n}={}){const s=new Ry(i),o=new lo(s,e,t,r);return co(o,n)}function Iy(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...n}={}){const s=new Py(i),o=new lo(s,e,t,r);return co(o,n)}function qn(i,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?Ay(i,t):typeof XMLHttpRequest<"u"?Ly(i,t):Iy(i,t)}class Cy extends so{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((r,n)=>{const s=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>r(a.target.result),o.onerror=n,o.onabort=n,o.readAsArrayBuffer(s),t&&t.addEventListener("abort",()=>o.abort())})}}function Fy(i){return new Cy(i)}function Kn(i){switch(i){case W.BYTE:case W.ASCII:case W.SBYTE:case W.UNDEFINED:return 1;case W.SHORT:case W.SSHORT:return 2;case W.LONG:case W.SLONG:case W.FLOAT:case W.IFD:return 4;case W.RATIONAL:case W.SRATIONAL:case W.DOUBLE:case W.LONG8:case W.SLONG8:case W.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${i}`)}}function Oy(i){const e=i.GeoKeyDirectory;if(!e)return null;const t={};for(let r=4;r<=e[3]*4;r+=4){const n=V_[e[r]],s=e[r+1]?Or[e[r+1]]:null,o=e[r+2],a=e[r+3];let l=null;if(!s)l=a;else{if(l=i[s],typeof l>"u"||l===null)throw new Error(`Could not get value of geoKey '${n}'.`);typeof l=="string"?l=l.substring(a,a+o-1):l.subarray&&(l=l.subarray(a,a+o),o===1&&(l=l[0]))}t[n]=l}return t}function Jt(i,e,t,r){let n=null,s=null;const o=Kn(e);switch(e){case W.BYTE:case W.ASCII:case W.UNDEFINED:n=new Uint8Array(t),s=i.readUint8;break;case W.SBYTE:n=new Int8Array(t),s=i.readInt8;break;case W.SHORT:n=new Uint16Array(t),s=i.readUint16;break;case W.SSHORT:n=new Int16Array(t),s=i.readInt16;break;case W.LONG:case W.IFD:n=new Uint32Array(t),s=i.readUint32;break;case W.SLONG:n=new Int32Array(t),s=i.readInt32;break;case W.LONG8:case W.IFD8:n=new Array(t),s=i.readUint64;break;case W.SLONG8:n=new Array(t),s=i.readInt64;break;case W.RATIONAL:n=new Uint32Array(t*2),s=i.readUint32;break;case W.SRATIONAL:n=new Int32Array(t*2),s=i.readInt32;break;case W.FLOAT:n=new Float32Array(t),s=i.readFloat32;break;case W.DOUBLE:n=new Float64Array(t),s=i.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===W.RATIONAL||e===W.SRATIONAL)for(let a=0;a<t;a+=2)n[a]=s.call(i,r+a*o),n[a+1]=s.call(i,r+(a*o+4));else for(let a=0;a<t;++a)n[a]=s.call(i,r+a*o);return e===W.ASCII?new TextDecoder("utf-8").decode(n):n}class My{constructor(e,t,r){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=r}}class di extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class Fc{async readRasters(e={}){const{window:t,width:r,height:n}=e;let{resX:s,resY:o,bbox:a}=e;const l=await this.getImage();let c=l;const u=await this.getImageCount(),h=l.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(r||n){if(t){const[d,p]=l.getOrigin(),[m,y]=l.getResolution();a=[d+t[0]*m,p+t[1]*y,d+t[2]*m,p+t[3]*y]}const g=a||h;if(r){if(s)throw new Error("Both width and resX passed");s=(g[2]-g[0])/r}if(n){if(o)throw new Error("Both width and resY passed");o=(g[3]-g[1])/n}}if(s||o){const g=[];for(let d=0;d<u;++d){const p=await this.getImage(d),{SubfileType:m,NewSubfileType:y}=p.fileDirectory;(d===0||m===2||y&1)&&g.push(p)}g.sort((d,p)=>d.getWidth()-p.getWidth());for(let d=0;d<g.length;++d){const p=g[d],m=(h[2]-h[0])/p.getWidth(),y=(h[3]-h[1])/p.getHeight();if(c=p,s&&s>m||o&&o>y)break}}let f=t;if(a){const[g,d]=l.getOrigin(),[p,m]=c.getResolution(l);f=[Math.round((a[0]-g)/p),Math.round((a[1]-d)/m),Math.round((a[2]-g)/p),Math.round((a[3]-d)/m)],f=[Math.min(f[0],f[2]),Math.min(f[1],f[3]),Math.max(f[0],f[2]),Math.max(f[1],f[3])]}return c.readRasters({...e,window:f})}}class hr extends Fc{constructor(e,t,r,n,s={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=r,this.firstIFDOffset=n,this.cache=s.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const r=this.bigTiff?4048:1024;return new cy((await this.source.fetch([{offset:e,length:typeof t<"u"?t:r}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,r=this.bigTiff?8:2;let n=await this.getSlice(e);const s=this.bigTiff?n.readUint64(e):n.readUint16(e),o=s*t+(this.bigTiff?16:6);n.covers(e,o)||(n=await this.getSlice(e,o));const a={};let l=e+(this.bigTiff?8:2);for(let h=0;h<s;l+=t,++h){const f=n.readUint16(l),g=n.readUint16(l+2),d=this.bigTiff?n.readUint64(l+4):n.readUint32(l+4);let p,m;const y=Kn(g),_=l+(this.bigTiff?12:8);if(y*d<=(this.bigTiff?8:4))p=Jt(n,g,d,_);else{const E=n.readOffset(_),w=Kn(g)*d;if(n.covers(E,w))p=Jt(n,g,d,E);else{const S=await this.getSlice(E,w);p=Jt(S,g,d,E)}}d===1&&k_.indexOf(f)===-1&&!(g===W.RATIONAL||g===W.SRATIONAL)?m=p[0]:m=p,a[Or[f]]=m}const c=Oy(a),u=n.readOffset(e+r+t*s);return new My(a,c,u)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof di?new di(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new di(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new Ic(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(r){if(r instanceof di)t=!1;else throw r}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",r=t.length+100;let n=await this.getSlice(e,r);if(t===Jt(n,W.ASCII,t.length,e)){const o=Jt(n,W.ASCII,r,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>r&&(n=await this.getSlice(e,a));const l=Jt(n,W.ASCII,a,e);this.ghostValues={},l.split(`
`).filter(c=>c.length>0).map(c=>c.split("=")).forEach(([c,u])=>{this.ghostValues[c]=u})}return this.ghostValues}static async fromSource(e,t,r){const n=(await e.fetch([{offset:0,length:1024}],r))[0],s=new ly(n),o=s.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const l=s.getUint16(2,a);let c;if(l===42)c=!1;else if(l===43){if(c=!0,s.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const u=c?s.getUint64(8,a):s.getUint32(4,a);return new hr(e,a,c,u,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}class Ny extends Fc{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,r=0;for(let n=0;n<this.imageFiles.length;n++){const s=this.imageFiles[n];for(let o=0;o<this.imageCounts[n];o++){if(e===t){const a=await s.requestIFD(r);return new Ic(a.fileDirectory,a.geoKeyDirectory,s.dataView,s.littleEndian,s.cache,s.source)}t++,r++}r=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,r)=>t+r,0),this.imageCount}}async function Dy(i,e={},t){return hr.fromSource(qn(i,e),t)}async function Uy(i,e){return hr.fromSource(Fy(i),e)}async function By(i,e=[],t={},r){const n=await hr.fromSource(qn(i,t),r),s=await Promise.all(e.map(o=>hr.fromSource(qn(o,t))));return new Ny(n,s)}const Gy=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,zy=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class ky{constructor(e){this.gl_=e,this.program_=Jn(e,zy,Gy),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,r,n,s,o,a,l,c,u,h,f,g){const d=this.gl_;l===void 0&&(l=n),c===void 0&&(c=s),o===void 0&&(o=t),a===void 0&&(a=r),u===void 0&&(u=o),h===void 0&&(h=a),f===void 0&&(f=d.canvas.width),g===void 0&&(g=d.canvas.height),d.bindTexture(d.TEXTURE_2D,e),d.useProgram(this.program_),d.bindBuffer(d.ARRAY_BUFFER,this.positionBuffer),d.enableVertexAttribArray(this.positionLocation),d.vertexAttribPointer(this.positionLocation,2,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,this.texcoordBuffer),d.enableVertexAttribArray(this.texcoordLocation),d.vertexAttribPointer(this.texcoordLocation,2,d.FLOAT,!1,0,0);let p=Vn(0,f,0,g,-1,1);p=wp(p,l,c,0),p=ra(p,u,h,1),d.uniformMatrix4fv(this.matrixLocation,!1,p);let m=Sp(n/t,s/r,0);m=ra(m,o/t,a/r,1),d.uniformMatrix4fv(this.textureMatrixLocation,!1,m),d.uniform1i(this.textureLocation,0),d.drawArrays(d.TRIANGLES,0,this.positions.length/2)}}function Ea(i,e,t){const r=i.createShader(e);if(r===null)throw new Error("Shader compilation failed");if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){const n=i.getShaderInfoLog(r);throw n===null?new Error("Shader info log creation failed"):new Error(n)}return r}function Jn(i,e,t){const r=i.createProgram(),n=Ea(i,i.VERTEX_SHADER,t),s=Ea(i,i.FRAGMENT_SHADER,e);if(r===null)throw new Error("Program creation failed");if(i.attachShader(r,n),i.attachShader(r,s),i.linkProgram(r),!i.getProgramParameter(r,i.LINK_STATUS))throw i.getProgramInfoLog(r)===null?new Error("Program info log creation failed"):new Error;return r}const $y=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,Vy=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,jy=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,Xy=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function Wy(i,e,t,r){let n;return t&&t.length?n=t.shift():rh?n=new OffscreenCanvas(i||300,e||300):n=document.createElement("canvas"),i&&(n.width=i),e&&(n.height=e),n.getContext("webgl",r)}function Hy(i){const e=i.canvas;e.width=1,e.height=1,i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT)}const xa=[];function Zy(i,e,t,r,n,s,o,a,l,c,u,h,f,g){const d=Math.round(r*e),p=Math.round(r*t);i.canvas.width=d,i.canvas.height=p;let m,y;if(y=i.createTexture(),i.bindTexture(i.TEXTURE_2D,y),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,d,p,0,i.RGBA,u,null),m=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,m),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,y,0),m===null)throw new Error("Could not create framebuffer");if(y===null)throw new Error("Could not create texture");if(l.length===0)return{width:d,height:p,framebuffer:m,texture:y};const _=Xr();l.forEach(function(R,N,O){Au(_,R.extent)});let E,w,S;const T=1/n;{if(E=i.createTexture(),y===null)throw new Error("Could not create texture");w=Math.round(Ae(_)*T),S=Math.round(Je(_)*T);const R=i.getParameter(i.MAX_TEXTURE_SIZE),N=Math.max(w,S),O=N>R?R/N:1,k=Math.round(w*O),$=Math.round(S*O);i.bindTexture(i.TEXTURE_2D,E),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,k,$,0,i.RGBA,u,null);const D=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,D),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,E,0);const re=new ky(i);l.forEach(function(z,H,Q){const ie=(z.extent[0]-_[0])*T*O,he=-(z.extent[3]-_[3])*T*O,_e=Ae(z.extent)*T*O,fe=Je(z.extent)*T*O;if(i.bindFramebuffer(i.FRAMEBUFFER,D),i.viewport(0,0,k,$),z.clipExtent){const Ee=(z.clipExtent[0]-_[0])*T*O,Re=-(z.clipExtent[3]-_[3])*T*O,we=Ae(z.clipExtent)*T*O,Ie=Je(z.clipExtent)*T*O;i.enable(i.SCISSOR_TEST),i.scissor(f?Ee:Math.round(Ee),f?Re:Math.round(Re),f?we:Math.round(Ee+we)-Math.round(Ee),f?Ie:Math.round(Re+Ie)-Math.round(Re))}re.drawImage(z.texture,z.width,z.height,c,c,z.width-2*c,z.height-2*c,f?ie:Math.round(ie),f?he:Math.round(he),f?_e:Math.round(ie+_e)-Math.round(ie),f?fe:Math.round(he+fe)-Math.round(he),k,$),i.disable(i.SCISSOR_TEST)}),i.deleteFramebuffer(D)}const v=Mn(o),A=Mn(_),L=R=>{const N=(R[0][0]-v[0])/s*r,O=-(R[0][1]-v[1])/s*r,k=(R[1][0]-v[0])/s*r,$=-(R[1][1]-v[1])/s*r,D=(R[2][0]-v[0])/s*r,re=-(R[2][1]-v[1])/s*r;return{u1:k,v1:$,u0:N,v0:O,u2:D,v2:re}};i.bindFramebuffer(i.FRAMEBUFFER,m),i.viewport(0,0,d,p);{const R=[],N=[],O=Jn(i,Xy,jy);i.useProgram(O);const k=i.getUniformLocation(O,"u_texture");i.bindTexture(i.TEXTURE_2D,E),i.uniform1i(k,0),a.getTriangles().forEach(function(ie,he,_e){const fe=ie.source,Ee=ie.target,{u1:Re,v1:we,u0:Ie,v0:Xt,u2:Wt,v2:ft}=L(Ee),si=(fe[0][0]-A[0])/n/w,oi=-(fe[0][1]-A[1])/n/S,Yc=(fe[1][0]-A[0])/n/w,qc=-(fe[1][1]-A[1])/n/S,Kc=(fe[2][0]-A[0])/n/w,Jc=-(fe[2][1]-A[1])/n/S;R.push(Re,we,Ie,Xt,Wt,ft),N.push(Yc,qc,si,oi,Kc,Jc)});const $=Vn(0,d,p,0,-1,1),D=i.getUniformLocation(O,"u_matrix");i.uniformMatrix4fv(D,!1,$);const re=i.getAttribLocation(O,"a_position"),z=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,z),i.bufferData(i.ARRAY_BUFFER,new Float32Array(R),i.STATIC_DRAW),i.vertexAttribPointer(re,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(re);const H=i.getAttribLocation(O,"a_texcoord"),Q=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,Q),i.bufferData(i.ARRAY_BUFFER,new Float32Array(N),i.STATIC_DRAW),i.vertexAttribPointer(H,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(H),i.drawArrays(i.TRIANGLES,0,R.length/2)}if(h){const R=Jn(i,Vy,$y);i.useProgram(R);const N=Vn(0,d,p,0,-1,1),O=i.getUniformLocation(R,"u_matrix");i.uniformMatrix4fv(O,!1,N);const k=Array.isArray(h)?h:[0,0,0,255],$=i.getUniformLocation(R,"u_val");i.uniform4fv($,k);const D=i.getAttribLocation(R,"a_position"),re=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,re),i.vertexAttribPointer(D,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(D);const z=a.getTriangles().reduce(function(H,Q){const ie=Q.target,{u1:he,v1:_e,u0:fe,v0:Ee,u2:Re,v2:we}=L(ie);return H.concat([he,_e,fe,Ee,fe,Ee,Re,we,Re,we,he,_e])},[]);i.bufferData(i.ARRAY_BUFFER,new Float32Array(z),i.STATIC_DRAW),i.drawArrays(i.LINES,0,z.length/2)}return{width:d,height:p,framebuffer:m,texture:y}}class Yy extends gs{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,r=t.getExtent(),n=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?n?ut(r,n):r:n;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const l=o?ut(s,o):s;if(Ro(l)===0){this.state=Z.EMPTY;return}r&&(a?a=ut(a,r):a=r);const c=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),u=e.targetProj,h=ih(t,u,l,c);if(!isFinite(h)||h<=0){this.state=Z.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:nh;if(this.triangulation_=new sh(t,u,l,a,h*f,c,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=Z.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(h);let g=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(g[1]=me(g[1],a[1],a[3]),g[3]=me(g[3],a[1],a[3])):g=ut(g,a)),!Ro(g))this.state=Z.EMPTY;else{let d=0,p=0;t.canWrapX()&&(d=Ae(r),p=Math.floor((g[0]-r[0])/d)),Lu(g.slice(),t,!0).forEach(y=>{const _=this.sourceTileGrid_.getTileRangeForExtentAndZ(y,this.sourceZ_),E=e.getTileFunction;for(let w=_.minX;w<=_.maxX;w++)for(let S=_.minY;S<=_.maxY;S++){const T=E(this.sourceZ_,w,S,this.pixelRatio_);if(T){const v=p*d;this.sourceTiles_.push({tile:T,offset:v})}}++p}),this.sourceTiles_.length===0&&(this.state=Z.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(w=>{var he;const S=w.tile;if(!S||S.getState()!==Z.LOADED)return;const T=S.getSize(),v=this.gutter_;let A;const L=Nn(S.getData());L?A=L:(t=!0,A=oh(Dn(S.getData())));const R=[T[0]+2*v,T[1]+2*v],N=A instanceof Float32Array,O=R[0]*R[1],k=N?Float32Array:Uint8ClampedArray,$=new k(A.buffer),D=k.BYTES_PER_ELEMENT,re=D*$.length/O,z=$.byteLength/R[1],H=Math.floor(z/D/R[0]),Q=this.sourceTileGrid_.getTileCoordExtent(S.tileCoord);Q[0]+=w.offset,Q[2]+=w.offset;const ie=(he=this.clipExtent_)==null?void 0:he.slice();ie&&(ie[0]+=w.offset,ie[2]+=w.offset),e.push({extent:Q,clipExtent:ie,data:$,dataType:k,bytesPerPixel:re,pixelSize:R,bandCount:H})}),this.sourceTiles_.length=0,e.length===0){this.state=Z.ERROR,this.changed();return}const r=this.wrappedTileCoord_[0],n=this.targetTileGrid_.getTileSize(r),s=typeof n=="number"?n:n[0],o=typeof n=="number"?n:n[1],a=s*this.pixelRatio_,l=o*this.pixelRatio_,c=this.targetTileGrid_.getResolution(r),u=this.sourceTileGrid_.getResolution(this.sourceZ_),h=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,g=new e[0].dataType(f*a*l),d=Wy(a,l,xa,{premultipliedAlpha:!1,antialias:!1});let p;const m=d.RGBA;let y;e[0].dataType==Float32Array?(y=d.FLOAT,d.getExtension("WEBGL_color_buffer_float"),d.getExtension("OES_texture_float"),d.getExtension("EXT_float_blend"),p=d.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(y=d.UNSIGNED_BYTE,p=this.interpolate);const _=4,E=Math.ceil(f/_);for(let w=E-1;w>=0;--w){const S=[];for(let k=0,$=e.length;k<$;++k){const D=e[k],re=D.pixelSize,z=re[0],H=re[1],Q=new D.dataType(_*z*H),ie=D.data;let he=w*_;for(let fe=0,Ee=Q.length;fe<Ee;fe+=_)Q[fe]=ie[he],Q[fe+1]=ie[he+1],Q[fe+2]=ie[he+2],Q[fe+3]=ie[he+3],he+=f;const _e=d.createTexture();d.bindTexture(d.TEXTURE_2D,_e),p?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR)):(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST)),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,m,z,H,0,m,y,Q),S.push({extent:D.extent,clipExtent:D.clipExtent,texture:_e,width:z,height:H})}const{framebuffer:T,width:v,height:A}=Zy(d,s,o,this.pixelRatio_,u,c,h,this.triangulation_,S,this.gutter_,y,this.renderEdges_,p),L=v,R=A*_,N=new e[0].dataType(L*R);d.bindFramebuffer(d.FRAMEBUFFER,T),d.readPixels(0,0,v,A,d.RGBA,y,N);let O=w*_;for(let k=0,$=N.length;k<$;k+=_){const D=(L-1-(k/R|0))*R+k%R;g[O]=N[D],g[O+1]=N[D+1],g[O+2]=N[D+2],g[O+3]=N[D+3],O+=f}}if(Hy(d),xa.push(d.canvas),t){const w=It(s,o),S=new ImageData(g,s);w.putImageData(S,0,0),this.reprojData_=w.canvas}else this.reprojData_=g;this.reprojSize_=[Math.round(a),Math.round(l)],this.state=Z.LOADED,this.changed()}load(){if(this.state!==Z.IDLE&&this.state!==Z.ERROR)return;this.state=Z.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const r=t.getState();if(r!==Z.IDLE&&r!==Z.LOADING)return;e++;const n=mt(t,De.CHANGE,()=>{const s=t.getState();(s==Z.LOADED||s==Z.ERROR||s==Z.EMPTY)&&(wi(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==Z.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(wi),this.sourcesListenerKeys_=null}}class ri extends ms{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=Hr({extent:Zr(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?Qe(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?Qe(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||mi(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,n,s){const o=this.tileGrid||this.getTileGridForProjection(s||n),a=Math.max.apply(null,o.getResolutions().map((g,d)=>{const p=Qe(o.getTileSize(d)),m=this.getTileSize(d);return Math.max(m[0]/p[0],m[1]/p[1])})),l=this.getTileGridForProjection(n),c=[e,t,r],u=this.getTileCoordForTileUrlFunction(c,n),h=Object.assign({sourceProj:s||n,sourceTileGrid:o,targetProj:n,targetTileGrid:l,tileCoord:c,wrappedTileCoord:u,pixelRatio:a,gutter:this.gutter_,getTileFunction:(g,d,p,m)=>this.getTile(g,d,p,m),transformMatrix:this.transformMatrix},this.tileOptions),f=new Yy(h);return f.key=this.getKey(),f}getTile(e,t,r,n,s){var E;const o=this.getProjection();if(s&&(o&&!mi(o,s)||this.transformMatrix))return this.getReprojTile_(e,t,r,s,o);const a=this.getTileSize(e),l=this.loader_,c=new AbortController,u={signal:c.signal,crossOrigin:this.crossOrigin_},h=this.getTileCoordForTileUrlFunction([e,t,r]);if(!h)return null;const f=h[0],g=h[1],d=h[2],p=(E=this.getTileGrid())==null?void 0:E.getFullTileRange(f);p&&(u.maxY=p.getHeight()-1);function m(){return Iu(function(){return l(f,g,d,u)})}const y=Object.assign({tileCoord:[e,t,r],loader:m,size:a,controller:c},this.tileOptions),_=new gs(y);return _.key=this.getKey(),_.addEventListener(De.CHANGE,this.handleTileChange_),_}handleTileChange_(e){const t=e.target,r=ae(t),n=t.getState();let s;n==Z.LOADING?(this.tileLoadingKeys_[r]=!0,s=mn.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=n==Z.ERROR?mn.TILELOADERROR:n==Z.LOADED?mn.TILELOADEND:void 0),s&&this.dispatchEvent(new ah(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||mi(t,e))&&!this.transformMatrix)return this.tileGrid;const r=ae(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=lh(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=se(e);if(r){const n=ae(r);n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=t)}}}function qy(i){return((i.fileDirectory.NewSubfileType||0)&4)===4}function Ky(i,e){if(!i)return!1;if(i===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=Be;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const ba="STATISTICS_MAXIMUM",Ta="STATISTICS_MINIMUM",An=256;let Ln;function Jy(){return Ln||(Ln=new hy),Ln}function Qy(i){try{return i.getBoundingBox(!0)}catch{return[0,0,i.getWidth(),i.getHeight()]}}function e0(i){try{return i.getOrigin().slice(0,2)}catch{return[0,i.getHeight()]}}function t0(i,e){try{return i.getResolution(e)}catch{return[e.getWidth()/i.getWidth(),e.getHeight()/i.getHeight()]}}function r0(i){const e=i.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=se(t);if(!r){const n=To(e.ProjLinearUnitsGeoKey);n&&(r=new wo({code:t,units:n}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=se(t);if(!r){const n=To(e.GeogAngularUnitsGeoKey);n&&(r=new wo({code:t,units:n}))}return r}return null}function i0(i){return i.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=i.getImage(r);return Promise.all(t)})}function n0(i,e){let t;return i.blob?t=Uy(i.blob):i.overviews?t=By(i.url,i.overviews,e):t=Dy(i.url,e),t.then(i0)}function Lr(i,e,t,r,n){if(Array.isArray(i)){const s=i.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(r);throw n(o),o}for(let o=0;o<s;++o)Lr(i[o],e[o],t,r,n);return}if(e=e,Math.abs(i-e)>t*i)throw new Error(r)}function s0(i){return i instanceof Int8Array?-128:i instanceof Int16Array?-32768:i instanceof Int32Array?-2147483648:i instanceof Float32Array?12e-39:0}function o0(i){return i instanceof Int8Array?127:i instanceof Uint8Array||i instanceof Uint8ClampedArray?255:i instanceof Int16Array?32767:i instanceof Uint16Array?65535:i instanceof Int32Array?2147483647:i instanceof Uint32Array?4294967295:i instanceof Float32Array?34e37:255}class uo extends ri{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const r=this,n=new Array(t);for(let s=0;s<t;++s)n[s]=n0(this.sourceInfo_[s],this.sourceOptions_);Promise.all(n).then(function(s){r.configure_(s)}).catch(function(s){Br(s),r.error_=s,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const n=t[r],s=r0(n);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const s=t[r].fileDirectory.ModelTransformation;if(s){const[o,a,l,c,u,h,f,g]=s,d=Dr(Dr([1/Math.sqrt(o*o+u*u),0,0,-1/Math.sqrt(a*a+h*h),c,g],[o,u,a,h,0,0]),[1,0,0,1,-c,-g]);this.transformMatrix=d,this.addAlpha_=!0;break}}}configure_(e){let t,r,n,s,o;const a=new Array(e.length),l=new Array(e.length),c=new Array(e.length);let u=0;const h=e.length;for(let m=0;m<h;++m){const y=[],_=[];e[m].forEach(L=>{qy(L)?_.push(L):y.push(L)});const E=y.length;if(_.length>0&&_.length!==E)throw new Error(`Expected one mask per image found ${_.length} masks and ${E} images`);let w,S;const T=new Array(E),v=new Array(E),A=new Array(E);l[m]=new Array(E),c[m]=new Array(E);for(let L=0;L<E;++L){const R=y[L],N=R.getGDALNoData();c[m][L]=R.getGDALMetadata(0),l[m][L]=N;const O=this.sourceInfo_[m].bands;a[m]=O?O.length:R.getSamplesPerPixel();const k=E-(L+1);w||(w=Qy(R)),S||(S=e0(R));const $=t0(R,y[0]);A[k]=$[0];const D=[R.getTileWidth(),R.getTileHeight()];D[0]!==D[1]&&D[1]<An&&(D[0]=An,D[1]=An),T[k]=D;const re=$[0]/Math.abs($[1]);v[k]=[D[0],D[1]/re]}if(t?ut(t,w,t):t=w,!r)r=S;else{const L=`Origin mismatch for source ${m}, got [${S}] but expected [${r}]`;Lr(r,S,0,L,this.viewRejector)}if(!o)o=A,this.resolutionFactors_[m]=1;else{o.length-u>A.length&&(u=o.length-A.length);const L=o[o.length-1]/A[A.length-1];this.resolutionFactors_[m]=L;const R=A.map(O=>O*=L),N=`Resolution mismatch for source ${m}, got [${R}] but expected [${o}]`;Lr(o.slice(u,o.length),R,.02,N,this.viewRejector)}n?Lr(n.slice(u,n.length),v,.01,`Tile size mismatch for source ${m}`,this.viewRejector):n=v,s?Lr(s.slice(u,s.length),T,0,`Tile size mismatch for source ${m}`,this.viewRejector):s=T,this.sourceImagery_[m]=y.reverse(),this.sourceMasks_[m]=_.reverse()}for(let m=0,y=this.sourceImagery_.length;m<y;++m){const _=this.sourceImagery_[m];for(;_.length<o.length;)_.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=c;e:for(let m=0;m<h;++m){if(this.sourceInfo_[m].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[m].length){this.addAlpha_=!0;break}const y=l[m],_=this.sourceInfo_[m].bands;if(_){for(let E=0;E<_.length;++E)if(y[_[E]-1]!==null){this.addAlpha_=!0;break e}continue}for(let E=0;E<y.length;++E)if(y[E]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let m=0;m<h;++m)f+=a[m];this.bandCount=f;const g=new tn({extent:t,minZoom:u,origin:r,resolutions:o,tileSizes:n});this.tileGrid=g,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const d=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let p=t;if(this.transformMatrix){const m=Ur(Pe(),this.transformMatrix.slice()),y=gu(_=>xt(m,_));p=ar(t,y)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:mu(Pt(p),this.projection),extent:pu(p,this.projection),zoom:d})}loadTile_(e,t,r,n){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),l=this.nodataValues_,c=this.sourceInfo_,u=Jy();for(let h=0;h<o;++h){const f=c[h],g=this.resolutionFactors_[h],d=[Math.round(t*(s[0]*g)),Math.round(r*(s[1]*g)),Math.round((t+1)*(s[0]*g)),Math.round((r+1)*(s[1]*g))],p=this.sourceImagery_[h][e];let m;f.bands&&(m=f.bands.map(function(S){return S-1}));let y;"nodata"in f&&f.nodata!==null?y=f.nodata:m?y=m.map(function(S){return l[h][S]}):y=l[h];const _={window:d,width:s[0],height:s[1],samples:m,fillValue:y,pool:u,interleave:!1,signal:n.signal};Ky(this.convertToRGB_,p)?a[h]=p.readRGB(_):a[h]=p.readRasters(_);const E=o+h,w=this.sourceMasks_[h][e];if(!w){a[E]=Promise.resolve(null);continue}a[E]=w.readRasters({window:d,width:s[0],height:s[1],samples:[0],pool:u,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(h){throw Br(h),h})}composeTile_(e,t){const r=this.metadata_,n=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,c=this.normalize_,u=this.addAlpha_,h=e[0]*e[1],f=h*o;let g;c?g=new Uint8Array(f):g=new Float32Array(f);let d=0;for(let p=0;p<h;++p){let m=u;for(let y=0;y<s;++y){const _=n[y];let E=_.min,w=_.max,S,T;if(c){const v=r[y][0];E===void 0&&(v&&Ta in v?E=parseFloat(v[Ta]):E=s0(t[y][0])),w===void 0&&(v&&ba in v?w=parseFloat(v[ba]):w=o0(t[y][0])),S=255/(w-E),T=-E*S}for(let v=0;v<a[y];++v){const A=t[y][v][p];let L;if(c?L=me(S*A+T,0,255):L=A,!u)g[d]=L;else{let R=_.nodata;if(R===void 0){let O;_.bands?O=_.bands[v]-1:O=v,R=l[y][O]}const N=isNaN(R);(!N&&A!==R||N&&!isNaN(A))&&(m=!1,g[d]=L)}d++}if(!m){const v=s+y,A=t[v];A&&!A[0][p]&&(m=!0)}}u&&(m||(g[d]=255),d++)}return g}}uo.prototype.getView;class ge{constructor(e){this.name=e}toString(){return this.name}}ge.GeoTIFF=new ge("GeoTIFF");ge.ImageStatic=new ge("ImageStatic");ge.PMTilesRaster=new ge("PMTilesRaster");ge.PMTilesVector=new ge("PMTilesVector");ge.TileJSON=new ge("TileJSON");ge.TileWMS=new ge("TileWMS");ge.WMTS=new ge("WMTS");ge.XYZ=new ge("XYZ");function a0(i){const e=i.load||pr,t=i.imageExtent,r=i.crossOrigin??null;return()=>{const n=new Image;return n.crossOrigin=r,e(n,i.url).then(s=>{const o=Ae(t)/s.width,a=Je(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class Oc extends Vt{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,r=e.imageLoadFunction!==void 0?e.imageLoadFunction:_s;super({attributions:e.attributions,interpolate:e.interpolate,projection:se(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new tl(this.imageExtent_,void 0,1,a0({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(n,s)=>(this.image.setImage(n),r(this.image,s),pr(n))})),this.image.addEventListener(De.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,r,n){return or(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}function ho(i,e,t,r){const n=document.createElement("script"),s="olc_"+ae(e);function o(){delete window[s],n.parentNode.removeChild(n)}n.async=!0,n.src=i+(i.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(l){clearTimeout(a),o(),e(l)},document.head.appendChild(n)}class l0 extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class c0 extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function Mc(i){return new Promise(function(e,t){function r(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let l;try{l=JSON.parse(a.responseText)}catch(c){const u="Error parsing response text as JSON: "+c.message;t(new Error(u));return}e(l);return}t(new l0(a))}function n(o){t(new c0(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",r),s.addEventListener("error",n),s.open("GET",i),s.setRequestHeader("Accept","application/json"),s.send()})}function Nc(i,e){return e.includes("://")?e:new URL(e,i).href}class Dc extends Tt{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:se("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)ho(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=se("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const c=ls(t,r);n=ar(e.bounds,c)}const s=Zr(r),o=e.minzoom||0,a=e.maxzoom||22,l=Hr({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=l,this.tileUrlFunction=rl(e.tiles,l),e.attribution&&!this.getAttributions()){const c=n!==void 0?n:s;this.setAttributions(function(u){return or(c,u.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}const u0="https://stac-extensions.github.io/label/v1.*/schema.json",Uc=new Li({color:"rgba(0,0,0,0)"});function Bc(i,e,t="rgba(255,255,255,0.4)",r=5){let n=Uc;t&&(n=new Li({color:t}));const s=new Ai({color:i,width:e});return new _i({image:new ch({fill:n,stroke:s,radius:r}),fill:n,stroke:s})}const h0=Bc("#3399CC",3),wa=Bc("#ff9933",2,null);function f0(i,e){const t={url:i.getAbsoluteUrl()};let r=i;i.getBands().length===1&&(r=i.getBand(0));const{minimum:n,maximum:s}=r.getMinMaxValues();typeof n=="number"&&(t.min=n),typeof s=="number"&&(t.max=s);const o=r.getNoDataValues();return o.length>0&&(t.nodata=o[0]),e.length>0&&(t.bands=e),t}async function Sa(i,e=void 0){let t=e;if(uh()){const r=i.getMetadata("proj:code");if(r)try{if(r.startsWith("EPSG:")){const n=parseInt(r.replace("EPSG:",""),10);t=await hh(n)}}catch{}}return t}function Ra(i,e){const t=i.clone();return e.hasOnlyBounds()||t.setFill(Uc),t}function d0(i){let e=i.href;if(e.includes("{s}"))if(Array.isArray(i["href:servers"])&&i["href:servers"].length>0){const t=Math.random()*i["href:servers"].length|0;e=e.replace("{s}",i["href:servers"][t])}else return null;return e}class va extends ri{constructor(t){super({...t,state:"loading"});J(this,"loadImage",t=>new Promise((r,n)=>{const s=new Image;s.addEventListener("load",()=>r(s)),s.addEventListener("error",()=>n(new Error("load failed"))),s.src=t}));const r=new Hs(t.url);r.getHeader().then(n=>{this.tileGrid.minZoom=n.minZoom,this.tileGrid.maxZoom=n.maxZoom,this.setLoader(async(s,o,a)=>{const l=await r.getZxy(s,o,a),c=URL.createObjectURL(new Blob([l.data])),u=await this.loadImage(c);return URL.revokeObjectURL(c),u}),this.setState("ready")})}}class g0 extends ys{constructor(t){super({...t,state:"loading",url:"pmtiles://"+t.url+"/{z}/{x}/{y}",format:new fh});J(this,"tileLoadFunction",(t,r)=>{const n=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=r.match(n),o=+s[2],a=+s[3],l=+s[4];t.setLoader((c,u,h)=>{t.setState(Z.LOADING),this.pmtiles_.getZxy(o,a,l).then(f=>{if(f){const g=t.getFormat();t.setFeatures(g.readFeatures(f.data,{extent:c,featureProjection:h})),t.setState(Z.LOADED)}else t.setFeatures([]),t.setState(Z.EMPTY)}).catch(f=>{t.setFeatures([]),t.setState(Z.ERROR)})})});this.pmtiles_=new Hs(t.url),this.pmtiles_.getHeader().then(r=>{this.tileGrid.minZoom=r.minZoom,this.tileGrid.maxZoom=r.maxZoom,this.setTileLoadFunction(this.tileLoadFunction),this.setState("ready")})}}class fo extends Ih{constructor(e){const t={};if(["opacity","visible","zIndex","minResolution","maxResolution","minZoom","maxZoom","properties"].forEach(r=>t[r]=e[r]),super(t),this.getSourceOptions_=e.getSourceOptions,this.children_=null,this.childrenOptions_=e.childrenOptions||{},this.assets_=null,this.bands_=[],this.crossOrigin_=e.crossOrigin||null,this.displayFootprint_=e.displayFootprint!==!1,this.displayGeoTiffByDefault_=!!e.displayGeoTiffByDefault,this.displayPreview_=!!e.displayPreview,this.displayOverview_=e.displayOverview!==!1,this.displayWebMapLink_=e.displayWebMapLink||!1,this.buildTileUrlTemplate_=e.buildTileUrlTemplate||null,this.useTileLayerAsFallback_=e.useTileLayerAsFallback||!1,this.boundsStyle_=e.boundsStyle||h0,this.collectionStyle_=e.collectionStyle||wa,this.boundsLayer_=null,this.disableMigration_=e.disableMigration||!1,this.map_=null,this.eventQueue_=[],e.httpRequestFn&&(this.fetch_=e.httpRequestFn),e.data){try{this.configure_(e.data,e.url,e.children,e.assets,e.bands)}catch(r){this.handleError_(r)}return}if(!e.url)throw new Error("Either url or data must be provided");this.fetch_(e.url).then(r=>this.configure_(r,e.url,e.children,e.assets,e.bands)).catch(r=>this.handleError_(r))}async fetch_(e,t="json"){const r=await fetch(e);if(!r.ok)throw new Error(`Unexpected response from ${e}: ${r.status}`);return t==="json"?await r.json():t==="text"?await r.text():null}getBoundsLayer(){return this.boundsLayer_}isEmpty(){var e;if(this.getLayers().getLength()>1)return!1;const r=(e=this.getData())===null||e===void 0?void 0:e.getBoundingBox();return!r||Yi(r)?!0:!this.boundsLayer_||!this.displayFootprint_}handleError_(e){this.dispatch_(new l_(e))}configure_(e,t=null,r=null,n=null,s=[]){let o;e instanceof ai||e instanceof Ht?o=e:o=li(e,!this.disableMigration_),t&&t.includes("://")&&o instanceof Ht&&o.setAbsoluteUrl(t),this.set("stac",o),this.bands_=s,this.boundsLayer_=this.addFootprint_();const a=()=>{this.boundsLayer_&&this.boundsLayer_.setStyle(Ra(this.boundsStyle_,this))};this.getLayers().on("add",a),this.getLayers().on("remove",a);const l=h=>this.handleError_(h),c=this.setChildren(r).catch(l),u=this.setAssets(n).catch(l);Promise.all([c,u]).then(()=>this.dispatch_("layersready")),this.dispatch_("sourceready")}dispatch_(e){this.eventQueue_.push(e),this.flush_()}flush_(){if(this.map_){for(const e of this.eventQueue_)this.dispatchEvent(e);this.eventQueue_=[]}}setMap_(e){this.map_!==e&&(this.map_=e,this.flush_())}async addChildren_(e,t={}){const r=e.map(n=>{const s={data:n,crossOrigin:this.crossOrigin_,boundsStyle:this.collectionStyle_,displayGeoTiffByDefault:this.displayGeoTiffByDefault_,displayOverview:this.displayOverview_,displayPreview:this.displayPreview_,displayFootprint:this.displayFootprint_,useTileLayerAsFallback:this.useTileLayerAsFallback_,buildTileUrlTemplate:this.buildTileUrlTemplate_},o=new fo(Object.assign(s,t));return o.on("sourceready",()=>{o.map_&&this.setMap_(o.map_)}),this.addLayer_(o,null),o});return await Promise.all(r)}async addPreviewImage_(e){const t=await Sa(e,"EPSG:4326"),r=e.getContext().getBoundingBoxes();if(r.length!==1)return;const n=r[0];let s={url:e.getAbsoluteUrl(),projection:t,imageExtent:On(n,"EPSG:4326",t),crossOrigin:this.crossOrigin_};this.getSourceOptions_&&(s=await this.getSourceOptions_(ge.ImageStatic,s,e));const o=new il({source:new Oc(s)});return this.addLayer_(o,e),o}async addLayerForLink(e){const t=d0(e);if(!t)return;const r={attributions:e.getMetadata("attribution")||this.getData().getMetadata("attribution"),crossOrigin:this.crossOrigin_,url:t},n=async(o,a)=>(this.getSourceOptions_&&(a=await this.getSourceOptions_(o,a,e)),a),s=[];switch(e.rel){case"pmtiles":const a=await new Hs(r.url).getHeader();let l;switch(a.tileType){case tr.Mvt:l=new g0(await n(ge.PMTilesVector,r));break;case tr.Avif:case tr.Jpeg:case tr.Png:case tr.Webp:l=new va(await n(ge.PMTilesRaster,r));break;default:return}s.push(l);break;case"tilejson":s.push(new Dc(await n(ge.TileJSON,r)));break;case"wms":if(!Array.isArray(e["wms:layers"]))break;for(const h in e["wms:layers"]){const f=e["wms:layers"][h]||"";let g="";Array.isArray(e["wms:styles"])&&typeof e["wms:styles"][h]=="string"&&(g=e["wms:styles"][h]);const d=Object.assign({LAYERS:f,STYLES:g},e["wms:dimensions"]);typeof e["wms:transparent"]=="boolean"&&(d.TRANSPARENT=String(e["wms:transparent"])),typeof e.type=="string"&&e.type.startsWith("image/")&&(d.FORMAT=e.type);const p=await n(ge.TileWMS,Object.assign({},r,{params:d}));s.push(new gh(p))}break;case"wmts":const c=await this.getWmtsCapabilities_(t);if(!c)return;const u=Array.isArray(e["wmts:layer"])?e["wmts:layer"]:[e["wmts:layer"]];for(const h of u){let f=Object.assign({},r,{layer:h});typeof e.type=="string"&&e.type.startsWith("image/")&&(f.format=e.type),f=await n(ge.WMTS,f),s.push(new dh(nl(c,f)))}break;case"xyz":s.push(new Ii(await n(ge.XYZ,r)));break;default:return}return s.map(o=>{let a;return o instanceof ys?a=new ph({source:o,declutter:!0}):o instanceof va?a=new Gi({source:o}):a=new Bn({source:o}),this.addLayer_(a,e),a})}async addGeoTiff_(e){if(this.buildTileUrlTemplate_&&!this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);let r={sources:[f0(e,this.bands_)]};const n=await Sa(e);n&&(r.projection=n),this.getSourceOptions_&&(r=await this.getSourceOptions_(ge.GeoTIFF,r,e));const s=new uo(r),o=new Promise((a,l)=>{s.on("error",l),s.on("change",()=>{s.getState()==="error"?l(s.getError()):a()})});try{await o;const a=new Gi({source:s});return this.addLayer_(a,e),a}catch(a){if(this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);this.handleError_(a)}}async addTileLayerForImagery_(e){let t=this.buildTileUrlTemplate_(e);t instanceof Promise&&(t=await t);let r={crossOrigin:this.crossOrigin_,url:t};this.getSourceOptions_&&(r=await this.getSourceOptions_(ge.XYZ,r,e));const n=new Bn({source:new Ii(r)});return this.addLayer_(n,e),n}addLayer_(e,t=null,r=0){t&&e.set("stac",t),e.setZIndex(r),this.getLayers().push(e)}addFootprint_(){let e=null;const t=this.getData();if(t.isItemCollection()||t.isCollectionCollection()?e=Mh(t.getBoundingBox()):e=t.toGeoJSON(),e){const r=this.createGeoJsonLayer_(e,Ra(this.boundsStyle_,this),this.displayFootprint_);return r.set("bounds",!0),r.on("change",()=>this.setMap_(r.getMapInternal())),this.addLayer_(r,t,1),r}return null}async addGeoJson_(e){try{const t=await this.fetch_(e.getAbsoluteUrl()),r=this.createGeoJsonLayer_(t);return this.addLayer_(r,e),r}catch(t){this.handleError_(t)}}createGeoJsonLayer_(e,t=null,r=!0){const n=new ja,s=new Ji({format:n,loader:(o,a,l)=>{e=Nh(e);const c=n.readFeatures(e,{featureProjection:l});s.addFeatures(c)}});return t||(t=wa),new Ka({source:s,style:t,visible:r})}async addLabelExtension_(){const e=this.getData();if(!(e instanceof Ts))return;let t=e.getAssetsWithRoles(["labels","labels-vector"],!0),r;t.length>1&&(r=t.find(s=>s.roles.includes("labels-vector"))),r||(r=e.getAsset("vector_labels")),r||(t=e.getAssets().filter(s=>s.type===Lo&&!s.roles),t.length===1&&(r=t[0]));const n=e.getLinksWithRels(["source"]);if(r&&n.length>0){const s=n.map(async a=>{try{const l=await this.fetch_(a.getAbsoluteUrl());return li(l)}catch(l){return this.handleError_(l),null}}),o=(await Promise.all(s)).filter(a=>a instanceof Ht);await this.addChildren_(o,{displayFootprint:!1})}try{await this.addGeoJson_(r)}catch(s){this.handleError_(s)}}async updateLayers_(){const e=this.getLayers();for(let n=e.getLength()-1;n>=0;n--){const s=e.item(n);s.get("stac")&&!s.get("bounds")&&e.removeAt(n)}const t=this.getData();if(Array.isArray(this.displayWebMapLink_)){const n=this.getWebMapLinks().map(async s=>await this.addLayerForLink(s));await Promise.all(n)}this.children_&&await this.addChildren_(this.children_,this.childrenOptions_);const r=this.getAssets();if(r){const n=r.map(async s=>{if(s){if(s.type===Lo)return await this.addGeoJson_(s);if(s.isGeoTIFF())return await this.addGeoTiff_(s);if(s.canBrowserDisplayImage())return await this.addPreviewImage_(s)}});await Promise.all(n)}if(this.hasOnlyBounds()){if(t instanceof ws)await this.addChildren_(t.getAll(),this.childrenOptions_);else if(t instanceof Ht){if(t.isItem()&&t.supportsExtension(u0)&&t.getMetadata("label:type")==="vector"){await this.addLabelExtension_();return}const n=this.getWebMapLinks();if(n.length>0)await this.addLayerForLink(n[0]);else{const s=t.getDefaultGeoTIFF(!0,!this.displayGeoTiffByDefault_);let o;if(s&&this.displayOverview_&&(o=await this.addGeoTiff_(s)),this.displayPreview_&&(!s||!o)){const a=t.getThumbnails(!0,"overview");a.length>0&&await this.addPreviewImage_(a[0])}}}}}hasOnlyBounds(){const e=this.getBoundsLayer();return typeof this.getLayersArray().find(r=>r!==e)>"u"}getWebMapLinks(){const e=this.getData();if(e instanceof ai)return[];let t=["xyz","tilejson","pmtiles","wmts","wms"];typeof this.displayWebMapLink_=="string"&&(t=[this.displayWebMapLink_]);let r=e.getLinksWithRels(t);return Array.isArray(this.displayWebMapLink_)?r=this.displayWebMapLink_.map(n=>{if(typeof n=="string"){const s=r.find(o=>o.id===n);return s||null}return n}).filter(n=>!!n):r.sort((n,s)=>{const o=t.indexOf(n.rel),a=t.indexOf(s.rel);return o-a}),r}async setAssets(e){if(Array.isArray(e)){const t=this.getData();this.assets_=e.map(r=>t instanceof Ht&&typeof r=="string"?t.getAsset(r):r instanceof ai?r:new ai(r))}else this.assets_=null;await this.updateLayers_()}async setChildren(e,t={}){if(!e){this.children_=null,this.childrenOptions_={};return}e instanceof fl?this.children_=e.getAll():Dh(e)&&e.type==="FeatureCollection"?this.children_=li(e,!this.disableMigration_).getAll():Array.isArray(e)?this.children_=e.map(r=>r instanceof Ht?r:li(r,!this.disableMigration_)):this.children_=null,this.children_&&this.children_.length===0&&(this.children_=null),this.childrenOptions_=t,await this.updateLayers_()}getData(){return this.get("stac")}getChildren(){return this.children_}getAssets(){return this.assets_}getExtent(){if(!this.map_)return;const e=this.map_.getView();if(!e)return;let t;const r=this.getData();r&&(t=r.getBoundingBox());const n=this.getChildren();if(!t&&n){const s=n.map(o=>o.getBoundingBox());t=bs(s)}if(t)return On(t,"EPSG:4326",e.getProjection())}getAttributions(){const e=[],t=this.getData();if(t){const r=t.getMetadata("attribution");r&&r.push(r)}return e}getSource(){return null}async getWmtsCapabilities_(e){try{const t=new URL(e);t.searchParams.set("service","wmts"),t.searchParams.set("request","GetCapabilities");const r=await this.fetch_(t.toString(),"text");return new Ns().read(r)}catch{return null}}}mh(_h);window.eoxMapAdvancedOlLayers={Graticule:Tp,Heatmap:_m,Image,Layer:ps,VectorImage:xm,WebGLPoints:Tm,WebGLTile:Gi,WebGLVector:wm,STAC:fo};function p0(i){const e=i[0],t=new Array(e);let r=1<<e-1,n,s;for(n=0;n<e;++n)s=48,i[1]&r&&(s+=1),i[2]&r&&(s+=2),t[n]=String.fromCharCode(s),r>>=1;return t.join("")}const m0='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class _0 extends Tt{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:se("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const r="https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(r).then(n=>n.json()).then(n=>this.handleImageryMetadataResponse(n))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],r=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,n=this.getProjection(),s=Zr(n),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],l=Hr({extent:s,minZoom:t.zoomMin,maxZoom:r,tileSize:a});this.tileGrid=l;const c=this.culture_,u=this.hidpi_,h=this.placeholderTiles_;if(this.tileUrlFunction=Es(t.imageUrlSubdomains.map(function(f){const g=[0,0,0],d=t.imageUrl.replace("{subdomain}",f).replace("{culture}",c);return function(p,m,y){if(!p)return;Un(p[0],p[1],p[2],g);const _=new URL(d.replace("{quadkey}",p0(g))),E=_.searchParams;return u&&(E.set("dpi","d1"),E.set("device","mobile")),h===!0?E.delete("n"):h===!1&&E.set("n","z"),_.toString()}})),t.imageryProviders){const f=ls(se("EPSG:4326"),this.getProjection());this.setAttributions(g=>{const d=[],p=g.viewState,m=this.getTileGrid(),y=m.getZForResolution(p.resolution,this.zDirection),E=m.getTileCoordForCoordAndZ(p.center,y)[0];return t.imageryProviders.map(function(w){let S=!1;const T=w.coverageAreas;for(let v=0,A=T.length;v<A;++v){const L=T[v];if(E>=L.zoomMin&&E<=L.zoomMax){const R=L.bbox,N=[R[1],R[0],R[3],R[2]],O=ar(N,f);if(or(O,g.extent)){S=!0;break}}}S&&d.push(w.attribution)}),d.push(m0),d})}this.setState("ready")}}class y0 extends Ii{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const r=new XMLHttpRequest;r.addEventListener("load",this.handleInitResponse_.bind(this,e)),r.addEventListener("error",this.handleInitError_.bind(this)),r.open("POST",t),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const r=t.target;if(!r.status||r.status>=200&&r.status<300){let n;try{n=JSON.parse(r.responseText)}catch{this.setState("error");return}this.applyTemplate_(n),this.templateCache_[e]=n,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}class E0 extends Ji{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const r=t.getGeometry();return Ze(!r||r.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),r},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,r){var n;(n=this.source)==null||n.loadFeatures(e,t,r),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(De.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(De.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const r=e===0?0:Math.min(t,e)/e,n=e!==this.distance||this.interpolationRatio!==r;this.distance=e,this.minDistance=t,this.interpolationRatio=r,n&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=Xr(),t=this.distance*this.resolution,r=this.source.getFeatures(),n={};for(let s=0,o=r.length;s<o;s++){const a=r[s];if(!(ae(a)in n)){const l=this.geometryFunction(a);if(l){const c=l.getCoordinates();Cu(c,e),hs(e,t,e);const u=this.source.getFeaturesInExtent(e).filter(function(h){const f=ae(h);return f in n?!1:(n[f]=!0,!0)});this.features.push(this.createCluster(u,e))}}}}createCluster(e,t){const r=[0,0];for(let a=e.length-1;a>=0;--a){const l=this.geometryFunction(e[a]);l?_u(r,l.getCoordinates()):e.splice(a,1)}yu(r,1/e.length);const n=Pt(t),s=this.interpolationRatio,o=new ct([r[0]*(1-s)+n[0]*s,r[1]*(1-s)+n[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new et({geometry:o,features:e})}}const x0="https://tile.googleapis.com/v1/createSession",b0="https://tile.googleapis.com/v1/2dtiles",T0="https://tile.googleapis.com/tile/v1/viewport",w0=22;class S0 extends Tt{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const r={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(r.imageFormat=e.imageFormat),e.scale&&(r.scale=e.scale),t&&(r.highDpi=!0),e.layerTypes&&(r.layerTypes=e.layerTypes),e.styles&&(r.styles=e.styles),e.overlay===!0&&(r.overlay=!0),e.apiOptions&&(r.apiOptions=e.apiOptions),this.sessionTokenRequest_=r,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_,this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=x0+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},r=await this.fetchSessionToken(e,t);if(!r.ok){try{const h=await r.json();this.error_=new Error(h.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const n=await r.json(),s=this.getTilePixelRatio(1),o=[n.tileWidth/s,n.tileHeight/s];this.tileGrid=Hr({extent:Zr(this.getProjection()),maxZoom:w0,tileSize:o});const a=n.session;this.sessionTokenValue_=a;const l=this.apiKey_;this.tileUrlFunction=function(h,f,g){const d=h[0],p=h[1],m=h[2];return`${b0}/${d}/${p}/${m}?session=${a}&key=${l}`};const c=parseInt(n.expiry,10)*1e3,u=Math.max(c-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),u),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[Ft.ANIMATING]||e.viewHints[Ft.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,r]=So(Fu(e.extent),e.viewState.projection),[n,s]=So(Ou(e.extent),e.viewState.projection),l=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${r}&east=${n}&west=${t}`;if(this.previousViewportExtent_==l)return this.previousViewportAttribution_;this.previousViewportExtent_=l;const c=this.sessionTokenValue_,u=this.apiKey_,h=`${T0}?session=${c}&key=${u}&${l}`;return this.previousViewportAttribution_=await fetch(h).then(f=>f.json()).then(f=>f.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let Gc=class extends ds{constructor(e,t,r,n,s,o,a){super(t,r,n,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==Z.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const r=It(t[0],t[1]);return r.drawImage(e,0,0),this.zoomifyImage_=r.canvas,r.canvas}return e}};class R0 extends Tt{constructor(e){const t=e.size,r=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",n=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],l=e.tileSize||Gn;let c=l*n;switch(r){case"default":for(;s>c||o>c;)a.push([Math.ceil(s/c),Math.ceil(o/c)]),c+=c;break;case"truncated":let T=s,v=o;for(;T>c||v>c;)a.push([Math.ceil(T/c),Math.ceil(v/c)]),T>>=1,v>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const u=[n],h=[0];for(let T=1,v=a.length;T<v;T++)u.push(n<<T),h.push(a[T-1][0]*a[T-1][1]+h[T-1]);u.reverse();const f=new tn({tileSize:l,extent:e.extent||[0,-o,s,0],resolutions:u});let g=e.url;g&&!g.includes("{TileGroup}")&&!g.includes("{tileIndex}")&&(g+="{TileGroup}/{z}-{x}-{y}.jpg");const d=sl(g);let p=l*n;function m(T){return function(v,A,L){if(!v)return;const R=v[0],N=v[1],O=v[2],k=N+O*a[R][0],$=(k+h[R])/p|0,D={z:R,x:N,y:O,tileIndex:k,TileGroup:"TileGroup"+$};return T.replace(/\{(\w+?)\}/g,function(re,z){return D[z]})}}const y=Es(d.map(m)),_=Gc.bind(null,Qe(l*n));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:n,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:_,tileGrid:f,tileUrlFunction:y,transition:e.transition}),this.zDirection=e.zDirection;const E=f.getTileCoordForCoordAndResolution(Pt(f.getExtent()),u[u.length-1]),w=y(E,1,null),S=new Image;S.addEventListener("error",()=>{p=l,this.changed()}),S.src=w}}function vr(i){return i.toLocaleString("en",{maximumFractionDigits:10})}class v0 extends Tt{constructor(e){const t=e||{};let r=t.url||"";r=r+(r.lastIndexOf("/")===r.length-1||r===""?"":"/");const n=t.version||be.VERSION2,s=t.sizes||[],o=t.size;Ze(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],l=o[1],c=t.tileSize,u=t.tilePixelRatio||1,h=t.format||"jpg",f=t.quality||(t.version==be.VERSION1?"native":"default");let g=t.resolutions||[];const d=t.supports||[],p=t.extent||[0,-l,a,0],m=s!=null&&Array.isArray(s)&&s.length>0,y=c!==void 0&&(typeof c=="number"&&Number.isInteger(c)&&c>0||Array.isArray(c)&&c.length>0),_=d!=null&&Array.isArray(d)&&(d.includes("regionByPx")||d.includes("regionByPct"))&&(d.includes("sizeByWh")||d.includes("sizeByH")||d.includes("sizeByW")||d.includes("sizeByPct"));let E,w,S;if(g.sort(function(L,R){return R-L}),y||_)if(c!=null&&(typeof c=="number"&&Number.isInteger(c)&&c>0?(E=c,w=c):Array.isArray(c)&&c.length>0&&((c.length==1||c[1]==null&&Number.isInteger(c[0]))&&(E=c[0],w=c[0]),c.length==2&&(Number.isInteger(c[0])&&Number.isInteger(c[1])?(E=c[0],w=c[1]):c[0]==null&&Number.isInteger(c[1])&&(E=c[1],w=c[1])))),(E===void 0||w===void 0)&&(E=Gn,w=Gn),g.length==0){S=Math.max(Math.ceil(Math.log(a/E)/Math.LN2),Math.ceil(Math.log(l/w)/Math.LN2));for(let L=S;L>=0;L--)g.push(Math.pow(2,L))}else{const L=Math.max(...g);S=Math.round(Math.log(L)/Math.LN2)}else if(E=a,w=l,g=[],m){s.sort(function(R,N){return R[0]-N[0]}),S=-1;const L=[];for(let R=0;R<s.length;R++){const N=a/s[R][0];if(g.length>0&&g[g.length-1]==N){L.push(R);continue}g.push(N),S++}if(L.length>0)for(let R=0;R<L.length;R++)s.splice(L[R]-R,1)}else g.push(1),s.push([a,l]),S=0;const T=new tn({tileSize:[E,w],extent:p,origin:Mn(p),resolutions:g}),v=function(L,R,N){let O,k;const $=L[0];if($>S)return;const D=L[1],re=L[2],z=g[$];if(!(D===void 0||re===void 0||z===void 0||D<0||Math.ceil(a/z/E)<=D||re<0||Math.ceil(l/z/w)<=re)){if(_||y){const H=D*E*z,Q=re*w*z;let ie=E*z,he=w*z,_e=E,fe=w;if(H+ie>a&&(ie=a-H),Q+he>l&&(he=l-Q),H+E*z>a&&(_e=Math.floor((a-H+z-1)/z)),Q+w*z>l&&(fe=Math.floor((l-Q+z-1)/z)),H==0&&ie==a&&Q==0&&he==l)O="full";else if(!_||d.includes("regionByPx"))O=H+","+Q+","+ie+","+he;else if(d.includes("regionByPct")){const Ee=vr(H/a*100),Re=vr(Q/l*100),we=vr(ie/a*100),Ie=vr(he/l*100);O="pct:"+Ee+","+Re+","+we+","+Ie}n==be.VERSION3&&(!_||d.includes("sizeByWh"))?k=_e+","+fe:!_||d.includes("sizeByW")?k=_e+",":d.includes("sizeByH")?k=","+fe:d.includes("sizeByWh")?k=_e+","+fe:d.includes("sizeByPct")&&(k="pct:"+vr(100/z))}else if(O="full",m){const H=s[$][0],Q=s[$][1];n==be.VERSION3?H==a&&Q==l?k="max":k=H+","+Q:H==a?k="full":k=H+","}else k=n==be.VERSION3?"max":"full";return r+O+"/"+k+"/0/"+f+"."+h}},A=Gc.bind(null,Qe(c||256).map(function(L){return L*u}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:A,tileGrid:T,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:v,transition:t.transition}),this.zDirection=t.zDirection}}function zc(i,e,t,r,n,s){const o=n.getCode().split(/:(?=\d+$)/).pop(),a=t/r,l=[vo(Ae(e)/a,Ao),vo(Je(e)/a,Ao)];s.SIZE=l[0]+","+l[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*r:90*r);const c=i.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return Ci(c,s)}function P0(i){const e=i.load?i.load:pr,t=se(i.projection||"EPSG:3857"),r=i.ratio??1.5,n=i.crossOrigin??null;return function(s,o,a){a=i.hidpi?a:1;const l={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(l,i.params),s=ol(s,o,a,r);const c=zc(i.url,s,o,a,t,l),u=new Image;return u.crossOrigin=n,e(u,c).then(h=>{const f=Ae(s)/h.width*a;return{image:h,extent:s,resolution:f,pixelRatio:a}})}}class A0 extends Vt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:_s,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=P0({crossOrigin:this.crossOrigin_,params:this.params_,projection:n,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),pr(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class L0 extends Vt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,r,n){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==r&&bi(s.getExtent(),e))return s;e=e.slice(),Ha(e,this.ratio_);const o=Ae(e)/t,a=Je(e)/t,l=[o*r,a*r],c=this.canvasFunction_.call(this,e,t,r,l,n);return c&&(s=new Xs(e,t,r,c)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function I0(i,e,t,r){const n=Ae(i),s=Je(i),o=e[0],a=e[1],l=.0254/r;return a*n>o*s?n*t/(o*l):s*t/(a*l)}function C0(i,e,t,r,n,s,o){const a=I0(t,r,s,o),l=Pt(t),c={OPERATION:n?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(r[0]),SETDISPLAYHEIGHT:Math.round(r[1]),SETVIEWSCALE:a,SETVIEWCENTERX:l[0],SETVIEWCENTERY:l[1]};return Object.assign(c,e),Ci(i,c)}function F0(i){const e=i.load||pr,t=i.useOverlay??!1,r=i.metersPerUnit||1,n=i.displayDpi||96,s=i.ratio??1,o=i.crossOrigin??null;return function(a,l,c){const u=new Image;u.crossOrigin=o,a=ol(a,l,c,s);const h=Ae(a)/l,f=Je(a)/l,g=[h*c,f*c],d=C0(i.url,i.params,a,g,t,r,n);return e(u,d).then(p=>({image:p,extent:a,pixelRatio:c}))}}class O0 extends Vt{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:_s,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=F0({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),pr(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}const M0=new Error("Image failed to load");function kc(i,e,t,r,n){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=n.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(M0)),a.src=al(i,e,t,r,n.maxY)})}function Pa(i){return function(e,t,r,n){const s=yh(i,e,t,r);return kc(s,e,t,r,n)}}function N0(i){return function(e,t,r,n){const s=i(e,t,r,n);return kc(s,e,t,r,n)}}function Aa(i){let e;if(Array.isArray(i))e=Pa(i);else if(typeof i=="string"){const t=sl(i);e=Pa(t)}else if(typeof i=="function")e=N0(i);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let La=0;function Ia(i){return Array.isArray(i)?i.join(`
`):typeof i=="string"?i:(++La,"url-function-key-"+La)}class $c extends ri{constructor(e){e=e||{};let t=e.loader,r;e.url&&(t=Aa(e.url),r=Ia(e.url));const n=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:r,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:n,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=Aa(e);this.setLoader(t),this.setKey(Ia(e)),this.getState()!=="ready"&&this.setState("ready")}}const D0={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},U0={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function Vc(i,e){if(!e.length)return i;const t=new URL(i,"file:/");if(t.pathname.split("/").includes("collections"))return Br('The "collections" query parameter cannot be added to collection endpoints'),i;const r=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",r);const n=i.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${n}?${s}`}function B0(i,e,t){let r,n;for(let s=0;s<i.length;++s){const o=i[s];if(o.rel==="item"){if(o.type===e){r=o.href;break}(D0[o.type]||!n&&o.type.startsWith("image/"))&&(n=o.href)}}if(!r)if(n)r=n;else throw new Error('Could not find "item" link');return t&&(r=Vc(r,t)),r}function G0(i,e,t,r){let n,s;const o={};for(let a=0;a<i.length;++a){const l=i[a];if(o[l.type]=l.href,l.rel==="item"){if(l.type===e){n=l.href;break}U0[l.type]&&(s=l.href)}}if(!n&&t)for(let a=0;a<t.length;++a){const l=t[a];if(o[l]){n=o[l];break}}if(!n)if(s)n=s;else throw new Error('Could not find "item" link');return r&&(n=Vc(n,r)),n}function Ca(i,e,t,r){let n=i.projection;if(!n&&(typeof e.crs=="string"?n=se(e.crs):"uri"in e.crs&&(n=se(e.crs.uri)),!n))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(T=>T.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):n.getAxisOrientation()).startsWith("en"),l=e.tileMatrices,c={};for(let T=0;T<l.length;++T){const v=l[T];c[v.id]=v}const u={},h=[];if(r)for(let T=0;T<r.length;++T){const v=r[T],A=v.tileMatrix;h.push(A),u[A]=v}else for(let T=0;T<l.length;++T){const v=l[T].id;h.push(v)}const f=h.length,g=new Array(f),d=new Array(f),p=new Array(f),m=new Array(f),y=[-1/0,-1/0,1/0,1/0];for(let T=0;T<f;++T){const v=h[T],A=c[v],L=A.pointOfOrigin;a?g[T]=[L[1],L[0]]:g[T]=L,d[T]=A.cellSize,p[T]=[A.matrixWidth,A.matrixHeight],m[T]=[A.tileWidth,A.tileHeight];const R=u[v];if(R){const N=A.cellSize*A.tileWidth,O=g[T][0]+R.minTileCol*N,k=g[T][0]+(R.maxTileCol+1)*N,$=A.cellSize*A.tileHeight,D=A.cornerOfOrigin==="bottomLeft";let re,z;D?(re=g[T][1]+R.minTileRow*$,z=g[T][1]+(R.maxTileRow+1)*$):(re=g[T][1]-(R.maxTileRow+1)*$,z=g[T][1]-R.minTileRow*$),ut(y,[O,re,k,z],y)}}const _=new tn({origins:g,resolutions:d,sizes:p,tileSizes:m,extent:r?y:void 0}),E=i.context,w=i.url;function S(T,v,A){if(!T)return;const L=h[T[0]],R=c[L],N=R.cornerOfOrigin==="bottomLeft",O={tileMatrix:L,tileCol:T[1],tileRow:N?-T[2]-1:T[2]};if(r){const $=u[R.id];if(O.tileCol<$.minTileCol||O.tileCol>$.maxTileCol||O.tileRow<$.minTileRow||O.tileRow>$.maxTileRow)return}Object.assign(O,E);const k=t.replace(/\{(\w+?)\}/g,function($,D){return O[D]});return Nc(w,k)}return{grid:_,projection:n,urlTemplate:t,urlFunction:S}}function z0(i,e){const t=e.tileMatrixSetLimits;let r;if(e.dataType==="map")r=B0(e.links,i.mediaType,i.collections);else if(e.dataType==="vector")r=G0(e.links,i.mediaType,i.supportedMediaTypes,i.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return Ca(i,e.tileMatrixSet,r,t);const n=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!n)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=n.href,o=Nc(i.url,s);return Mc(o).then(function(a){return Ca(i,a,r,t)})}function jc(i){return Mc(i.url).then(function(e){return z0(i,e)})}class k0 extends Tt{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};jc(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Br(e),this.setState("error")}}class $0 extends ys{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};jc(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Br(e),this.setState("error")}}function Xc(i){return function(e){const t=e.buffers,r=e.meta,n=e.imageOps,s=e.width,o=e.height,a=t.length,l=t[0].byteLength;if(n){const f=new Array(a);for(let d=0;d<a;++d)f[d]=new ImageData(new Uint8ClampedArray(t[d]),s,o);return i(f,r).data.buffer}const c=new Uint8ClampedArray(l),u=new Array(a),h=new Array(a);for(let f=0;f<a;++f)u[f]=new Uint8ClampedArray(t[f]),h[f]=[0,0,0,0];for(let f=0;f<l;f+=4){for(let d=0;d<a;++d){const p=u[d];h[d][0]=p[f],h[d][1]=p[f+1],h[d][2]=p[f+2],h[d][3]=p[f+3]}const g=i(h,r);c[f]=g[0],c[f+1]=g[1],c[f+2]=g[2],c[f+3]=g[3]}return c.buffer}}function V0(i,e){const r=Object.keys(i.lib||{}).map(function(s){return"const "+s+" = "+i.lib[s].toString()+";"}).concat(["const __minion__ = ("+Xc.toString()+")(",i.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),n=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(r.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return n.addEventListener("message",e),n}function j0(i,e){const t=Xc(i.operation);let r=!1;return{postMessage:function(n){setTimeout(function(){r||e({data:{buffer:t(n),meta:n.meta}})},0)},terminate:function(){r=!0}}}class X0 extends Wa{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const r=new Array(t);if(t)for(let n=0;n<t;++n)r[n]=V0(e,this.onWorkerMessage_.bind(this,n));else r[0]=j0(e,this.onWorkerMessage_.bind(this,0));this.workers_=r,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,r){this.enqueue_({inputs:e,meta:t,callback:r}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,r=e.inputs[0].height,n=e.inputs.map(function(l){return l.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:n,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},n);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let l=0;l<s;++l){const c=l*a,u=[];for(let h=0,f=n.length;h<f;++h)u.push(n[h].slice(c,c+a));this.workers_[l].postMessage({buffers:u,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},u)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let r,n;if(t===1)r=new Uint8ClampedArray(this.dataLookup_[0].buffer),n=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;r=new Uint8ClampedArray(s),n=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const l=this.dataLookup_[a].buffer,c=a*o;r.set(new Uint8ClampedArray(l),c),n[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(r,e.inputs[0].width,e.inputs[0].height),n),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const Fa={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class Oa extends Za{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class Wc extends Vt{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=Z0(e.sources);const t=this.changed.bind(this);for(let r=0,n=this.layers_.length;r<n;++r)this.layers_[r].addEventListener(De.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new Eh(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:Pe(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:H0(this.layers_),pixelRatio:1,pixelToCoordinateTransform:Pe(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:ae(this),renderTargets:{}},this.setAttributions(function(r){var s;const n=[];for(let o=0,a=e.sources.length;o<a;++o){const l=e.sources[o],c=l instanceof xs?l:l.getSource();if(!c)continue;const u=(s=c.getAttributions())==null?void 0:s(r);typeof u=="string"?n.push(u):u!==void 0&&n.push(...u)}return n}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new X0({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const n=Object.assign({},this.frameState_);n.viewState=Object.assign({},n.viewState);const s=Pt(e);n.size[0]=Math.ceil(Ae(e)/t),n.size[1]=Math.ceil(Je(e)/t),n.extent=[s[0]-n.size[0]*t/2,s[1]-n.size[1]*t/2,s[0]+n.size[0]*t/2,s[1]+n.size[1]*t/2],n.time=Date.now();const o=n.viewState;return o.center=s,o.projection=r,o.resolution=t,n}allSourcesReady_(){let e=!0,t;for(let r=0,n=this.layers_.length;r<n;++r)if(t=this.layers_[r].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,r,n){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,n);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!Gr(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=W0(this.layers_[s],e);if(o)r[s]=o;else return}const n={};this.dispatchEvent(new Oa(Fa.BEFOREOPERATIONS,e,n)),this.processor_.process(r,n,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,r,n){if(t||!r)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!Gr(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const l=Math.round(Ae(s)/o),c=Math.round(Je(s)/o);a=It(l,c),this.renderedImageCanvas_=new Xs(s,o,1,a.canvas)}a.putImageData(r,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new Oa(Fa.AFTEROPERATIONS,e,n))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let r=0,n=this.layers_.length;r<n&&(t=this.layers_[r].getSource().getResolutions(e),!t);++r);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}Wc.prototype.dispose;let Ut=null;function W0(i,e){const t=i.getRenderer();if(!t)throw new Error("Unsupported layer type: "+i);if(!t.prepareFrame(e))return null;const r=e.size[0],n=e.size[1];if(r===0||n===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===r&&o.height===n)return o.getContext("2d").getImageData(0,0,r,n)}if(!Ut)Ut=It(r,n,void 0,{willReadFrequently:!0});else{const a=Ut.canvas;a.width!==r||a.height!==n?Ut=It(r,n,void 0,{willReadFrequently:!0}):Ut.clearRect(0,0,r,n)}return Ut.drawImage(o,0,0,r,n),Ut.getImageData(0,0,r,n)}function H0(i){return i.map(function(e){return e.getLayerState()})}function Z0(i){const e=i.length,t=new Array(e);for(let r=0;r<e;++r)t[r]=Y0(i[r]);return t}function Y0(i){let e;return i instanceof xs?i instanceof ms?e=new Bn({source:i}):i instanceof Vt&&(e=new il({source:i})):e=i,e}const q0='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',K0='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',J0='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',Q0={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},eE={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class tE extends Ii{constructor(e){const t=e.layer.indexOf("-"),r=t==-1?e.layer:e.layer.slice(0,t),n=eE[r]||{minZoom:0,maxZoom:20,retina:!0},s=Q0[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=n.retina&&e.retina?"@2x":"",l=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,c=[q0,K0,xh];e.layer.startsWith("stamen_")&&c.splice(1,0,J0),super({attributions:c,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:n.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:n.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:l,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class rE extends Tt{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=Xr(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const r in this.params_)t[e++]=r+"-"+this.params_[r];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,r,n,s,o){const a=this.urls;if(!a)return;let l;if(a.length==1)l=a[0];else{const c=Mu(bh(e),a.length);l=a[c]}return zc(l,r,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),n,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}setParams(e){this.params_=Object.assign({},e),this.setKey(this.getKeyForParams_())}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,r){let n=this.getTileGrid();if(n||(n=this.getTileGridForProjection(r)),n.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=n.getTileCoordExtent(e,this.tmpExtent_);let o=Qe(n.getTileSize(e[0]),this.tmpSize);t!=1&&(o=Th(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,r,a)}}class iE extends $c{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",r=e.source;super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:r!==void 0?r.getWrapX():void 0});const n=()=>{var o;this.projection=e.projection!==void 0?se(e.projection):r!==void 0?r.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:r!==void 0?r.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:r!==void 0?r.zDirection:this.zDirection,r instanceof ri&&(this.transformMatrix=((o=r.transformMatrix)==null?void 0:o.slice())||null);const s=this.tileGrid;s&&this.setTileSizes(s.getResolutions().map((a,l)=>Qe(s.getTileSize(l)).map(c=>Math.max(Math.floor(c),1)))),this.setLoader((a,l,c,u)=>{const h=al(t,a,l,c,u.maxY),[f,g]=this.getTileSize(a),d=It(f,g);return d.strokeStyle="grey",d.strokeRect(.5,.5,f+.5,g+.5),d.fillStyle="grey",d.strokeStyle="white",d.textAlign="center",d.textBaseline="middle",d.font="24px sans-serif",d.lineWidth=4,d.strokeText(h,f/2,g/2,f),d.fillText(h,f/2,g/2,f),Promise.resolve(d.canvas)}),this.setState("ready")};if(r===void 0||r.getState()==="ready")n();else{const s=()=>{r.getState()==="ready"&&(r.removeEventListener(De.CHANGE,s),n())};r.addEventListener(De.CHANGE,s)}}}class nE extends Rh{constructor(e,t,r,n,s,o){super(e,t),this.src_=r,this.extent_=n,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),r=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),n=this.grid_[Math.floor((1-r)*this.grid_.length)];if(typeof n!="string")return null;let s=n.charCodeAt(Math.floor(t*n.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,r){this.state==Z.EMPTY&&r===!0?(this.state=Z.IDLE,Nu(this,De.CHANGE,n=>{t(this.getData(e))}),this.loadInternal_()):r===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=Z.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=Z.LOADED,this.changed()}loadInternal_(){if(this.state==Z.IDLE)if(this.state=Z.LOADING,this.jsonp_)ho(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(r)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(Z.EMPTY)}}class sE extends ms{constructor(e){if(super({projection:se("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=wh,this.template_=void 0,this.jsonp_=e.jsonp||!1,this.tileCache_=new Ja(512),e.url)if(this.jsonp_)ho(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,r,n){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s),a=this.getTile(o[0],o[1],o[2],1,this.getProjection());a.getState()==Z.IDLE&&a.load(),a.forDataAtCoordinate(e,r,n)}else n===!0?setTimeout(function(){r(null)},0):r(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=se("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const u=ls(t,r);n=ar(e.bounds,u)}const s=Zr(r),o=e.minzoom||0,a=e.maxzoom||22,l=Hr({extent:s,maxZoom:a,minZoom:o});this.tileGrid=l,this.template_=e.template;const c=e.grids;if(!c){this.setState("error");return}if(this.tileUrlFunction_=rl(c,l),e.attribution){const u=n!==void 0?n:s;this.setAttributions(function(h){return or(u,h.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,r,n,s){const o=[e,t,r],a=this.getTileCoordForTileUrlFunction(o,s),l=this.tileUrlFunction_(a,n,s),c=`${this.getKey()},${Sh(e,t,r)}`;if(this.tileCache_.containsKey(c))return this.tileCache_.get(c);this.tileCache_.expireCache();const u=new nE(o,l!==void 0?Z.IDLE:Z.EMPTY,l!==void 0?l:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_);return this.tileCache_.set(c,u),u}}class oE extends Tt{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,tilePixelRatio:e.tilePixelRatio,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection,wrapX:e.wrapX}),this.version_=e.version!==void 0?e.version:"1.0.0",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,fetch(e.url).then(t=>t.text()).then(t=>new window.DOMParser().parseFromString(t,"application/xml")).then(t=>{this.handleCapabilitiesResponse(t,e)})}handleCapabilitiesResponse(e,t){const n=new Ns().read(e),s=nl(n,t);this.crossOrigin=s.crossOrigin,this.projection=s.projection,this.tileGrid=s.tileGrid,this.requestEncoding_=s.requestEncoding,this.matrixSet_=s.matrixSet,this.style_=s.style,this.format_=s.format,this.dimensions_=s.dimensions,this.setUrls(s.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=Es(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.setState("ready")}createFromWMTSTemplate(e){const t=this.requestEncoding_,r={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};t==="KVP"&&Object.assign(r,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=t==="KVP"?Ci(e,r):e.replace(/\{(\w+?)\}/g,(o,a)=>a.toLowerCase()in r?r[a.toLowerCase()]:o);const n=this.tileGrid,s=this.dimensions_;return function(o){if(!o)return;const a={TileMatrix:n.getMatrixId(o[0]),TileCol:o[1],TileRow:o[2]};Object.assign(a,s);let l=e;return t==="KVP"?l=Ci(l,a):l=l.replace(/\{(\w+?)\}/g,(c,u)=>a[u]),l}}}const _t=new Uint8Array([102,103,98,3,102,103,98,0]),Ve=4,Pr=4,Ar=4,ii=4,St=new Int32Array(2),Ma=new Float32Array(St.buffer),Na=new Float64Array(St.buffer),gi=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;var Qn;(function(i){i[i.UTF8_BYTES=1]="UTF8_BYTES",i[i.UTF16_STRING=2]="UTF16_STRING"})(Qn||(Qn={}));class tt{constructor(e){this.bytes_=e,this.position_=0,this.text_decoder_=new TextDecoder}static allocate(e){return new tt(new Uint8Array(e))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(e){this.position_=e}capacity(){return this.bytes_.length}readInt8(e){return this.readUint8(e)<<24>>24}readUint8(e){return this.bytes_[e]}readInt16(e){return this.readUint16(e)<<16>>16}readUint16(e){return this.bytes_[e]|this.bytes_[e+1]<<8}readInt32(e){return this.bytes_[e]|this.bytes_[e+1]<<8|this.bytes_[e+2]<<16|this.bytes_[e+3]<<24}readUint32(e){return this.readInt32(e)>>>0}readInt64(e){return BigInt.asIntN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readUint64(e){return BigInt.asUintN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readFloat32(e){return St[0]=this.readInt32(e),Ma[0]}readFloat64(e){return St[gi?0:1]=this.readInt32(e),St[gi?1:0]=this.readInt32(e+4),Na[0]}writeInt8(e,t){this.bytes_[e]=t}writeUint8(e,t){this.bytes_[e]=t}writeInt16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeUint16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeInt32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeUint32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeInt64(e,t){this.writeInt32(e,Number(BigInt.asIntN(32,t))),this.writeInt32(e+4,Number(BigInt.asIntN(32,t>>BigInt(32))))}writeUint64(e,t){this.writeUint32(e,Number(BigInt.asUintN(32,t))),this.writeUint32(e+4,Number(BigInt.asUintN(32,t>>BigInt(32))))}writeFloat32(e,t){Ma[0]=t,this.writeInt32(e,St[0])}writeFloat64(e,t){Na[0]=t,this.writeInt32(e,St[gi?0:1]),this.writeInt32(e+4,St[gi?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+Pr+Ar)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let e="";for(let t=0;t<Ar;t++)e+=String.fromCharCode(this.readInt8(this.position_+Pr+t));return e}__offset(e,t){const r=e-this.readInt32(e);return t<this.readInt16(r)?this.readInt16(r+t):0}__union(e,t){return e.bb_pos=t+this.readInt32(t),e.bb=this,e}__string(e,t){e+=this.readInt32(e);const r=this.readInt32(e);e+=Pr;const n=this.bytes_.subarray(e,e+r);return t===Qn.UTF8_BYTES?n:this.text_decoder_.decode(n)}__union_with_string(e,t){return typeof e=="string"?this.__string(t):this.__union(e,t)}__indirect(e){return e+this.readInt32(e)}__vector(e){return e+this.readInt32(e)+Pr}__vector_len(e){return this.readInt32(e+this.readInt32(e))}__has_identifier(e){if(e.length!=Ar)throw new Error("FlatBuffers: file identifier must be length "+Ar);for(let t=0;t<Ar;t++)if(e.charCodeAt(t)!=this.readInt8(this.position()+Pr+t))return!1;return!0}createScalarList(e,t){const r=[];for(let n=0;n<t;++n){const s=e(n);s!==null&&r.push(s)}return r}createObjList(e,t){const r=[];for(let n=0;n<t;++n){const s=e(n);s!==null&&r.push(s.unpack())}return r}}var oe,ve=((oe={})[oe.Byte=0]="Byte",oe[oe.UByte=1]="UByte",oe[oe.Bool=2]="Bool",oe[oe.Short=3]="Short",oe[oe.UShort=4]="UShort",oe[oe.Int=5]="Int",oe[oe.UInt=6]="UInt",oe[oe.Long=7]="Long",oe[oe.ULong=8]="ULong",oe[oe.Float=9]="Float",oe[oe.Double=10]="Double",oe[oe.String=11]="String",oe[oe.Json=12]="Json",oe[oe.DateTime=13]="DateTime",oe[oe.Binary=14]="Binary",oe);class Se{constructor(){J(this,"bb",null);J(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsColumn(e,t){return(t||new Se).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsColumn(e,t){return e.setPosition(e.position()+ii),(t||new Se).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}type(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readUint8(this.bb_pos+e):ve.Byte}title(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}width(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.readInt32(this.bb_pos+e):-1}precision(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readInt32(this.bb_pos+e):-1}scale(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readInt32(this.bb_pos+e):-1}nullable(){let e=this.bb.__offset(this.bb_pos,18);return!e||!!this.bb.readInt8(this.bb_pos+e)}unique(){let e=this.bb.__offset(this.bb_pos,20);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}primaryKey(){let e=this.bb.__offset(this.bb_pos,22);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}metadata(e){let t=this.bb.__offset(this.bb_pos,24);return t?this.bb.__string(this.bb_pos+t,e):null}static startColumn(e){e.startObject(11)}static addName(e,t){e.addFieldOffset(0,t,0)}static addType(e,t){e.addFieldInt8(1,t,ve.Byte)}static addTitle(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWidth(e,t){e.addFieldInt32(4,t,-1)}static addPrecision(e,t){e.addFieldInt32(5,t,-1)}static addScale(e,t){e.addFieldInt32(6,t,-1)}static addNullable(e,t){e.addFieldInt8(7,+t,1)}static addUnique(e,t){e.addFieldInt8(8,+t,0)}static addPrimaryKey(e,t){e.addFieldInt8(9,+t,0)}static addMetadata(e,t){e.addFieldOffset(10,t,0)}static endColumn(e){let t=e.endObject();return e.requiredField(t,4),t}static createColumn(e,t,r,n,s,o,a,l,c,u,h,f){return Se.startColumn(e),Se.addName(e,t),Se.addType(e,r),Se.addTitle(e,n),Se.addDescription(e,s),Se.addWidth(e,o),Se.addPrecision(e,a),Se.addScale(e,l),Se.addNullable(e,c),Se.addUnique(e,u),Se.addPrimaryKey(e,h),Se.addMetadata(e,f),Se.endColumn(e)}}var K,Ce=((K={})[K.Unknown=0]="Unknown",K[K.Point=1]="Point",K[K.LineString=2]="LineString",K[K.Polygon=3]="Polygon",K[K.MultiPoint=4]="MultiPoint",K[K.MultiLineString=5]="MultiLineString",K[K.MultiPolygon=6]="MultiPolygon",K[K.GeometryCollection=7]="GeometryCollection",K[K.CircularString=8]="CircularString",K[K.CompoundCurve=9]="CompoundCurve",K[K.CurvePolygon=10]="CurvePolygon",K[K.MultiCurve=11]="MultiCurve",K[K.MultiSurface=12]="MultiSurface",K[K.Curve=13]="Curve",K[K.Surface=14]="Surface",K[K.PolyhedralSurface=15]="PolyhedralSurface",K[K.TIN=16]="TIN",K[K.Triangle=17]="Triangle",K);class Me{constructor(){J(this,"bb",null);J(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsGeometry(e,t){return(t||new Me).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsGeometry(e,t){return e.setPosition(e.position()+ii),(t||new Me).__init(e.readInt32(e.position())+e.position(),e)}ends(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.readUint32(this.bb.__vector(this.bb_pos+t)+4*e):0}endsLength(){let e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__vector_len(this.bb_pos+e):0}endsArray(){let e=this.bb.__offset(this.bb_pos,4);return e?new Uint32Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}xy(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}xyLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}xyArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}z(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}zLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}zArray(){let e=this.bb.__offset(this.bb_pos,8);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}m(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}mLength(){let e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__vector_len(this.bb_pos+e):0}mArray(){let e=this.bb.__offset(this.bb_pos,10);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}t(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}tLength(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.__vector_len(this.bb_pos+e):0}tArray(){let e=this.bb.__offset(this.bb_pos,12);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}tm(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readUint64(this.bb.__vector(this.bb_pos+t)+8*e):BigInt(0)}tmLength(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.__vector_len(this.bb_pos+e):0}type(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readUint8(this.bb_pos+e):Ce.Unknown}parts(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Me).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}partsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}static startGeometry(e){e.startObject(8)}static addEnds(e,t){e.addFieldOffset(0,t,0)}static createEndsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addInt32(t[r]);return e.endVector()}static startEndsVector(e,t){e.startVector(4,t,4)}static addXy(e,t){e.addFieldOffset(1,t,0)}static createXyVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startXyVector(e,t){e.startVector(8,t,8)}static addZ(e,t){e.addFieldOffset(2,t,0)}static createZVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startZVector(e,t){e.startVector(8,t,8)}static addM(e,t){e.addFieldOffset(3,t,0)}static createMVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startMVector(e,t){e.startVector(8,t,8)}static addT(e,t){e.addFieldOffset(4,t,0)}static createTVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startTVector(e,t){e.startVector(8,t,8)}static addTm(e,t){e.addFieldOffset(5,t,0)}static createTmVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addInt64(t[r]);return e.endVector()}static startTmVector(e,t){e.startVector(8,t,8)}static addType(e,t){e.addFieldInt8(6,t,Ce.Unknown)}static addParts(e,t){e.addFieldOffset(7,t,0)}static createPartsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startPartsVector(e,t){e.startVector(4,t,4)}static endGeometry(e){return e.endObject()}static createGeometry(e,t,r,n,s,o,a,l,c){return Me.startGeometry(e),Me.addEnds(e,t),Me.addXy(e,r),Me.addZ(e,n),Me.addM(e,s),Me.addT(e,o),Me.addTm(e,a),Me.addType(e,l),Me.addParts(e,c),Me.endGeometry(e)}}class He{constructor(){J(this,"bb",null);J(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsFeature(e,t){return(t||new He).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsFeature(e,t){return e.setPosition(e.position()+ii),(t||new He).__init(e.readInt32(e.position())+e.position(),e)}geometry(e){let t=this.bb.__offset(this.bb_pos,4);return t?(e||new Me).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}properties(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readUint8(this.bb.__vector(this.bb_pos+t)+e):0}propertiesLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}propertiesArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Uint8Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}columns(e,t){let r=this.bb.__offset(this.bb_pos,8);return r?(t||new Se).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}static startFeature(e){e.startObject(3)}static addGeometry(e,t){e.addFieldOffset(0,t,0)}static addProperties(e,t){e.addFieldOffset(1,t,0)}static createPropertiesVector(e,t){e.startVector(1,t.length,1);for(let r=t.length-1;r>=0;r--)e.addInt8(t[r]);return e.endVector()}static startPropertiesVector(e,t){e.startVector(1,t,1)}static addColumns(e,t){e.addFieldOffset(2,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static endFeature(e){return e.endObject()}static finishFeatureBuffer(e,t){e.finish(t)}static finishSizePrefixedFeatureBuffer(e,t){e.finish(t,void 0,!0)}static createFeature(e,t,r,n){return He.startFeature(e),He.addGeometry(e,t),He.addProperties(e,r),He.addColumns(e,n),He.endFeature(e)}}function In(i,e){let t=[];for(let r=0;r<i.length;r+=2){let n=[i[r],i[r+1]];e&&n.push(e[r>>1]),t.push(n)}return t}new TextEncoder;let Da=new TextDecoder;function aE(i,e){let t={};if(!e||e.length===0)return t;let r=i.propertiesArray();if(!r)return t;let n=new DataView(r.buffer,r.byteOffset),s=i.propertiesLength(),o=0;for(;o<s;){let a=n.getUint16(o,!0);o+=2;let l=e[a],c=l.name;switch(l.type){case ve.Bool:t[c]=!!n.getUint8(o),o+=1;break;case ve.Byte:t[c]=n.getInt8(o),o+=1;break;case ve.UByte:t[c]=n.getUint8(o),o+=1;break;case ve.Short:t[c]=n.getInt16(o,!0),o+=2;break;case ve.UShort:t[c]=n.getUint16(o,!0),o+=2;break;case ve.Int:t[c]=n.getInt32(o,!0),o+=4;break;case ve.UInt:t[c]=n.getUint32(o,!0),o+=4;break;case ve.Long:t[c]=Number(n.getBigInt64(o,!0)),o+=8;break;case ve.ULong:t[c]=Number(n.getBigUint64(o,!0)),o+=8;break;case ve.Float:t[c]=n.getFloat32(o,!0),o+=4;break;case ve.Double:t[c]=n.getFloat64(o,!0),o+=8;break;case ve.DateTime:case ve.String:{let u=n.getUint32(o,!0);o+=4,t[c]=Da.decode(r.subarray(o,o+u)),o+=u;break}case ve.Json:{let u=n.getUint32(o,!0);o+=4;let h=Da.decode(r.subarray(o,o+u));t[c]=JSON.parse(h),o+=u;break}case ve.Binary:{let u=n.getUint32(o,!0);o+=4,t[c]=r.subarray(o,o+u),o+=u;break}default:throw Error(`Unknown type ${l.type}`)}}return t}const go=new Uint8Array(0);function lE(){return this._source.cancel()}function cE(i,e){if(!i.length)return e;if(!e.length)return i;var t=new Uint8Array(i.length+e.length);return t.set(i),t.set(e,i.length),t}function uE(){var i=this,e=i._array.subarray(i._index);return i._source.read().then(function(t){return i._array=go,i._index=0,t.done?e.length>0?{done:!1,value:e}:{done:!0,value:void 0}:{done:!1,value:cE(e,t.value)}})}function hE(i){if((i|=0)<0)throw new Error("invalid length");var e=this,t=this._array.length-this._index;if(this._index+i<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=i));var r=new Uint8Array(i);return r.set(this._array.subarray(this._index)),function n(){return e._source.read().then(function(s){return s.done?(e._array=go,e._index=0,t>0?r.subarray(0,t):null):t+s.value.length>=i?(e._array=s.value,e._index=i-t,r.set(s.value.subarray(0,i-t),t),r):(r.set(s.value,t),t+=s.value.length,n())})}()}function fE(i){return typeof i.slice=="function"?i:new hn(typeof i.read=="function"?i:i.getReader())}function hn(i){this._source=i,this._array=go,this._index=0}hn.prototype.read=uE;hn.prototype.slice=hE;hn.prototype.cancel=lE;class We{constructor(){J(this,"bb",null);J(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsCrs(e,t){return(t||new We).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsCrs(e,t){return e.setPosition(e.position()+ii),(t||new We).__init(e.readInt32(e.position())+e.position(),e)}org(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}code(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt32(this.bb_pos+e):0}name(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}wkt(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.__string(this.bb_pos+t,e):null}codeString(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.__string(this.bb_pos+t,e):null}static startCrs(e){e.startObject(6)}static addOrg(e,t){e.addFieldOffset(0,t,0)}static addCode(e,t){e.addFieldInt32(1,t,0)}static addName(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWkt(e,t){e.addFieldOffset(4,t,0)}static addCodeString(e,t){e.addFieldOffset(5,t,0)}static endCrs(e){return e.endObject()}static createCrs(e,t,r,n,s,o,a){return We.startCrs(e),We.addOrg(e,t),We.addCode(e,r),We.addName(e,n),We.addDescription(e,s),We.addWkt(e,o),We.addCodeString(e,a),We.endCrs(e)}}class ki{constructor(){J(this,"bb",null);J(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsHeader(e,t){return(t||new ki).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsHeader(e,t){return e.setPosition(e.position()+ii),(t||new ki).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}envelope(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}envelopeLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}envelopeArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}geometryType(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.readUint8(this.bb_pos+e):Ce.Unknown}hasZ(){let e=this.bb.__offset(this.bb_pos,10);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasM(){let e=this.bb.__offset(this.bb_pos,12);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasT(){let e=this.bb.__offset(this.bb_pos,14);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasTm(){let e=this.bb.__offset(this.bb_pos,16);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}columns(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Se).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}featuresCount(){let e=this.bb.__offset(this.bb_pos,20);return e?this.bb.readUint64(this.bb_pos+e):BigInt("0")}indexNodeSize(){let e=this.bb.__offset(this.bb_pos,22);return e?this.bb.readUint16(this.bb_pos+e):16}crs(e){let t=this.bb.__offset(this.bb_pos,24);return t?(e||new We).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}title(e){let t=this.bb.__offset(this.bb_pos,26);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,28);return t?this.bb.__string(this.bb_pos+t,e):null}metadata(e){let t=this.bb.__offset(this.bb_pos,30);return t?this.bb.__string(this.bb_pos+t,e):null}static startHeader(e){e.startObject(14)}static addName(e,t){e.addFieldOffset(0,t,0)}static addEnvelope(e,t){e.addFieldOffset(1,t,0)}static createEnvelopeVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startEnvelopeVector(e,t){e.startVector(8,t,8)}static addGeometryType(e,t){e.addFieldInt8(2,t,Ce.Unknown)}static addHasZ(e,t){e.addFieldInt8(3,+t,0)}static addHasM(e,t){e.addFieldInt8(4,+t,0)}static addHasT(e,t){e.addFieldInt8(5,+t,0)}static addHasTm(e,t){e.addFieldInt8(6,+t,0)}static addColumns(e,t){e.addFieldOffset(7,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static addFeaturesCount(e,t){e.addFieldInt64(8,t,BigInt("0"))}static addIndexNodeSize(e,t){e.addFieldInt16(9,t,16)}static addCrs(e,t){e.addFieldOffset(10,t,0)}static addTitle(e,t){e.addFieldOffset(11,t,0)}static addDescription(e,t){e.addFieldOffset(12,t,0)}static addMetadata(e,t){e.addFieldOffset(13,t,0)}static endHeader(e){return e.endObject()}static finishHeaderBuffer(e,t){e.finish(t)}static finishSizePrefixedHeaderBuffer(e,t){e.finish(t,void 0,!0)}}function fn(i){let e=ki.getRootAsHeader(i),t=e.featuresCount(),r=e.indexNodeSize(),n=[];for(let a=0;a<e.columnsLength();a++){let l=e.columns(a);if(!l)throw Error("Column unexpectedly missing");if(!l.name())throw Error("Column name unexpectedly missing");n.push({name:l.name(),type:l.type(),title:l.title(),description:l.description(),width:l.width(),precision:l.precision(),scale:l.scale(),nullable:l.nullable(),unique:l.unique(),primary_key:l.primaryKey()})}let s=e.crs(),o=s?{org:s.org(),code:s.code(),name:s.name(),description:s.description(),wkt:s.wkt(),code_string:s.codeString()}:null;return{geometryType:e.geometryType(),columns:n,envelope:null,featuresCount:Number(t),indexNodeSize:r,crs:o,title:e.title(),description:e.description(),metadata:e.metadata()}}const Wi=class Wi{constructor(){J(this,"_extraRequestThreshold",262144)}extraRequestThreshold(){return this._extraRequestThreshold}setExtraRequestThreshold(e){if(e<0)throw Error("extraRequestThreshold cannot be negative");this._extraRequestThreshold=e}};J(Wi,"global",new Wi);let $i=Wi;const dE=40,gE=16;function dn(i,e){e=Math.min(Math.max(+e,2),65535);let t=i,r=t;do r+=t=Math.ceil(t/e);while(t!==1);return 40*r}function pE(i,e){if(e<2)throw Error("Node size must be at least 2");if(i===0)throw Error("Number of items must be greater than 0");let t=i,r=t,n=[t];do r+=t=Math.ceil(t/e),n.push(t);while(t!==1);let s=[];for(let a of(t=r,n))s.push(t-a),t-=a;let o=[];for(let a=0;a<n.length;a++)o.push([s[a],s[a]+n[a]]);return o}async function*Hc(i,e,t,r){class n{constructor(g,d){J(this,"_level");J(this,"nodes");this._level=d,this.nodes=g}level(){return this._level}startNodeIdx(){return this.nodes[0]}endNodeIdx(){return this.nodes[1]}extendEndNodeIdx(g){this.nodes[1]=g}toString(){return`[NodeRange level: ${this._level}, nodes: ${this.nodes[0]}-${this.nodes[1]}]`}}let{minX:s,minY:o,maxX:a,maxY:l}=t,c=pE(i,e),u=c[0][0],h=[new n([0,1],c.length-1)];for(;h.length!==0;){let f=h.shift(),g=f.startNodeIdx(),d=g>=u,p=(()=>{let[,_]=c[f.level()],E=Math.min(f.endNodeIdx()+e,_);return d&&E<_?E+1:E})(),m=p-g,y=new DataView(await r(40*g,40*m));for(let _=g;_<p;_++){let E=_-g,w=40*E;if(a<y.getFloat64(w+0,!0)||l<y.getFloat64(w+8,!0)||s>y.getFloat64(w+16,!0)||o>y.getFloat64(w+24,!0))continue;let S=y.getBigUint64(w+32,!0);if(d){let L=(()=>{if(_<i-1){let N=(E+1)*40;return y.getBigUint64(N+32,!0)-S}return null})(),R=_-u;yield[Number(S),R,Number(L)];continue}let T=$i.global.extraRequestThreshold()/40,v=h[h.length-1];if(v!==void 0&&v.level()===f.level()-1&&S<v.endNodeIdx()+T){v.extendEndNodeIdx(Number(S));continue}let A=(()=>{let L=f.level()-1;return new n([Number(S),Number(S)+1],L)})();v!==void 0&&(v.level(),A.level()),h.push(A)}}}class po{constructor(e,t,r,n){J(this,"bytes");J(this,"header");J(this,"headerLength");J(this,"indexLength");this.bytes=e,this.header=t,this.headerLength=r,this.indexLength=n}static open(e){if(!e.subarray(0,3).every((o,a)=>_t[a]===o))throw Error("Not a FlatGeobuf file");let t=new DataView(e.buffer).getUint32(8,!0);if(t>10485760||t<8)throw Error("Invalid header size");let r=e.subarray(12,12+t),n=fn(new tt(r)),s=dn(n.featuresCount,n.indexNodeSize);return new po(e,n,t,s)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=async(n,s)=>{let o=t+n;return this.bytes.slice(o,o+s).buffer};for await(let n of Hc(this.header.featuresCount,this.header.indexNodeSize,e,r)){let[s,o]=n,a=this.readFeature(s);yield{id:o,feature:a}}}lengthBeforeTree(){return _t.length+Ve+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}readFeature(e){let t=e+this.lengthBeforeFeatures(),r=new DataView(this.bytes.buffer).getUint32(t,!0),n=this.bytes.subarray(t+4,t+4+r),s=new Uint8Array(r+Ve);s.set(n,Ve);let o=new tt(s);return o.setPosition(Ve),He.getRootAsFeature(o)}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var es=function(i,e){return es=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var n in r)r.hasOwnProperty(n)&&(t[n]=r[n])},es(i,e)};function mE(i,e){es(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function fr(i,e,t,r){function n(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{c(r.next(u))}catch(h){o(h)}}function l(u){try{c(r.throw(u))}catch(h){o(h)}}function c(u){u.done?s(u.value):n(u.value).then(a,l)}c((r=r.apply(i,[])).next())})}function Ot(i,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},r,n,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(c){return function(u){return l([c,u])}}function l(c){if(r)throw new TypeError("Generator is already executing.");for(;t;)try{if(r=1,n&&(s=c[0]&2?n.return:c[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,c[1])).done)return s;switch(n=0,s&&(c=[c[0]&2,s.value]),c[0]){case 0:case 1:s=c;break;case 4:return t.label++,{value:c[1],done:!1};case 5:t.label++,n=c[1],c=[0];continue;case 7:c=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(c[0]===6||c[0]===2)){t=0;continue}if(c[0]===3&&(!s||c[1]>s[0]&&c[1]<s[3])){t.label=c[1];break}if(c[0]===6&&t.label<s[1]){t.label=s[1],s=c;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(c);break}s[2]&&t.ops.pop(),t.trys.pop();continue}c=e.call(i,t)}catch(u){c=[6,u],n=0}finally{r=s=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function wr(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],r=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&r>=i.length&&(i=void 0),{value:i&&i[r++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Vr(i){return this instanceof Vr?(this.v=i,this):new Vr(i)}function _E(i,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(i,e||[]),n,s=[];return n={},o("next"),o("throw"),o("return"),n[Symbol.asyncIterator]=function(){return this},n;function o(f){r[f]&&(n[f]=function(g){return new Promise(function(d,p){s.push([f,g,d,p])>1||a(f,g)})})}function a(f,g){try{l(r[f](g))}catch(d){h(s[0][3],d)}}function l(f){f.value instanceof Vr?Promise.resolve(f.value.v).then(c,u):h(s[0][2],f)}function c(f){a("next",f)}function u(f){a("throw",f)}function h(f,g){f(g),s.shift(),s.length&&a(s[0][0],s[0][1])}}var Zc=function(i){mE(e,i);function e(t){var r=i.call(this,t)||this;return Object.defineProperty(r,"name",{value:"RepeaterOverflowError",enumerable:!1}),typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(r,r.constructor.prototype):r.__proto__=r.constructor.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(r,r.constructor),r}return e}(Error);(function(){function i(e){if(e<0)throw new RangeError("Capacity may not be less than 0");this._c=e,this._q=[]}return Object.defineProperty(i.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"full",{get:function(){return this._q.length>=this._c},enumerable:!1,configurable:!0}),i.prototype.add=function(e){if(this.full)throw new Error("Buffer full");this._q.push(e)},i.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},i})();(function(){function i(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(i.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),i.prototype.add=function(e){for(;this._q.length>=this._c;)this._q.shift();this._q.push(e)},i.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},i})();(function(){function i(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(i.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),i.prototype.add=function(e){this._q.length<this._c&&this._q.push(e)},i.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},i})();function ts(i){i!=null&&typeof i.then=="function"&&i.then(Xi,Xi)}var Cn=0,Ua=1,$t=2,Vi=3,rs=4,ji=1024,Xi=function(){};function sr(i){var e=i.err,t=Promise.resolve(i.execution).then(function(r){if(e!=null)throw e;return r});return i.err=void 0,i.execution=t.then(function(){},function(){}),i.pending===void 0?t:i.pending.then(function(){return t})}function zt(i,e){var t=i.state>=Vi;return Promise.resolve(e).then(function(r){return!t&&i.state>=rs?sr(i).then(function(n){return{value:n,done:!0}}):{value:r,done:t}})}function mo(i,e){var t,r;if(!(i.state>=$t))if(i.state=$t,i.onnext(),i.onstop(),i.err==null&&(i.err=e),i.pushes.length===0&&(typeof i.buffer>"u"||i.buffer.empty))Mr(i);else try{for(var n=wr(i.pushes),s=n.next();!s.done;s=n.next()){var o=s.value;o.resolve()}}catch(a){t={error:a}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}}function Mr(i){var e,t;if(!(i.state>=Vi)){i.state<$t&&mo(i),i.state=Vi,i.buffer=void 0;try{for(var r=wr(i.nexts),n=r.next();!n.done;n=r.next()){var s=n.value,o=i.pending===void 0?sr(i):i.pending.then(function(){return sr(i)});s.resolve(zt(i,o))}}catch(a){e={error:a}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}i.pushes=[],i.nexts=[]}}function Ba(i){i.state>=rs||(i.state<Vi&&Mr(i),i.state=rs)}function yE(i,e){if(ts(e),i.pushes.length>=ji)throw new Zc("No more than "+ji+" pending calls to push are allowed on a single repeater.");if(i.state>=$t)return Promise.resolve(void 0);var t=i.pending===void 0?Promise.resolve(e):i.pending.then(function(){return e});t=t.catch(function(l){i.state<$t&&(i.err=l),Ba(i)});var r;if(i.nexts.length){var n=i.nexts.shift();n.resolve(zt(i,t)),i.nexts.length?r=Promise.resolve(i.nexts[0].value):typeof i.buffer<"u"&&!i.buffer.full?r=Promise.resolve(void 0):r=new Promise(function(l){return i.onnext=l})}else typeof i.buffer<"u"&&!i.buffer.full?(i.buffer.add(t),r=Promise.resolve(void 0)):r=new Promise(function(l){return i.pushes.push({resolve:l,value:t})});var s=!0,o={},a=r.catch(function(l){if(s)throw l});return o.then=function(l,c){return s=!1,Promise.prototype.then.call(r,l,c)},o.catch=function(l){return s=!1,Promise.prototype.catch.call(r,l)},o.finally=r.finally.bind(r),i.pending=t.then(function(){return a}).catch(function(l){i.err=l,Ba(i)}),o}function EE(i){var e=mo.bind(null,i),t=new Promise(function(r){return i.onstop=r});return e.then=t.then.bind(t),e.catch=t.catch.bind(t),e.finally=t.finally.bind(t),e}function xE(i){if(!(i.state>=Ua)){i.state=Ua;var e=yE.bind(null,i),t=EE(i);i.execution=new Promise(function(r){return r(i.executor(e,t))}),i.execution.catch(function(){return mo(i)})}}var pi=new WeakMap,ni=function(){function i(e,t){pi.set(this,{executor:e,buffer:t,err:void 0,state:Cn,pushes:[],nexts:[],pending:void 0,execution:void 0,onnext:Xi,onstop:Xi})}return i.prototype.next=function(e){ts(e);var t=pi.get(this);if(t===void 0)throw new Error("WeakMap error");if(t.nexts.length>=ji)throw new Zc("No more than "+ji+" pending calls to next are allowed on a single repeater.");if(t.state<=Cn&&xE(t),t.onnext(e),typeof t.buffer<"u"&&!t.buffer.empty){var r=zt(t,t.buffer.remove());if(t.pushes.length){var n=t.pushes.shift();t.buffer.add(n.value),t.onnext=n.resolve}return r}else if(t.pushes.length){var s=t.pushes.shift();return t.onnext=s.resolve,zt(t,s.value)}else if(t.state>=$t)return Mr(t),zt(t,sr(t));return new Promise(function(o){return t.nexts.push({resolve:o,value:e})})},i.prototype.return=function(e){ts(e);var t=pi.get(this);if(t===void 0)throw new Error("WeakMap error");return Mr(t),t.execution=Promise.resolve(t.execution).then(function(){return e}),zt(t,sr(t))},i.prototype.throw=function(e){var t=pi.get(this);if(t===void 0)throw new Error("WeakMap error");return t.state<=Cn||t.state>=$t||typeof t.buffer<"u"&&!t.buffer.empty?(Mr(t),t.err==null&&(t.err=e),zt(t,sr(t))):this.next(Promise.reject(e))},i.prototype[Symbol.asyncIterator]=function(){return this},i.race=bE,i.merge=TE,i.zip=wE,i.latest=SE,i}();function gn(i,e){var t,r,n=[],s=function(c){c!=null&&typeof c[Symbol.asyncIterator]=="function"?n.push(c[Symbol.asyncIterator]()):c!=null&&typeof c[Symbol.iterator]=="function"?n.push(c[Symbol.iterator]()):n.push(function(){return _E(this,arguments,function(){return Ot(this,function(f){switch(f.label){case 0:return e.yieldValues?[4,Vr(c)]:[3,3];case 1:return[4,f.sent()];case 2:f.sent(),f.label=3;case 3:return e.returnValues?[4,Vr(c)]:[3,5];case 4:return[2,f.sent()];case 5:return[2]}})})}())};try{for(var o=wr(i),a=o.next();!a.done;a=o.next()){var l=a.value;s(l)}}catch(c){t={error:c}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return n}function bE(i){var e=this,t=gn(i,{returnValues:!0});return new ni(function(r,n){return fr(e,void 0,void 0,function(){var s,o,a,l,c,u;return Ot(this,function(h){switch(h.label){case 0:if(!t.length)return n(),[2];o=!1,n.then(function(){s(),o=!0}),h.label=1;case 1:h.trys.push([1,,5,7]),l=void 0,c=0,u=function(){var f,g,d,p,m,y;return Ot(this,function(_){switch(_.label){case 0:f=c;try{for(g=(m=void 0,wr(t)),d=g.next();!d.done;d=g.next())p=d.value,Promise.resolve(p.next()).then(function(E){E.done?(n(),a===void 0&&(a=E)):c===f&&(c++,s(E))},function(E){return n(E)})}catch(E){m={error:E}}finally{try{d&&!d.done&&(y=g.return)&&y.call(g)}finally{if(m)throw m.error}}return[4,new Promise(function(E){return s=E})];case 1:return l=_.sent(),l===void 0?[3,3]:[4,r(l.value)];case 2:_.sent(),_.label=3;case 3:return[2]}})},h.label=2;case 2:return o?[3,4]:[5,u()];case 3:return h.sent(),[3,2];case 4:return[2,a&&a.value];case 5:return n(),[4,Promise.race(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}function TE(i){var e=this,t=gn(i,{yieldValues:!0});return new ni(function(r,n){return fr(e,void 0,void 0,function(){var s,o,a,l=this;return Ot(this,function(c){switch(c.label){case 0:if(!t.length)return n(),[2];s=[],o=!1,n.then(function(){var u,h;o=!0;try{for(var f=wr(s),g=f.next();!g.done;g=f.next()){var d=g.value;d()}}catch(p){u={error:p}}finally{try{g&&!g.done&&(h=f.return)&&h.call(f)}finally{if(u)throw u.error}}}),c.label=1;case 1:return c.trys.push([1,,3,4]),[4,Promise.all(t.map(function(u,h){return fr(l,void 0,void 0,function(){var f,g;return Ot(this,function(d){switch(d.label){case 0:d.trys.push([0,,6,9]),d.label=1;case 1:return o?[3,5]:(Promise.resolve(u.next()).then(function(p){return s[h](p)},function(p){return n(p)}),[4,new Promise(function(p){s[h]=p})]);case 2:return f=d.sent(),f===void 0?[3,4]:f.done?(a=f,[2]):[4,r(f.value)];case 3:d.sent(),d.label=4;case 4:return[3,1];case 5:return[3,9];case 6:return g=u.return,g?[4,u.return()]:[3,8];case 7:g=d.sent(),d.label=8;case 8:return[7];case 9:return[2]}})})}))];case 2:return c.sent(),[2,a&&a.value];case 3:return n(),[7];case 4:return[2]}})})})}function wE(i){var e=this,t=gn(i,{returnValues:!0});return new ni(function(r,n){return fr(e,void 0,void 0,function(){var s,o,a,l;return Ot(this,function(c){switch(c.label){case 0:if(!t.length)return n(),[2,[]];o=!1,n.then(function(){s(),o=!0}),c.label=1;case 1:c.trys.push([1,,6,8]),c.label=2;case 2:return o?[3,5]:(Promise.all(t.map(function(u){return u.next()})).then(function(u){return s(u)},function(u){return n(u)}),[4,new Promise(function(u){return s=u})]);case 3:return a=c.sent(),a===void 0?[2]:(l=a.map(function(u){return u.value}),a.some(function(u){return u.done})?[2,l]:[4,r(l)]);case 4:return c.sent(),[3,2];case 5:return[3,8];case 6:return n(),[4,Promise.all(t.map(function(u){return u.return&&u.return()}))];case 7:return c.sent(),[7];case 8:return[2]}})})})}function SE(i){var e=this,t=gn(i,{yieldValues:!0,returnValues:!0});return new ni(function(r,n){return fr(e,void 0,void 0,function(){var s,o,a,l,c,u=this;return Ot(this,function(h){switch(h.label){case 0:if(!t.length)return n(),[2,[]];o=[],a=!1,n.then(function(){var f,g;s();try{for(var d=wr(o),p=d.next();!p.done;p=d.next()){var m=p.value;m()}}catch(y){f={error:y}}finally{try{p&&!p.done&&(g=d.return)&&g.call(d)}finally{if(f)throw f.error}}a=!0}),h.label=1;case 1:return h.trys.push([1,,5,7]),Promise.all(t.map(function(f){return f.next()})).then(function(f){return s(f)},function(f){return n(f)}),[4,new Promise(function(f){return s=f})];case 2:return l=h.sent(),l===void 0?[2]:(c=l.map(function(f){return f.value}),l.every(function(f){return f.done})?[2,c]:[4,r(c.slice())]);case 3:return h.sent(),[4,Promise.all(t.map(function(f,g){return fr(u,void 0,void 0,function(){var d;return Ot(this,function(p){switch(p.label){case 0:if(l[g].done)return[2,l[g].value];p.label=1;case 1:return a?[3,4]:(Promise.resolve(f.next()).then(function(m){return o[g](m)},function(m){return n(m)}),[4,new Promise(function(m){return o[g]=m})]);case 2:return d=p.sent(),d===void 0?[2,l[g].value]:d.done?[2,d.value]:(c[g]=d.value,[4,r(c.slice())]);case 3:return p.sent(),[3,1];case 4:return[2]}})})}))];case 4:return[2,h.sent()];case 5:return n(),[4,Promise.all(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}class _o{constructor(e,t,r,n,s){J(this,"headerClient");J(this,"header");J(this,"headerLength");J(this,"indexLength");J(this,"nocache");this.headerClient=e,this.header=t,this.headerLength=r,this.indexLength=n,this.nocache=s}static async open(e,t){let r,n=new Ga(e,t),s=2024+(()=>{let c,u=0;for(c=0;c<3;c++)u+=gE**c*dE;return u})();if(!new Uint8Array(await n.getRange(0,8,s,"header")).subarray(0,3).every((c,u)=>_t[u]===c))throw Error("Not a FlatGeobuf file");if((r=new DataView(await n.getRange(8,4,s,"header")).getUint32(0,!0))>10485760||r<8)throw Error("Invalid header size");let o=await n.getRange(12,r,s,"header"),a=fn(new tt(new Uint8Array(o)));if(a.indexNodeSize===0)throw Error("No index found, cannot read features filtered by bbox");let l=dn(a.featuresCount,a.indexNodeSize);return new _o(n,a,r,l,t)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=this.headerClient,n=async(l,c)=>r.getRange(t+l,c,0,"index"),s=[],o=[];for await(let l of Hc(this.header.featuresCount,this.header.indexNodeSize,e,n)){let[c,u]=l,[,,h]=l;if(h||(h=4),o.length===0){o.push([c,h,u]);continue}let f=o[o.length-1];c-(f[0]+f[1])>$i.global.extraRequestThreshold()&&(s.push(o),o=[]),o.push([c,h,u])}this.headerClient.logUsage("header+index"),o.length>0&&s.push(o);let a=s.flatMap(l=>this.readFeatureBatch(l,this.nocache));yield*ni.merge(a)}lengthBeforeTree(){return _t.length+Ve+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}buildFeatureClient(e){return new Ga(this.headerClient.httpClient,e)}async*readFeatureBatch(e,t){let[r]=e[0],[n,s]=e[e.length-1],o=this.buildFeatureClient(t),a=n+s-r;for(let[l,,c]of e){let u=await this.readFeature(o,l,a);yield{id:c,feature:u},a=0}o.logUsage("feature")}async readFeature(e,t,r){let n,s=t+this.lengthBeforeFeatures();n=new DataView(await e.getRange(s,4,r,"feature length")).getUint32(0,!0);let o=new Uint8Array(await e.getRange(s+4,n,r,"feature data")),a=new Uint8Array(n+Ve);a.set(o,Ve);let l=new tt(a);return l.setPosition(Ve),He.getRootAsFeature(l)}}class Ga{constructor(e,t){J(this,"httpClient");J(this,"bytesEverUsed",0);J(this,"bytesEverFetched",0);J(this,"buffer",new ArrayBuffer(0));J(this,"head",0);if(typeof e=="string")this.httpClient=new za(e,t);else if(e instanceof za)this.httpClient=e;else throw Error("Unknown source")}async getRange(e,t,r,n){this.bytesEverUsed+=t;let s=e-this.head,o=s+t;if(s>=0&&o<=this.buffer.byteLength)return this.buffer.slice(s,o);let a=Math.max(t,r);return this.bytesEverFetched+=a,this.buffer=await this.httpClient.getRange(e,a,n),this.head=e,this.buffer.slice(0,t)}logUsage(e){e.split(" ")[0],(100*this.bytesEverUsed/this.bytesEverFetched).toFixed(2)}}class za{constructor(e,t){J(this,"url");J(this,"nocache");J(this,"requestsEverMade",0);J(this,"bytesEverRequested",0);this.url=e,this.nocache=t}async getRange(e,t,r){this.requestsEverMade+=1,this.bytesEverRequested+=t;let n={Range:`bytes=${e}-${e+t-1}`};return this.nocache&&(n["Cache-Control"]="no-cache, no-store"),await(await fetch(this.url,{headers:n})).arrayBuffer()}}async function*RE(i,e,t,r){if(!i.subarray(0,3).every((h,f)=>_t[f]===h))throw Error("Not a FlatGeobuf file");if(t){let h=po.open(i);for await(let f of h.selectBbox(t))yield e(f.id,f.feature,h.header);return}let n=new tt(i),s=n.readUint32(_t.length);n.setPosition(_t.length+Ve);let o=fn(n),a=_t.length+Ve+s,{indexNodeSize:l,featuresCount:c}=o;l>0&&(a+=dn(c,l));let u=0;for(;a<n.capacity();){let h=n.readUint32(a);n.setPosition(a+Ve);let f=He.getRootAsFeature(n);yield e(u++,f,o),a+=Ve+h}}async function*vE(i,e,t){let r,n=fE(i),s=async g=>await n.slice(g),o=new Uint8Array(await s(8));if(!o.subarray(0,3).every((g,d)=>_t[d]===g))throw Error("Not a FlatGeobuf file");o=new Uint8Array(await s(4));let a=new tt(o),l=a.readUint32(0);o=new Uint8Array(await s(l));let c=fn(a=new tt(o)),{indexNodeSize:u,featuresCount:h}=c;if(u>0){let g=dn(h,u);await s(g)}let f=0;for(;r=await AE(s,c,e,f++);)yield r}async function*PE(i,e,t,r,n=!1){let s=await _o.open(i,n);for await(let o of s.selectBbox(e))yield t(o.id,o.feature,s.header)}async function AE(i,e,t,r){let n=new Uint8Array(await i(4,"feature length"));if(n.byteLength===0)return;let s=new tt(n),o=s.readUint32(0);n=new Uint8Array(await i(o,"feature data"));let a=new Uint8Array(o+4);return a.set(n,4),(s=new tt(a)).setPosition(Ve),t(r,He.getRootAsFeature(s),e)}function is(i,e){let t=e;if(t===Ce.Unknown&&(t=i.type()),t===Ce.GeometryCollection){let n=[];for(let s=0;s<i.partsLength();s++){let o=i.parts(s),a=o.type();n.push(is(o,a))}return{type:Ce[t],geometries:n}}if(t===Ce.MultiPolygon){let n=[];for(let s=0;s<i.partsLength();s++)n.push(is(i.parts(s),Ce.Polygon));return{type:Ce[t],coordinates:n.map(s=>s.coordinates)}}let r=function(n,s){let o=n.xyArray(),a=n.zArray();switch(s){case Ce.Point:{let l=Array.from(o);return a&&l.push(a[0]),l}case Ce.MultiPoint:case Ce.LineString:return In(o,a);case Ce.MultiLineString:case Ce.Polygon:return function(l,c,u){let h;if(!u||u.length===0)return[In(l,c)];let f=0,g=Array.from(u).map(d=>l.slice(f,f=d<<1));return c&&(f=0,h=Array.from(u).map(d=>c.slice(f,f=d))),g.map((d,p)=>In(d,h?h[p]:void 0))}(o,a,n.endsArray())}}(i,t);return{type:Ce[t],coordinates:r}}function yo(i,e,t){let r=t.columns;return{type:"Feature",id:i,geometry:is(e.geometry(),t.geometryType),properties:aE(e,r)}}async function*LE(i,e,t){yield*RE(i,yo,e)}function IE(i,e){return vE(i,yo)}function CE(i,e,t,r=!1){return PE(i,e,yo,t,r)}function FE(i,e,t,r=!1){return i instanceof Uint8Array?LE(i,e):i instanceof ReadableStream?IE(i):CE(i,e,t,r)}const ka=new ja({featureProjection:"EPSG:3857"});class OE extends Ji{constructor(e){super({url:e.url,attributions:e.attributions,wrapX:e.wrapX,format:ka,strategy:vh}),this.ressourceURL=e.url,super.setLoader(this.loader)}fgbBoundingBox(e,t){const r=On(e,t.getCode(),"EPSG:4326");return{minX:r[0],minY:r[1],maxX:r[2],maxY:r[3]}}async loader(e,t,r,n,s){const o=this.fgbBoundingBox(e,r);try{if(o.minX!==-1/0){const a=[],l=FE(this.ressourceURL,o);for await(const c of l){const u=ka.readFeature(c);a.push(u)}super.clear(),super.addFeatures(a),n(a)}}catch{s()}}}window.eoxMapAdvancedOlSources={BingMaps:_0,CartoDB:y0,Cluster:E0,DataTile:ri,GeoTIFF:uo,Google:S0,IIIF:v0,Image:Vt,ImageArcGISRest:A0,ImageCanvas:L0,ImageMapGuide:O0,ImageStatic:Oc,ImageTile:$c,OGCMapTile:k0,OGCVectorTile:$0,Raster:Wc,Source:xs,StadiaMaps:tE,TileArcGISRest:rE,TileDebug:iE,TileImage:Tt,TileJSON:Dc,UrlTile:Ph,UTFGrid:sE,Zoomify:R0,WMTSCapabilities:oE,FlatGeoBuf:OE};const HE=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{jE as L,XE as a,HE as i};
