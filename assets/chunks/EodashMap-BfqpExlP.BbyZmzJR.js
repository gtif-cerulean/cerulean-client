const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/raw.DxtaBMev.js","assets/chunks/basedecoder.B2c5_Eok.js","assets/chunks/lzw.BikwkTY2.js","assets/chunks/jpeg.CbvpOiPg.js","assets/chunks/deflate.B4_27dB1.js","assets/chunks/pako.esm.BkaqWuDM.js","assets/chunks/packbits.D6Qr5eNi.js","assets/chunks/lerc.CdwJDlDo.js","assets/chunks/commonjsHelpers.BosuxZz1.js","assets/chunks/main.C1aqUF2Z.js","assets/chunks/lit-element.Deg-YTNa.js","assets/chunks/Group.DOXtryoE.js","assets/chunks/getElement.BTPto6G5.js","assets/chunks/GeoJSON.CclkGaeh.js","assets/chunks/mustache.B8xfPrro.js","assets/chunks/framework.CS8NzaNW.js","assets/chunks/eo-dash.CF7SpKqS.js","assets/chunks/webimage.CU41Mh7j.js"])))=>i.map(i=>d[i]);
var pu=Object.defineProperty;var mu=(n,e,t)=>e in n?pu(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var ie=(n,e,t)=>mu(n,typeof e!="symbol"?e+"":e,t);import{g as _u,C as yu,V as ls,S as Br,a as Cr,T as So,F as Ni,R as Dt,b as qr,I as el,c as Ut,X as Jn,m as z,d as G,p as C,e as An,f as Eu,h as vt,i as j,j as b,w as q,k as de,l as Ve,O as gr,r as St,n as Gr,o as tl,q as Ln,s as In,t as M,u as x,v as cs,x as I,y as rl,z as Cn,A as Qn,B as Fe,D as Mt,E as xu,G as ye,H as oe,J as Ke,K as lt,L as bu,M as nl,N as Tu,P as wu,Q as Su,U as pi,W as Rt,Y as At,Z as ei,_ as Y,$ as us,a0 as Qe,a1 as Ru,a2 as hs,a3 as Di,a4 as Ui,a5 as Lt,a6 as vu,a7 as Bi,a8 as il,a9 as er,aa as zr,ab as Pu,ac as Au,ad as ue,ae as fs,af as kr,ag as Ge,ah as It,ai as pr,aj as Lu,ak as X,al as Iu,am as Cu,an as Fu,ao as Ou,ap as sl,aq as ol,ar as ds,as as Mu,at as Nu,au as Du,av as gs,aw as Fn,ax as al,ay as bt,az as Kr,aA as Jr,aB as ps,aC as $r,aD as Uu,aE as Bu,aF as Gu,aG as zu,aH as ku,aI as ti,aJ as $u,aK as Vu,aL as mi,aM as ri,aN as Gi,aO as ll,aP as mr,aQ as cl,aR as On,aS as Ro,aT as jt,aU as ms,aV as ju,aW as ul,aX as ni,aY as Xu,aZ as _s,a_ as Wu,a$ as Hu,b0 as Zu,b1 as hl,b2 as Yu,b3 as qu,b4 as Ku,b5 as Ju,b6 as fl,b7 as Qu,b8 as dl,b9 as eh,ba as th,bb as rh,bc as gl,bd as nh,be as ih,bf as sh}from"./main.C1aqUF2Z.js";import{g as ne,a as Mn,m as Vr,d as vo,e as Rn,F as tt,P as ct,L as _t,J as oh,t as Oe,b as ah,l as lh,c as zi,M as ii,f as Qr,h as ys,i as si,j as Es,G as ch,k as uh,n as hh,o as fh,p as jr,S as Po,q as dh,r as xs,s as Pe,u as bs,v as Xr,w as yt,x as Ts,y as gh,z as Ao,A as ph,B as pl,R as mh,C as _h,D as ml,E as yh,H as ws,I as Eh,K as xh,N as Wr,O as bh,Q as Th,T as wh,U as Lo,V as Io,W as Co,X as _l}from"./GeoJSON.CclkGaeh.js";import{s as Sh,w as Rh,a as vh,b as Je,e as Hr,i as Ss,c as Pt,d as lr,f as Ae,h as Nn,j as me,k as cr,l as nr,m as Ph,n as Dn,o as yl,p as We,q as Rs,r as vs,t as ce,D as El,u as Ah,v as Lh,x as en,y as gt,z as Ps,A as Un,T as Ih,E as De,B as Ch,C as Fh,F as xl,G as et,H as Oh,I as Mh,J as ki,K as Fo,L as Nh,M as Dh,N as Uh,O as Bh,P as Oo,Q as bl,R as Gh,S as zh}from"./getElement.BTPto6G5.js";import{T as Tl,W as kh,m as $h}from"./mustache.B8xfPrro.js";import{C as Vh,a as $i,L as wl}from"./Group.DOXtryoE.js";import{g as Sl}from"./commonjsHelpers.BosuxZz1.js";import{a0 as Ft,p as Zt,ak as Mo,h as _i,v as Rl,c as jh,o as Xh,j as gn,N as No,k as Do,x as vl,q as Wh,P as Uo}from"./framework.CS8NzaNW.js";import{S as Hh,C as Zh,q as Pl,r as Al,t as Ll,I as Il,M as Yh,A as yi,v as qh,w as Kh,x as pn,s as Vi,a as ji,j as Jh,h as Qh,d as Bo,f as Ei,l as Bt,y as ef,o as tf,n as rf,z as Fr,k as nf,B as sf,D as of,E as Go,F as af}from"./eo-dash.CF7SpKqS.js";function Cl(n,e,t){const r=[];let i=n(0),s=n(1),o=e(i),a=e(s);const c=[s,i],l=[a,o],u=[1,0],h={};let f=1e5,d,g,p,m,y,_;for(;--f>0&&u.length>0;)p=u.pop(),i=c.pop(),o=l.pop(),_=p.toString(),_ in h||(r.push(o[0],o[1]),h[_]=!0),m=u.pop(),s=c.pop(),a=l.pop(),y=(p+m)/2,d=n(y),g=e(d),Sh(g[0],g[1],o[0],o[1],a[0],a[1])<t?(r.push(a[0],a[1]),_=m.toString(),h[_]=!0):(u.push(m,y,y,p),l.push(a,g,g,o),c.push(s,d,d,i));return r}function lf(n,e,t,r,i){const s=ne("EPSG:4326");return Cl(function(o){return[n,e+(t-e)*o]},Mn(s,r),i)}function cf(n,e,t,r,i){const s=ne("EPSG:4326");return Cl(function(o){return[e+(t-e)*o,n]},Mn(s,r),i)}function uf(n){if(!(n.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=n.inversePixelTransform[0],t=n.inversePixelTransform[1],r=Math.sqrt(e*e+t*t),i=n.frameState,s=Vr(n.inversePixelTransform.slice(),i.coordinateToPixelTransform),o=_u(i.viewState.resolution,r);let a;return new yu(n.context,r,i.extent,s,i.viewState.rotation,o,a)}const hf=new Br({color:"rgba(0,0,0,0.2)"}),ff=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class df extends ls{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:hf,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?vo.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?vo.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new Cr({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new So({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new Ni({color:"rgba(0,0,0,1)"}),stroke:new Br({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=r=>{const i=r.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(i),this.lonLabelStyleBase_},this.latLabelStyleBase_=new Cr({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new So({font:"12px Calibri,sans-serif",textAlign:"right",fill:new Ni({color:"rgba(0,0,0,1)"}),stroke:new Br({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=r=>{const i=r.get("graticule_label");return this.latLabelStyleBase_.getText().setText(i),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(Dt.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:ff,this.setSource(new qr({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new Vh,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new Cr({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let r=e.slice();return this.projection_&&this.getSource().getWrapX()&&Rh(r,this.projection_),this.loadedExtent_&&(vh(this.loadedExtent_,r,t)?r=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[r]}loaderFunction(e,t,r){this.loadedExtent_=e;const i=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=Je(s,e);if(this.renderedExtent_&&Hr(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,Ss(o)))return;const a=Pt(o),c=t*t/4;(!this.projection_||!Rn(this.projection_,r))&&this.updateProjectionInfo_(r),this.createGraticule_(o,a,t,c);let u=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(u+=this.meridians_.length),this.parallelsLabels_&&(u+=this.parallels_.length);let h;for(;u>this.featurePool_.length;)h=new tt,this.featurePool_.push(h);const f=i.getFeaturesCollection();f.clear();let d=0,g,p;for(g=0,p=this.meridians_.length;g<p;++g)h=this.featurePool_[d++],h.setGeometry(this.meridians_[g]),h.setStyle(this.lineStyle_),f.push(h);for(g=0,p=this.parallels_.length;g<p;++g)h=this.featurePool_[d++],h.setGeometry(this.parallels_[g]),h.setStyle(this.lineStyle_),f.push(h)}addMeridian_(e,t,r,i,s,o){const a=this.getMeridian_(e,t,r,i,o);if(lr(a.getExtent(),s)){if(this.meridiansLabels_){const c=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=c:this.meridiansLabels_[o]={geom:new ct([]),text:c}}this.meridians_[o++]=a}return o}addParallel_(e,t,r,i,s,o){const a=this.getParallel_(e,t,r,i,o);if(lr(a.getExtent(),s)){if(this.parallelsLabels_){const c=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=c:this.parallelsLabels_[o]={geom:new ct([]),text:c}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,r=e.frameState.viewState.resolution,i=e.frameState.size,s=e.frameState.extent,o=Pt(s);let a=s;if(t){const g=i[0]*r,p=i[1]*r;a=[o[0]-g/2,o[1]-p/2,o[0]+g/2,o[1]+p/2]}let c=0,l=0,u=this.latLabelPosition_<.5;const h=this.projection_.getExtent(),f=Ae(h);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Nn(h,s)){c=Math.floor((s[0]-h[0])/f),l=Math.ceil((s[2]-h[2])/f);const g=Math.abs(t)>Math.PI/2;u=u!==g}const d=uf(e);for(let g=c;g<=l;++g){let p=this.meridians_.length+this.parallels_.length,m,y,_,E;if(this.meridiansLabels_)for(y=0,_=this.meridiansLabels_.length;y<_;++y){const w=this.meridians_[y];if(!t&&g===0)E=this.getMeridianPoint_(w,s,y);else{const S=w.clone();S.translate(g*f,0),S.rotate(-t,o),E=this.getMeridianPoint_(S,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.meridiansLabels_[y].text),d.drawFeature(m,this.lonLabelStyle_(m))}if(this.parallelsLabels_&&(g===c&&u||g===l&&!u))for(y=0,_=this.parallels_.length;y<_;++y){const w=this.parallels_[y];if(!t&&g===0)E=this.getParallelPoint_(w,s,y);else{const S=w.clone();S.translate(g*f,0),S.rotate(-t,o),E=this.getParallelPoint_(S,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.parallelsLabels_[y].text),d.drawFeature(m,this.latLabelStyle_(m))}}}createGraticule_(e,t,r,i){const s=this.getInterval_(r);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),c=Ae(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Nn(a,e)&&(Ae(e)>=c?(e[0]=a[0],e[2]=a[2]):o=!0);const l=[me(t[0],this.minX_,this.maxX_),me(t[1],this.minY_,this.maxY_)],u=this.toLonLatTransform_(l);isNaN(u[1])&&(u[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let h=me(u[0],this.minLon_,this.maxLon_),f=me(u[1],this.minLat_,this.maxLat_);const d=this.maxLines_;let g,p,m,y,_=e;o||(_=[me(e[0],this.minX_,this.maxX_),me(e[1],this.minY_,this.maxY_),me(e[2],this.minX_,this.maxX_),me(e[3],this.minY_,this.maxY_)]);const E=cr(_,this.toLonLatTransform_,void 0,8);let w=E[3],S=E[2],T=E[1],v=E[0];if(o||(nr(_,this.bottomLeft_)&&(v=this.minLon_,T=this.minLat_),nr(_,this.bottomRight_)&&(S=this.maxLon_,T=this.minLat_),nr(_,this.topLeft_)&&(v=this.minLon_,w=this.maxLat_),nr(_,this.topRight_)&&(S=this.maxLon_,w=this.maxLat_),w=me(w,f,this.maxLat_),S=me(S,h,this.maxLon_),T=me(T,this.minLat_,f),v=me(v,this.minLon_,h)),h=Math.floor(h/s)*s,y=me(h,this.minLon_,this.maxLon_),p=this.addMeridian_(y,T,w,i,e,0),g=0,o)for(;(y-=s)>=v&&g++<d;)p=this.addMeridian_(y,T,w,i,e,p);else for(;y!=this.minLon_&&g++<d;)y=Math.max(y-s,this.minLon_),p=this.addMeridian_(y,T,w,i,e,p);if(y=me(h,this.minLon_,this.maxLon_),g=0,o)for(;(y+=s)<=S&&g++<d;)p=this.addMeridian_(y,T,w,i,e,p);else for(;y!=this.maxLon_&&g++<d;)y=Math.min(y+s,this.maxLon_),p=this.addMeridian_(y,T,w,i,e,p);for(this.meridians_.length=p,this.meridiansLabels_&&(this.meridiansLabels_.length=p),f=Math.floor(f/s)*s,m=me(f,this.minLat_,this.maxLat_),p=this.addParallel_(m,v,S,i,e,0),g=0;m!=this.minLat_&&g++<d;)m=Math.max(m-s,this.minLat_),p=this.addParallel_(m,v,S,i,e,p);for(m=me(f,this.minLat_,this.maxLat_),g=0;m!=this.maxLat_&&g++<d;)m=Math.min(m+s,this.maxLat_),p=this.addParallel_(m,v,S,i,e,p);this.parallels_.length=p,this.parallelsLabels_&&(this.parallelsLabels_.length=p)}getInterval_(e){const t=this.projectionCenterLonLat_[0],r=this.projectionCenterLonLat_[1];let i=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let c=0,l=this.intervals_.length;c<l;++c){const u=me(this.intervals_[c]/2,0,90),h=me(r,-90+u,90-u);if(o[0]=t-u,o[1]=h-u,a[0]=t+u,a[1]=h+u,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;i=this.intervals_[c]}return i}getMeridian_(e,t,r,i,s){const o=lf(e,t,r,this.projection_,i);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new _t(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,r){const i=e.getFlatCoordinates();let s=1,o=i.length-1;i[s]>i[o]&&(s=o,o=1);const a=Math.max(t[1],i[s]),c=Math.min(t[3],i[o]),l=me(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,c),h=[i[s-1]+(i[o-1]-i[s-1])*(l-i[s])/(i[o]-i[s]),l],f=this.meridiansLabels_[r].geom;return f.setCoordinates(h),f}getMeridians(){return this.meridians_}getParallel_(e,t,r,i,s){const o=cf(e,t,r,this.projection_,i);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new _t(o,"XY"),a}getParallelPoint_(e,t,r){const i=e.getFlatCoordinates();let s=0,o=i.length-2;i[s]>i[o]&&(s=o,o=0);const a=Math.max(t[0],i[s]),c=Math.min(t[2],i[o]),l=me(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,c),u=i[s+1]+(i[o+1]-i[s+1])*(l-i[s])/(i[o]-i[s]),h=[l,u],f=this.parallelsLabels_[r].geom;return f.setCoordinates(h),f}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=ne("EPSG:4326"),r=e.getWorldExtent();this.maxLat_=r[3],this.maxLon_=r[2],this.minLat_=r[1],this.minLon_=r[0];const i=Mn(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=i;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,c,l){l=l||2;const u=i(a,c,l);for(let h=0,f=u.length;h<f;h+=l)u[h]<o&&(u[h]+=360);return u}}this.fromLonLatTransform_=Mn(t,e);const s=cr([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(Pt(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}class As extends el{constructor(e,t,r,i,s){const o=s!==void 0?Ut.IDLE:Ut.LOADED;super(e,t,r,o),this.loader_=s!==void 0?s:null,this.canvas_=i,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=Ut.ERROR):this.state=Ut.LOADED,this.changed()}load(){this.state==Ut.IDLE&&(this.state=Ut.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}const gf={Point:yf,LineString:Ef,Polygon:wf,MultiPoint:bf,MultiLineString:xf,MultiPolygon:Tf},pf={Point:Sf,LineString:Rf,Polygon:vf,MultiPoint:Af,MultiLineString:Pf,MultiPolygon:Lf};class mf extends oh{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,r){const i=e,s=zo(i.geometry,t),o=new tt;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),i.attributes){o.setProperties(i.attributes,!0);const a=i.attributes[r];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const r=e,i=[],s=r.features;for(let o=0,a=s.length;o<a;++o)i.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return i}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return zo(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const r=e.spatialReference.wkid;return ne("EPSG:"+r)}return null}writeGeometryObject(e,t){return ko(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const r={};if(!e.hasProperties())return r.attributes={},r;const i=e.getProperties(),s=e.getGeometry();if(s){r.geometry=ko(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(r.geometry.spatialReference={wkid:Number(ne(o).getCode().split(":").pop())}),delete i[e.getGeometryName()]}return Ph(i)?r.attributes={}:r.attributes=i,r}writeFeaturesObject(e,t){t=this.adaptOptions(t);const r=[];for(let i=0,s=e.length;i<s;++i)r.push(this.writeFeatureObject(e[i],t));return{features:r}}}function zo(n,e){if(!n)return null;let t;if(typeof n.x=="number"&&typeof n.y=="number")t="Point";else if(n.points)t="MultiPoint";else if(n.paths)n.paths.length===1?t="LineString":t="MultiLineString";else if(n.rings){const i=n,s=_r(i),o=_f(i.rings,s);o.length===1?(t="Polygon",n=Object.assign({},n,{rings:o[0]})):(t="MultiPolygon",n=Object.assign({},n,{rings:o}))}const r=gf[t];return Oe(r(n),!1,e)}function _f(n,e){const t=[],r=[],i=[];let s,o;for(s=0,o=n.length;s<o;++s)t.length=0,ah(t,0,n[s],e.length),lh(t,0,t.length,e.length)?r.push([n[s]]):i.push(n[s]);for(;i.length;){const a=i.shift();let c=!1;for(s=r.length-1;s>=0;s--){const l=r[s][0];if(Nn(new zi(l).getExtent(),new zi(a).getExtent())){r[s].push(a),c=!0;break}}c||r.push([a.reverse()])}return r}function yf(n){let e;return n.m!==void 0&&n.z!==void 0?e=new ct([n.x,n.y,n.z,n.m],"XYZM"):n.z!==void 0?e=new ct([n.x,n.y,n.z],"XYZ"):n.m!==void 0?e=new ct([n.x,n.y,n.m],"XYM"):e=new ct([n.x,n.y]),e}function Ef(n){const e=_r(n);return new _t(n.paths[0],e)}function xf(n){const e=_r(n);return new Qr(n.paths,e)}function _r(n){let e="XY";return n.hasZ===!0&&n.hasM===!0?e="XYZM":n.hasZ===!0?e="XYZ":n.hasM===!0&&(e="XYM"),e}function bf(n){const e=_r(n);return new ys(n.points,e)}function Tf(n){const e=_r(n);return new ii(n.rings,e)}function wf(n){const e=_r(n);return new si(n.rings,e)}function Sf(n,e){const t=n.getCoordinates();let r;const i=n.getLayout();if(i==="XYZ")r={x:t[0],y:t[1],z:t[2]};else if(i==="XYM")r={x:t[0],y:t[1],m:t[2]};else if(i==="XYZM")r={x:t[0],y:t[1],z:t[2],m:t[3]};else if(i==="XY")r={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return r}function tn(n){const e=n.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function Rf(n,e){const t=tn(n);return{hasZ:t.hasZ,hasM:t.hasM,paths:[n.getCoordinates()]}}function vf(n,e){const t=tn(n);return{hasZ:t.hasZ,hasM:t.hasM,rings:n.getCoordinates(!1)}}function Pf(n,e){const t=tn(n);return{hasZ:t.hasZ,hasM:t.hasM,paths:n.getCoordinates()}}function Af(n,e){const t=tn(n);return{hasZ:t.hasZ,hasM:t.hasM,points:n.getCoordinates()}}function Lf(n,e){const t=tn(n),r=n.getCoordinates(!1),i=[];for(let s=0;s<r.length;s++)for(let o=r[s].length-1;o>=0;o--)i.push(r[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:i}}function ko(n,e){const t=pf[n.getType()];return t(Oe(n,!0,e),e)}const mt="http://www.opengis.net/gml",If=/^\s*$/;class D extends Jn{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:G(this.readFeaturesInternal),featureMembers:z(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const r=e.localName;let i=null;if(r=="FeatureCollection")i=C([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(r=="featureMembers"||r=="featureMember"||r=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const c="p",l="p0";if(!o&&e.childNodes){o=[],a={};for(let f=0,d=e.childNodes.length;f<d;++f){const g=e.childNodes[f];if(g.nodeType===1){const p=g.nodeName.split(":").pop();if(!o.includes(p)){let m="",y=0;const _=g.namespaceURI;for(const E in a){if(a[E]===_){m=E;break}++y}m||(m=c+y,a[m]=_),o.push(m+":"+p)}}}r!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const f=a;a={},a[l]=f}const u={},h=Array.isArray(o)?o:[o];for(const f in a){const d={};for(let g=0,p=h.length;g<p;++g)(h[g].includes(":")?h[g].split(":")[0]:l)===f&&(d[h[g].split(":").pop()]=r=="featureMembers"?G(this.readFeatureElement,this):z(this.readFeatureElement,this));u[a[f]]=d}r=="featureMember"||r=="member"?i=C(void 0,u,e,t):i=C([],u,e,t)}return i===null&&(i=[]),i}readGeometryOrExtent(e,t){const r=t[0];return r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),C(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const r=t[0],i=this.readGeometryOrExtent(e,t);return i?Es(i,r):void 0}readGeometryElement(e,t){const r=t[0],i=this.readGeometryOrExtent(e,t);return i?Oe(i,!1,r):void 0}readFeatureElementInternal(e,t,r){let i;const s={};for(let c=e.firstElementChild;c;c=c.nextElementSibling){let l;const u=c.localName;c.childNodes.length===0||c.childNodes.length===1&&(c.firstChild.nodeType===3||c.firstChild.nodeType===4)?(l=An(c,!1),If.test(l)&&(l=void 0)):(r&&(l=u==="boundedBy"?this.readExtentElement(c,t):this.readGeometryElement(c,t)),l?u!=="boundedBy"&&(i=u):l=this.readFeatureElementInternal(c,t,!1));const h=c.attributes.length;if(h>0&&!(l instanceof ch)){l={_content_:l};for(let f=0;f<h;f++){const d=c.attributes[f].name;l[d]=c.attributes[f].value}}s[u]?(s[u]instanceof Array||(s[u]=[s[u]]),s[u].push(l)):s[u]=l}if(!r)return s;const o=new tt(s);i&&o.setGeometryName(i);const a=e.getAttribute("fid")||Eu(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new ct(r,"XYZ")}readMultiPoint(e,t){const r=C([],this.MULTIPOINT_PARSERS,e,t,this);if(r)return new ys(r)}readMultiLineString(e,t){const r=C([],this.MULTILINESTRING_PARSERS,e,t,this);if(r)return new Qr(r)}readMultiPolygon(e,t){const r=C([],this.MULTIPOLYGON_PARSERS,e,t,this);if(r)return new ii(r)}pointMemberParser(e,t){vt(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){vt(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){vt(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new _t(r,"XYZ")}readFlatLinearRing(e,t){const r=C(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(r)return r}readLinearRing(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new zi(r,"XYZ")}readPolygon(e,t){const r=C([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){const i=r[0],s=[i.length];let o,a;for(o=1,a=r.length;o<a;++o)Dn(i,r[o]),s.push(i.length);return new si(i,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return C(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const r=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return r||null}readFeaturesFromNode(e,t){const r={featureType:this.featureType,featureNS:this.featureNS};return r&&Object.assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r])||[]}readProjectionFromNode(e){return ne(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}D.prototype.namespace=mt;D.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};D.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};D.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};D.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:G(D.prototype.pointMemberParser),pointMembers:G(D.prototype.pointMemberParser)}};D.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:G(D.prototype.lineStringMemberParser),lineStringMembers:G(D.prototype.lineStringMemberParser)}};D.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:G(D.prototype.polygonMemberParser),polygonMembers:G(D.prototype.polygonMemberParser)}};D.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:G(D.prototype.readFlatCoordinatesFromNode)}};D.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:G(D.prototype.readLineString)}};D.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:G(D.prototype.readPolygon)}};D.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:z(D.prototype.readFlatLinearRing)}};const Cf=mt+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",Ff={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class Z extends D{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[mt].featureMember=G(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:Cf}readFlatCoordinates(e,t){const r=An(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const l=ne(s);l&&(o=l.getAxisOrientation())}const a=r.trim().split(/\s+/),c=[];for(let l=0,u=a.length;l<u;l++){const h=a[l].split(/,+/),f=parseFloat(h[0]),d=parseFloat(h[1]),g=h.length===3?parseFloat(h[2]):0;o.startsWith("en")?c.push(f,d,g):c.push(d,f,g)}return c}readBox(e,t){const r=C([null],this.BOX_PARSERS_,e,t,this);return yl(r[1][0],r[1][1],r[1][3],r[1][4])}innerBoundaryIsParser(e,t){const r=C(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}outerBoundaryIsParser(e,t){const r=C(void 0,this.RING_PARSERS,e,t,this);if(r){const i=t[t.length-1];i[0]=r}}GEOMETRY_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.multiSurface,o=i.surface,a=i.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="MultiLineString"&&a===!0&&(r="MultiCurve")),j("http://www.opengis.net/gml",r)}writeFeatureElement(e,t,r){const i=t.getId();i&&e.setAttribute("fid",i);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const c=[],l=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const d=h[f];d!=null&&(c.push(f),l.push(d),f==a||typeof d.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=b(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=b(q)))}}const u=Object.assign({},s);u.node=e,de(u,s.serializers,Ve(void 0,o),l,r,c)}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}else if(e.nodeName==="Curve"){const o=j(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeLineStringOrCurveMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeCurveOrLineString(i,t,r))}writeMultiCurveOrLineString(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.curve;o&&e.setAttribute("srsName",o);const c=t.getLineStrings();de({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,c,r,void 0,this)}writeGeometryElement(e,t,r){const i=r[r.length-1],s=Object.assign({},i);s.node=e;let o;Array.isArray(t)?o=Es(t,i):o=Oe(t,!0,i),de(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}createCoordinatesNode_(e){const t=j(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=t.getCoordinates(),c=a.length,l=new Array(c);for(let u=0;u<c;++u){const h=a[u];l[u]=this.getCoords_(h,o,s)}q(e,l.join(" "))}writeCurveSegments_(e,t,r){const i=j(e.namespaceURI,"LineStringSegment");e.appendChild(i),this.writeCurveOrLineString(i,t,r)}writeSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();de({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=j(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}RING_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.node,o=i.exteriorWritten;return o===void 0&&(i.exteriorWritten=!0),j(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,r){const i=j(e.namespaceURI,"PolygonPatch");e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r)}writeRing(e,t,r){const i=j(e.namespaceURI,"LinearRing");e.appendChild(i),this.writeLinearRing(i,t,r)}getCoords_(e,t,r){let s=(t?ne(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(r){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const c=t.getCoordinates(),l=this.getCoords_(c,o,s);q(a,l)}writeMultiPoint(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();de({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,Ve("pointMember"),a,r,void 0,this)}writePointMember(e,t,r){const i=j(e.namespaceURI,"Point");e.appendChild(i),this.writePoint(i,t,r)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}writeMultiSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.surface;o&&e.setAttribute("srsName",o);const c=t.getPolygons();de({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,c,r,void 0,this)}writeSurfaceOrPolygonMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r))}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];de({node:e},this.ENVELOPE_SERIALIZERS,gr,a,r,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const i=t[t.length-1].node;return j("http://www.opengis.net/gml",Ff[i.nodeName])}}Z.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:z(Z.prototype.readFlatCoordinates)}};Z.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:Z.prototype.innerBoundaryIsParser,outerBoundaryIs:Z.prototype.outerBoundaryIsParser}};Z.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:G(Z.prototype.readFlatCoordinates)}};Z.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:z(D.prototype.readPoint),MultiPoint:z(D.prototype.readMultiPoint),LineString:z(D.prototype.readLineString),MultiLineString:z(D.prototype.readMultiLineString),LinearRing:z(D.prototype.readLinearRing),Polygon:z(D.prototype.readPolygon),MultiPolygon:z(D.prototype.readMultiPolygon),Box:z(Z.prototype.readBox)}};Z.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:b(Z.prototype.writeCurveOrLineString),MultiCurve:b(Z.prototype.writeMultiCurveOrLineString),Point:b(Z.prototype.writePoint),MultiPoint:b(Z.prototype.writeMultiPoint),LineString:b(Z.prototype.writeCurveOrLineString),MultiLineString:b(Z.prototype.writeMultiCurveOrLineString),LinearRing:b(Z.prototype.writeLinearRing),Polygon:b(Z.prototype.writeSurfaceOrPolygon),MultiPolygon:b(Z.prototype.writeMultiSurfaceOrPolygon),Surface:b(Z.prototype.writeSurfaceOrPolygon),MultiSurface:b(Z.prototype.writeMultiSurfaceOrPolygon),Envelope:b(Z.prototype.writeEnvelope)}};Z.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:b(Z.prototype.writeLineStringOrCurveMember),curveMember:b(Z.prototype.writeLineStringOrCurveMember)}};Z.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:b(Z.prototype.writeRing),innerBoundaryIs:b(Z.prototype.writeRing)}};Z.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:b(Z.prototype.writePointMember)}};Z.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:b(Z.prototype.writeSurfaceOrPolygonMember),polygonMember:b(Z.prototype.writeSurfaceOrPolygonMember)}};Z.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:b(q),upperCorner:b(q)}};const Of=mt+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",Mf={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class A extends D{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:Of,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const r=C([],this.MULTICURVE_PARSERS,e,t,this);if(r)return new Qr(r)}readFlatCurveRing(e,t){const r=C([],this.MULTICURVE_PARSERS,e,t,this),i=[];for(let s=0,o=r.length;s<o;++s)Dn(i,r[s].getFlatCoordinates());return i}readMultiSurface(e,t){const r=C([],this.MULTISURFACE_PARSERS,e,t,this);if(r)return new ii(r)}curveMemberParser(e,t){vt(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){vt(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return C([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return C([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return C([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return C([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const r=C(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}exteriorParser(e,t){const r=C(void 0,this.RING_PARSERS,e,t,this);if(r){const i=t[t.length-1];i[0]=r}}readSurface(e,t){const r=C([null],this.SURFACE_PARSERS,e,t,this);if(r&&r[0]){const i=r[0],s=[i.length];let o,a;for(o=1,a=r.length;o<a;++o)Dn(i,r[o]),s.push(i.length);return new si(i,"XYZ",s)}}readCurve(e,t){const r=C([null],this.CURVE_PARSERS,e,t,this);if(r)return new _t(r,"XYZ")}readEnvelope(e,t){const r=C([null],this.ENVELOPE_PARSERS,e,t,this);return yl(r[1][0],r[1][1],r[2][0],r[2][1])}readFlatPos(e,t){let r=An(e,!1);const i=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=i.exec(r);)s.push(parseFloat(o[1])),r=r.substr(o[0].length);if(r!=="")return;const c=t[0].srsName;if((c?ne(c).getAxisOrientation():"enu")==="neu")for(let h=0,f=s.length;h<f;h+=3){const d=s[h],g=s[h+1];s[h]=g,s[h+1]=d}const u=s.length;if(u==2&&s.push(0),u!==0)return s}readFlatPosList(e,t){const r=An(e,!1).replace(/^\s*|\s*$/g,""),i=t[0],s=i.srsName,o=i.srsDimension,a=s?ne(s).getAxisOrientation():"enu",c=r.split(/\s+/);let l=2;e.getAttribute("srsDimension")?l=St(e.getAttribute("srsDimension")):e.getAttribute("dimension")?l=St(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?l=St(e.parentNode.getAttribute("srsDimension")):o&&(l=St(o));const u=a.startsWith("en");let h,f,d;const g=[];for(let p=0,m=c.length;p<m;p+=l)h=parseFloat(c[p]),f=parseFloat(c[p+1]),d=l===3?parseFloat(c[p+2]):0,u?g.push(h,f,d):g.push(f,h,d);return g}writePos_(e,t,r){const i=r[r.length-1],s=i.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=i.srsName,c=a?ne(a).getAxisOrientation():"enu",l=t.getCoordinates();let u=c.startsWith("en")?l[0]+" "+l[1]:l[1]+" "+l[0];if(s){const h=l[2]||0;u+=" "+h}q(e,u)}getCoords_(e,t,r){let s=(t?ne(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(r){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,r){const i=r[r.length-1],s=i.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=i.srsName,c=t.getCoordinates(),l=c.length,u=new Array(l);let h;for(let f=0;f<l;++f)h=c[f],u[f]=this.getCoords_(h,a,s);q(e,u.join(" "))}writePoint(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=j(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,r)}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];de({node:e},this.ENVELOPE_SERIALIZERS,gr,a,r,o,this)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=j(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}RING_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.node,o=i.exteriorWritten;return o===void 0&&(i.exteriorWritten=!0),j(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();de({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=j(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=j(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}else if(e.nodeName==="Curve"){const o=j(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeMultiSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.surface;o&&e.setAttribute("srsName",o);const c=t.getPolygons();de({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,c,r,void 0,this)}writeMultiPoint(e,t,r){const i=r[r.length-1],s=i.srsName,o=i.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();de({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,Ve("pointMember"),a,r,void 0,this)}writeMultiCurveOrLineString(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.curve;o&&e.setAttribute("srsName",o);const c=t.getLineStrings();de({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,c,r,void 0,this)}writeRing(e,t,r){const i=j(e.namespaceURI,"LinearRing");e.appendChild(i),this.writeLinearRing(i,t,r)}writeSurfaceOrPolygonMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r))}writePointMember(e,t,r){const i=j(e.namespaceURI,"Point");e.appendChild(i),this.writePoint(i,t,r)}writeLineStringOrCurveMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeCurveOrLineString(i,t,r))}writeSurfacePatches_(e,t,r){const i=j(e.namespaceURI,"PolygonPatch");e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r)}writeCurveSegments_(e,t,r){const i=j(e.namespaceURI,"LineStringSegment");e.appendChild(i),this.writeCurveOrLineString(i,t,r)}writeGeometryElement(e,t,r){const i=r[r.length-1],s=Object.assign({},i);s.node=e;let o;Array.isArray(t)?o=Es(t,i):o=Oe(t,!0,i),de(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}writeFeatureElement(e,t,r){const i=t.getId();i&&e.setAttribute("fid",i);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const c=[],l=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const d=h[f];d!=null&&(c.push(f),l.push(d),f==a||typeof d.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=b(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=b(q)))}}const u=Object.assign({},s);u.node=e,de(u,s.serializers,Ve(void 0,o),l,r,c)}writeFeatureMembers_(e,t,r){const i=r[r.length-1],s=i.featureType,o=i.featureNS,a={};a[o]={},a[o][s]=b(this.writeFeatureElement,this);const c=Object.assign({},i);c.node=e,de(c,a,Ve(s,o),t,r)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const i=t[t.length-1].node;return j(this.namespace,Mf[i.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.multiSurface,o=i.surface,a=i.curve,c=i.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="LineString"&&a===!0?r="Curve":r==="MultiLineString"&&c===!0&&(r="MultiCurve")),j(this.namespace,r)}writeGeometryNode(e,t){t=this.adaptOptions(t);const r=j(this.namespace,"geom"),i={node:r,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(i,t),this.writeGeometryElement(r,e,[i]),r}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=j(this.namespace,"featureMembers");r.setAttributeNS(Gr,"xsi:schemaLocation",this.schemaLocation);const i={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(i,t),this.writeFeatureMembers_(r,e,[i]),r}}A.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:z(A.prototype.readFlatPos),posList:z(A.prototype.readFlatPosList),coordinates:z(Z.prototype.readFlatCoordinates)}};A.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:A.prototype.interiorParser,exterior:A.prototype.exteriorParser}};A.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:z(D.prototype.readPoint),MultiPoint:z(D.prototype.readMultiPoint),LineString:z(D.prototype.readLineString),MultiLineString:z(D.prototype.readMultiLineString),LinearRing:z(D.prototype.readLinearRing),Polygon:z(D.prototype.readPolygon),MultiPolygon:z(D.prototype.readMultiPolygon),Surface:z(A.prototype.readSurface),MultiSurface:z(A.prototype.readMultiSurface),Curve:z(A.prototype.readCurve),MultiCurve:z(A.prototype.readMultiCurve),Envelope:z(A.prototype.readEnvelope)}};A.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:G(A.prototype.curveMemberParser),curveMembers:G(A.prototype.curveMemberParser)}};A.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:G(A.prototype.surfaceMemberParser),surfaceMembers:G(A.prototype.surfaceMemberParser)}};A.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:G(D.prototype.readLineString),Curve:G(A.prototype.readCurve)}};A.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:G(D.prototype.readPolygon),Surface:G(A.prototype.readSurface)}};A.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:z(A.prototype.readPatch)}};A.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:z(A.prototype.readSegment)}};A.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:G(A.prototype.readFlatPosList),upperCorner:G(A.prototype.readFlatPosList)}};A.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:z(A.prototype.readPolygonPatch)}};A.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:tl(A.prototype.readLineStringSegment)}};D.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:z(D.prototype.readFlatLinearRing),Ring:z(A.prototype.readFlatCurveRing)}};A.prototype.writeFeatures;A.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:b(A.prototype.writeRing),interior:b(A.prototype.writeRing)}};A.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:b(q),upperCorner:b(q)}};A.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:b(A.prototype.writeSurfaceOrPolygonMember),polygonMember:b(A.prototype.writeSurfaceOrPolygonMember)}};A.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:b(A.prototype.writePointMember)}};A.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:b(A.prototype.writeLineStringOrCurveMember),curveMember:b(A.prototype.writeLineStringOrCurveMember)}};A.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:b(A.prototype.writeCurveOrLineString),MultiCurve:b(A.prototype.writeMultiCurveOrLineString),Point:b(A.prototype.writePoint),MultiPoint:b(A.prototype.writeMultiPoint),LineString:b(A.prototype.writeCurveOrLineString),MultiLineString:b(A.prototype.writeMultiCurveOrLineString),LinearRing:b(A.prototype.writeLinearRing),Polygon:b(A.prototype.writeSurfaceOrPolygon),MultiPolygon:b(A.prototype.writeMultiSurfaceOrPolygon),Surface:b(A.prototype.writeSurfaceOrPolygon),MultiSurface:b(A.prototype.writeMultiSurfaceOrPolygon),Envelope:b(A.prototype.writeEnvelope)}};const Ls=A;Ls.prototype.writeFeatures;Ls.prototype.writeFeaturesNode;const pe=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],Nf="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",Df={rte:Fl,trk:Ol,wpt:Ml},Uf=M(pe,{rte:G(Fl),trk:G(Ol),wpt:G(Ml)}),Bf=M(pe,{text:x(I,"linkText"),type:x(I,"linkType")}),Gf=M(pe,{name:x(I),email:fd,link:rn}),zf=M(pe,{name:x(I),desc:x(I),author:x(cd),copyright:x(ud),link:rn,time:x(Qn),keywords:x(I),bounds:hd,extensions:oi}),kf=M(pe,{year:x(ye),license:x(I)}),$f=M(pe,{rte:b(md),trk:b(_d),wpt:b(Ed)});class Vf extends Jn{constructor(e){super(),e=e||{},this.dataProjection=ne("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,r=e.length;t<r;++t){const i=e[t];if(this.readExtensions_){const s=i.get("extensionsNode_")||null;this.readExtensions_(i,s)}i.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(Ln(e)):In(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const r=this.readMetadataFromNode(t);if(r)return r}return null}readMetadataFromNode(e){if(!pe.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(pe.includes(t.namespaceURI)&&t.localName==="metadata")return C({},zf,t,[]);return null}readFeatureFromNode(e,t){if(!pe.includes(e.namespaceURI))return null;const r=Df[e.localName];if(!r)return null;const i=r(e,[this.getReadOptions(e,t)]);return i?(this.handleReadExtensions_([i]),i):null}readFeaturesFromNode(e,t){if(!pe.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const r=C([],Uf,e,[this.getReadOptions(e,t)]);return r?(this.handleReadExtensions_(r),r):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=j("http://www.topografix.com/GPX/1/1","gpx");return r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",Gr),r.setAttributeNS(Gr,"xsi:schemaLocation",Nf),r.setAttribute("version","1.1"),r.setAttribute("creator","OpenLayers"),de({node:r},$f,ld,e,[t]),r}}const jf=M(pe,{name:x(I),cmt:x(I),desc:x(I),src:x(I),link:rn,number:x(ye),extensions:oi,type:x(I),rtept:dd}),Xf=M(pe,{ele:x(Fe),time:x(Qn)}),Wf=M(pe,{name:x(I),cmt:x(I),desc:x(I),src:x(I),link:rn,number:x(ye),type:x(I),extensions:oi,trkseg:pd}),Hf=M(pe,{trkpt:gd}),Zf=M(pe,{ele:x(Fe),time:x(Qn)}),Yf=M(pe,{ele:x(Fe),time:x(Qn),magvar:x(Fe),geoidheight:x(Fe),name:x(I),cmt:x(I),desc:x(I),src:x(I),link:rn,sym:x(I),type:x(I),fix:x(I),sat:x(ye),hdop:x(Fe),vdop:x(Fe),pdop:x(Fe),ageofdgpsdata:x(Fe),dgpsid:x(ye),extensions:oi}),qf=["text","type"],Kf=M(pe,{text:b(q),type:b(q)}),Jf=M(pe,["name","cmt","desc","src","link","number","type","rtept"]),Qf=M(pe,{name:b(q),cmt:b(q),desc:b(q),src:b(q),link:b(Fs),number:b(Cn),type:b(q),rtept:rl(b(Os))}),ed=M(pe,["ele","time"]),td=M(pe,["name","cmt","desc","src","link","number","type","trkseg"]),rd=M(pe,{name:b(q),cmt:b(q),desc:b(q),src:b(q),link:b(Fs),number:b(Cn),type:b(q),trkseg:rl(b(yd))}),nd=Ve("trkpt"),id=M(pe,{trkpt:b(Os)}),sd=M(pe,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),od=M(pe,{ele:b(Mt),time:b(xu),magvar:b(Mt),geoidheight:b(Mt),name:b(q),cmt:b(q),desc:b(q),src:b(q),link:b(Fs),sym:b(q),type:b(q),fix:b(q),sat:b(Cn),hdop:b(Mt),vdop:b(Mt),pdop:b(Mt),ageofdgpsdata:b(Mt),dgpsid:b(Cn)}),ad={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function ld(n,e,t){const r=n.getGeometry();if(r){const i=ad[r.getType()];if(i){const s=e[e.length-1].node;return j(s.namespaceURI,i)}}}function Is(n,e,t,r){return n.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in r?(n.push(r.ele),delete r.ele,e.hasZ=!0):n.push(0),"time"in r?(n.push(r.time),delete r.time,e.hasM=!0):n.push(0),n}function Cs(n,e,t){let r="XY",i=2;if(n.hasZ&&n.hasM?(r="XYZM",i=4):n.hasZ?(r="XYZ",i=3):n.hasM&&(r="XYM",i=3),i!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*i]=e[s*4],e[s*i+1]=e[s*4+1],n.hasZ&&(e[s*i+2]=e[s*4+2]),n.hasM&&(e[s*i+2]=e[s*4+3]);if(e.length=e.length/4*i,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*i}return r}function cd(n,e){const t=C({},Gf,n,e);if(t)return t}function ud(n,e){const t=C({},kf,n,e);if(t){const r=n.getAttribute("author");return r!==null&&(t.author=r),t}}function hd(n,e){const t=e[e.length-1],r=n.getAttribute("minlat"),i=n.getAttribute("minlon"),s=n.getAttribute("maxlat"),o=n.getAttribute("maxlon");i!==null&&r!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(i),parseFloat(r)],[parseFloat(o),parseFloat(s)]])}function fd(n,e){const t=e[e.length-1],r=n.getAttribute("id"),i=n.getAttribute("domain");r!==null&&i!==null&&(t.email=`${r}@${i}`)}function rn(n,e){const t=e[e.length-1],r=n.getAttribute("href");r!==null&&(t.link=r),vt(Bf,n,e)}function oi(n,e){const t=e[e.length-1];t.extensionsNode_=n}function dd(n,e){const t=C({},Xf,n,e);if(t){const r=e[e.length-1],i=r.flatCoordinates,s=r.layoutOptions;Is(i,s,n,t)}}function gd(n,e){const t=C({},Zf,n,e);if(t){const r=e[e.length-1],i=r.flatCoordinates,s=r.layoutOptions;Is(i,s,n,t)}}function pd(n,e){const t=e[e.length-1];vt(Hf,n,e);const r=t.flatCoordinates;t.ends.push(r.length)}function Fl(n,e){const t=e[0],r=C({flatCoordinates:[],layoutOptions:{}},jf,n,e);if(!r)return;const i=r.flatCoordinates;delete r.flatCoordinates;const s=r.layoutOptions;delete r.layoutOptions;const o=Cs(s,i),a=new _t(i,o);Oe(a,!1,t);const c=new tt(a);return c.setProperties(r,!0),c}function Ol(n,e){const t=e[0],r=C({flatCoordinates:[],ends:[],layoutOptions:{}},Wf,n,e);if(!r)return;const i=r.flatCoordinates;delete r.flatCoordinates;const s=r.ends;delete r.ends;const o=r.layoutOptions;delete r.layoutOptions;const a=Cs(o,i,s),c=new Qr(i,a,s);Oe(c,!1,t);const l=new tt(c);return l.setProperties(r,!0),l}function Ml(n,e){const t=e[0],r=C({},Yf,n,e);if(!r)return;const i={},s=Is([],i,n,r),o=Cs(i,s),a=new ct(s,o);Oe(a,!1,t);const c=new tt(a);return c.setProperties(r,!0),c}function Fs(n,e,t){n.setAttribute("href",e);const i=t[t.length-1].properties,s=[i.linkText,i.linkType];de({node:n},Kf,gr,s,t,qf)}function Os(n,e,t){const r=t[t.length-1],s=r.node.namespaceURI,o=r.properties;switch(n.setAttributeNS(null,"lat",String(e[1])),n.setAttributeNS(null,"lon",String(e[0])),r.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const c=n.nodeName=="rtept"?ed[s]:sd[s],l=cs(o,c);de({node:n,properties:o},od,gr,l,t,c)}function md(n,e,t){const r=t[0],i=e.getProperties(),s={node:n};s.properties=i;const o=e.getGeometry();if(o.getType()=="LineString"){const u=Oe(o,!0,r);s.geometryLayout=u.getLayout(),i.rtept=u.getCoordinates()}const a=t[t.length-1].node,c=Jf[a.namespaceURI],l=cs(i,c);de(s,Qf,gr,l,t,c)}function _d(n,e,t){const r=t[0],i=e.getProperties(),s={node:n};s.properties=i;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const u=Oe(o,!0,r);i.trkseg=u.getLineStrings()}const a=t[t.length-1].node,c=td[a.namespaceURI],l=cs(i,c);de(s,rd,gr,l,t,c)}function yd(n,e,t){const r={node:n};r.geometryLayout=e.getLayout(),r.properties={},de(r,id,nd,e.getCoordinates(),t)}function Ed(n,e,t){const r=t[0],i=t[t.length-1];i.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=Oe(s,!0,r);i.geometryLayout=o.getLayout(),Os(n,o.getCoordinates(),t)}}const xd=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,bd=/^H.([A-Z]{3}).*?:(.*)/,Td=/^HFDTE(\d{2})(\d{2})(\d{2})/,wd=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,Sd=/\r\n|\r|\n/;class Rd extends Tl{constructor(e){super(),e=e||{},this.dataProjection=ne("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const r=this.altitudeMode_,i=e.split(Sd),s={},o=[];let a=2e3,c=0,l=1,u=-1,h,f;for(h=0,f=i.length;h<f;++h){const m=i[h];let y;if(m.charAt(0)=="B"){if(y=xd.exec(m),y){const _=parseInt(y[1],10),E=parseInt(y[2],10),w=parseInt(y[3],10);let S=parseInt(y[4],10)+parseInt(y[5],10)/6e4;this.lad_&&(S+=parseInt(m.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),y[6]=="S"&&(S=-S);let T=parseInt(y[7],10)+parseInt(y[8],10)/6e4;if(this.lod_&&(T+=parseInt(m.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),y[9]=="W"&&(T=-T),o.push(T,S),r!="none"){let L;r=="gps"?L=parseInt(y[11],10):r=="barometric"?L=parseInt(y[12],10):L=0,o.push(L)}let v=Date.UTC(a,c,l,_,E,w);v<u&&(v=Date.UTC(a,c,l+1,_,E,w)),o.push(v/1e3),u=v}}else if(m.charAt(0)=="H")y=wd.exec(m),y?(l=parseInt(y[1],10),c=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=Td.exec(m),y?(l=parseInt(y[1],10),c=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=bd.exec(m),y&&(s[y[1]]=y[2].trim())));else if(m.charAt(0)=="I"){const _=parseInt(m.slice(1,3),10);for(let E=0;E<_;E++){const w=m.slice(7+E*7,10+E*7);if(w==="LAD"||w==="LOD"){const S=parseInt(m.slice(3+E*7,5+E*7),10)-1,T=parseInt(m.slice(5+E*7,7+E*7),10);w==="LAD"?(this.lad_=!0,this.ladStart_=S,this.ladStop_=T):w==="LOD"&&(this.lod_=!0,this.lodStart_=S,this.lodStop_=T)}}}}if(o.length===0)return null;const d=r=="none"?"XYM":"XYZM",g=new _t(o,d),p=new tt(Oe(g,!1,t));return p.setProperties(s,!0),p}readFeaturesFromText(e,t){const r=this.readFeatureFromText(e,t);return r?[r]:[]}}const be={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},$t={};$t[be.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};$t[be.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};$t[be.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};$t.none={none:{supports:[],formats:[],qualities:[]}};const vd=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,$o=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,Pd=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function Ad(n){let e=n.getComplianceLevelSupportedFeatures();return e===void 0&&(e=$t[be.VERSION1].level0),{url:n.imageInfo["@id"]===void 0?void 0:n.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,n.imageInfo.formats===void 0?[]:n.imageInfo.formats],qualities:[...e.qualities,n.imageInfo.qualities===void 0?[]:n.imageInfo.qualities],resolutions:n.imageInfo.scale_factors,tileSize:n.imageInfo.tile_width!==void 0?n.imageInfo.tile_height!==void 0?[n.imageInfo.tile_width,n.imageInfo.tile_height]:[n.imageInfo.tile_width,n.imageInfo.tile_width]:n.imageInfo.tile_height!=null?[n.imageInfo.tile_height,n.imageInfo.tile_height]:void 0}}function Ld(n){const e=n.getComplianceLevelSupportedFeatures(),t=Array.isArray(n.imageInfo.profile)&&n.imageInfo.profile.length>1,r=t&&n.imageInfo.profile[1].supports?n.imageInfo.profile[1].supports:[],i=t&&n.imageInfo.profile[1].formats?n.imageInfo.profile[1].formats:[],s=t&&n.imageInfo.profile[1].qualities?n.imageInfo.profile[1].qualities:[];return{url:n.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:n.imageInfo.sizes===void 0?void 0:n.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:n.imageInfo.tiles===void 0?void 0:[n.imageInfo.tiles.map(function(o){return o.width})[0],n.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:n.imageInfo.tiles===void 0?void 0:n.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...r],formats:[...e.formats,...i],qualities:[...e.qualities,...s]}}function Id(n){const e=n.getComplianceLevelSupportedFeatures(),t=n.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...n.imageInfo.extraFormats],r=n.imageInfo.preferredFormats!==void 0&&Array.isArray(n.imageInfo.preferredFormats)&&n.imageInfo.preferredFormats.length>0?n.imageInfo.preferredFormats.filter(function(i){return["jpg","png","gif"].includes(i)}).reduce(function(i,s){return i===void 0&&t.includes(s)?s:i},void 0):void 0;return{url:n.imageInfo.id,sizes:n.imageInfo.sizes===void 0?void 0:n.imageInfo.sizes.map(function(i){return[i.width,i.height]}),tileSize:n.imageInfo.tiles===void 0?void 0:[n.imageInfo.tiles.map(function(i){return i.width})[0],n.imageInfo.tiles.map(function(i){return i.height})[0]],resolutions:n.imageInfo.tiles===void 0?void 0:n.imageInfo.tiles.map(function(i){return i.scaleFactors})[0],supports:n.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...n.imageInfo.extraFeatures],formats:t,qualities:n.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...n.imageInfo.extraQualities],preferredFormat:r}}const ai={};ai[be.VERSION1]=Ad;ai[be.VERSION2]=Ld;ai[be.VERSION3]=Id;class Cd{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return be.VERSION1;case"http://iiif.io/api/image/2/context.json":return be.VERSION2;case"http://iiif.io/api/image/3/context.json":return be.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(be.VERSION1)&&this.imageInfo.identifier)return be.VERSION1;break}We(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case be.VERSION1:if(vd.test(this.imageInfo.profile))return this.imageInfo.profile;break;case be.VERSION3:if(Pd.test(this.imageInfo.profile))return this.imageInfo.profile;break;case be.VERSION2:if(typeof this.imageInfo.profile=="string"&&$o.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&$o.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const r=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(r)?r[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?$t.none.none:$t[e][t]}getTileSourceOptions(e){const t=e||{},r=this.getImageApiVersion();if(r===void 0)return;const i=r===void 0?void 0:ai[r](this);if(i!==void 0)return{url:i.url,version:r,size:[this.imageInfo.width,this.imageInfo.height],sizes:i.sizes,format:t.format!==void 0&&i.formats.includes(t.format)?t.format:i.preferredFormat!==void 0?i.preferredFormat:"jpg",supports:i.supports,quality:t.quality&&i.qualities.includes(t.quality)?t.quality:i.qualities.includes("native")?"native":"default",resolutions:Array.isArray(i.resolutions)?i.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:i.tileSize}}}class Ms{read(e){if(!e)return null;if(typeof e=="string"){const t=Ln(e);return this.readFromDocument(t)}return In(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){Rs()}}const Fd="http://www.w3.org/1999/xlink";function yr(n){return n.getAttributeNS(Fd,"href")}const ze=[null,"http://www.opengis.net/ows/1.1"],Od=M(ze,{ServiceIdentification:x(ng),ServiceProvider:x(sg),OperationsMetadata:x(tg)});class Nl extends Ms{constructor(){super()}readFromNode(e){const t=C({},Od,e,[]);return t||null}}const Md=M(ze,{DeliveryPoint:x(I),City:x(I),AdministrativeArea:x(I),PostalCode:x(I),Country:x(I),ElectronicMailAddress:x(I)}),Nd=M(ze,{Value:oe(og)}),Dd=M(ze,{AllowedValues:x(Zd)}),Ud=M(ze,{Phone:x(rg),Address:x(Hd)}),Bd=M(ze,{HTTP:x(Qd)}),Gd=M(ze,{Get:oe(Jd),Post:void 0}),zd=M(ze,{DCP:x(Kd)}),kd=M(ze,{Operation:eg}),$d=M(ze,{Voice:x(I),Facsimile:x(I)}),Vd=M(ze,{Constraint:oe(Yd)}),jd=M(ze,{IndividualName:x(I),PositionName:x(I),ContactInfo:x(qd)}),Xd=M(ze,{Abstract:x(I),AccessConstraints:x(I),Fees:x(I),Title:x(I),ServiceTypeVersion:x(I),ServiceType:x(I)}),Wd=M(ze,{ProviderName:x(I),ProviderSite:x(yr),ServiceContact:x(ig)});function Hd(n,e){return C({},Md,n,e)}function Zd(n,e){return C({},Nd,n,e)}function Yd(n,e){const t=n.getAttribute("name");if(t)return C({name:t},Dd,n,e)}function qd(n,e){return C({},Ud,n,e)}function Kd(n,e){return C({},Bd,n,e)}function Jd(n,e){const t=yr(n);if(t)return C({href:t},Vd,n,e)}function Qd(n,e){return C({},Gd,n,e)}function eg(n,e){const t=n.getAttribute("name"),r=C({},zd,n,e);if(!r)return;const i=e[e.length-1];i[t]=r}function tg(n,e){return C({},kd,n,e)}function rg(n,e){return C({},$d,n,e)}function ng(n,e){return C({},Xd,n,e)}function ig(n,e){return C({},jd,n,e)}function sg(n,e){return C({},Wd,n,e)}function og(n,e){return I(n)}function Vo(n,e,t,r,i,s){i!==void 0?(i=i,s=s!==void 0?s:0):(i=[],s=0);let o=e;for(;o<t;){const a=n[o++];i[s++]=n[o++],i[s++]=a;for(let c=2;c<r;++c)i[s++]=n[o++]}return i.length=s,i}class ag extends Tl{constructor(e){super(),e=e||{},this.dataProjection=ne("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t);return new tt(r)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const r=uh(this.geometryLayout_),i=cg(e,r,this.factor_);Vo(i,0,i.length,r,i);const s=hh(i,0,i.length,r),o=new _t(s,this.geometryLayout_);return Oe(o,!1,this.adaptOptions(t))}writeFeatureText(e,t){const r=e.getGeometry();if(r)return this.writeGeometryText(r,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=Oe(e,!0,this.adaptOptions(t));const r=e.getFlatCoordinates(),i=e.getStride();return Vo(r,0,r.length,i,r),lg(r,i,this.factor_)}}function lg(n,e,t){t=t||1e5;let r;const i=new Array(e);for(r=0;r<e;++r)i[r]=0;for(let s=0,o=n.length;s<o;)for(r=0;r<e;++r,++s){const a=n[s],c=a-i[r];i[r]=a,n[s]=c}return ug(n,t)}function cg(n,e,t){t=t||1e5;let r;const i=new Array(e);for(r=0;r<e;++r)i[r]=0;const s=hg(n,t);for(let o=0,a=s.length;o<a;)for(r=0;r<e;++r,++o)i[r]+=s[o],s[o]=i[r];return s}function ug(n,e){e=e||1e5;for(let t=0,r=n.length;t<r;++t)n[t]=Math.round(n[t]*e);return fg(n)}function hg(n,e){e=e||1e5;const t=dg(n);for(let r=0,i=t.length;r<i;++r)t[r]/=e;return t}function fg(n){for(let e=0,t=n.length;e<t;++e){const r=n[e];n[e]=r<0?~(r<<1):r<<1}return gg(n)}function dg(n){const e=pg(n);for(let t=0,r=e.length;t<r;++t){const i=e[t];e[t]=i&1?~(i>>1):i>>1}return e}function gg(n){let e="";for(let t=0,r=n.length;t<r;++t)e+=mg(n[t]);return e}function pg(n){const e=[];let t=0,r=0;for(let i=0,s=n.length;i<s;++i){const o=n.charCodeAt(i)-63;t|=(o&31)<<r,o<32?(e.push(t),t=0,r=0):r+=5}return e}function mg(n){let e,t="";for(;n>=32;)e=(32|n&31)+63,t+=String.fromCharCode(e),n>>=5;return e=n+63,t+=String.fromCharCode(e),t}class ee extends A{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,r){const i=r[r.length-1];r[r.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},i),super.writeGeometryElement(e,t,r)}}ee.prototype.namespace="http://www.opengis.net/gml/3.2";ee.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:z(A.prototype.readFlatPos),posList:z(A.prototype.readFlatPosList),coordinates:z(Z.prototype.readFlatCoordinates)}};ee.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:A.prototype.interiorParser,exterior:A.prototype.exteriorParser}};ee.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:z(D.prototype.readPoint),MultiPoint:z(D.prototype.readMultiPoint),LineString:z(D.prototype.readLineString),MultiLineString:z(D.prototype.readMultiLineString),LinearRing:z(D.prototype.readLinearRing),Polygon:z(D.prototype.readPolygon),MultiPolygon:z(D.prototype.readMultiPolygon),Surface:z(ee.prototype.readSurface),MultiSurface:z(A.prototype.readMultiSurface),Curve:z(ee.prototype.readCurve),MultiCurve:z(A.prototype.readMultiCurve),Envelope:z(ee.prototype.readEnvelope)}};ee.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:G(A.prototype.curveMemberParser),curveMembers:G(A.prototype.curveMemberParser)}};ee.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:G(A.prototype.surfaceMemberParser),surfaceMembers:G(A.prototype.surfaceMemberParser)}};ee.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:G(D.prototype.readLineString),Curve:G(A.prototype.readCurve)}};ee.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:G(D.prototype.readPolygon),Surface:G(A.prototype.readSurface)}};ee.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:z(A.prototype.readPatch)}};ee.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:z(A.prototype.readSegment)}};ee.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:G(A.prototype.readFlatPosList),upperCorner:G(A.prototype.readFlatPosList)}};ee.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:z(A.prototype.readPolygonPatch)}};ee.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:tl(A.prototype.readLineStringSegment)}};ee.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:G(D.prototype.pointMemberParser),pointMembers:G(D.prototype.pointMemberParser)}};ee.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:G(D.prototype.lineStringMemberParser),lineStringMembers:G(D.prototype.lineStringMemberParser)}};ee.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:G(D.prototype.polygonMemberParser),polygonMembers:G(D.prototype.polygonMemberParser)}};ee.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:G(D.prototype.readFlatCoordinatesFromNode)}};ee.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:G(D.prototype.readLineString)}};ee.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:G(D.prototype.readPolygon)}};ee.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:z(D.prototype.readFlatLinearRing),Ring:z(ee.prototype.readFlatCurveRing)}};ee.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:b(A.prototype.writeRing),interior:b(A.prototype.writeRing)}};ee.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:b(q),upperCorner:b(q)}};ee.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:b(A.prototype.writeSurfaceOrPolygonMember),polygonMember:b(A.prototype.writeSurfaceOrPolygonMember)}};ee.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:b(A.prototype.writePointMember)}};ee.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:b(A.prototype.writeLineStringOrCurveMember),curveMember:b(A.prototype.writeLineStringOrCurveMember)}};ee.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:b(A.prototype.writeCurveOrLineString),MultiCurve:b(A.prototype.writeMultiCurveOrLineString),Point:b(ee.prototype.writePoint),MultiPoint:b(A.prototype.writeMultiPoint),LineString:b(A.prototype.writeCurveOrLineString),MultiLineString:b(A.prototype.writeMultiCurveOrLineString),LinearRing:b(A.prototype.writeLinearRing),Polygon:b(A.prototype.writeSurfaceOrPolygon),MultiPolygon:b(A.prototype.writeMultiSurfaceOrPolygon),Surface:b(A.prototype.writeSurfaceOrPolygon),MultiSurface:b(A.prototype.writeMultiSurfaceOrPolygon),Envelope:b(A.prototype.writeEnvelope)}};class Dl{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class _g extends Dl{constructor(e,t){super(e),this.conditions=t,We(this.conditions.length>=2,"At least 2 conditions are required")}}class yg extends _g{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class Eg extends Dl{constructor(e,t,r){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=r}}function xg(n){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(yg,e))}function bg(n,e,t){return new Eg(n,e,t)}const jo={"http://www.opengis.net/gml":{boundedBy:x(D.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:G(D.prototype.readFeaturesInternal)}},Tg={"http://www.opengis.net/wfs":{totalInserted:x(ye),totalUpdated:x(ye),totalDeleted:x(ye)},"http://www.opengis.net/wfs/2.0":{totalInserted:x(ye),totalUpdated:x(ye),totalDeleted:x(ye)}},wg={"http://www.opengis.net/wfs":{TransactionSummary:x(Wo,"transactionSummary"),InsertResults:x(Zo,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:x(Wo,"transactionSummary"),InsertResults:x(Zo,"insertIds")}},Sg={"http://www.opengis.net/wfs":{PropertyName:b(q)},"http://www.opengis.net/wfs/2.0":{PropertyName:b(q)}},Ul={"http://www.opengis.net/wfs":{Insert:b(Yo),Update:b(Ko),Delete:b(qo),Property:b(Jo),Native:b(Qo)},"http://www.opengis.net/wfs/2.0":{Insert:b(Yo),Update:b(Ko),Delete:b(qo),Property:b(Jo),Native:b(Qo)}},Bl="feature",Ns="http://www.w3.org/2000/xmlns/",Ds={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},Xi={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},Us={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},Xo={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},Bs={"2.0.0":ee,"1.1.0":A,"1.0.0":Z},Rg="1.1.0";class vg extends Jn{constructor(e){super(),e=e||{},this.version_=e.version?e.version:Rg,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new Bs[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:Xo[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const r={node:e};Object.assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(r,this.getReadOptions(e,t||{}));const i=[r];let s;this.version_==="2.0.0"?s=jo:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=C([],s,e,i,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=Ln(e);return this.readTransactionResponseFromDocument(t)}return In(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=Ln(e);return this.readFeatureCollectionMetadataFromDocument(t)}return In(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},r=St(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,C(t,jo,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return C({},wg,e,[])}writeGetFeature(e){const t=j(Xi[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS(Gr,"xsi:schemaLocation",this.schemaLocation_);const r={node:t};if(Object.assign(r,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),We(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let i=e.filter;e.bbox&&(We(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),i=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,i)),Object.assign(r,{geometryName:e.geometryName,filter:i}),ca(t,e.featureTypes,[r])}else e.featureTypes.forEach(i=>{const s=this.combineBboxAndFilter(i.geometryName,i.bbox,e.srsName,e.filter);Object.assign(r,{geometryName:i.geometryName,filter:s}),ca(t,[i.name],[r])});return t}combineBboxAndFilter(e,t,r,i){const s=bg(e,t,r);return i?xg(i,s):s}writeTransaction(e,t,r,i){const s=[],o=i.version?i.version:this.version_,a=j(Xi[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let c;i&&(c=i.gmlOptions?i.gmlOptions:{},i.handle&&a.setAttribute("handle",i.handle)),a.setAttributeNS(Gr,"xsi:schemaLocation",Xo[o]);const l=Pg(a,c,o,i);return e&&mn("Insert",e,s,l),t&&mn("Update",t,s,l),r&&mn("Delete",r,s,l),i.nativeElements&&mn("Native",i.nativeElements,s,l),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const r=[{}];return this.gmlFormat_.readGeometryElement(t,r),ne(r.pop().srsName)}}return null}}function Pg(n,e,t,r){const i=r.featurePrefix?r.featurePrefix:Bl;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:n},{version:t,featureNS:r.featureNS,featureType:r.featureType,featurePrefix:i,gmlVersion:s,hasZ:r.hasZ,srsName:r.srsName},e)}function mn(n,e,t,r){de(r,Ul,Ve(n),e,t)}function Wo(n,e){return C({},Tg,n,e)}const Ag={"http://www.opengis.net/ogc":{FeatureId:G(function(n,e){return n.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:G(function(n,e){return n.getAttribute("fid")})}};function Ho(n,e){vt(Ag,n,e)}const Lg={"http://www.opengis.net/wfs":{Feature:Ho},"http://www.opengis.net/wfs/2.0":{Feature:Ho}};function Zo(n,e){return C([],Lg,n,e)}function Yo(n,e,t){const r=t[t.length-1],i=r.featureType,s=r.featureNS,o=r.gmlVersion,a=j(s,i);n.appendChild(a),o===2?Z.prototype.writeFeatureElement(a,e,t):o===3?A.prototype.writeFeatureElement(a,e,t):ee.prototype.writeFeatureElement(a,e,t)}function Gl(n,e,t){const i=t[t.length-1].version,s=Ds[i],o=j(s,"Filter"),a=j(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),n.appendChild(o)}function Gs(n,e){n=n||Bl;const t=n+":";return e.startsWith(t)?e:t+e}function qo(n,e,t){const r=t[t.length-1];We(e.getId()!==void 0,"Features must have an id set");const i=r.featureType,s=r.featurePrefix,o=r.featureNS,a=Gs(s,i);n.setAttribute("typeName",a),n.setAttributeNS(Ns,"xmlns:"+s,o);const c=e.getId();c!==void 0&&Gl(n,c,t)}function Ko(n,e,t){const r=t[t.length-1];We(e.getId()!==void 0,"Features must have an id set");const i=r.version,s=r.featureType,o=r.featurePrefix,a=r.featureNS,c=Gs(o,s),l=e.getGeometryName();n.setAttribute("typeName",c),n.setAttributeNS(Ns,"xmlns:"+o,a);const u=e.getId();if(u!==void 0){const h=e.getKeys(),f=[];for(let d=0,g=h.length;d<g;d++){const p=e.get(h[d]);if(p!==void 0){let m=h[d];p&&typeof p.getSimplifiedGeometry=="function"&&(m=l),f.push({name:m,value:p})}}de({version:i,gmlVersion:r.gmlVersion,node:n,hasZ:r.hasZ,srsName:r.srsName},Ul,Ve("Property"),f,t),Gl(n,u,t)}}function Jo(n,e,t){const r=t[t.length-1],i=r.version,s=Xi[i],a=j(s,i==="2.0.0"?"ValueReference":"Name"),c=r.gmlVersion;if(n.appendChild(a),q(a,e.name),e.value!==void 0&&e.value!==null){const l=j(s,"Value");n.appendChild(l),e.value&&typeof e.value.getSimplifiedGeometry=="function"?c===2?Z.prototype.writeGeometryElement(l,e.value,t):c===3?A.prototype.writeGeometryElement(l,e.value,t):ee.prototype.writeGeometryElement(l,e.value,t):q(l,e.value)}}function Qo(n,e,t){e.vendorId&&n.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&n.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&q(n,e.value)}const li={"http://www.opengis.net/wfs":{Query:b(ea)},"http://www.opengis.net/wfs/2.0":{Query:b(ea)},"http://www.opengis.net/ogc":{During:b(na),And:b(_n),Or:b(_n),Not:b(ia),BBOX:b(ta),Contains:b(Tt),Intersects:b(Tt),Within:b(Tt),DWithin:b(ra),PropertyIsEqualTo:b(je),PropertyIsNotEqualTo:b(je),PropertyIsLessThan:b(je),PropertyIsLessThanOrEqualTo:b(je),PropertyIsGreaterThan:b(je),PropertyIsGreaterThanOrEqualTo:b(je),PropertyIsNull:b(sa),PropertyIsBetween:b(oa),PropertyIsLike:b(aa)},"http://www.opengis.net/fes/2.0":{During:b(na),And:b(_n),Or:b(_n),Not:b(ia),BBOX:b(ta),Contains:b(Tt),Disjoint:b(Tt),Intersects:b(Tt),ResourceId:b(Cg),Within:b(Tt),DWithin:b(ra),PropertyIsEqualTo:b(je),PropertyIsNotEqualTo:b(je),PropertyIsLessThan:b(je),PropertyIsLessThanOrEqualTo:b(je),PropertyIsGreaterThan:b(je),PropertyIsGreaterThanOrEqualTo:b(je),PropertyIsNull:b(sa),PropertyIsBetween:b(oa),PropertyIsLike:b(aa)}};function ea(n,e,t){const r=t[t.length-1],i=r.version,s=r.featurePrefix,o=r.featureNS,a=r.propertyNames,c=r.srsName;let l;s?l=Gs(s,e):l=e;let u;i==="2.0.0"?u="typeNames":u="typeName",n.setAttribute(u,l),c&&n.setAttribute("srsName",c),o&&n.setAttributeNS(Ns,"xmlns:"+s,o);const h=Object.assign({},r);h.node=n,de(h,Sg,Ve("PropertyName"),a,t);const f=r.filter;if(f){const d=j(ci(i),"Filter");n.appendChild(d),Ig(d,f,t)}}function Ig(n,e,t){const r=t[t.length-1],i={node:n};Object.assign(i,{context:r}),de(i,li,Ve(e.getTagName()),[e],t)}function ta(n,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Bs[s];Er(s,n,e.geometryName),o.prototype.writeGeometryElement(n,e.extent,t)}function Cg(n,e,t){n.setAttribute("rid",e.rid)}function Tt(n,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Bs[s];Er(s,n,e.geometryName),o.prototype.writeGeometryElement(n,e.geometry,t)}function ra(n,e,t){const s=t[t.length-1].context.version;Tt(n,e,t);const o=j(ci(s),"Distance");q(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),n.appendChild(o)}function na(n,e,t){const s=t[t.length-1].context.version;Bn(Us[s],"ValueReference",n,e.propertyName);const o=j(mt,"TimePeriod");n.appendChild(o);const a=j(mt,"begin");o.appendChild(a),la(a,e.begin);const c=j(mt,"end");o.appendChild(c),la(c,e.end)}function _n(n,e,t){const i=t[t.length-1].context,s={node:n};Object.assign(s,{context:i});const o=e.conditions;for(let a=0,c=o.length;a<c;++a){const l=o[a];de(s,li,Ve(l.getTagName()),[l],t)}}function ia(n,e,t){const i=t[t.length-1].context,s={node:n};Object.assign(s,{context:i});const o=e.condition;de(s,li,Ve(o.getTagName()),[o],t)}function je(n,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&n.setAttribute("matchCase",e.matchCase.toString()),Er(s,n,e.propertyName),Gn(s,n,""+e.expression)}function sa(n,e,t){const s=t[t.length-1].context.version;Er(s,n,e.propertyName)}function oa(n,e,t){const s=t[t.length-1].context.version,o=ci(s);Er(s,n,e.propertyName);const a=j(o,"LowerBoundary");n.appendChild(a),Gn(s,a,""+e.lowerBoundary);const c=j(o,"UpperBoundary");n.appendChild(c),Gn(s,c,""+e.upperBoundary)}function aa(n,e,t){const s=t[t.length-1].context.version;n.setAttribute("wildCard",e.wildCard),n.setAttribute("singleChar",e.singleChar),n.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&n.setAttribute("matchCase",e.matchCase.toString()),Er(s,n,e.propertyName),Gn(s,n,""+e.pattern)}function Bn(n,e,t,r){const i=j(n,e);q(i,r),t.appendChild(i)}function Gn(n,e,t){Bn(ci(n),"Literal",e,t)}function Er(n,e,t){n==="2.0.0"?Bn(Us[n],"ValueReference",e,t):Bn(Ds[n],"PropertyName",e,t)}function la(n,e){const t=j(mt,"TimeInstant");n.appendChild(t);const r=j(mt,"timePosition");t.appendChild(r),q(r,e)}function ca(n,e,t){const r=t[t.length-1],i=Object.assign({},r);i.node=n,de(i,li,Ve("Query"),e,t)}function ci(n){let e;return n==="2.0.0"?e=Us[n]:e=Ds[n],e}const le={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class ua{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readLineString());return t}readWkbHeader(e){const r=this.readUint8()>0,i=this.readUint32(r),s=Math.floor((i&268435455)/1e3),o=!!(i&2147483648)||s===1||s===3,a=!!(i&1073741824)||s===2||s===3,c=!!(i&536870912),l=(i&268435455)%1e3,u=["XY",o?"Z":"",a?"M":""].join(""),h=c?this.readUint32(r):null;if(e!==void 0&&e!==l)throw new Error("Unexpected WKB geometry type "+l);if(this.initialized_){if(this.isLittleEndian_!==r)throw new Error("Inconsistent endian");if(this.layout_!==u)throw new Error("Inconsistent geometry layout");if(h&&this.srid_!==h)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=r,this.hasZ_=o,this.hasM_=a,this.layout_=u,this.srid_=h,this.initialized_=!0;return l}readWkbPayload(e){switch(e){case le.POINT:return this.readPoint();case le.LINE_STRING:return this.readLineString();case le.POLYGON:case le.TRIANGLE:return this.readPolygon();case le.MULTI_POINT:return this.readMultiPoint();case le.MULTI_LINE_STRING:return this.readMultiLineString();case le.MULTI_POLYGON:case le.POLYHEDRAL_SURFACE:case le.TIN:return this.readMultiPolygon();case le.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const r=this.readUint32(),i=[];for(let s=0;s<r;s++){const o=e.call(this,t);o&&i.push(o)}return i}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,le.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,le.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,le.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case le.POINT:return new ct(t,this.layout_);case le.LINE_STRING:return new _t(t,this.layout_);case le.POLYGON:case le.TRIANGLE:return new si(t,this.layout_);case le.MULTI_POINT:return new ys(t,this.layout_);case le.MULTI_LINE_STRING:return new Qr(t,this.layout_);case le.MULTI_POLYGON:case le.POLYHEDRAL_SURFACE:case le.TIN:return new ii(t,this.layout_);case le.GEOMETRY_COLLECTION:return new jr(t);default:return null}}getSrid(){return this.srid_}}class Fg{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const r=Object.assign.apply(null,t.split("").map((i,s)=>({[i]:e[s]})));for(const i of this.layout_)this.writeDouble(i in r?r[i]:this.nodata_[i])}writeLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writePoint(e[r],t)}writePolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeLineString(e[r],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(1),this.writePoint(e[r],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(2),this.writeLineString(e[r],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(3),this.writePolygon(e[r],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const r=(i,s)=>i===s?i:i==="XYZM"?s:s==="XYZM"?i:"XY";if(e instanceof Po)return r(e.getLayout(),t);if(e instanceof jr){const i=e.getGeometriesArray();for(let s=0;s<i.length&&t!=="XY";s++)t=this.findMinimumLayout(i[s],t)}return t}writeGeometry(e,t){const r={Point:le.POINT,LineString:le.LINE_STRING,Polygon:le.POLYGON,MultiPoint:le.MULTI_POINT,MultiLineString:le.MULTI_LINE_STRING,MultiPolygon:le.MULTI_POLYGON,GeometryCollection:le.GEOMETRY_COLLECTION},i=e.getType(),s=r[i];if(!s)throw new Error("GeometryType "+i+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof Po?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[i].call(this,e.getCoordinates(),e.getLayout()):e instanceof jr&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),r=new DataView(t);let i=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:r.setUint8(i,s[1]);break;case 4:r.setUint32(i,s[1],this.isLittleEndian_);break;case 8:r.setFloat64(i,s[1],this.isLittleEndian_);break}i+=s[0]}),t}}class Og extends fh{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new tt({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let r=[];const i=this.readGeometry(e,t);return this.splitCollection&&i instanceof jr?r=i.getGeometriesArray():r=[i],r.map(s=>new tt({geometry:s}))}readGeometry(e,t){const r=ha(e);if(!r)return null;const s=new ua(r).readGeometry();return this.viewCache_=r,t=this.getReadOptions(e,t),this.viewCache_=null,Oe(s,!1,t)}readProjection(e){const t=this.viewCache_||ha(e);if(!t)return;const r=new ua(t);return r.readWkbHeader(),r.getSrid()&&ne("EPSG:"+r.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new jr(e.map(r=>r.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const r=new Fg({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let i=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&ne(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(i=Number(a.substring(5)))}}r.writeGeometry(Oe(e,!0,t),i);const s=r.getBuffer();return this.hex_?Mg(s):s}}function Mg(n){const e=new Uint8Array(n);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function Ng(n){const e=new Uint8Array(n.length/2);for(let t=0;t<n.length/2;t++)e[t]=parseInt(n.substr(t*2,2),16);return new DataView(e.buffer)}function ha(n){return typeof n=="string"?Ng(n):ArrayBuffer.isView(n)?n instanceof DataView?n:new DataView(n.buffer,n.byteOffset,n.byteLength):n instanceof ArrayBuffer?new DataView(n):null}const Te=[null,"http://www.opengis.net/wms"];function xr(n){return dh(n[0].version,"1.3")>=0}const Dg=M(Te,{Service:x(sp),Capability:x(ip)}),zl={Request:x(gp),Exception:x(cp),Layer:x(up)},Ug=M(Te,{...zl,UserDefinedSymbolization:x(rp)}),Bg=M(Te,zl);class Gg extends Ms{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=C({version:this.version},Dg,e,[]);return t||null}}const kl={Name:x(I),Title:x(I),Abstract:x(I),KeywordList:x(Hl),OnlineResource:x(yr),ContactInformation:x(op),Fees:x(I),AccessConstraints:x(I)},zg=M(Te,kl),kg=M(Te,{...kl,LayerLimit:x(ye),MaxWidth:x(ye),MaxHeight:x(ye)}),$g=M(Te,{ContactPersonPrimary:x(ap),ContactPosition:x(I),ContactAddress:x(lp),ContactVoiceTelephone:x(I),ContactFacsimileTelephone:x(I),ContactElectronicMailAddress:x(I)}),Vg=M(Te,{ContactPerson:x(I),ContactOrganization:x(I)}),jg=M(Te,{AddressType:x(I),Address:x(I),City:x(I),StateOrProvince:x(I),PostCode:x(I),Country:x(I)}),Xg=M(Te,{Format:G(I)}),$l={Name:x(I),Title:x(I),Abstract:x(I),KeywordList:x(Hl),BoundingBox:oe(Xl),Dimension:oe(hp),Attribution:x(tp),AuthorityURL:oe(_p),Identifier:oe(I),MetadataURL:oe(yp),DataURL:oe(Et),FeatureListURL:oe(Et),Style:oe(Ep),Layer:oe(ui)},Vl=M(Te,{...$l,SRS:oe(I),Extent:x(fp),ScaleHint:oe(dp),LatLonBoundingBox:x((n,e)=>Xl(n,e,!1)),Layer:oe(ui)}),jl=M(Te,{...$l,CRS:oe(I),EX_GeographicBoundingBox:x(np),MinScaleDenominator:x(Fe),MaxScaleDenominator:x(Fe),Layer:oe(ui)}),Wg=M(Te,{Title:x(I),OnlineResource:x(yr),LogoURL:x(Wl)}),Hg=M(Te,{westBoundLongitude:x(Fe),eastBoundLongitude:x(Fe),southBoundLatitude:x(Fe),northBoundLatitude:x(Fe)}),Zg=M(Te,{GetCapabilities:x(xi),GetMap:x(xi),GetFeatureInfo:x(xi)}),Yg=M(Te,{Format:oe(I),DCPType:oe(pp)}),qg=M(Te,{HTTP:x(mp)}),Kg=M(Te,{Get:x(Et),Post:x(Et)}),Jg=M(Te,{Name:x(I),Title:x(I),Abstract:x(I),LegendURL:oe(Wl),StyleSheetURL:x(Et),StyleURL:x(Et)}),Qg=M(Te,{Format:x(I),OnlineResource:x(yr)}),ep=M(Te,{Keyword:G(I)});function tp(n,e){return C({},Wg,n,e)}function rp(n,e){return{SupportSLD:!!Ke(n.getAttribute("UserDefinedSymbolization")),UserLayer:!!Ke(n.getAttribute("UserLayer")),UserStyle:!!Ke(n.getAttribute("UserStyle")),RemoteWFS:!!Ke(n.getAttribute("RemoteWFS"))}}function Xl(n,e,t=!0){const r=[lt(n.getAttribute("minx")),lt(n.getAttribute("miny")),lt(n.getAttribute("maxx")),lt(n.getAttribute("maxy"))],i=[lt(n.getAttribute("resx")),lt(n.getAttribute("resy"))],s={extent:r,res:i};return t&&(xr(e)?s.crs=n.getAttribute("CRS"):s.srs=n.getAttribute("SRS")),s}function np(n,e){const t=C({},Hg,n,e);if(!t)return;const r=t.westBoundLongitude,i=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(r===void 0||i===void 0||s===void 0||o===void 0))return[r,i,s,o]}function ip(n,e){return C({},xr(e)?Bg:Ug,n,e)}function sp(n,e){return C({},xr(e)?kg:zg,n,e)}function op(n,e){return C({},$g,n,e)}function ap(n,e){return C({},Vg,n,e)}function lp(n,e){return C({},jg,n,e)}function cp(n,e){return C([],Xg,n,e)}function up(n,e){const t=C({},xr(e)?jl:Vl,n,e);return t.Layer===void 0?Object.assign(t,ui(n,e)):t}function ui(n,e){const t=xr(e),r=e[e.length-1],i=C({},t?jl:Vl,n,e);if(!i)return;let s=Ke(n.getAttribute("queryable"));s===void 0&&(s=r.queryable),i.queryable=s!==void 0?s:!1;let o=St(n.getAttribute("cascaded"));o===void 0&&(o=r.cascaded),i.cascaded=o;let a=Ke(n.getAttribute("opaque"));a===void 0&&(a=r.opaque),i.opaque=a!==void 0?a:!1;let c=Ke(n.getAttribute("noSubsets"));c===void 0&&(c=r.noSubsets),i.noSubsets=c!==void 0?c:!1;let l=lt(n.getAttribute("fixedWidth"));l||(l=r.fixedWidth),i.fixedWidth=l;let u=lt(n.getAttribute("fixedHeight"));u||(u=r.fixedHeight),i.fixedHeight=u;const h=["Style","AuthorityURL"];t?h.push("CRS"):h.push("SRS","Dimension"),h.forEach(function(d){if(d in r){const g=i[d]||[];i[d]=g.concat(r[d])}});const f=["BoundingBox","Attribution"];return t?f.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):f.push("LatLonBoundingBox","ScaleHint","Extent"),f.forEach(function(d){if(!(d in i)){const g=r[d];i[d]=g}}),i}function hp(n,e){const t={name:n.getAttribute("name"),units:n.getAttribute("units"),unitSymbol:n.getAttribute("unitSymbol")};return xr(e)&&Object.assign(t,{default:n.getAttribute("default"),multipleValues:Ke(n.getAttribute("multipleValues")),nearestValue:Ke(n.getAttribute("nearestValue")),current:Ke(n.getAttribute("current")),values:I(n)}),t}function fp(n,e){return{name:n.getAttribute("name"),default:n.getAttribute("default"),nearestValue:Ke(n.getAttribute("nearestValue"))}}function dp(n,e){return{min:lt(n.getAttribute("min")),max:lt(n.getAttribute("max"))}}function Et(n,e){return C({},Qg,n,e)}function gp(n,e){return C({},Zg,n,e)}function pp(n,e){return C({},qg,n,e)}function mp(n,e){return C({},Kg,n,e)}function xi(n,e){return C({},Yg,n,e)}function Wl(n,e){const t=Et(n,e);if(t){const r=[St(n.getAttribute("width")),St(n.getAttribute("height"))];return t.size=r,t}}function _p(n,e){const t=Et(n,e);if(t)return t.name=n.getAttribute("name"),t}function yp(n,e){const t=Et(n,e);if(t)return t.type=n.getAttribute("type"),t}function Ep(n,e){return C({},Jg,n,e)}function Hl(n,e){return C([],ep,n,e)}const xp="_feature",bp="_layer";class Tp extends Jn{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new Z,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const r=e.localName;let i=[];if(e.childNodes.length===0)return i;if(r=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const c=a,l=t[0],u=bp,h=c.localName.replace(u,"");if(this.layers_&&!this.layers_.includes(h))continue;const f=h+xp;l.featureType=f,l.featureNS=this.featureNS_;const d={};d[f]=G(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const g=M([l.featureNS,null],d);c.setAttribute("namespaceURI",this.featureNS_);const p=C([],g,c,t,this.gmlFormat_);p&&Dn(i,p)}if(r=="FeatureCollection"){const s=C([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(i=s)}return i}readFeaturesFromNode(e,t){const r={};return t&&Object.assign(r,this.getReadOptions(e,t)),this.readFeatures_(e,[r])}}const ut=[null,"http://www.opengis.net/wmts/1.0"],br=[null,"http://www.opengis.net/ows/1.1"],wp=M(ut,{Contents:x(Op)});let zs=class extends Ms{constructor(){super(),this.owsParser_=new Nl}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let r=this.owsParser_.readFromNode(e);return r?(r.version=t,r=C(r,wp,e,[]),r||null):null}};const Sp=M(ut,{Layer:oe(Mp),TileMatrixSet:oe(Np)}),Rp=M(ut,{Style:oe(Dp),Format:oe(I),TileMatrixSetLink:oe(Up),Dimension:oe(Bp),ResourceURL:oe(Gp)},M(br,{Title:x(I),Abstract:x(I),WGS84BoundingBox:x(Yl),BoundingBox:oe(zp),Identifier:x(I)})),vp=M(ut,{LegendURL:oe(kp)},M(br,{Title:x(I),Identifier:x(I)})),Pp=M(ut,{TileMatrixSet:x(I),TileMatrixSetLimits:x(Vp)}),Ap=M(ut,{TileMatrixLimits:G(jp)}),Lp=M(ut,{TileMatrix:x(I),MinTileRow:x(ye),MaxTileRow:x(ye),MinTileCol:x(ye),MaxTileCol:x(ye)}),Ip=M(ut,{Default:x(I),Value:oe(I)},M(br,{Identifier:x(I)})),Zl=M(br,{LowerCorner:G(Wi),UpperCorner:G(Wi)}),Cp=M(ut,{WellKnownScaleSet:x(I),TileMatrix:oe($p)},M(br,{SupportedCRS:x(I),Identifier:x(I),BoundingBox:x(Yl)})),Fp=M(ut,{TopLeftCorner:x(Wi),ScaleDenominator:x(Fe),TileWidth:x(ye),TileHeight:x(ye),MatrixWidth:x(ye),MatrixHeight:x(ye)},M(br,{Identifier:x(I)}));function Op(n,e){return C({},Sp,n,e)}function Mp(n,e){return C({},Rp,n,e)}function Np(n,e){return C({},Cp,n,e)}function Dp(n,e){const t=C({},vp,n,e);if(!t)return;const r=n.getAttribute("isDefault")==="true";return t.isDefault=r,t}function Up(n,e){return C({},Pp,n,e)}function Bp(n,e){return C({},Ip,n,e)}function Gp(n,e){const t=n.getAttribute("format"),r=n.getAttribute("template"),i=n.getAttribute("resourceType"),s={};return t&&(s.format=t),r&&(s.template=r),i&&(s.resourceType=i),s}function Yl(n,e){const t=C([],Zl,n,e);if(t.length==2)return vs(t)}function zp(n,e){const t=n.getAttribute("crs"),r=C([],Zl,n,e);if(r.length==2)return{extent:vs(r),crs:t}}function kp(n,e){const t={};return t.format=n.getAttribute("format"),t.href=yr(n),t}function Wi(n,e){const t=I(n).split(/\s+/);if(!t||t.length!=2)return;const r=+t[0],i=+t[1];if(!(isNaN(r)||isNaN(i)))return[r,i]}function $p(n,e){return C({},Fp,n,e)}function Vp(n,e){return C([],Ap,n,e)}function jp(n,e){return C({},Lp,n,e)}const Xp=Object.freeze(Object.defineProperty({__proto__:null,EsriJSON:mf,GML:Ls,GPX:Vf,GeoJSON:xs,IGC:Rd,IIIFInfo:Cd,KML:bu,MVT:nl,OWS:Nl,Polyline:ag,TopoJSON:Tu,WFS:vg,WKB:Og,WKT:kh,WMSCapabilities:Gg,WMSGetFeatureInfo:Tp,WMTSCapabilities:zs},Symbol.toStringTag,{value:"Module"})),Or={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"},fa=.985;function ql(n,e){e=e||[];const t=256,r=t-1;return e[0]=Math.floor(n/t/t/t)/r,e[1]=Math.floor(n/t/t)%t/r,e[2]=Math.floor(n/t)%t/r,e[3]=n%t/r,e}function Kl(n){let e=0;const t=256,r=t-1;return e+=Math.round(n[0]*t*t*t*r),e+=Math.round(n[1]*t*t*r),e+=Math.round(n[2]*t*r),e+=Math.round(n[3]*r),e}function Wp(n){const e=Array.isArray(n)?n:[n];if("style"in e[0]){const t=[],r=e,i=[];for(const s of r){const o=Array.isArray(s.style)?s.style:[s.style];let a=s.filter;s.else&&i.length&&(a=["all",...i.map(l=>["!",l])],s.filter&&a.push(s.filter),a.length<3&&(a=a[1])),s.filter&&i.push(s.filter);const c=o.map(l=>({style:l,...a&&{filter:a}}));t.push(...c)}return t}return"builder"in e[0]?e:e.map(t=>({style:t}))}const nn=34962,sn=34963,ks=35044,zn=35048,Hp=5121,Zp=5123,Yp=5125,Jl=5126,da=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function qp(n,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!wu},e);const t=da.length;for(let r=0;r<t;++r)try{const i=n.getContext(da[r],e);if(i)return i}catch{}return null}const Kp={STATIC_DRAW:ks};class ur{constructor(e,t){this.array_=null,this.type_=e,We(e===nn||e===sn,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:Kp.STATIC_DRAW}ofSize(e){return this.array_=new(yn(this.type_))(e),this}fromArray(e){return this.array_=yn(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(yn(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=yn(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function yn(n){switch(n){case nn:return Float32Array;case sn:return Uint32Array;default:return Float32Array}}function Xt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function kn(n,e){return n[0]=e[0],n[1]=e[1],n[4]=e[2],n[5]=e[3],n[12]=e[4],n[13]=e[5],n}function Hi(n,e,t,r,i,s,o){o=o??Xt();const a=1/(n-e),c=1/(t-r),l=1/(i-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*c,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*l,o[11]=0,o[12]=(n+e)*a,o[13]=(r+t)*c,o[14]=(s+i)*l,o[15]=1,o}function ga(n,e,t,r,i){return i=i??Xt(),i[0]=n[0]*e,i[1]=n[1]*e,i[2]=n[2]*e,i[3]=n[3]*e,i[4]=n[4]*t,i[5]=n[5]*t,i[6]=n[6]*t,i[7]=n[7]*t,i[8]=n[8]*r,i[9]=n[9]*r,i[10]=n[10]*r,i[11]=n[11]*r,i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],i}function Jp(n,e,t,r,i){i=i??Xt();let s,o,a,c,l,u,h,f,d,g,p,m;return n===i?(i[12]=n[0]*e+n[4]*t+n[8]*r+n[12],i[13]=n[1]*e+n[5]*t+n[9]*r+n[13],i[14]=n[2]*e+n[6]*t+n[10]*r+n[14],i[15]=n[3]*e+n[7]*t+n[11]*r+n[15]):(s=n[0],o=n[1],a=n[2],c=n[3],l=n[4],u=n[5],h=n[6],f=n[7],d=n[8],g=n[9],p=n[10],m=n[11],i[0]=s,i[1]=o,i[2]=a,i[3]=c,i[4]=l,i[5]=u,i[6]=h,i[7]=f,i[8]=d,i[9]=g,i[10]=p,i[11]=m,i[12]=s*e+l*t+d*r+n[12],i[13]=o*e+u*t+g*r+n[13],i[14]=a*e+h*t+p*r+n[14],i[15]=c*e+f*t+m*r+n[15]),i}function Qp(n,e,t,r){return r=r??Xt(),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=n,r[13]=e,r[14]=t,r[15]=1,r}const En={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},em=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,tm=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class pa{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||em),t.compileShader(r);const i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(i,e.fragmentShader||tm),t.compileShader(i),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,i),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const i=0,s=t.RGBA,o=0,a=t.RGBA,c=t.UNSIGNED_BYTE,l=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,i,s,r[0],r[1],o,a,c,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,i){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const c=ce(s.canvas);if(!e.renderTargets[c]){const l=s.getContextAttributes();l&&l.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[c]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),i&&i(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,i=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${i}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,i++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const at={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},xe={UNSIGNED_BYTE:Hp,UNSIGNED_SHORT:Zp,UNSIGNED_INT:Yp,FLOAT:Jl},$n={};function ma(n){return"shared/"+n}let _a=0;function rm(){const n="unique/"+_a;return _a+=1,n}function nm(n){let e=$n[n];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:qp(t)},$n[n]=e}return e.users+=1,e.context}function im(n){const e=$n[n];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const i=t.canvas;i.width=1,i.height=1,delete $n[n]}class sm extends El{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?ma(e.canvasCacheKey):rm(),this.gl_=nm(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(En.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(En.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=Pe(),this.offsetScaleMatrix_=Pe(),this.tmpMat4_=Xt(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new pa({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new pa({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===ma(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=ce(e);let i=this.bufferCache_[r];if(!i){const s=t.createBuffer();i={buffer:e,webGlBuffer:s},this.bufferCache_[r]=i}t.bindBuffer(e.getType(),i.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=ce(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(En.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(En.RESTORED,this.boundHandleWebGLContextRestored_),im(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const i=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let c=this.postProcessPasses_.length-1;c>=0;c--)this.postProcessPasses_[c].init(e);i.bindTexture(i.TEXTURE_2D,null),i.clearColor(0,0,0,0),i.depthRange(0,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,t?i.ZERO:i.ONE_MINUS_SRC_ALPHA),r?(i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL)):i.disable(i.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const i=this.gl_;i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const i=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);i.enableVertexAttribArray(s),i.vertexAttribPointer(s,r,i.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,i){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,r?s.ZERO:s.ONE_MINUS_SRC_ALPHA),i?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const i=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,i,a)}finalizeDraw(e,t,r){for(let i=0,s=this.postProcessPasses_.length;i<s;i++)i===s-1?this.postProcessPasses_[i].apply(e,null,t,r):this.postProcessPasses_[i].apply(e,this.postProcessPasses_[i+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,i=e.pixelRatio;this.setUniformFloatValue(at.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(at.ZOOM,e.viewState.zoom),this.setUniformFloatValue(at.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(at.PIXEL_RATIO,i),this.setUniformFloatVec2(at.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(at.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(at.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(at.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,i=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=r):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,i,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&o&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),i++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,kn(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,i=r.createShader(t);return r.shaderSource(i,e),r.compileShader(i),i}getProgram(e,t){const r=this.gl_,i=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,i),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(i,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(i)}`;throw new Error(a)}if(r.deleteShader(i),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=ce(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=ce(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,i=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return bs(t,0,0,2/(s*r[0]),2/(s*r[1]),-i,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,i,s){const o=this.getAttributeLocation(e);o<0||(this.gl_.enableVertexAttribArray(o),this.gl_.vertexAttribPointer(o,t,r,!1,i,s))}enableAttributes(e){const t=om(e);let r=0;for(let i=0;i<e.length;i++){const s=e[i];this.enableAttributeArray_(s.name,s.size,s.type||Jl,t,r),r+=s.size*Ql(s.type)}}handleWebGLContextLost(e){Ah(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,i){const s=this.gl_;r=r||s.createTexture();const o=i?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,c=s.RGBA,l=0,u=s.RGBA,h=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,c,e[0],e[1],l,u,h,t):t?s.texImage2D(s.TEXTURE_2D,a,c,u,h,t):s.texImage2D(s.TEXTURE_2D,a,c,e[0],e[1],l,u,h,null),r}}function om(n){let e=0;for(let t=0;t<n.length;t++){const r=n[t];e+=r.size*Ql(r.type)}return e}function Ql(n){switch(n){case xe.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case xe.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case xe.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case xe.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}const rt=new Uint8Array(4);class ec{constructor(e,t){this.helper_=e;const r=e.getGL();this.texture_=r.createTexture(),this.framebuffer_=r.createFramebuffer(),this.depthbuffer_=r.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){Lh(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return rt[0]=0,rt[1]=0,rt[2]=0,rt[3]=0,rt;this.readAll();const r=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return rt[0]=this.data_[r*4],rt[1]=this.data_[r*4+1],rt[2]=this.data_[r*4+2],rt[3]=this.data_[r*4+3],rt}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function tc(){const n='const t="GENERATE_POLYGON_BUFFERS",e="GENERATE_POINT_BUFFERS",n="GENERATE_LINE_STRING_BUFFERS";function r(t,e,n=2){const r=e&&e.length,o=r?e[0]*n:t.length;let u=x(t,0,o,n,!0);const f=[];if(!u||u.next===u.prev)return f;let s,l,h;if(r&&(u=function(t,e,n,r){const o=[];for(let n=0,i=e.length;n<i;n++){const u=x(t,e[n]*r,n<i-1?e[n+1]*r:t.length,r,!1);u===u.next&&(u.steiner=!0),o.push(p(u))}o.sort(c);for(let t=0;t<o.length;t++)n=a(o[t],n);return n}(t,e,u,n)),t.length>80*n){s=1/0,l=1/0;let e=-1/0,r=-1/0;for(let x=n;x<o;x+=n){const n=t[x],o=t[x+1];n<s&&(s=n),o<l&&(l=o),n>e&&(e=n),o>r&&(r=o)}h=Math.max(e-s,r-l),h=0!==h?32767/h:0}return i(u,f,n,s,l,h,0),f}function x(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=I(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=I(x/r|0,t[x],t[x+1],o);return o&&m(o,o.next)&&(z(o),o=o.next),o}function o(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!m(r,r.next)&&0!==M(r.prev,r,r.next))r=r.next;else{if(z(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function i(t,e,n,r,x,c,a){if(!t)return;!a&&c&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=y(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,u=0;for(let t=0;t<n&&(u++,i=i.nextZ,i);t++);let f=n;for(;u>0||f>0&&i;)0!==u&&(0===f||!i||x.z<=i.z)?(r=x,x=x.nextZ,u--):(r=i,i=i.nextZ,f--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,r,x,c);let h=t;for(;t.prev!==t.next;){const y=t.prev,p=t.next;if(c?f(t,r,x,c):u(t))e.push(y.i,t.i,p.i),z(t),t=p.next,h=p.next;else if((t=p)===h){a?1===a?i(t=s(o(t),e),e,n,r,x,c,2):2===a&&l(t,e,n,r,x,c):i(o(t),e,n,r,x,c,1);break}}}function u(t){const e=t.prev,n=t,r=t.next;if(M(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,u=e.y,f=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(u,f,s),a=Math.max(x,o,i),h=Math.max(u,f,s);let y=r.next;for(;y!==e;){if(y.x>=l&&y.x<=a&&y.y>=c&&y.y<=h&&g(x,u,o,f,i,s,y.x,y.y)&&M(y.prev,y,y.next)>=0)return!1;y=y.next}return!0}function f(t,e,n,r){const x=t.prev,o=t,i=t.next;if(M(x,o,i)>=0)return!1;const u=x.x,f=o.x,s=i.x,l=x.y,c=o.y,a=i.y,h=Math.min(u,f,s),p=Math.min(l,c,a),v=Math.max(u,f,s),b=Math.max(l,c,a),m=y(h,p,e,n,r),Z=y(v,b,e,n,r);let d=t.prevZ,w=t.nextZ;for(;d&&d.z>=m&&w&&w.z<=Z;){if(d.x>=h&&d.x<=v&&d.y>=p&&d.y<=b&&d!==x&&d!==i&&g(u,l,f,c,s,a,d.x,d.y)&&M(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,w.x>=h&&w.x<=v&&w.y>=p&&w.y<=b&&w!==x&&w!==i&&g(u,l,f,c,s,a,w.x,w.y)&&M(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;d&&d.z>=m;){if(d.x>=h&&d.x<=v&&d.y>=p&&d.y<=b&&d!==x&&d!==i&&g(u,l,f,c,s,a,d.x,d.y)&&M(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;w&&w.z<=Z;){if(w.x>=h&&w.x<=v&&w.y>=p&&w.y<=b&&w!==x&&w!==i&&g(u,l,f,c,s,a,w.x,w.y)&&M(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function s(t,e){let n=t;do{const r=n.prev,x=n.next.next;!m(r,x)&&Z(r,n,n.next,x)&&A(r,x)&&A(x,r)&&(e.push(r.i,n.i,x.i),z(n),z(n.next),n=t=x),n=n.next}while(n!==t);return o(n)}function l(t,e,n,r,x,u){let f=t;do{let t=f.next.next;for(;t!==f.prev;){if(f.i!==t.i&&b(f,t)){let s=E(f,t);return f=o(f,f.next),s=o(s,s.next),i(f,e,n,r,x,u,0),void i(s,e,n,r,x,u,0)}t=t.next}f=f.next}while(f!==t)}function c(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function a(t,e){const n=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(m(t,n))return n;do{if(m(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const u=o,f=o.x,s=o.y;let l=1/0;n=o;do{if(r>=n.x&&n.x>=f&&r!==n.x&&v(x<s?r:i,x,f,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);A(n,t)&&(e<l||e===l&&(n.x>o.x||n.x===o.x&&h(o,n)))&&(o=n,l=e)}n=n.next}while(n!==u);return o}(t,e);if(!n)return e;const r=E(n,t);return o(r,r.next),o(n,n.next)}function h(t,e){return M(t.prev,t,e.prev)<0&&M(e.next,t,t.next)<0}function y(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function p(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function v(t,e,n,r,x,o,i,u){return(x-i)*(e-u)>=(t-i)*(o-u)&&(t-i)*(r-u)>=(n-i)*(e-u)&&(n-i)*(o-u)>=(x-i)*(r-u)}function g(t,e,n,r,x,o,i,u){return!(t===i&&e===u)&&v(t,e,n,r,x,o,i,u)}function b(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Z(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(A(t,e)&&A(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(M(t.prev,t,e.prev)||M(t,e.prev,e))||m(t,e)&&M(t.prev,t,t.next)>0&&M(e.prev,e,e.next)>0)}function M(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function m(t,e){return t.x===e.x&&t.y===e.y}function Z(t,e,n,r){const x=w(M(t,e,n)),o=w(M(t,e,r)),i=w(M(n,r,t)),u=w(M(n,r,e));return x!==o&&i!==u||(!(0!==x||!d(t,n,e))||(!(0!==o||!d(t,r,e))||(!(0!==i||!d(n,t,r))||!(0!==u||!d(n,e,r)))))}function d(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function w(t){return t>0?1:t<0?-1:0}function A(t,e){return M(t.prev,t,t.next)<0?M(t,e,t.next)>=0&&M(t,t.prev,e)>=0:M(t,e,t.prev)<0||M(t,t.next,e)<0}function E(t,e){const n=F(t.i,t.x,t.y),r=F(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function I(t,e,n,r){const x=F(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function z(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function F(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function P(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function B(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],u=e[3],f=e[4],s=e[5];return t[0]=u/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-u*f)/n,t[5]=-(x*s-o*f)/n,t}new Array(6);const N=[],R={vertexPosition:0,indexPosition:0};function S(t,e,n,r,x){t[e+0]=n,t[e+1]=r,t[e+2]=x}function T(t,e,n,r,x,o){const i=3+x,u=t[e+0],f=t[e+1],s=N;s.length=x;for(let n=0;n<s.length;n++)s[n]=t[e+2+n];let l=o?o.vertexPosition:0,c=o?o.indexPosition:0;const a=l/i;return S(n,l,u,f,0),s.length&&n.set(s,l+3),l+=i,S(n,l,u,f,1),s.length&&n.set(s,l+3),l+=i,S(n,l,u,f,2),s.length&&n.set(s,l+3),l+=i,S(n,l,u,f,3),s.length&&n.set(s,l+3),l+=i,r[c++]=a,r[c++]=a+1,r[c++]=a+3,r[c++]=a+1,r[c++]=a+2,r[c++]=a+3,R.vertexPosition=l,R.indexPosition=c,R}function _(t,e,n,r,x,o,i,u,f,s,l){const c=10+u.length,a=o.length/c,h=[t[e+0],t[e+1]],y=[t[n],t[n+1]],p=t[e+2],v=t[n+2],g=P(f,[...h]),b=P(f,[...y]);function M(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),u=[(n[0]-t[0])/i,(n[1]-t[1])/i],f=0===r||0===i?0:Math.acos((s=u[0]*x[0]+u[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;return u[0]*o[0]+u[1]*o[1]>0?f:2*Math.PI-f}let m=-1,Z=-1,d=l;const w=null!==x;if(null!==r){m=M(g,b,P(f,[...[t[r],t[r+1]]])),Math.cos(m)<=.985&&(d+=Math.tan((m-Math.PI)/2))}if(w){Z=M(b,g,P(f,[...[t[x],t[x+1]]])),Math.cos(Z)<=.985&&(d+=Math.tan((Math.PI-Z)/2))}function A(t,e){return 0===e?1e4*t:Math.sign(e)*(1e4*t+Math.abs(e))}return o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(0,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(1,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(2,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(3,l)),o.push(...u),i.push(a,a+1,a+2,a+1,a+3,a+2),{length:s+Math.sqrt((b[0]-g[0])*(b[0]-g[0])+(b[1]-g[1])*(b[1]-g[1])),angle:d}}function O(t,e,n,x,o){const i=2+o;let u=e;const f=t.slice(u,u+o);u+=o;const s=t[u++];let l=0;const c=new Array(s-1);for(let e=0;e<s;e++)l+=t[u++],e<s-1&&(c[e]=l);const a=t.slice(u,u+2*l),h=r(a,c,2);for(let t=0;t<h.length;t++)x.push(h[t]+n.length/i);for(let t=0;t<a.length;t+=2)n.push(a[t],a[t+1],...f);return u+2*l}const U=self;U.onmessage=r=>{const x=r.data;switch(x.type){case e:{const t=3,e=2,n=x.customAttributesSize,r=e+n,o=new Float32Array(x.renderInstructions),i=o.length/r,u=4*i*(n+t),f=new Uint32Array(6*i),s=new Float32Array(u);let l;for(let t=0;t<o.length;t+=r)l=T(o,t,s,f,n,l);const c=Object.assign({vertexBuffer:s.buffer,indexBuffer:f.buffer,renderInstructions:o.buffer},x);U.postMessage(c,[s.buffer,f.buffer,o.buffer]);break}case n:{const t=[],e=[],n=x.customAttributesSize,r=3,o=new Float32Array(x.renderInstructions);let i=0;const u=[1,0,0,1,0,0];let f,s;for(B(u,x.renderInstructionsTransform);i<o.length;){s=Array.from(o.slice(i,i+n)),i+=n,f=o[i++];const x=i,l=i+(f-1)*r,c=o[x]===o[l]&&o[x+1]===o[l+1];let a=0,h=0;for(let n=0;n<f-1;n++){let y=null;n>0?y=i+(n-1)*r:c&&(y=l-r);let p=null;n<f-2?p=i+(n+2)*r:c&&(p=x+r);const v=_(o,i+n*r,i+(n+1)*r,y,p,t,e,s,u,a,h);a=v.length,h=v.angle}i+=f*r}const l=Uint32Array.from(e),c=Float32Array.from(t),a=Object.assign({vertexBuffer:c.buffer,indexBuffer:l.buffer,renderInstructions:o.buffer},x);U.postMessage(a,[c.buffer,l.buffer,o.buffer]);break}case t:{const t=[],e=[],n=x.customAttributesSize,r=new Float32Array(x.renderInstructions);let o=0;for(;o<r.length;)o=O(r,o,t,e,n);const i=Uint32Array.from(e),u=Float32Array.from(t),f=Object.assign({vertexBuffer:u.buffer,indexBuffer:i.buffer,renderInstructions:r.buffer},x);U.postMessage(f,[u.buffer,i.buffer,r.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(n,"binary").toString("base64"):URL.createObjectURL(new Blob([n],{type:"application/javascript"})))}class on extends Su{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=Pe(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener($i.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(Dt.PRECOMPOSE)){const i=new pi(Dt.PRECOMPOSE,void 0,t,e);r.dispatchEvent(i)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(Dt.POSTCOMPOSE)){const i=new pi(Dt.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(i)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,i;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const c=e.layerStatesArray[o].layer,l=c.getRenderer();if(!(l instanceof on)){t=!0;continue}const u=c.getClassName();if((t||u!==i)&&(r+=1,t=!1),i=u,l===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new sm({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),i&&(this.helper.getCanvas().className=i),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener($i.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const i=this.getLayer();if(i.hasListener(e)){bs(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new pi(e,this.inversePixelTransform_,r,t);i.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(Dt.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(Dt.POSTRENDER,e,t)}}function rc(n,e){const t=n.viewState.projection,i=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=n.extent,a=i?Ae(s):null,c=i?Math.ceil((o[2]-s[2])/a)+1:1;return[i?Math.floor((o[0]-s[0])/a):0,c,a]}class nc extends on{constructor(e,t){const r=t.uniforms||{},i=Pe();r[at.PROJECTION_MATRIX]=i,super(e,{uniforms:r,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new ur(nn,zn),this.indicesBuffer_=new ur(sn,zn),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:xe.FLOAT}}):[];this.attributes=[{name:"a_position",size:2,type:xe.FLOAT},{name:"a_index",size:1,type:xe.FLOAT}],this.hitDetectionEnabled_&&(this.attributes.push({name:"a_hitColor",size:4,type:xe.FLOAT}),this.attributes.push({name:"a_featureUid",size:1,type:xe.FLOAT})),this.attributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=en(),this.currentTransform_=i,this.renderTransform_=Pe(),this.invertRenderTransform_=Pe(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=tc(),this.worker_.addEventListener("message",a=>{const c=a.data;if(c.type===Or.GENERATE_POINT_BUFFERS){const l=c.projectionTransform;this.verticesBuffer_.fromArrayBuffer(c.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.fromArrayBuffer(c.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=l,Xr(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),c.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[gt(o,Rt.ADDFEATURE,this.handleSourceFeatureAdded_,this),gt(o,Rt.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),gt(o,Rt.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),gt(o,Rt.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const c=a.getGeometry();c&&c.getType()==="Point"&&(this.featureCache_[ce(a)]={feature:a,properties:a.getProperties(),flatCoordinates:c.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new ec(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,r=t.getGeometry();r&&r.getType()==="Point"&&(this.featureCache_[ce(t)]={feature:t,properties:t.getProperties(),flatCoordinates:r.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,r=ce(t),i=this.featureCache_[r],s=t.getGeometry();i?s&&s.getType()==="Point"?(i.properties=t.getProperties(),i.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[r],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[r]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,r=ce(t);r in this.featureCache_&&(delete this.featureCache_[r],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,i,s]=rc(e,this.getLayer());return this.renderWorlds(e,!1,r,i,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,i,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),r=t.getSource(),i=e.viewState,s=!e.viewHints[At.ANIMATING]&&!e.viewHints[At.INTERACTING],o=!Hr(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const c=i.projection,l=i.resolution,u=t instanceof ei?t.getRenderBuffer():0,h=Ps(e.extent,u*l);r.loadFeatures(h,l,c),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0}rebuildBuffers_(e){const t=Pe();this.helper.makeProjectionTransform(e,t);const i=(this.hitDetectionEnabled_?7:2)+this.customAttributes.length,s=i*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const c=[];let l=-1;e.viewState.projection;for(const h in this.featureCache_){const f=this.featureCache_[h];if(a[0]=f.flatCoordinates[0],a[1]=f.flatCoordinates[1],yt(t,a),o[++l]=a[0],o[++l]=a[1],this.hitDetectionEnabled_){const d=ql(l+5,c);o[++l]=d[0],o[++l]=d[1],o[++l]=d[2],o[++l]=d[3],o[++l]=Number(h)}for(let d=0;d<this.customAttributes.length;d++){const g=this.customAttributes[d].callback(f.feature,f.properties);o[++l]=g}}const u={id:++this.lastSentId,type:Or.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:i-2};u.projectionTransform=t,this.ready=!1,this.worker_.postMessage(u,[o.buffer])}forEachFeatureAtCoordinate(e,t,r,i,s){if(We(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=yt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),c=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],l=Kl(c),u=this.renderInstructions_[l],h=Math.floor(u).toString(),d=this.getLayer().getSource().getFeatureByUid(h);if(d)return i(d,this.getLayer(),null)}renderWorlds(e,t,r,i,s){let o=r;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0)),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes);do{this.helper.makeProjectionTransform(e,this.currentTransform_),Ts(this.currentTransform_,o*s,0),Vr(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const a=this.indicesBuffer_.getSize();this.helper.drawElements(0,a)}while(++o<i)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){Un(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class am extends Ih{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(De.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===Y.LOADED,this.loaded)this.uploadTile();else{if(e instanceof us){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(De.CHANGE,this.handleTileChange_)}}uploadTile(){Rs()}setReady(){this.ready=!0,this.dispatchEvent(De.CHANGE)}handleTileChange_(){this.tile.getState()===Y.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(De.CHANGE,this.handleTileChange_)}}function ic(n,e,t){const r=t?n.LINEAR:n.NEAREST;n.bindTexture(n.TEXTURE_2D,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,r)}function lm(n,e,t,r){ic(n,e,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t)}function ya(n,e,t,r,i,s){const o=n.getGL();let a,c;t instanceof Float32Array?(a=o.FLOAT,n.getExtension("OES_texture_float"),c=n.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,c=!0),ic(o,e,s&&c);const l=t.byteLength/r[1];let u=1;l%8===0?u=8:l%4===0?u=4:l%2===0&&(u=2);let h;switch(i){case 1:{h=o.LUMINANCE;break}case 2:{h=o.LUMINANCE_ALPHA;break}case 3:{h=o.RGB;break}case 4:{h=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${i}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,u),o.texImage2D(o.TEXTURE_2D,0,h,r[0],r[1],0,h,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let tr=null;function cm(){tr=Lt(1,1,void 0,{willReadFrequently:!0})}class um extends am{constructor(e){super(e),this.textures=[],this.renderSize_=Qe(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new ur(nn,ks);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var r;const t=(r=this.helper)==null?void 0:r.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let i=0;i<this.textures.length;++i)t.deleteTexture(this.textures[i])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let i;r instanceof us||r instanceof Ru?i=r.getImage():i=r.getData();const s=Ui(i);if(s){const _=t.createTexture();this.textures.push(_),this.bandCount=4,lm(t,_,s,r.interpolate),this.setReady();return}i=Di(i);const o=r.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],c=i instanceof Float32Array,l=a[0]*a[1],u=c?Float32Array:Uint8Array,h=u.BYTES_PER_ELEMENT,f=i.byteLength/a[1];this.bandCount=Math.floor(f/h/a[0]);const d=Math.ceil(this.bandCount/4);if(d===1){const _=t.createTexture();this.textures.push(_),ya(e,_,i,a,this.bandCount,r.interpolate),this.setReady();return}const g=new Array(d);for(let _=0;_<d;++_){const E=t.createTexture();this.textures.push(E);const w=_<d-1?4:(this.bandCount-1)%4+1;g[_]=new u(l*w)}let p=0,m=0;const y=a[0]*this.bandCount;for(let _=0;_<a[1];++_){for(let E=0;E<y;++E){const w=i[m+E],S=Math.floor(p/this.bandCount),T=E%this.bandCount,v=Math.floor(T/4),L=g[v],P=L.length/l,R=T%4;L[S*P+R]=w,++p}m+=f/h}for(let _=0;_<d;++_){const E=this.textures[_],w=g[_],S=w.length/l;ya(e,E,w,a,S,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const i=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];tr||cm(),tr.clearRect(0,0,1,1);const a=e.width,c=e.height,l=a-2*i,u=c-2*i,h=i+Math.floor(l*(t/s)),f=i+Math.floor(u*(r/o));let d;try{tr.drawImage(e,h,f,1,1,0,0,1,1),d=tr.getImageData(0,0,1,1).data}catch{return tr=null,null}return d}getArrayPixelData_(e,t,r,i){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],c=t[0],l=t[1],u=c+2*s,h=l+2*s,f=s+Math.floor(c*(r/o)),d=s+Math.floor(l*(i/a));if(e instanceof DataView){const p=e.byteLength/(u*h),m=p*(d*u+f),y=e.buffer.slice(m,m+p);return new DataView(y)}const g=this.bandCount*(d*u+f);return e.slice(g,g+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof hs){const r=this.tile.getData(),i=Di(r);if(i){const s=this.tile.getSize();return this.getArrayPixelData_(i,s,e,t)}return this.getImagePixelData_(Ui(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}const hm={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function Ea(n){return 1/(n+2)}function fm(){return{tileIds:new Set,representationsByZ:{}}}function xa(n,e){return n.tileIds.has(ce(e))}function ba(n,e,t){const r=n.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),n.tileIds.add(ce(e.tile))}function bi(n,e){const t=n.layerStatesArray[n.layerIndex];t.extent&&(e=Je(e,pl(t.extent,n.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const i=r.getTileGridForProjection(n.viewState.projection).getExtent();i&&(e=Je(e,i))}return e}function Zi(n,e){return`${n.getKey()},${n.getRevision()},${er(e)}`}class dm extends on{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=Pe(),this.tempMat4=Xt(),this.tempTileRange_=new vu(0,0,0,0),this.tempTileCoord_=Bi(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new il(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||Ss(bi(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return Rs()}enqueueTiles(e,t,r,i,s){const o=e.viewState,a=this.getLayer(),c=a.getRenderSource(),l=c.getTileGridForProjection(o.projection),u=c.getGutterForProjection(o.projection),h=ce(c);h in e.wantedTiles||(e.wantedTiles[h]={});const f=e.wantedTiles[h],d=this.tileRepresentationCache,g=a.getMapInternal(),p=Math.max(r-s,l.getMinZoom(),l.getZForResolution(Math.min(a.getMaxResolution(),g?g.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):l.getResolution(0)),c.zDirection)),m=o.rotation,y=m?Ch(o.center,o.resolution,m,e.size):void 0;for(let _=r;_>=p;--_){const E=l.getTileRangeForExtentAndZ(t,_,this.tempTileRange_),w=l.getResolution(_);for(let S=E.minX;S<=E.maxX;++S)for(let T=E.minY;T<=E.maxY;++T){if(m&&!l.tileCoordIntersectsViewport([_,S,T],y))continue;const v=Bi(_,S,T,this.tempTileCoord_),L=Zi(c,v);let P,R;if(d.containsKey(L)&&(P=d.get(L),R=P.tile),(!P||P.tile.key!==c.getKey())&&(R=c.getTile(_,S,T,e.pixelRatio,o.projection),!R)||xa(i,R))continue;P?P.setTile(R):(P=this.createTileRepresentation({tile:R,grid:l,helper:this.helper,gutter:u}),d.set(L,P)),ba(i,P,_);const N=R.getKey();f[N]=!0,R.getState()===Y.IDLE&&(e.tileQueue.isKeyQueued(N)||e.tileQueue.enqueue([R,h,l.getTileCoordCenter(v),w]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,i,s,o,a,c,l,u,h){}renderTileMask(e,t,r,i){}drawTile_(e,t,r,i,s,o,a){if(!t.ready)return;const l=t.tile.tileCoord,u=er(l),h=u in o?o[u]:1,f=a.getResolution(r),d=Qe(a.getTileSize(r),this.tempSize_),g=a.getOrigin(r),p=a.getTileCoordExtent(l),m=h<1?-1:Ea(r);h<1&&(e.animate=!0);const y=e.viewState,_=y.center[0],E=y.center[1],w=d[0]+2*i,S=d[1]+2*i,T=w/S,v=(_-g[0])/(d[0]*f),L=(g[1]-E)/(d[1]*f),P=y.resolution/f,R=l[1],N=l[2];gh(this.tileTransform_),Ao(this.tileTransform_,2/(e.size[0]*P/w),-2/(e.size[1]*P/w)),ph(this.tileTransform_,y.rotation),Ao(this.tileTransform_,1,1/T),Ts(this.tileTransform_,(d[0]*(R-v)-i)/w,(d[1]*(N-L)-i)/S),this.renderTile(t,this.tileTransform_,e,s,f,d,g,p,m,i,h)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,i=this.getLayer(),s=i.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),c=bi(e,e.extent),l=o.getZForResolution(r.resolution,s.zDirection),u=fm(),h=i.getPreload();if(e.nextExtent){const E=o.getZForResolution(r.nextResolution,s.zDirection),w=bi(e,e.nextExtent);this.enqueueTiles(e,w,E,u,h)}this.enqueueTiles(e,c,l,u,0),h>0&&setTimeout(()=>{this.enqueueTiles(e,c,l-1,u,h-1)},0);const f={};let d=!1;const g=u.representationsByZ;if(l in g){const E=ce(this),w=e.time;for(const S of g[l]){const T=S.tile;if(T.getState()===Y.EMPTY)continue;const v=T.tileCoord;if(S.ready){const R=T.getAlpha(E,w);if(R===1){T.endTransition(E);continue}d=!0;const N=er(v);f[N]=R}if(this.renderComplete=!1,this.findAltTiles_(o,v,l+1,u))continue;const P=o.getMinZoom();for(let R=l-1;R>=P&&!this.findAltTiles_(o,v,R,u);--R);}}const p=Object.keys(g).map(Number).sort(Fh);if(this.beforeTilesMaskRender(e))for(let E=0,w=p.length;E<w;++E){const S=p[E];for(const T of g[S]){const v=T.tile.tileCoord;if(er(v)in f)continue;const P=o.getTileCoordExtent(v);this.renderTileMask(T,S,P,Ea(S))}}this.beforeTilesRender(e,d);for(let E=0,w=p.length;E<w;++E){const S=p[E];for(const T of g[S]){const v=T.tile.tileCoord;er(v)in f||this.drawTile_(e,T,S,a,c,f,o)}}if(l in g)for(const E of g[l]){const w=E.tile.tileCoord;er(w)in f&&this.drawTile_(e,E,l,a,c,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const y=this.helper.getCanvas(),_=this.tileRepresentationCache;for(;_.canExpireCache();)_.pop().dispose();return this.postRender(t,e),y}beforeFinalize(e){}findAltTiles_(e,t,r,i){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,c=this.getLayer().getRenderSource();for(let l=s.minX;l<=s.maxX;++l)for(let u=s.minY;u<=s.maxY;++u){const h=Zi(c,[r,l,u]);let f=!1;if(a.containsKey(h)){const d=a.get(h);d.ready&&!xa(i,d.tile)&&(ba(i,d,r),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const V={...hm,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},vn={TEXTURE_COORD:"a_textureCoord"},gm=[{name:vn.TEXTURE_COORD,size:2,type:xe.FLOAT}];class pm extends dm{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new ur(sn,ks),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new um(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,i,s,o,a,c,l,u,h){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(gm);let d=0;for(;d<e.textures.length;){const T=`${V.TILE_TEXTURE_ARRAY}[${d}]`;this.helper.bindTexture(e.textures[d],d,T),++d}for(let T=0;T<this.paletteTextures_.length;++T){const v=this.paletteTextures_[T],L=v.getTexture(f);this.helper.bindTexture(L,d,v.name),++d}const g=r.viewState,p=o[0]+2*u,m=o[1]+2*u,_=e.tile.tileCoord,E=_[1],w=_[2];this.helper.setUniformMatrixValue(V.TILE_TRANSFORM,kn(this.tempMat4,t)),this.helper.setUniformFloatValue(V.TRANSITION_ALPHA,h),this.helper.setUniformFloatValue(V.DEPTH,l);let S=i;u>0&&(S=c,Je(S,i,S)),this.helper.setUniformFloatVec4(V.RENDER_EXTENT,S),this.helper.setUniformFloatValue(V.RESOLUTION,g.resolution),this.helper.setUniformFloatValue(V.ZOOM,g.zoom),this.helper.setUniformFloatValue(V.TEXTURE_PIXEL_WIDTH,p),this.helper.setUniformFloatValue(V.TEXTURE_PIXEL_HEIGHT,m),this.helper.setUniformFloatValue(V.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(V.TEXTURE_ORIGIN_X,a[0]+E*o[0]*s-u*s),this.helper.setUniformFloatValue(V.TEXTURE_ORIGIN_Y,a[1]-w*o[1]*s+u*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const i=this.getLayer(),s=yt(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=i.getExtent();if(a&&!nr(pl(a,o.projection),s))return null;const c=i.getSources(vs([s]),o.resolution);let l,u,h;for(l=c.length-1;l>=0;--l)if(u=c[l],u.getState()==="ready"){if(h=u.getTileGridForProjection(o.projection),u.getWrapX())break;const d=h.getExtent();if(!d||nr(d,s))break}if(l<0)return null;const f=this.tileRepresentationCache;for(let d=h.getZForResolution(o.resolution);d>=h.getMinZoom();--d){const g=h.getTileCoordForCoordAndZ(s,d),p=Zi(u,g);if(!f.containsKey(p))continue;const m=f.get(p);if(m.tile.getState()===Y.EMPTY)return null;if(!m.loaded)continue;const _=h.getOrigin(d),E=Qe(h.getTileSize(d)),w=h.getResolution(d),S=(s[0]-_[0])/w-g[1]*E[0],T=(_[1]-s[1])/w-g[2]*E[1];return m.getPixelData(S,T)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class mm{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function _m(n,e){return`operator_${n}_${Object.keys(e.functions).length}`}function kt(n){const e=n.toString();return e.includes(".")?e:e+".0"}function $s(n){if(n.length<2||n.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${n.length}(${n.map(kt).join(", ")})`}function Pn(n){const e=zr(n),t=e.length>3?e[3]:1;return $s([e[0]/255,e[1]/255,e[2]/255,t])}function ym(n){const e=Qe(n);return $s(e)}const Ti={};let Em=0;function ir(n){return n in Ti||(Ti[n]=Em++),Ti[n]}function dt(n){return kt(ir(n))}function Vs(n){return"u_var_"+n}function Yi(){return{inFragmentShader:!1,variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const wi="getBandValue",sc="u_paletteTextures",oc="featureId",ac="geometryType";function xm(n,e,t,r){const i=Pu(n,e,t);return js(i,e,r)}function re(n){return(e,t,r)=>{const i=t.args.length,s=new Array(i);for(let o=0;o<i;++o)s[o]=js(t.args[o],r,e);return n(s,e)}}const bm={[X.Get]:(n,e)=>{const r=e.args[0].value;return r in n.properties||(n.properties[r]={name:r,type:e.type}),(n.inFragmentShader?"v_prop_":"a_prop_")+r},[X.Id]:n=>(n.featureId=!0,(n.inFragmentShader?"v_":"a_")+oc),[X.GeometryType]:n=>(n.geometryType=!0,(n.inFragmentShader?"v_":"a_")+ac),[X.LineMetric]:()=>"currentLineMetric",[X.Var]:(n,e)=>{const r=e.args[0].value;return r in n.variables||(n.variables[r]={name:r,type:e.type}),Vs(r)},[X.Resolution]:()=>"u_resolution",[X.Zoom]:()=>"u_zoom",[X.Time]:()=>"u_time",[X.Any]:re(n=>`(${n.join(" || ")})`),[X.All]:re(n=>`(${n.join(" && ")})`),[X.Not]:re(([n])=>`(!${n})`),[X.Equal]:re(([n,e])=>`(${n} == ${e})`),[X.NotEqual]:re(([n,e])=>`(${n} != ${e})`),[X.GreaterThan]:re(([n,e])=>`(${n} > ${e})`),[X.GreaterThanOrEqualTo]:re(([n,e])=>`(${n} >= ${e})`),[X.LessThan]:re(([n,e])=>`(${n} < ${e})`),[X.LessThanOrEqualTo]:re(([n,e])=>`(${n} <= ${e})`),[X.Multiply]:re(n=>`(${n.join(" * ")})`),[X.Divide]:re(([n,e])=>`(${n} / ${e})`),[X.Add]:re(n=>`(${n.join(" + ")})`),[X.Subtract]:re(([n,e])=>`(${n} - ${e})`),[X.Clamp]:re(([n,e,t])=>`clamp(${n}, ${e}, ${t})`),[X.Mod]:re(([n,e])=>`mod(${n}, ${e})`),[X.Pow]:re(([n,e])=>`pow(${n}, ${e})`),[X.Abs]:re(([n])=>`abs(${n})`),[X.Floor]:re(([n])=>`floor(${n})`),[X.Ceil]:re(([n])=>`ceil(${n})`),[X.Round]:re(([n])=>`floor(${n} + 0.5)`),[X.Sin]:re(([n])=>`sin(${n})`),[X.Cos]:re(([n])=>`cos(${n})`),[X.Atan]:re(([n,e])=>e!==void 0?`atan(${n}, ${e})`:`atan(${n})`),[X.Sqrt]:re(([n])=>`sqrt(${n})`),[X.Match]:re(n=>{const e=n[0],t=n[n.length-1];let r=null;for(let i=n.length-3;i>=1;i-=2){const s=n[i],o=n[i+1];r=`(${e} == ${s} ? ${o} : ${r||t})`}return r}),[X.Between]:re(([n,e,t])=>`(${n} >= ${e} && ${n} <= ${t})`),[X.Interpolate]:re(([n,e,...t])=>{let r="";for(let i=0;i<t.length-2;i+=2){const s=t[i],o=r||t[i+1],a=t[i+2],c=t[i+3];let l;n===kt(1)?l=`(${e} - ${s}) / (${a} - ${s})`:l=`(pow(${n}, (${e} - ${s})) - 1.0) / (pow(${n}, (${a} - ${s})) - 1.0)`,r=`mix(${o}, ${c}, clamp(${l}, 0.0, 1.0))`}return r}),[X.Case]:re(n=>{const e=n[n.length-1];let t=null;for(let r=n.length-3;r>=0;r-=2){const i=n[r],s=n[r+1];t=`(${i} ? ${s} : ${t||e})`}return t}),[X.In]:re(([n,...e],t)=>{const r=_m("in",t),i=[];for(let s=0;s<e.length;s+=1)i.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${i.join(`
`)}
  return false;
}`,`${r}(${n})`}),[X.Array]:re(n=>`vec${n.length}(${n.join(", ")})`),[X.Color]:re(n=>{if(n.length===1)return`vec4(vec3(${n[0]} / 255.0), 1.0)`;if(n.length===2)return`vec4(vec3(${n[0]} / 255.0), ${n[1]})`;const e=n.slice(0,3).map(r=>`${r} / 255.0`);if(n.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=n[3];return`vec4(${e.join(", ")}, ${t})`}),[X.Band]:re(([n,e,t],r)=>{if(!(wi in r.functions)){let i="";const s=r.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let c=o%4;o===s-1&&c===1&&(c=3);const l=`${V.TILE_TEXTURE_ARRAY}[${a}]`;i+=`  if (band == ${o+1}.0) {
    return texture2D(${l}, v_textureCoord + vec2(dx, dy))[${c}];
  }
`}r.functions[wi]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${V.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${V.TEXTURE_PIXEL_HEIGHT};
${i}
}`}return`${wi}(${n}, ${e??"0.0"}, ${t??"0.0"})`}),[X.Palette]:(n,e)=>{const[t,...r]=e.args,i=r.length,s=new Uint8Array(i*4);for(let l=0;l<r.length;l++){const u=r[l].value,h=zr(u),f=l*4;s[f]=h[0],s[f+1]=h[1],s[f+2]=h[2],s[f+3]=h[3]*255}n.paletteTextures||(n.paletteTextures=[]);const o=`${sc}[${n.paletteTextures.length}]`,a=new mm(o,s);n.paletteTextures.push(a);const c=js(t,ue,n);return`texture2D(${o}, vec2((${c} + 0.5) / ${i}.0, 0.5))`}};function js(n,e,t){if(n instanceof Au){const r=bm[n.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(n.operator)}`);return r(t,n,e)}if((n.type&ue)>0)return kt(n.value);if((n.type&fs)>0)return n.value.toString();if((n.type&kr)>0)return dt(n.value.toString());if((n.type&Ge)>0)return Pn(n.value);if((n.type&It)>0)return $s(n.value);if((n.type&pr)>0)return ym(n.value);throw new Error(`Unexpected expression ${n.value} (expected type ${Lu(e)})`)}function Tm(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const Yt=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders
`,qt=Tm();class lc{constructor(){this.uniforms_=[],this.attributes_=[],this.varyings_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${kt(qt["circle-radius"])} + ${kt(qt["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=Pn(qt["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=kt(qt["stroke-width"]),this.strokeColorExpression_=Pn(qt["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=dt("round"),this.strokeJoinExpression_=dt("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.hasFill_=!1,this.fillColorExpression_=Pn(qt["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e){return this.uniforms_.push(e),this}addAttribute(e){return this.attributes_.push(e),this}addVarying(e,t,r){return this.varyings_.push({name:e,type:t,expression:r}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){this.vertexShaderFunctions_.includes(e)||this.vertexShaderFunctions_.push(e)}addFragmentShaderFunction(e){this.fragmentShaderFunctions_.includes(e)||this.fragmentShaderFunctions_.push(e)}getSymbolVertexShader(){return this.hasSymbol_?`${Yt}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
attribute vec2 a_position;
attribute float a_index;
attribute vec4 a_hitColor;
${this.attributes_.map(function(e){return"attribute "+e+";"}).join(`
`)}
varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx;
  if (a_index == 0.0) {
    offsetPx -= halfSizePx;
  } else if (a_index == 1.0) {
    offsetPx += halfSizePx * vec2(1., -1.);
  } else if (a_index == 2.0) {
    offsetPx += halfSizePx;
  } else {
    offsetPx += halfSizePx * vec2(-1., 1.);
  }
  float angle = ${this.symbolRotationExpression_};
  ${this.symbolRotateWithView_?"angle += u_rotation;":""}
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = a_index == 0.0 || a_index == 3.0 ? texCoord.s : texCoord.p;
  float v = a_index == 2.0 || a_index == 3.0 ? texCoord.t : texCoord.q;
  v_texCoord = vec2(u, v);
  v_hitColor = a_hitColor;
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y); 
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.varyings_.map(function(e){return"  "+e.name+" = "+e.expression+";"}).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${Yt}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${Yt}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_parameters;
attribute float a_distance;
attribute vec2 a_joinAngles;
attribute vec4 a_hitColor;
${this.attributes_.map(function(e){return"attribute "+e+";"}).join(`
`)}
varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float vertexNumber = floor(abs(a_parameters) / 10000. + 0.5);
  currentLineMetric = vertexNumber < 1.5 ? a_measureStart : a_measureEnd;
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)
  float angleTangentSum = fract(abs(a_parameters) / 10000.) * 10000. * sign(a_parameters);

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);
  
  // compute current vertex position
  float normalDir = vertexNumber < 0.5 || (vertexNumber > 1.5 && vertexNumber < 2.5) ? 1.0 : -1.0;
  float tangentDir = vertexNumber < 1.5 ? 1.0 : -1.0;
  float angle = vertexNumber < 1.5 ? v_angleStart : v_angleEnd;
  vec2 joinDirection;
  vec2 positionPx = vertexNumber < 1.5 ? segmentStartPx : segmentEndPx;
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${fa} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStart = segmentStartPx;
  v_segmentEnd = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = a_hitColor;
  v_distanceOffsetPx = a_distance / u_resolution - (lineOffsetPx * angleTangentSum);
  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.varyings_.map(function(e){return"  "+e.name+" = "+e.expression+";"}).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${Yt}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${fa}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${dt("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${dt("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${dt("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${dt("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

void main(void) {
  vec2 currentPoint = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPoint);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLength = length(v_segmentEnd - v_segmentStart);
  vec2 segmentTangent = (v_segmentEnd - v_segmentStart) / segmentLength;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPoint = currentPoint - v_segmentStart;
  float lengthToPoint = max(0., min(dot(segmentTangent, startToPoint), segmentLength));
  float currentLengthPx = lengthToPoint + v_distanceOffsetPx; 
  float currentRadiusPx = abs(dot(segmentNormal, startToPoint));
  float currentRadiusRatio = dot(segmentNormal, startToPoint) * 2. / v_width;
  currentLineMetric = mix(v_measureStart, v_measureEnd, lengthToPoint / segmentLength);

  if (${this.discardExpression_}) { discard; }

  vec4 color = ${this.strokeColorExpression_};
  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPoint, v_segmentStart, v_segmentEnd, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPoint, v_segmentEnd, v_segmentStart, v_width, v_angleEnd, capType, joinType);
  float distance = max(
    segmentDistanceField(currentPoint, v_segmentStart, v_segmentEnd, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distance = max(distance, ${this.strokeDistanceFieldExpression_});
  color.a *= smoothstep(0.5, -0.5, distance);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${Yt}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
attribute vec2 a_position;
attribute vec4 a_hitColor;
${this.attributes_.map(function(e){return"attribute "+e+";"}).join(`
`)}
varying vec4 v_hitColor;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = a_hitColor;
${this.varyings_.map(function(e){return"  "+e.name+" = "+e.expression+";"}).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${Yt}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
varying vec4 v_hitColor;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}const He={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},wm=["#00f","#0ff","#0f0","#ff0","#f00"];class Sm extends ei{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.gradient_=null,this.addChangeListener(He.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:wm),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const r=e.weight?e.weight:"weight";this.weightFunction_=typeof r=="string"?i=>i.get(r):r,this.setRenderOrder(null)}getBlur(){return this.get(He.BLUR)}getGradient(){return this.get(He.GRADIENT)}getRadius(){return this.get(He.RADIUS)}handleGradientChanged_(){this.gradient_=Rm(this.getGradient())}setBlur(e){this.set(He.BLUR,e)}setGradient(e){this.set(He.GRADIENT,e)}setRadius(e){this.set(He.RADIUS,e)}createRenderer(){const e=new lc().addAttribute("float a_weight").addVarying("v_weight","float","a_weight").addUniform("float u_size").addUniform("float u_blurSlope").setSymbolSizeExpression("vec2(u_size)").setSymbolColorExpression("vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * u_blurSlope) * v_weight)");return new nc(this,{className:this.getClassName(),attributes:[{name:"weight",callback:t=>{const r=this.weightFunction_(t);return r!==void 0?me(r,0,1):1}}],uniforms:{u_size:()=>(this.get(He.RADIUS)+this.get(He.BLUR))*2,u_blurSlope:()=>this.get(He.RADIUS)/Math.max(1,this.get(He.BLUR))},hitDetectionEnabled:!0,vertexShader:e.getSymbolVertexShader(),fragmentShader:e.getSymbolFragmentShader(),postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}renderDeclutter(){}}function Rm(n){const r=Lt(1,256),i=r.createLinearGradient(0,0,1,256),s=1/(n.length-1);for(let o=0,a=n.length;o<a;++o)i.addColorStop(o*s,n[o]);return r.fillStyle=i,r.fillRect(0,0,1,256),r.canvas}class vm extends Iu{constructor(e){super(e),this.vectorRenderer_=new Cu(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=Pe(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=yt(this.coordinateToVectorPixelTransform_,yt(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){const t=e.pixelRatio,r=e.viewState,i=r.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),xl(a,this.layerImageRatio_));const c=Ae(a)/i,l=et(a)/i;if(!s[At.ANIMATING]&&!s[At.INTERACTING]&&!Ss(a)){o.useContainer(null,null);const u=o.context,h=e.layerStatesArray[e.layerIndex],f=Object.assign({},h,{opacity:1}),d=Object.assign({},e,{extent:a,size:[c,l],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[f],layerIndex:0,declutter:null}),g=this.getLayer().getDeclutter();g&&(d.declutter={[g]:new Fu(9)});let p=!0;const m=new As(a,i,t,u.canvas,function(y){o.prepareFrame(d)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(d,null)&&(o.renderDeclutter(d),o.renderDeferred(d),p=!1),y())});m.addEventListener(De.CHANGE,()=>{if(m.getState()!==Ut.LOADED)return;this.image=p?null:m;const y=m.getPixelRatio(),_=Ou(m.getResolution())*t/y;this.renderedResolution=_,this.coordinateToVectorPixelTransform_=bs(this.coordinateToVectorPixelTransform_,c/2,l/2,1/_,-1/_,0,-r.center[0],-r.center[1])}),m.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,r,i,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,r,i,s):super.forEachFeatureAtCoordinate(e,t,r,i,s)}}class Pm extends ei{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new vm(this)}}function $(n,e,t){const r=sl();return xm(e,t,r,n)}function Am(n){const e=zr(n),t=e[0]*256,r=e[1],i=e[2]*256,s=Math.round(e[3]*255);return[t+r,i+s]}const Lm=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    fract(floor(packedColor[0] / 256.0) / 256.0),
    fract(packedColor[0] / 256.0),
    fract(floor(packedColor[1] / 256.0) / 256.0),
    fract(packedColor[1] / 256.0)
  );
}`;function qi(n){return n===Ge||n===pr?2:n===It?4:1}function xn(n){const e=qi(n);return e>1?`vec${e}`:"float"}function Vn(n){return(JSON.stringify(n).split("").reduce((t,r)=>(t<<5)-t+r.charCodeAt(0),0)>>>0).toString()}function Xs(n,e,t,r){if(`${r}radius`in n&&r!=="icon-"){let i=$(t,n[`${r}radius`],ue);if(`${r}radius2`in n){const s=$(t,n[`${r}radius2`],ue);i=`max(${i}, ${s})`}`${r}stroke-width`in n&&(i=`(${i} + ${$(t,n[`${r}stroke-width`],ue)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${i} * 2. + 0.5)`)}if(`${r}scale`in n){const i=$(t,n[`${r}scale`],pr);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${i}`)}`${r}displacement`in n&&e.setSymbolOffsetExpression($(t,n[`${r}displacement`],It)),`${r}rotation`in n&&e.setSymbolRotationExpression($(t,n[`${r}rotation`],ue)),`${r}rotate-with-view`in n&&e.setSymbolRotateWithView(!!n[`${r}rotate-with-view`])}function cc(n,e,t,r,i){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&r!==null){const c=`smoothstep(-${r} + 0.63, -${r} - 0.58, ${n})`;s=`mix(${t}, ${s}, ${c})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${n}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return i!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${i})`),a}function Ws(n,e,t,r,i){const s=new Image;s.crossOrigin=n[`${r}cross-origin`]===void 0?"anonymous":n[`${r}cross-origin`],We(typeof n[`${r}src`]=="string",`WebGL layers do not support expressions for the ${r}src style property`),s.src=n[`${r}src`],t[`u_texture${i}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`vec2 u_texture${i}_size`);const o=`u_texture${i}_size`;return t[`u_texture${i}`]=s,e.addUniform(`sampler2D u_texture${i}`),o}function Hs(n,e,t,r,i){let s=$(t,n[`${e}offset`],It);if(`${e}offset-origin`in n)switch(n[`${e}offset-origin`]){case"top-right":s=`vec2(${r}.x, 0.) + ${i} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${r}.y) + ${i} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${r} - ${i} - ${s}`;break}return s}function Im(n,e,t,r,i){i.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,Xs(n,e,r,"circle-");let s=null;"circle-opacity"in n&&(s=$(i,n["circle-opacity"],ue));let o="coordsPx";"circle-scale"in n&&(o=`coordsPx / ${$(i,n["circle-scale"],pr)}`);let a=null;"circle-fill-color"in n&&(a=$(i,n["circle-fill-color"],Ge));let c=null;"circle-stroke-color"in n&&(c=$(i,n["circle-stroke-color"],Ge));let l=$(i,n["circle-radius"],ue),u=null;"circle-stroke-width"in n&&(u=$(i,n["circle-stroke-width"],ue),l=`(${l} + ${u} * 0.5)`);const h=`circleDistanceField(${o}, ${l})`,f=cc(h,a,c,u,s);e.setSymbolColorExpression(f)}function Cm(n,e,t,r,i){i.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,i.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,i.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,Xs(n,e,r,"shape-");let s=null;"shape-opacity"in n&&(s=$(i,n["shape-opacity"],ue));let o="coordsPx";"shape-scale"in n&&(o=`coordsPx / ${$(i,n["shape-scale"],pr)}`);let a=null;"shape-fill-color"in n&&(a=$(i,n["shape-fill-color"],Ge));let c=null;"shape-stroke-color"in n&&(c=$(i,n["shape-stroke-color"],Ge));let l=null;"shape-stroke-width"in n&&(l=$(i,n["shape-stroke-width"],ue));const u=$(i,n["shape-points"],ue);let h="0.";"shape-angle"in n&&(h=$(i,n["shape-angle"],ue));let f,d=$(i,n["shape-radius"],ue);if(l!==null&&(d=`${d} + ${l} * 0.5`),"shape-radius2"in n){let p=$(i,n["shape-radius2"],ue);l!==null&&(p=`${p} + ${l} * 0.5`),f=`starDistanceField(${o}, ${u}, ${d}, ${p}, ${h})`}else f=`regularDistanceField(${o}, ${u}, ${d}, ${h})`;const g=cc(f,a,c,l,s);e.setSymbolColorExpression(g)}function Fm(n,e,t,r,i){let s="vec4(1.0)";"icon-color"in n&&(s=$(i,n["icon-color"],Ge)),"icon-opacity"in n&&(s=`${s} * vec4(1.0, 1.0, 1.0, ${$(i,n["icon-opacity"],ue)})`);const o=Vn(n["icon-src"]),a=Ws(n,e,t,"icon-",o);if(e.setSymbolColorExpression(`${s} * texture2D(u_texture${o}, v_texCoord)`).setSymbolSizeExpression(a),"icon-width"in n&&"icon-height"in n&&e.setSymbolSizeExpression(`vec2(${$(r,n["icon-width"],ue)}, ${$(r,n["icon-height"],ue)})`),"icon-offset"in n&&"icon-size"in n){const c=$(r,n["icon-size"],It),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(c);const u=Hs(n,"icon-",r,"v_quadSizePx",c);e.setTextureCoordinateExpression(`(vec4((${u}).xyxy) + vec4(0., 0., ${c})) / (${l}).xyxy`)}if(Xs(n,e,r,"icon-"),"icon-anchor"in n){const c=$(r,n["icon-anchor"],It);let l="1.0";"icon-scale"in n&&(l=$(r,n["icon-scale"],pr));let u;n["icon-anchor-x-units"]==="pixels"&&n["icon-anchor-y-units"]==="pixels"?u=`${c} * ${l}`:n["icon-anchor-x-units"]==="pixels"?u=`${c} * vec2(vec2(${l}).x, v_quadSizePx.y)`:n["icon-anchor-y-units"]==="pixels"?u=`${c} * vec2(v_quadSizePx.x, vec2(${l}).x)`:u=`${c} * v_quadSizePx`;let h=`v_quadSizePx * vec2(0.5, -0.5) + ${u} * vec2(-1., 1.)`;if("icon-anchor-origin"in n)switch(n["icon-anchor-origin"]){case"top-right":h=`v_quadSizePx * -0.5 + ${u}`;break;case"bottom-left":h=`v_quadSizePx * 0.5 - ${u}`;break;case"bottom-right":h=`v_quadSizePx * vec2(-0.5, 0.5) + ${u} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${h}`)}}function Om(n,e,t,r,i){if("stroke-color"in n&&e.setStrokeColorExpression($(i,n["stroke-color"],Ge)),"stroke-pattern-src"in n){const s=Vn(n["stroke-pattern-src"]),o=Ws(n,e,t,"stroke-pattern-",s);let a=o,c="vec2(0.)";"stroke-pattern-offset"in n&&"stroke-pattern-size"in n&&(a=$(i,n["stroke-pattern-size"],It),c=Hs(n,"stroke-pattern-",i,o,a));let l="0.";"stroke-pattern-spacing"in n&&(l=$(i,n["stroke-pattern-spacing"],ue)),i.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = currentLengthPx * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord);
}`;const u=`u_texture${s}`;let h="1.";"stroke-color"in n&&(h=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${h} * sampleStrokePattern(${u}, ${o}, ${c}, ${a}, ${l}, currentLengthPx, currentRadiusRatio, v_width)`)}if("stroke-width"in n&&e.setStrokeWidthExpression($(r,n["stroke-width"],ue)),"stroke-offset"in n&&e.setStrokeOffsetExpression($(r,n["stroke-offset"],ue)),"stroke-line-cap"in n&&e.setStrokeCapExpression($(r,n["stroke-line-cap"],kr)),"stroke-line-join"in n&&e.setStrokeJoinExpression($(r,n["stroke-line-join"],kr)),"stroke-miter-limit"in n&&e.setStrokeMiterLimitExpression($(r,n["stroke-miter-limit"],ue)),"stroke-line-dash"in n){i.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${dt("square")}) {
    distanceSegment -= v_width * 0.5;
  } else if (capType == ${dt("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - v_width * 0.5);
  }
  return distanceSegment;
}`;let s=n["stroke-line-dash"].map(d=>$(i,d,ue));s.length%2===1&&(s=[...s,...s]);let o="0.";"stroke-line-dash-offset"in n&&(o=$(r,n["stroke-line-dash-offset"],ue));const c=`dashDistanceField_${Vn(n["stroke-line-dash"])}`,l=s.map((d,g)=>`float dashLength${g} = ${d};`),u=s.map((d,g)=>`dashLength${g}`).join(" + ");let h="0.",f=`getSingleDashDistance(distance, radius, ${h}, dashLength0, totalDashLength, capType)`;for(let d=2;d<s.length;d+=2)h=`${h} + dashLength${d-2} + dashLength${d-1}`,f=`min(${f}, getSingleDashDistance(distance, radius, ${h}, dashLength${d}, totalDashLength, capType))`;i.functions[c]=`float ${c}(float distance, float radius, float capType) {
  ${l.join(`
  `)}
  float totalDashLength = ${u};
  return ${f};
}`,e.setStrokeDistanceFieldExpression(`${c}(currentLengthPx + ${o}, currentRadiusPx, capType)`)}}function Mm(n,e,t,r,i){if("fill-color"in n&&e.setFillColorExpression($(i,n["fill-color"],Ge)),"fill-pattern-src"in n){const s=Vn(n["fill-pattern-src"]),o=Ws(n,e,t,"fill-pattern-",s);let a=o,c="vec2(0.)";"fill-pattern-offset"in n&&"fill-pattern-size"in n&&(a=$(i,n["fill-pattern-size"],It),c=Hs(n,"fill-pattern-",i,o,a)),i.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${s}`;let u="1.";"fill-color"in n&&(u=e.getFillColorExpression()),e.setFillColorExpression(`${u} * sampleFillPattern(${l}, ${o}, ${c}, ${a}, pxOrigin, pxPos)`)}}function uc(n,e,t){const r=Yi(),i={...Yi(),inFragmentShader:!0,variables:r.variables},s=new lc,o={};if("icon-src"in n?Fm(n,s,o,r,i):"shape-points"in n?Cm(n,s,o,r,i):"circle-radius"in n&&Im(n,s,o,r,i),Om(n,s,o,r,i),Mm(n,s,o,r,i),t){const l=$(i,t,fs);s.setFragmentDiscardExpression(`!${l}`)}for(const l in i.variables){const u=i.variables[l],h=Vs(u.name);let f=xn(u.type);u.type===Ge&&(f="vec4"),s.addUniform(`${f} ${h}`),o[h]=()=>{const d=e[u.name];return typeof d=="number"?d:typeof d=="boolean"?d?1:0:u.type===Ge?zr(d||"#eee"):typeof d=="string"?ir(d):d}}for(const l in i.properties){const u=i.properties[l];r.properties[l]||(r.properties[l]=u);let h=xn(u.type),f=`a_prop_${u.name}`;u.type===Ge&&(h="vec4",f=`unpackColor(${f})`,s.addVertexShaderFunction(Lm)),s.addVarying(`v_prop_${u.name}`,h,f)}for(const l in r.properties){const u=r.properties[l];s.addAttribute(`${xn(u.type)} a_prop_${u.name}`)}for(const l in r.functions)s.addVertexShaderFunction(r.functions[l]);for(const l in i.functions)s.addFragmentShaderFunction(i.functions[l]);const a={};for(const l in r.properties){const u=r.properties[l],h=f=>{const d=f.get(u.name);return u.type===Ge?Am([...zr(d||"#eee")]):typeof d=="string"?ir(d):typeof d=="boolean"?d?1:0:d};a[`prop_${u.name}`]={size:qi(u.type),callback:h}}function c(l,u,h,f){const d=r[l],g=i[l];if(!d&&!g)return;const p=xn(h),m=qi(h);s.addAttribute(`${p} a_${u}`),g&&s.addVarying(`v_${u}`,p,`a_${u}`),a[u]={size:m,callback:f}}return c("geometryType",ac,kr,l=>ir(ol(l.getGeometry()))),c("featureId",oc,kr|ue,l=>{const u=l.getId()??null;return typeof u=="string"?ir(u):u}),{builder:s,attributes:a,uniforms:o}}class Nm extends ds{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=uc(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new nc(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function Ta(n,e){const t=`
    attribute vec2 ${vn.TEXTURE_COORD};
    uniform mat4 ${V.TILE_TRANSFORM};
    uniform float ${V.TEXTURE_PIXEL_WIDTH};
    uniform float ${V.TEXTURE_PIXEL_HEIGHT};
    uniform float ${V.TEXTURE_RESOLUTION};
    uniform float ${V.TEXTURE_ORIGIN_X};
    uniform float ${V.TEXTURE_ORIGIN_Y};
    uniform float ${V.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${vn.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${V.TEXTURE_ORIGIN_X} + ${V.TEXTURE_RESOLUTION} * ${V.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${V.TEXTURE_ORIGIN_Y} - ${V.TEXTURE_RESOLUTION} * ${V.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${V.TILE_TRANSFORM} * vec4(${vn.TEXTURE_COORD}, ${V.DEPTH}, 1.0);
    }
  `,r={...Yi(),inFragmentShader:!0,bandCount:e},i=[];if(n.color!==void 0){const h=$(r,n.color,Ge);i.push(`color = ${h};`)}if(n.contrast!==void 0){const h=$(r,n.contrast,ue);i.push(`color.rgb = clamp((${h} + 1.0) * color.rgb - (${h} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.exposure!==void 0){const h=$(r,n.exposure,ue);i.push(`color.rgb = clamp((${h} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.saturation!==void 0){const h=$(r,n.saturation,ue);i.push(`
      float saturation = ${h} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(n.gamma!==void 0){const h=$(r,n.gamma,ue);i.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${h}));`)}if(n.brightness!==void 0){const h=$(r,n.brightness,ue);i.push(`color.rgb = clamp(color.rgb + ${h}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(r.variables).length;if(o>1&&!n.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let h=0;h<o;++h){const f=r.variables[Object.keys(r.variables)[h]];if(!(f.name in n.variables))throw new Error(`Missing '${f.name}' in style variables`);const d=Vs(f.name);s[d]=function(){let g=n.variables[f.name];return typeof g=="string"&&(g=ir(g)),g!==void 0?g:-9999999}}const a=Object.keys(s).map(function(h){return`uniform float ${h};`}),c=Math.ceil(e/4);a.push(`uniform sampler2D ${V.TILE_TEXTURE_ARRAY}[${c}];`),r.paletteTextures&&a.push(`uniform sampler2D ${sc}[${r.paletteTextures.length}];`);const l=Object.keys(r.functions).map(function(h){return r.functions[h]}),u=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${V.RENDER_EXTENT};
    uniform float ${V.TRANSITION_ALPHA};
    uniform float ${V.TEXTURE_PIXEL_WIDTH};
    uniform float ${V.TEXTURE_PIXEL_HEIGHT};
    uniform float ${V.RESOLUTION};
    uniform float ${V.ZOOM};

    ${a.join(`
`)}

    ${l.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${V.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${V.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${V.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${V.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${V.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${i.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${V.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:u,uniforms:s,paletteTextures:r.paletteTextures}}class jn extends Mu{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener($i.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Ta(this.style_,this.getSourceBandCount_());return new pm(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let i;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(i=r.renderFrame(e));return i}render(e,t){this.rendered=!0;const r=e.viewState,i=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,c=i.length;a<c;++a){const l=i[a],u=l.getState();if(u=="loading"){const h=()=>{l.getState()=="ready"&&(l.removeEventListener("change",h),this.changed())};l.addEventListener("change",h)}s=s&&u=="ready"}const o=this.renderSources(e,i);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(c=>!i.includes(c));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=Ta(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}jn.prototype.dispose;class Zs{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let r=0;r<e.length;r++)this.addFeature(e[r],t)}addFeature(e,t){let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}clearFeatureEntryInPointBatch_(e){const t=ce(e),r=this.pointBatch.entries[t];if(r)return this.pointBatch.geometriesCount-=r.flatCoordss.length,delete this.pointBatch.entries[t],r}clearFeatureEntryInLineStringBatch_(e){const t=ce(e),r=this.lineStringBatch.entries[t];if(r)return this.lineStringBatch.verticesCount-=r.verticesCount,this.lineStringBatch.geometriesCount-=r.flatCoordss.length,delete this.lineStringBatch.entries[t],r}clearFeatureEntryInPolygonBatch_(e){const t=ce(e),r=this.polygonBatch.entries[t];if(r)return this.polygonBatch.verticesCount-=r.verticesCount,this.polygonBatch.ringsCount-=r.ringsCount,this.polygonBatch.geometriesCount-=r.flatCoordss.length,delete this.polygonBatch.entries[t],r}addGeometry_(e,t){var i;const r=e.getType();switch(r){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEndss(),t,ce(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,ce(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,ce(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,ce(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,ce(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(r,s.getFlatCoordinates(),null,t,ce(t),o,(i=s.getLayout)==null?void 0:i.call(s));break}}}addCoordinates_(e,t,r,i,s,o,a){let c;switch(e){case"MultiPolygon":{const l=r;for(let u=0,h=l.length;u<h;u++){let f=l[u];const d=u>0?l[u-1]:null,g=d?d[d.length-1]:0,p=f[f.length-1];f=g>0?f.map(m=>m-g):f,this.addCoordinates_("Polygon",t.slice(g,p),f,i,s,o,a)}break}case"MultiLineString":{const l=r;for(let u=0,h=l.length;u<h;u++){const f=u>0?l[u-1]:0;this.addCoordinates_("LineString",t.slice(f,l[u]),null,i,s,o,a)}break}case"MultiPoint":for(let l=0,u=t.length;l<u;l+=o)this.addCoordinates_("Point",t.slice(l,l+2),null,i,s,null,null);break;case"Polygon":{const l=r;if(i instanceof mh){const f=_h(t,l);if(f.length>1){this.addCoordinates_("MultiPolygon",t,f,i,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),c=t.length/o;const u=r.length,h=r.map((f,d,g)=>d>0?(f-g[d-1])/o:f/o);this.polygonBatch.verticesCount+=c,this.polygonBatch.ringsCount+=u,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push(Dm(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(h),this.polygonBatch.entries[s].verticesCount+=c,this.polygonBatch.entries[s].ringsCount+=u;for(let f=0,d=l.length;f<d;f++){const g=f>0?l[f-1]:0;this.addCoordinates_("LinearRing",t.slice(g,l[f]),null,i,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[],verticesCount:0})),c=t.length/o,this.lineStringBatch.verticesCount+=c,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push(Um(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=c;break}}addRefToEntry_(e,t){const r=this.uidToRef_.get(e),i=r||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=i,r||(this.refToFeature_.set(i,t.feature),this.uidToRef_.set(e,i)),t}returnRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e){this.removeFeature(e);const t=e.getGeometry();t&&this.addGeometry_(t,e)}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.returnRef_(t.ref,ce(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new Zs;for(const r of this.refToFeature_.values())e(r)&&t.addFeature(r);return t}}function Dm(n,e){return e===2?n:n.filter((t,r)=>r%e<2)}function Um(n,e,t){return e===3&&t==="XYM"?n:e===4?n.filter((r,i)=>i%e!==2):e===3?n.map((r,i)=>i%e!==2?r:0):new Array(n.length*1.5).fill(0).map((r,i)=>i%3===2?0:n[Math.round(i/1.5)])}function Ys(n,e,t,r){let i=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);n[r+i++]=(a==null?void 0:a[0])??a,!(!o.size||o.size===1)&&(n[r+i++]=a[1],!(o.size<3)&&(n[r+i++]=a[2],!(o.size<4)&&(n[r+i++]=a[3])))}return i}function hi(n){return Object.keys(n).reduce((e,t)=>e+(n[t].size||1),0)}function Bm(n,e,t,r){const i=(2+hi(t))*n.geometriesCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in n.entries){const c=n.entries[a];for(let l=0,u=c.flatCoordss.length;l<u;l++)s[0]=c.flatCoordss[l][0],s[1]=c.flatCoordss[l][1],yt(r,s),e[o++]=s[0],e[o++]=s[1],o+=Ys(e,t,c,o)}return e}function Gm(n,e,t,r){const i=3*n.verticesCount+(1+hi(t))*n.geometriesCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in n.entries){const c=n.entries[a];for(let l=0,u=c.flatCoordss.length;l<u;l++){s.length=c.flatCoordss[l].length,ml(c.flatCoordss[l],0,s.length,3,r,s,3),o+=Ys(e,t,c,o),e[o++]=s.length/3;for(let h=0,f=s.length;h<f;h+=3)e[o++]=s[h],e[o++]=s[h+1],e[o++]=s[h+2]}}return e}function zm(n,e,t,r){const i=2*n.verticesCount+(1+hi(t))*n.geometriesCount+n.ringsCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in n.entries){const c=n.entries[a];for(let l=0,u=c.flatCoordss.length;l<u;l++){s.length=c.flatCoordss[l].length,ml(c.flatCoordss[l],0,s.length,2,r,s),o+=Ys(e,t,c,o),e[o++]=c.ringsVerticesCounts[l].length;for(let h=0,f=c.ringsVerticesCounts[l].length;h<f;h++)e[o++]=c.ringsVerticesCounts[l][h];for(let h=0,f=s.length;h<f;h+=2)e[o++]=s[h],e[o++]=s[h+1]}}return e}const km=[];let Si;function $m(){return Si||(Si=tc()),Si}let Vm=0;const nt={POSITION:"a_position",INDEX:"a_index",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",PARAMETERS:"a_parameters",JOIN_ANGLES:"a_joinAngles",DISTANCE:"a_distance"};class jm{constructor(e,t,r,i,s){this.helper_,this.hitDetectionEnabled_=!!i;let o=e;if(!("builder"in e)){const u=e,h=uc(u.style,t,u.filter);o={builder:h.builder,attributes:h.attributes,uniforms:h.uniforms}}this.fillProgram_,this.strokeProgram_,this.symbolProgram_,this.hasFill_=!!o.builder.getFillVertexShader(),this.hasFill_&&(this.fillVertexShader_=o.builder.getFillVertexShader(),this.fillFragmentShader_=o.builder.getFillFragmentShader()),this.hasStroke_=!!o.builder.getStrokeVertexShader(),this.hasStroke_&&(this.strokeVertexShader_=o.builder.getStrokeVertexShader(),this.strokeFragmentShader_=o.builder.getStrokeFragmentShader()),this.hasSymbol_=!!o.builder.getSymbolVertexShader(),this.hasSymbol_&&(this.symbolVertexShader_=o.builder.getSymbolVertexShader(),this.symbolFragmentShader_=o.builder.getSymbolFragmentShader()),this.featureFilter_=null,s&&(this.featureFilter_=this.computeFeatureFilter(s));const c=this.hitDetectionEnabled_?{hitColor:{callback(){return ql(this.ref,km)},size:4}}:{};this.customAttributes_=Object.assign({},c,o.attributes),this.uniforms_=o.uniforms;const l=Object.entries(this.customAttributes_).map(([u,h])=>({name:`a_${u}`,size:h.size||1,type:xe.FLOAT}));this.polygonAttributesDesc_=[{name:nt.POSITION,size:2,type:xe.FLOAT},...l],this.lineStringAttributesDesc_=[{name:nt.SEGMENT_START,size:2,type:xe.FLOAT},{name:nt.MEASURE_START,size:1,type:xe.FLOAT},{name:nt.SEGMENT_END,size:2,type:xe.FLOAT},{name:nt.MEASURE_END,size:1,type:xe.FLOAT},{name:nt.JOIN_ANGLES,size:2,type:xe.FLOAT},{name:nt.DISTANCE,size:1,type:xe.FLOAT},{name:nt.PARAMETERS,size:1,type:xe.FLOAT},...l],this.pointAttributesDesc_=[{name:nt.POSITION,size:2,type:xe.FLOAT},{name:nt.INDEX,size:1,type:xe.FLOAT},...l],this.setHelper(r)}computeFeatureFilter(e){const t=sl();let r;try{r=Nu(e,fs,t)}catch{return null}if(t.mapState||t.variables.size>0)return null;const i=Du();return s=>{if(i.properties=s.getPropertiesInternal(),t.featureId){const o=s.getId();o!==void 0?i.featureId=o:i.featureId=null}return i.geometryType=ol(s.getGeometry()),r(i)}}async generateBuffers(e,t){let r=e;if(this.featureFilter_&&(r=r.filter(this.featureFilter_),r.isEmpty()))return null;const i=this.generateRenderInstructions_(r,t),[s,o,a]=await Promise.all([this.generateBuffersForType_(i.polygonInstructions,"Polygon",t),this.generateBuffersForType_(i.lineStringInstructions,"LineString",t),this.generateBuffersForType_(i.pointInstructions,"Point",t)]),c=Xr(Pe(),t);return{polygonBuffers:s,lineStringBuffers:o,pointBuffers:a,invertVerticesTransform:c}}generateRenderInstructions_(e,t){const r=this.hasFill_?zm(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,i=this.hasStroke_?Gm(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?Bm(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:r,lineStringInstructions:i,pointInstructions:s}}generateBuffersForType_(e,t,r){if(e===null)return null;const i=Vm++;let s;switch(t){case"Polygon":s=Or.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=Or.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=Or.GENERATE_POINT_BUFFERS;break}const o={id:i,type:s,renderInstructions:e.buffer,renderInstructionsTransform:r,customAttributesSize:hi(this.customAttributes_)},a=$m();return a.postMessage(o,[e.buffer]),e=null,new Promise(c=>{const l=u=>{const h=u.data;if(h.id!==i||(a.removeEventListener("message",l),!this.helper_.getGL()))return;const f=new ur(nn,zn).fromArrayBuffer(h.vertexBuffer),d=new ur(sn,zn).fromArrayBuffer(h.indexBuffer);this.helper_.flushBufferData(f),this.helper_.flushBufferData(d),c([d,f])};a.addEventListener("message",l)})}render(e,t,r){this.hasFill_&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],this.fillProgram_,this.polygonAttributesDesc_,t,r),this.hasStroke_&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],this.strokeProgram_,this.lineStringAttributesDesc_,t,r),this.hasSymbol_&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],this.symbolProgram_,this.pointAttributesDesc_,t,r)}renderInternal_(e,t,r,i,s,o){const a=e.getSize();a!==0&&(this.helper_.useProgram(r,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(i),o(),this.helper_.drawElements(0,a))}setHelper(e,t=null){this.helper_=e,this.hasFill_&&(this.fillProgram_=this.helper_.getProgram(this.fillFragmentShader_,this.fillVertexShader_)),this.hasStroke_&&(this.strokeProgram_=this.helper_.getProgram(this.strokeFragmentShader_,this.strokeVertexShader_)),this.hasSymbol_&&(this.symbolProgram_=this.helper_.getProgram(this.symbolFragmentShader_,this.symbolVertexShader_)),this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1])))}}const Kt={...at,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class Xm extends on{constructor(e,t){const r={[Kt.RENDER_EXTENT]:[0,0,0,0],[Kt.PATTERN_ORIGIN]:[0,0],[Kt.GLOBAL_ALPHA]:1};super(e,{uniforms:r,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=en(),this.currentTransform_=Pe(),this.tmpCoords_=[0,0],this.tmpTransform_=Pe(),this.tmpMat4_=Xt(),this.currentFrameStateTransform_=Pe(),this.styleVariables_={},this.styles_=[],this.styleRenderers_=[],this.buffers_=[],this.applyOptions_(t),this.batch_=new Zs,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let r;this.batch_.addFeatures(t.getFeatures(),r),this.sourceListenKeys_=[gt(t,Rt.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,r)),gt(t,Rt.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),gt(t,Rt.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),gt(t,Rt.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.styles_=Wp(e.style)}createRenderers_(){this.buffers_=[],this.styleRenderers_=this.styles_.map(e=>new jm(e,this.styleVariables_,this.helper,this.hitDetectionEnabled_,"filter"in e?e.filter:null))}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderers_.length?this.styleRenderers_.forEach((e,t)=>e.setHelper(this.helper,this.buffers_[t])):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new ec(this.helper))}handleSourceFeatureAdded_(e,t){const r=t.feature;this.batch_.addFeature(r,e)}handleSourceFeatureChanged_(e){const t=e.feature;this.batch_.changeFeature(t)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){yh(this.tmpTransform_,this.currentFrameStateTransform_),Vr(this.tmpTransform_,e),this.helper.setUniformMatrixValue(Kt.PROJECTION_MATRIX,kn(this.tmpMat4_,this.tmpTransform_)),Xr(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(Kt.SCREEN_TO_WORLD_MATRIX,kn(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,Xr(this.tmpTransform_,e),yt(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(Kt.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,i,s]=rc(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,r,i,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,i,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),r=t.getSource(),i=e.viewState,s=!e.viewHints[At.ANIMATING]&&!e.viewHints[At.INTERACTING],o=!Hr(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const c=i.projection,l=i.resolution,u=t instanceof ei?t.getRenderBuffer():0,h=Ps(e.extent,u*l);r.loadFeatures(h,l,c),this.ready=!1;const f=this.helper.makeProjectionTransform(e,Pe()),d=this.styleRenderers_.map((g,p)=>g.generateBuffers(this.batch_,f).then(m=>{this.buffers_[p]&&this.disposeBuffers(this.buffers_[p]),this.buffers_[p]=m}));Promise.all(d).then(()=>{this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,r,i,s){let o=r;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do{this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),Ts(this.currentFrameStateTransform_,o*s,0);for(let a=0,c=this.styleRenderers_.length;a<c;a++){const l=this.styleRenderers_[a],u=this.buffers_[a];u&&l.render(u,e,()=>{this.applyUniforms_(u.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)})}}while(++o<i)}forEachFeatureAtCoordinate(e,t,r,i,s){if(We(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderers_.length||!this.hitDetectionEnabled_)return;const o=yt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),c=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],l=Kl(c),u=this.batch_.getFeatureFromRef(l);if(u)return i(u,this.getLayer(),null)}disposeBuffers(e){const t=r=>{for(const i of r)i&&this.helper.deleteBuffer(i)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_.forEach(e=>{e&&this.disposeBuffers(e)}),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){Un(e)}),this.sourceListenKeys_=null),super.disposeInternal()}}class Wm extends ds{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new Xm(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style=e,this.clearRenderer(),this.changed()}}const Hm=Object.freeze(Object.defineProperty({__proto__:null,Graticule:df,Group:wl,Heatmap:Sm,Image:gs,Layer:ds,Tile:Fn,Vector:ls,VectorImage:Pm,VectorTile:al,WebGLPoints:Nm,WebGLTile:jn,WebGLVector:Wm},Symbol.toStringTag,{value:"Module"}));function Zm(n){const e=n[0],t=new Array(e);let r=1<<e-1,i,s;for(i=0;i<e;++i)s=48,n[1]&r&&(s+=1),n[2]&r&&(s+=2),t[i]=String.fromCharCode(s),r>>=1;return t.join("")}const Ym='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class qm extends bt{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:ne("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const r="https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(r).then(i=>i.json()).then(i=>this.handleImageryMetadataResponse(i))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],r=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,i=this.getProjection(),s=Kr(i),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],c=Jr({extent:s,minZoom:t.zoomMin,maxZoom:r,tileSize:a});this.tileGrid=c;const l=this.culture_,u=this.hidpi_,h=this.placeholderTiles_;if(this.tileUrlFunction=ps(t.imageUrlSubdomains.map(function(f){const d=[0,0,0],g=t.imageUrl.replace("{subdomain}",f).replace("{culture}",l);return function(p,m,y){if(!p)return;Bi(p[0],p[1],p[2],d);const _=new URL(g.replace("{quadkey}",Zm(d))),E=_.searchParams;return u&&(E.set("dpi","d1"),E.set("device","mobile")),h===!0?E.delete("n"):h===!1&&E.set("n","z"),_.toString()}})),t.imageryProviders){const f=ws(ne("EPSG:4326"),this.getProjection());this.setAttributions(d=>{const g=[],p=d.viewState,m=this.getTileGrid(),y=m.getZForResolution(p.resolution,this.zDirection),E=m.getTileCoordForCoordAndZ(p.center,y)[0];return t.imageryProviders.map(function(w){let S=!1;const T=w.coverageAreas;for(let v=0,L=T.length;v<L;++v){const P=T[v];if(E>=P.zoomMin&&E<=P.zoomMax){const R=P.bbox,N=[R[1],R[0],R[3],R[2]],F=cr(N,f);if(lr(F,d.extent)){S=!0;break}}}S&&g.push(w.attribution)}),g.push(Ym),g})}this.setState("ready")}}class Km extends $r{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const r=new XMLHttpRequest;r.addEventListener("load",this.handleInitResponse_.bind(this,e)),r.addEventListener("error",this.handleInitError_.bind(this)),r.open("POST",t),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const r=t.target;if(!r.status||r.status>=200&&r.status<300){let i;try{i=JSON.parse(r.responseText)}catch{this.setState("error");return}this.applyTemplate_(i),this.templateCache_[e]=i,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}class Jm extends qr{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const r=t.getGeometry();return We(!r||r.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),r},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,r){var i;(i=this.source)==null||i.loadFeatures(e,t,r),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(De.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(De.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const r=e===0?0:Math.min(t,e)/e,i=e!==this.distance||this.interpolationRatio!==r;this.distance=e,this.minDistance=t,this.interpolationRatio=r,i&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=en(),t=this.distance*this.resolution,r=this.source.getFeatures(),i={};for(let s=0,o=r.length;s<o;s++){const a=r[s];if(!(ce(a)in i)){const c=this.geometryFunction(a);if(c){const l=c.getCoordinates();Oh(l,e),Ps(e,t,e);const u=this.source.getFeaturesInExtent(e).filter(function(h){const f=ce(h);return f in i?!1:(i[f]=!0,!0)});this.features.push(this.createCluster(u,e))}}}}createCluster(e,t){const r=[0,0];for(let a=e.length-1;a>=0;--a){const c=this.geometryFunction(e[a]);c?Eh(r,c.getCoordinates()):e.splice(a,1)}xh(r,1/e.length);const i=Pt(t),s=this.interpolationRatio,o=new ct([r[0]*(1-s)+i[0]*s,r[1]*(1-s)+i[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new tt({geometry:o,features:e})}}const Qm=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,e_=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class t_{constructor(e){this.gl_=e,this.program_=Ki(e,e_,Qm),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,r,i,s,o,a,c,l,u,h,f,d){const g=this.gl_;c===void 0&&(c=i),l===void 0&&(l=s),o===void 0&&(o=t),a===void 0&&(a=r),u===void 0&&(u=o),h===void 0&&(h=a),f===void 0&&(f=g.canvas.width),d===void 0&&(d=g.canvas.height),g.bindTexture(g.TEXTURE_2D,e),g.useProgram(this.program_),g.bindBuffer(g.ARRAY_BUFFER,this.positionBuffer),g.enableVertexAttribArray(this.positionLocation),g.vertexAttribPointer(this.positionLocation,2,g.FLOAT,!1,0,0),g.bindBuffer(g.ARRAY_BUFFER,this.texcoordBuffer),g.enableVertexAttribArray(this.texcoordLocation),g.vertexAttribPointer(this.texcoordLocation,2,g.FLOAT,!1,0,0);let p=Hi(0,f,0,d,-1,1);p=Jp(p,c,l,0),p=ga(p,u,h,1),g.uniformMatrix4fv(this.matrixLocation,!1,p);let m=Qp(i/t,s/r,0);m=ga(m,o/t,a/r,1),g.uniformMatrix4fv(this.textureMatrixLocation,!1,m),g.uniform1i(this.textureLocation,0),g.drawArrays(g.TRIANGLES,0,this.positions.length/2)}}function wa(n,e,t){const r=n.createShader(e);if(r===null)throw new Error("Shader compilation failed");if(n.shaderSource(r,t),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){const i=n.getShaderInfoLog(r);throw i===null?new Error("Shader info log creation failed"):new Error(i)}return r}function Ki(n,e,t){const r=n.createProgram(),i=wa(n,n.VERTEX_SHADER,t),s=wa(n,n.FRAGMENT_SHADER,e);if(r===null)throw new Error("Program creation failed");if(n.attachShader(r,i),n.attachShader(r,s),n.linkProgram(r),!n.getProgramParameter(r,n.LINK_STATUS))throw n.getProgramInfoLog(r)===null?new Error("Program info log creation failed"):new Error;return r}const r_=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,n_=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,i_=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,s_=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function o_(n,e,t,r){let i;return t&&t.length?i=t.shift():Uu?i=new OffscreenCanvas(n||300,e||300):i=document.createElement("canvas"),n&&(i.width=n),e&&(i.height=e),i.getContext("webgl",r)}function a_(n){const e=n.canvas;e.width=1,e.height=1,n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT)}const Sa=[];function l_(n,e,t,r,i,s,o,a,c,l,u,h,f,d){const g=Math.round(r*e),p=Math.round(r*t);n.canvas.width=g,n.canvas.height=p;let m,y;if(y=n.createTexture(),n.bindTexture(n.TEXTURE_2D,y),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),f?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,g,p,0,n.RGBA,u,null),m=n.createFramebuffer(),n.bindFramebuffer(n.FRAMEBUFFER,m),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,y,0),m===null)throw new Error("Could not create framebuffer");if(y===null)throw new Error("Could not create texture");if(c.length===0)return{width:g,height:p,framebuffer:m,texture:y};const _=en();c.forEach(function(R,N,F){Mh(_,R.extent)});let E,w,S;const T=1/i;{if(E=n.createTexture(),y===null)throw new Error("Could not create texture");w=Math.round(Ae(_)*T),S=Math.round(et(_)*T);const R=n.getParameter(n.MAX_TEXTURE_SIZE),N=Math.max(w,S),F=N>R?R/N:1,B=Math.round(w*F),O=Math.round(S*F);n.bindTexture(n.TEXTURE_2D,E),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),f?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,B,O,0,n.RGBA,u,null);const U=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,U),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,E,0);const J=new t_(n);c.forEach(function(k,H,Q){const te=(k.extent[0]-_[0])*T*F,he=-(k.extent[3]-_[3])*T*F,_e=Ae(k.extent)*T*F,fe=et(k.extent)*T*F;if(n.bindFramebuffer(n.FRAMEBUFFER,U),n.viewport(0,0,B,O),k.clipExtent){const Ee=(k.clipExtent[0]-_[0])*T*F,Re=-(k.clipExtent[3]-_[3])*T*F,we=Ae(k.clipExtent)*T*F,Ie=et(k.clipExtent)*T*F;n.enable(n.SCISSOR_TEST),n.scissor(f?Ee:Math.round(Ee),f?Re:Math.round(Re),f?we:Math.round(Ee+we)-Math.round(Ee),f?Ie:Math.round(Re+Ie)-Math.round(Re))}J.drawImage(k.texture,k.width,k.height,l,l,k.width-2*l,k.height-2*l,f?te:Math.round(te),f?he:Math.round(he),f?_e:Math.round(te+_e)-Math.round(te),f?fe:Math.round(he+fe)-Math.round(he),B,O),n.disable(n.SCISSOR_TEST)}),n.deleteFramebuffer(U)}const v=ki(o),L=ki(_),P=R=>{const N=(R[0][0]-v[0])/s*r,F=-(R[0][1]-v[1])/s*r,B=(R[1][0]-v[0])/s*r,O=-(R[1][1]-v[1])/s*r,U=(R[2][0]-v[0])/s*r,J=-(R[2][1]-v[1])/s*r;return{u1:B,v1:O,u0:N,v0:F,u2:U,v2:J}};n.bindFramebuffer(n.FRAMEBUFFER,m),n.viewport(0,0,g,p);{const R=[],N=[],F=Ki(n,s_,i_);n.useProgram(F);const B=n.getUniformLocation(F,"u_texture");n.bindTexture(n.TEXTURE_2D,E),n.uniform1i(B,0),a.getTriangles().forEach(function(te,he,_e){const fe=te.source,Ee=te.target,{u1:Re,v1:we,u0:Ie,v0:Wt,u2:Ht,v2:ht}=P(Ee),fn=(fe[0][0]-L[0])/i/w,dn=-(fe[0][1]-L[1])/i/S,hu=(fe[1][0]-L[0])/i/w,fu=-(fe[1][1]-L[1])/i/S,du=(fe[2][0]-L[0])/i/w,gu=-(fe[2][1]-L[1])/i/S;R.push(Re,we,Ie,Wt,Ht,ht),N.push(hu,fu,fn,dn,du,gu)});const O=Hi(0,g,p,0,-1,1),U=n.getUniformLocation(F,"u_matrix");n.uniformMatrix4fv(U,!1,O);const J=n.getAttribLocation(F,"a_position"),k=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,k),n.bufferData(n.ARRAY_BUFFER,new Float32Array(R),n.STATIC_DRAW),n.vertexAttribPointer(J,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(J);const H=n.getAttribLocation(F,"a_texcoord"),Q=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,Q),n.bufferData(n.ARRAY_BUFFER,new Float32Array(N),n.STATIC_DRAW),n.vertexAttribPointer(H,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(H),n.drawArrays(n.TRIANGLES,0,R.length/2)}if(h){const R=Ki(n,n_,r_);n.useProgram(R);const N=Hi(0,g,p,0,-1,1),F=n.getUniformLocation(R,"u_matrix");n.uniformMatrix4fv(F,!1,N);const B=Array.isArray(h)?h:[0,0,0,255],O=n.getUniformLocation(R,"u_val");n.uniform4fv(O,B);const U=n.getAttribLocation(R,"a_position"),J=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,J),n.vertexAttribPointer(U,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(U);const k=a.getTriangles().reduce(function(H,Q){const te=Q.target,{u1:he,v1:_e,u0:fe,v0:Ee,u2:Re,v2:we}=P(te);return H.concat([he,_e,fe,Ee,fe,Ee,Re,we,Re,we,he,_e])},[]);n.bufferData(n.ARRAY_BUFFER,new Float32Array(k),n.STATIC_DRAW),n.drawArrays(n.LINES,0,k.length/2)}return{width:g,height:p,framebuffer:m,texture:y}}class c_ extends hs{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,r=t.getExtent(),i=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?i?Je(r,i):r:i;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const c=o?Je(s,o):s;if(Fo(c)===0){this.state=Y.EMPTY;return}r&&(a?a=Je(a,r):a=r);const l=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),u=e.targetProj,h=Gu(t,u,c,l);if(!isFinite(h)||h<=0){this.state=Y.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:zu;if(this.triangulation_=new ku(t,u,c,a,h*f,l,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=Y.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(h);let d=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(d[1]=me(d[1],a[1],a[3]),d[3]=me(d[3],a[1],a[3])):d=Je(d,a)),!Fo(d))this.state=Y.EMPTY;else{let g=0,p=0;t.canWrapX()&&(g=Ae(r),p=Math.floor((d[0]-r[0])/g)),Nh(d.slice(),t,!0).forEach(y=>{const _=this.sourceTileGrid_.getTileRangeForExtentAndZ(y,this.sourceZ_),E=e.getTileFunction;for(let w=_.minX;w<=_.maxX;w++)for(let S=_.minY;S<=_.maxY;S++){const T=E(this.sourceZ_,w,S,this.pixelRatio_);if(T){const v=p*g;this.sourceTiles_.push({tile:T,offset:v})}}++p}),this.sourceTiles_.length===0&&(this.state=Y.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(w=>{var he;const S=w.tile;if(!S||S.getState()!==Y.LOADED)return;const T=S.getSize(),v=this.gutter_;let L;const P=Di(S.getData());P?L=P:(t=!0,L=Bu(Ui(S.getData())));const R=[T[0]+2*v,T[1]+2*v],N=L instanceof Float32Array,F=R[0]*R[1],B=N?Float32Array:Uint8ClampedArray,O=new B(L.buffer),U=B.BYTES_PER_ELEMENT,J=U*O.length/F,k=O.byteLength/R[1],H=Math.floor(k/U/R[0]),Q=this.sourceTileGrid_.getTileCoordExtent(S.tileCoord);Q[0]+=w.offset,Q[2]+=w.offset;const te=(he=this.clipExtent_)==null?void 0:he.slice();te&&(te[0]+=w.offset,te[2]+=w.offset),e.push({extent:Q,clipExtent:te,data:O,dataType:B,bytesPerPixel:J,pixelSize:R,bandCount:H})}),this.sourceTiles_.length=0,e.length===0){this.state=Y.ERROR,this.changed();return}const r=this.wrappedTileCoord_[0],i=this.targetTileGrid_.getTileSize(r),s=typeof i=="number"?i:i[0],o=typeof i=="number"?i:i[1],a=s*this.pixelRatio_,c=o*this.pixelRatio_,l=this.targetTileGrid_.getResolution(r),u=this.sourceTileGrid_.getResolution(this.sourceZ_),h=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,d=new e[0].dataType(f*a*c),g=o_(a,c,Sa,{premultipliedAlpha:!1,antialias:!1});let p;const m=g.RGBA;let y;e[0].dataType==Float32Array?(y=g.FLOAT,g.getExtension("WEBGL_color_buffer_float"),g.getExtension("OES_texture_float"),g.getExtension("EXT_float_blend"),p=g.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(y=g.UNSIGNED_BYTE,p=this.interpolate);const _=4,E=Math.ceil(f/_);for(let w=E-1;w>=0;--w){const S=[];for(let B=0,O=e.length;B<O;++B){const U=e[B],J=U.pixelSize,k=J[0],H=J[1],Q=new U.dataType(_*k*H),te=U.data;let he=w*_;for(let fe=0,Ee=Q.length;fe<Ee;fe+=_)Q[fe]=te[he],Q[fe+1]=te[he+1],Q[fe+2]=te[he+2],Q[fe+3]=te[he+3],he+=f;const _e=g.createTexture();g.bindTexture(g.TEXTURE_2D,_e),p?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR)):(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.NEAREST)),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),g.texImage2D(g.TEXTURE_2D,0,m,k,H,0,m,y,Q),S.push({extent:U.extent,clipExtent:U.clipExtent,texture:_e,width:k,height:H})}const{framebuffer:T,width:v,height:L}=l_(g,s,o,this.pixelRatio_,u,l,h,this.triangulation_,S,this.gutter_,y,this.renderEdges_,p),P=v,R=L*_,N=new e[0].dataType(P*R);g.bindFramebuffer(g.FRAMEBUFFER,T),g.readPixels(0,0,v,L,g.RGBA,y,N);let F=w*_;for(let B=0,O=N.length;B<O;B+=_){const U=(P-1-(B/R|0))*R+B%R;d[F]=N[U],d[F+1]=N[U+1],d[F+2]=N[U+2],d[F+3]=N[U+3],F+=f}}if(a_(g),Sa.push(g.canvas),t){const w=Lt(s,o),S=new ImageData(d,s);w.putImageData(S,0,0),this.reprojData_=w.canvas}else this.reprojData_=d;this.reprojSize_=[Math.round(a),Math.round(c)],this.state=Y.LOADED,this.changed()}load(){if(this.state!==Y.IDLE&&this.state!==Y.ERROR)return;this.state=Y.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const r=t.getState();if(r!==Y.IDLE&&r!==Y.LOADING)return;e++;const i=gt(t,De.CHANGE,()=>{const s=t.getState();(s==Y.LOADED||s==Y.ERROR||s==Y.EMPTY)&&(Un(i),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(i)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==Y.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(Un),this.sourcesListenerKeys_=null}}class an extends ti{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=Jr({extent:Kr(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?Qe(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?Qe(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||Rn(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,i,s){const o=this.tileGrid||this.getTileGridForProjection(s||i),a=Math.max.apply(null,o.getResolutions().map((d,g)=>{const p=Qe(o.getTileSize(g)),m=this.getTileSize(g);return Math.max(m[0]/p[0],m[1]/p[1])})),c=this.getTileGridForProjection(i),l=[e,t,r],u=this.getTileCoordForTileUrlFunction(l,i),h=Object.assign({sourceProj:s||i,sourceTileGrid:o,targetProj:i,targetTileGrid:c,tileCoord:l,wrappedTileCoord:u,pixelRatio:a,gutter:this.gutter_,getTileFunction:(d,g,p,m)=>this.getTile(d,g,p,m),transformMatrix:this.transformMatrix},this.tileOptions),f=new c_(h);return f.key=this.getKey(),f}getTile(e,t,r,i,s){var E;const o=this.getProjection();if(s&&(o&&!Rn(o,s)||this.transformMatrix))return this.getReprojTile_(e,t,r,s,o);const a=this.getTileSize(e),c=this.loader_,l=new AbortController,u={signal:l.signal,crossOrigin:this.crossOrigin_},h=this.getTileCoordForTileUrlFunction([e,t,r]);if(!h)return null;const f=h[0],d=h[1],g=h[2],p=(E=this.getTileGrid())==null?void 0:E.getFullTileRange(f);p&&(u.maxY=p.getHeight()-1);function m(){return Dh(function(){return c(f,d,g,u)})}const y=Object.assign({tileCoord:[e,t,r],loader:m,size:a,controller:l},this.tileOptions),_=new hs(y);return _.key=this.getKey(),_.addEventListener(De.CHANGE,this.handleTileChange_),_}handleTileChange_(e){const t=e.target,r=ce(t),i=t.getState();let s;i==Y.LOADING?(this.tileLoadingKeys_[r]=!0,s=mi.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=i==Y.ERROR?mi.TILELOADERROR:i==Y.LOADED?mi.TILELOADEND:void 0),s&&this.dispatchEvent(new $u(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||Rn(t,e))&&!this.transformMatrix)return this.tileGrid;const r=ce(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=Vu(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=ne(e);if(r){const i=ce(r);i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=t)}}}function Le(n){return(e,...t)=>u_(n,e,t)}function Tr(n,e){return Le(hc(n,e).get)}const{apply:u_,getOwnPropertyDescriptor:hc,getPrototypeOf:qs,ownKeys:h_}=Reflect,{iterator:ln,toStringTag:f_}=Symbol,d_=Object,{create:Ks,defineProperty:g_}=d_,p_=Array,m_=p_.prototype,fc=m_[ln],__=Le(fc),dc=ArrayBuffer,y_=dc.prototype;Tr(y_,"byteLength");const Ra=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;Ra&&Tr(Ra.prototype,"byteLength");const gc=qs(Uint8Array);gc.from;const Ue=gc.prototype;Ue[ln];Le(Ue.keys);Le(Ue.values);Le(Ue.entries);Le(Ue.set);Le(Ue.reverse);Le(Ue.fill);Le(Ue.copyWithin);Le(Ue.sort);Le(Ue.slice);Le(Ue.subarray);Tr(Ue,"buffer");Tr(Ue,"byteOffset");Tr(Ue,"length");Tr(Ue,f_);const E_=Uint8Array,pc=Uint16Array,Js=Uint32Array,x_=Float32Array,Zr=qs([][ln]()),mc=Le(Zr.next),b_=Le(function*(){}().next),T_=qs(Zr),w_=DataView.prototype,S_=Le(w_.getUint16),Qs=WeakMap,_c=Qs.prototype,yc=Le(_c.get),R_=Le(_c.set),Ec=new Qs,v_=Ks(null,{next:{value:function(){const e=yc(Ec,this);return mc(e)}},[ln]:{value:function(){return this}}});function P_(n){if(n[ln]===fc&&Zr.next===mc)return n;const e=Ks(v_);return R_(Ec,e,__(n)),e}const A_=new Qs,L_=Ks(T_,{next:{value:function(){const e=yc(A_,this);return b_(e)},writable:!0,configurable:!0}});for(const n of h_(Zr))n!=="next"&&g_(L_,n,hc(Zr,n));const xc=new dc(4),I_=new x_(xc),C_=new Js(xc),it=new pc(512),st=new E_(512);for(let n=0;n<256;++n){const e=n-127;e<-24?(it[n]=0,it[n|256]=32768,st[n]=24,st[n|256]=24):e<-14?(it[n]=1024>>-e-14,it[n|256]=1024>>-e-14|32768,st[n]=-e-1,st[n|256]=-e-1):e<=15?(it[n]=e+15<<10,it[n|256]=e+15<<10|32768,st[n]=13,st[n|256]=13):e<128?(it[n]=31744,it[n|256]=64512,st[n]=24,st[n|256]=24):(it[n]=31744,it[n|256]=64512,st[n]=13,st[n|256]=13)}const eo=new Js(2048);for(let n=1;n<1024;++n){let e=n<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,eo[n]=e|t}for(let n=1024;n<2048;++n)eo[n]=939524096+(n-1024<<13);const wr=new Js(64);for(let n=1;n<31;++n)wr[n]=n<<23;wr[31]=1199570944;wr[32]=2147483648;for(let n=33;n<63;++n)wr[n]=2147483648+(n-32<<23);wr[63]=3347054592;const bc=new pc(64);for(let n=1;n<64;++n)n!==32&&(bc[n]=1024);function F_(n){const e=n>>10;return C_[0]=eo[bc[e]+(n&1023)]+wr[e],I_[0]}function Tc(n,e,...t){return F_(S_(n,e,...P_(t)))}var to={exports:{}};function wc(n,e,t){const r=t&&t.debug||!1;r&&console.log("[xml-utils] getting "+e+" in "+n);const i=typeof n=="object"?n.outer:n,s=i.slice(0,i.indexOf(">")+1),o=['"',"'"];for(let a=0;a<o.length;a++){const c=o[a],l=e+"\\="+c+"([^"+c+"]*)"+c;r&&console.log("[xml-utils] pattern:",l);const h=new RegExp(l).exec(s);if(r&&console.log("[xml-utils] match:",h),h)return h[1]}}to.exports=wc;to.exports.default=wc;var O_=to.exports;const Ri=Sl(O_);var ro={exports:{}},no={exports:{}},io={exports:{}};function Sc(n,e,t){const i=new RegExp(e).exec(n.slice(t));return i?t+i.index:-1}io.exports=Sc;io.exports.default=Sc;var M_=io.exports,so={exports:{}};function Rc(n,e,t){const i=new RegExp(e).exec(n.slice(t));return i?t+i.index+i[0].length-1:-1}so.exports=Rc;so.exports.default=Rc;var N_=so.exports,oo={exports:{}};function vc(n,e){const t=new RegExp(e,"g"),r=n.match(t);return r?r.length:0}oo.exports=vc;oo.exports.default=vc;var D_=oo.exports;const U_=M_,vi=N_,va=D_;function Pc(n,e,t){const r=t&&t.debug||!1,i=!(t&&typeof t.nested===!1),s=t&&t.startIndex||0;r&&console.log("[xml-utils] starting findTagByName with",e," and ",t);const o=U_(n,`<${e}[ 
>/]`,s);if(r&&console.log("[xml-utils] start:",o),o===-1)return;const a=n.slice(o+e.length);let c=vi(a,"^[^<]*[ /]>",0);const l=c!==-1&&a[c-1]==="/";if(r&&console.log("[xml-utils] selfClosing:",l),l===!1)if(i){let d=0,g=1,p=0;for(;(c=vi(a,"[ /]"+e+">",d))!==-1;){const m=a.substring(d,c+1);if(g+=va(m,"<"+e+`[ 
	>]`),p+=va(m,"</"+e+">"),p>=g)break;d=c}}else c=vi(a,"[ /]"+e+">",0);const u=o+e.length+c+1;if(r&&console.log("[xml-utils] end:",u),u===-1)return;const h=n.slice(o,u);let f;return l?f=null:f=h.slice(h.indexOf(">")+1,h.lastIndexOf("<")),{inner:f,outer:h,start:o,end:u}}no.exports=Pc;no.exports.default=Pc;var B_=no.exports;const G_=B_;function Ac(n,e,t){const r=[],i=t&&t.debug||!1,s=t&&typeof t.nested=="boolean"?t.nested:!0;let o=t&&t.startIndex||0,a;for(;a=G_(n,e,{debug:i,startIndex:o});)s?o=a.start+1+e.length:o=a.end,r.push(a);return i&&console.log("findTagsByName found",r.length,"tags"),r}ro.exports=Ac;ro.exports.default=Ac;var z_=ro.exports;const k_=Sl(z_),Mr={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},ot={};for(const n in Mr)Mr.hasOwnProperty(n)&&(ot[Mr[n]]=parseInt(n,10));const $_=[ot.BitsPerSample,ot.ExtraSamples,ot.SampleFormat,ot.StripByteCounts,ot.StripOffsets,ot.StripRowCounts,ot.TileByteCounts,ot.TileOffsets,ot.SubIFDs],Pi={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},W={};for(const n in Pi)Pi.hasOwnProperty(n)&&(W[Pi[n]]=parseInt(n,10));const Be={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},V_={Unspecified:0},Px={AddCompression:1},Ax={None:0,Deflate:1,Zstandard:2},j_={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function X_(n,e){const{width:t,height:r}=n,i=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<n.length;++o,a+=3)s=256-n[o]/e*256,i[a]=s,i[a+1]=s,i[a+2]=s;return i}function W_(n,e){const{width:t,height:r}=n,i=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<n.length;++o,a+=3)s=n[o]/e*256,i[a]=s,i[a+1]=s,i[a+2]=s;return i}function H_(n,e){const{width:t,height:r}=n,i=new Uint8Array(t*r*3),s=e.length/3,o=e.length/3*2;for(let a=0,c=0;a<n.length;++a,c+=3){const l=n[a];i[c]=e[l]/65536*256,i[c+1]=e[l+s]/65536*256,i[c+2]=e[l+o]/65536*256}return i}function Z_(n){const{width:e,height:t}=n,r=new Uint8Array(e*t*3);for(let i=0,s=0;i<n.length;i+=4,s+=3){const o=n[i],a=n[i+1],c=n[i+2],l=n[i+3];r[s]=255*((255-o)/256)*((255-l)/256),r[s+1]=255*((255-a)/256)*((255-l)/256),r[s+2]=255*((255-c)/256)*((255-l)/256)}return r}function Y_(n){const{width:e,height:t}=n,r=new Uint8ClampedArray(e*t*3);for(let i=0,s=0;i<n.length;i+=3,s+=3){const o=n[i],a=n[i+1],c=n[i+2];r[s]=o+1.402*(c-128),r[s+1]=o-.34414*(a-128)-.71414*(c-128),r[s+2]=o+1.772*(a-128)}return r}const q_=.95047,K_=1,J_=1.08883;function Q_(n){const{width:e,height:t}=n,r=new Uint8Array(e*t*3);for(let i=0,s=0;i<n.length;i+=3,s+=3){const o=n[i+0],a=n[i+1]<<24>>24,c=n[i+2]<<24>>24;let l=(o+16)/116,u=a/500+l,h=l-c/200,f,d,g;u=q_*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),l=K_*(l*l*l>.008856?l*l*l:(l-16/116)/7.787),h=J_*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),f=u*3.2406+l*-1.5372+h*-.4986,d=u*-.9689+l*1.8758+h*.0415,g=u*.0557+l*-.204+h*1.057,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,g=g>.0031308?1.055*g**(1/2.4)-.055:12.92*g,r[s]=Math.max(0,Math.min(1,f))*255,r[s+1]=Math.max(0,Math.min(1,d))*255,r[s+2]=Math.max(0,Math.min(1,g))*255}return r}const Lc=new Map;function Ot(n,e){Array.isArray(n)||(n=[n]),n.forEach(t=>Lc.set(t,e))}async function Ic(n){const e=Lc.get(n.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${n.Compression}`);const t=await e();return new t(n)}Ot([void 0,1],()=>Ft(()=>import("./raw.DxtaBMev.js"),__vite__mapDeps([0,1])).then(n=>n.default));Ot(5,()=>Ft(()=>import("./lzw.BikwkTY2.js"),__vite__mapDeps([2,1])).then(n=>n.default));Ot(6,()=>{throw new Error("old style JPEG compression is not supported.")});Ot(7,()=>Ft(()=>import("./jpeg.CbvpOiPg.js"),__vite__mapDeps([3,1])).then(n=>n.default));Ot([8,32946],()=>Ft(()=>import("./deflate.B4_27dB1.js"),__vite__mapDeps([4,5,1])).then(n=>n.default));Ot(32773,()=>Ft(()=>import("./packbits.D6Qr5eNi.js"),__vite__mapDeps([6,1])).then(n=>n.default));Ot(34887,()=>Ft(()=>import("./lerc.CdwJDlDo.js"),__vite__mapDeps([7,5,8,1,9,10,11,12,13,14,15,16])).then(async n=>(await n.zstd.init(),n)).then(n=>n.default));Ot(50001,()=>Ft(()=>import("./webimage.CU41Mh7j.js"),__vite__mapDeps([17,1])).then(n=>n.default));function fi(n,e,t,r=1){return new(Object.getPrototypeOf(n)).constructor(e*t*r)}function ey(n,e,t,r,i){const s=e/r,o=t/i;return n.map(a=>{const c=fi(a,r,i);for(let l=0;l<i;++l){const u=Math.min(Math.round(o*l),t-1);for(let h=0;h<r;++h){const f=Math.min(Math.round(s*h),e-1),d=a[u*e+f];c[l*r+h]=d}}return c})}function or(n,e,t){return(1-t)*n+t*e}function ty(n,e,t,r,i){const s=e/r,o=t/i;return n.map(a=>{const c=fi(a,r,i);for(let l=0;l<i;++l){const u=o*l,h=Math.floor(u),f=Math.min(Math.ceil(u),t-1);for(let d=0;d<r;++d){const g=s*d,p=g%1,m=Math.floor(g),y=Math.min(Math.ceil(g),e-1),_=a[h*e+m],E=a[h*e+y],w=a[f*e+m],S=a[f*e+y],T=or(or(_,E,p),or(w,S,p),u%1);c[l*r+d]=T}}return c})}function ry(n,e,t,r,i,s="nearest"){switch(s.toLowerCase()){case"nearest":return ey(n,e,t,r,i);case"bilinear":case"linear":return ty(n,e,t,r,i);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function ny(n,e,t,r,i,s){const o=e/r,a=t/i,c=fi(n,r,i,s);for(let l=0;l<i;++l){const u=Math.min(Math.round(a*l),t-1);for(let h=0;h<r;++h){const f=Math.min(Math.round(o*h),e-1);for(let d=0;d<s;++d){const g=n[u*e*s+f*s+d];c[l*r*s+h*s+d]=g}}}return c}function iy(n,e,t,r,i,s){const o=e/r,a=t/i,c=fi(n,r,i,s);for(let l=0;l<i;++l){const u=a*l,h=Math.floor(u),f=Math.min(Math.ceil(u),t-1);for(let d=0;d<r;++d){const g=o*d,p=g%1,m=Math.floor(g),y=Math.min(Math.ceil(g),e-1);for(let _=0;_<s;++_){const E=n[h*e*s+m*s+_],w=n[h*e*s+y*s+_],S=n[f*e*s+m*s+_],T=n[f*e*s+y*s+_],v=or(or(E,w,p),or(S,T,p),u%1);c[l*r*s+d*s+_]=v}}}return c}function sy(n,e,t,r,i,s,o="nearest"){switch(o.toLowerCase()){case"nearest":return ny(n,e,t,r,i,s);case"bilinear":case"linear":return iy(n,e,t,r,i,s);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function oy(n,e,t){let r=0;for(let i=e;i<t;++i)r+=n[i];return r}function Ji(n,e,t){switch(n){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function ay(n,e){return(n===1||n===2)&&e<=32&&e%8===0?!1:!(n===3&&(e===16||e===32||e===64))}function ly(n,e,t,r,i,s,o){const a=new DataView(n),c=t===2?o*s:o*s*r,l=t===2?1:r,u=Ji(e,i,c),h=parseInt("1".repeat(i),2);if(e===1){let f;t===1?f=r*i:f=i;let d=s*f;d&7&&(d=d+7&-8);for(let g=0;g<o;++g){const p=g*d;for(let m=0;m<s;++m){const y=p+m*l*i;for(let _=0;_<l;++_){const E=y+_*i,w=(g*s+m)*l+_,S=Math.floor(E/8),T=E%8;if(T+i<=8)u[w]=a.getUint8(S)>>8-i-T&h;else if(T+i<=16)u[w]=a.getUint16(S)>>16-i-T&h;else if(T+i<=24){const v=a.getUint16(S)<<8|a.getUint8(S+2);u[w]=v>>24-i-T&h}else u[w]=a.getUint32(S)>>32-i-T&h}}}}return u.buffer}class Cc{constructor(e,t,r,i,s,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=r,this.littleEndian=i,this.tiles=s?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,r=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(r<=8)return DataView.prototype.getUint8;if(r<=16)return DataView.prototype.getUint16;if(r<=32)return DataView.prototype.getUint32;break;case 2:if(r<=8)return DataView.prototype.getInt8;if(r<=16)return DataView.prototype.getInt16;if(r<=32)return DataView.prototype.getInt32;break;case 3:switch(r){case 16:return function(i,s){return Tc(this,i,s)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const r=this.getSampleFormat(e),i=this.getBitsPerSample(e);return Ji(r,i,t)}async getTileOrStrip(e,t,r,i,s){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let c;const{tiles:l}=this;this.planarConfiguration===1?c=t*o+e:this.planarConfiguration===2&&(c=r*o*a+t*o+e);let u,h;this.isTiled?(u=this.fileDirectory.TileOffsets[c],h=this.fileDirectory.TileByteCounts[c]):(u=this.fileDirectory.StripOffsets[c],h=this.fileDirectory.StripByteCounts[c]);const f=(await this.source.fetch([{offset:u,length:h}],s))[0];let d;return l===null||!l[c]?(d=(async()=>{let g=await i.decode(this.fileDirectory,f);const p=this.getSampleFormat(),m=this.getBitsPerSample();return ay(p,m)&&(g=ly(g,p,this.planarConfiguration,this.getSamplesPerPixel(),m,this.getTileWidth(),this.getBlockHeight(t))),g})(),l!==null&&(l[c]=d)):d=l[c],{x:e,y:t,sample:r,data:await d}}async _readRaster(e,t,r,i,s,o,a,c,l){const u=this.getTileWidth(),h=this.getTileHeight(),f=this.getWidth(),d=this.getHeight(),g=Math.max(Math.floor(e[0]/u),0),p=Math.min(Math.ceil(e[2]/u),Math.ceil(f/u)),m=Math.max(Math.floor(e[1]/h),0),y=Math.min(Math.ceil(e[3]/h),Math.ceil(d/h)),_=e[2]-e[0];let E=this.getBytesPerPixel();const w=[],S=[];for(let L=0;L<t.length;++L)this.planarConfiguration===1?w.push(oy(this.fileDirectory.BitsPerSample,0,t[L])/8):w.push(0),S.push(this.getReaderForSample(t[L]));const T=[],{littleEndian:v}=this;for(let L=m;L<y;++L)for(let P=g;P<p;++P){let R;this.planarConfiguration===1&&(R=this.getTileOrStrip(P,L,0,s,l));for(let N=0;N<t.length;++N){const F=N,B=t[N];this.planarConfiguration===2&&(E=this.getSampleByteSize(B),R=this.getTileOrStrip(P,L,B,s,l));const O=R.then(U=>{const J=U.data,k=new DataView(J),H=this.getBlockHeight(U.y),Q=U.y*h,te=U.x*u,he=Q+H,_e=(U.x+1)*u,fe=S[F],Ee=Math.min(H,H-(he-e[3]),d-Q),Re=Math.min(u,u-(_e-e[2]),f-te);for(let we=Math.max(0,e[1]-Q);we<Ee;++we)for(let Ie=Math.max(0,e[0]-te);Ie<Re;++Ie){const Wt=(we*u+Ie)*E,Ht=fe.call(k,Wt+w[F],v);let ht;i?(ht=(we+Q-e[1])*_*t.length+(Ie+te-e[0])*t.length+F,r[ht]=Ht):(ht=(we+Q-e[1])*_+Ie+te-e[0],r[F][ht]=Ht)}});T.push(O)}}if(await Promise.all(T),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let L;return i?L=sy(r,e[2]-e[0],e[3]-e[1],o,a,t.length,c):L=ry(r,e[2]-e[0],e[3]-e[1],o,a,c),L.width=o,L.height=a,L}return r.width=o||e[2]-e[0],r.height=a||e[3]-e[1],r}async readRasters({window:e,samples:t=[],interleave:r,pool:i=null,width:s,height:o,resampleMethod:a,fillValue:c,signal:l}={}){const u=e||[0,0,this.getWidth(),this.getHeight()];if(u[0]>u[2]||u[1]>u[3])throw new Error("Invalid subsets");const h=u[2]-u[0],f=u[3]-u[1],d=h*f,g=this.getSamplesPerPixel();if(!t||!t.length)for(let _=0;_<g;++_)t.push(_);else for(let _=0;_<t.length;++_)if(t[_]>=g)return Promise.reject(new RangeError(`Invalid sample index '${t[_]}'.`));let p;if(r){const _=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,E=Math.max.apply(null,this.fileDirectory.BitsPerSample);p=Ji(_,E,d*t.length),c&&p.fill(c)}else{p=[];for(let _=0;_<t.length;++_){const E=this.getArrayForSample(t[_],d);Array.isArray(c)&&_<c.length?E.fill(c[_]):c&&!Array.isArray(c)&&E.fill(c),p.push(E)}}const m=i||await Ic(this.fileDirectory);return await this._readRaster(u,t,p,r,m,s,o,a,l)}async readRGB({window:e,interleave:t=!0,pool:r=null,width:i,height:s,resampleMethod:o,enableAlpha:a=!1,signal:c}={}){const l=e||[0,0,this.getWidth(),this.getHeight()];if(l[0]>l[2]||l[1]>l[3])throw new Error("Invalid subsets");const u=this.fileDirectory.PhotometricInterpretation;if(u===Be.RGB){let y=[0,1,2];if(this.fileDirectory.ExtraSamples!==V_.Unspecified&&a){y=[];for(let _=0;_<this.fileDirectory.BitsPerSample.length;_+=1)y.push(_)}return this.readRasters({window:e,interleave:t,samples:y,pool:r,width:i,height:s,resampleMethod:o,signal:c})}let h;switch(u){case Be.WhiteIsZero:case Be.BlackIsZero:case Be.Palette:h=[0];break;case Be.CMYK:h=[0,1,2,3];break;case Be.YCbCr:case Be.CIELab:h=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const f={window:l,interleave:!0,samples:h,pool:r,width:i,height:s,resampleMethod:o,signal:c},{fileDirectory:d}=this,g=await this.readRasters(f),p=2**this.fileDirectory.BitsPerSample[0];let m;switch(u){case Be.WhiteIsZero:m=X_(g,p);break;case Be.BlackIsZero:m=W_(g,p);break;case Be.Palette:m=H_(g,d.ColorMap);break;case Be.CMYK:m=Z_(g);break;case Be.YCbCr:m=Y_(g);break;case Be.CIELab:m=Q_(g);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const y=new Uint8Array(m.length/3),_=new Uint8Array(m.length/3),E=new Uint8Array(m.length/3);for(let w=0,S=0;w<m.length;w+=3,++S)y[S]=m[w],_[S]=m[w+1],E[S]=m[w+2];m=[y,_,E]}return m.width=g.width,m.height=g.height,m}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const r=this.fileDirectory.GDAL_METADATA;let i=k_(r,"Item");e===null?i=i.filter(s=>Ri(s,"sample")===void 0):i=i.filter(s=>Number(Ri(s,"sample"))===e);for(let s=0;s<i.length;++s){const o=i[s];t[Ri(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(r)return r[1]===0&&r[4]===0?[r[0],-r[5],r[10]]:[Math.sqrt(r[0]*r[0]+r[4]*r[4]),-Math.sqrt(r[1]*r[1]+r[5]*r[5]),r[10]];if(e){const[i,s,o]=e.getResolution();return[i*e.getWidth()/this.getWidth(),s*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),r=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[i,s,o,a,c,l,u,h]=this.fileDirectory.ModelTransformation,d=[[0,0],[0,t],[r,0],[r,t]].map(([m,y])=>[a+i*m+s*y,h+c*m+l*y]),g=d.map(m=>m[0]),p=d.map(m=>m[1]);return[Math.min(...g),Math.min(...p),Math.max(...g),Math.max(...p)]}else{const i=this.getOrigin(),s=this.getResolution(),o=i[0],a=i[1],c=o+s[0]*r,l=a+s[1]*t;return[Math.min(o,c),Math.min(a,l),Math.max(o,c),Math.max(a,l)]}}}class cy{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const r=this.getUint32(e,t),i=this.getUint32(e+4,t);let s;if(t){if(s=r+2**32*i,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*r+i,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}getInt64(e,t){let r=0;const i=(this._dataView.getUint8(e+(t?7:0))&128)>0;let s=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));i&&(s?a!==0&&(a=~(a-1)&255,s=!1):a=~a&255),r+=a*256**o}return i&&(r=-r),r}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return Tc(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class uy{constructor(e,t,r,i){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=r,this._bigTiff=i}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),r=this.readUint32(e+4);let i;if(this._littleEndian){if(i=t+2**32*r,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}if(i=2**32*t+r,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}readInt64(e){let t=0;const r=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let i=!0;for(let s=0;s<8;s++){let o=this._dataView.getUint8(e+(this._littleEndian?s:7-s));r&&(i?o!==0&&(o=~(o-1)&255,i=!1):o=~o&255),t+=o*256**s}return r&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const hy=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class fy{constructor(e=hy,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(r=>{Ft(()=>import("./decoder.CaSv2t6h.js"),[]).then(i=>{r(i.create)})}),this._awaitingDecoder.then(r=>{this._awaitingDecoder=null,this.workers=[];for(let i=0;i<e;i++)this.workers.push({worker:r(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?Ic(e).then(r=>r.decode(e,t)):new Promise(r=>{const i=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];i.idle=!1;const s=this.messageId++,o=a=>{a.data.id===s&&(i.idle=!0,r(a.data.decoded),i.worker.removeEventListener("message",o))};i.worker.addEventListener("message",o),i.worker.postMessage({fileDirectory:e,buffer:t,id:s},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const Pa=`\r
\r
`;function Fc(n){if(typeof Object.fromEntries<"u")return Object.fromEntries(n);const e={};for(const[t,r]of n)e[t.toLowerCase()]=r;return e}function dy(n){const e=n.split(`\r
`).map(t=>{const r=t.split(":").map(i=>i.trim());return r[0]=r[0].toLowerCase(),r});return Fc(e)}function gy(n){const[e,...t]=n.split(";").map(i=>i.trim()),r=t.map(i=>i.split("="));return{type:e,params:Fc(r)}}function Qi(n){let e,t,r;return n&&([,e,t,r]=n.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),r=parseInt(r,10)),{start:e,end:t,total:r}}function py(n,e){let t=null;const r=new TextDecoder("ascii"),i=[],s=`--${e}`,o=`${s}--`;for(let a=0;a<10;++a)r.decode(new Uint8Array(n,a,s.length))===s&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<n.byteLength;){const a=r.decode(new Uint8Array(n,t,Math.min(s.length+1024,n.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(s))throw new Error("Part does not start with boundary");const c=a.substr(s.length+2);if(c.length===0)break;const l=c.indexOf(Pa),u=dy(c.substr(0,l)),{start:h,end:f,total:d}=Qi(u["content-range"]),g=t+s.length+l+Pa.length,p=parseInt(f,10)+1-parseInt(h,10);i.push({headers:u,data:n.slice(g,g+p),offset:h,length:p,fileSize:d}),t=g+p+4}return i}class ao{async fetch(e,t=void 0){return Promise.all(e.map(r=>this.fetchSlice(r,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class my extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield e)}for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const i=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:i}):this._set(e,{value:t,expiry:i}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[i,s]=r;this._deleteIfExpired(i,s)===!1&&(yield[i,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[i,s]=r;this.cache.has(i)||this._deleteIfExpired(i,s)===!1&&(yield[i,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,i]of this.entriesAscending())e.call(t,i,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function _y(n){return new Promise(e=>setTimeout(e,n))}function yy(n,e){const t=Array.isArray(n)?n:Array.from(n),r=Array.isArray(e)?e:Array.from(e);return t.map((i,s)=>[i,r[s]])}class hr extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,hr),this.name="AbortError"}}class Ey extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const xy=Ey;class by{constructor(e,t,r=null){this.offset=e,this.length=t,this.data=r}get top(){return this.offset+this.length}}class Aa{constructor(e,t,r){this.offset=e,this.length=t,this.blockIds=r}}class Ty extends ao{constructor(e,{blockSize:t=65536,cacheSize:r=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new my({maxSize:r,onEviction:(i,s)=>{this.evictedBlocks.set(i,s)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const r=[],i=[],s=[];this.evictedBlocks.clear();for(const{offset:f,length:d}of e){let g=f+d;const{fileSize:p}=this;p!==null&&(g=Math.min(g,p));const m=Math.floor(f/this.blockSize)*this.blockSize;for(let y=m;y<g;y+=this.blockSize){const _=Math.floor(y/this.blockSize);!this.blockCache.has(_)&&!this.blockRequests.has(_)&&(this.blockIdsToFetch.add(_),i.push(_)),this.blockRequests.has(_)&&r.push(this.blockRequests.get(_)),s.push(_)}}await _y(),this.fetchBlocks(t);const o=[];for(const f of i)this.blockRequests.has(f)&&o.push(this.blockRequests.get(f));await Promise.allSettled(r),await Promise.allSettled(o);const a=[],c=s.filter(f=>this.abortedBlockIds.has(f)||!this.blockCache.has(f));if(c.forEach(f=>this.blockIdsToFetch.add(f)),c.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const f of c){const d=this.blockRequests.get(f);if(!d)throw new Error(`Block ${f} is not in the block requests`);a.push(d)}await Promise.allSettled(a)}if(t&&t.aborted)throw new hr("Request was aborted");const l=s.map(f=>this.blockCache.get(f)||this.evictedBlocks.get(f)),u=l.filter(f=>!f);if(u.length)throw new xy(u,"Request failed");const h=new Map(yy(s,l));return this.readSliceData(e,h)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(t,e);for(let i=0;i<t.length;++i){const s=t[i];for(const o of s.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await r)[i],c=o*this.blockSize,l=c-a.offset,u=Math.min(l+this.blockSize,a.data.byteLength),h=a.data.slice(l,u),f=new by(c,h.byteLength,h,o);this.blockCache.set(o,f),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let r=[],i=null;const s=[];for(const o of t)i===null||i+1===o?(r.push(o),i=o):(s.push(new Aa(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[o],i=o);return s.push(new Aa(r[0]*this.blockSize,r.length*this.blockSize,r)),s}readSliceData(e,t){return e.map(r=>{let i=r.offset+r.length;this.fileSize!==null&&(i=Math.min(this.fileSize,i));const s=Math.floor(r.offset/this.blockSize),o=Math.floor(i/this.blockSize),a=new ArrayBuffer(r.length),c=new Uint8Array(a);for(let l=s;l<=o;++l){const u=t.get(l),h=u.offset-r.offset,f=u.top-i;let d=0,g=0,p;h<0?d=-h:h>0&&(g=h),f<0?p=u.length-d:p=i-u.offset-d;const m=new Uint8Array(u.data,d,p);c.set(m,g)}return a})}}class lo{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class co{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class wy extends lo{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class Sy extends co{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const r=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new wy(r)}}class Ry extends lo{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class vy extends co{constructRequest(e,t){return new Promise((r,i)=>{const s=new XMLHttpRequest;s.open("GET",this.url),s.responseType="arraybuffer";for(const[o,a]of Object.entries(e))s.setRequestHeader(o,a);s.onload=()=>{const o=s.response;r(new Ry(s,o))},s.onerror=i,s.onabort=()=>i(new hr("Request aborted")),s.send(),t&&(t.aborted&&s.abort(),t.addEventListener("abort",()=>s.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}const Ai={};class Py extends lo{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class Ay extends co{constructor(e){super(e),this.parsedUrl=Ai.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",Ai)}constructRequest(e,t){return new Promise((r,i)=>{const s=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(c=>{const l=[];o.on("data",u=>{l.push(u)}),o.on("end",()=>{const u=Buffer.concat(l).buffer;c(u)}),o.on("error",i)});r(new Py(o,a))});s.on("error",i),t&&(t.aborted&&s.destroy(new hr("Request aborted")),t.addEventListener("abort",()=>s.destroy(new hr("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class uo extends ao{constructor(e,t,r,i){super(),this.client=e,this.headers=t,this.maxRanges=r,this.allowFullFile=i,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(r=>this.fetchSlice(r,t))))}async fetchSlices(e,t){const r=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:i,length:s})=>`${i}-${i+s}`).join(",")}`},signal:t});if(r.ok)if(r.status===206){const{type:i,params:s}=gy(r.getHeader("content-type"));if(i==="multipart/byteranges"){const h=py(await r.getData(),s.boundary);return this._fileSize=h[0].fileSize||null,h}const o=await r.getData(),{start:a,end:c,total:l}=Qi(r.getHeader("content-range"));this._fileSize=l||null;const u=[{data:o,offset:a,length:c-a}];if(e.length>1){const h=await Promise.all(e.slice(1).map(f=>this.fetchSlice(f,t)));return u.concat(h)}return u}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const i=await r.getData();return this._fileSize=i.byteLength,[{data:i,offset:0,length:i.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:r,length:i}=e,s=await this.client.request({headers:{...this.headers,Range:`bytes=${r}-${r+i}`},signal:t});if(s.ok)if(s.status===206){const o=await s.getData(),{total:a}=Qi(s.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:r,length:i}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await s.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function ho(n,{blockSize:e,cacheSize:t}){return e===null?n:new Ty(n,{blockSize:e,cacheSize:t})}function Ly(n,{headers:e={},credentials:t,maxRanges:r=0,allowFullFile:i=!1,...s}={}){const o=new Sy(n,t),a=new uo(o,e,r,i);return ho(a,s)}function Iy(n,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...i}={}){const s=new vy(n),o=new uo(s,e,t,r);return ho(o,i)}function Cy(n,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...i}={}){const s=new Ay(n),o=new uo(s,e,t,r);return ho(o,i)}function es(n,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?Ly(n,t):typeof XMLHttpRequest<"u"?Iy(n,t):Cy(n,t)}class Fy extends ao{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((r,i)=>{const s=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>r(a.target.result),o.onerror=i,o.onabort=i,o.readAsArrayBuffer(s),t&&t.addEventListener("abort",()=>o.abort())})}}function Oy(n){return new Fy(n)}function ts(n){switch(n){case W.BYTE:case W.ASCII:case W.SBYTE:case W.UNDEFINED:return 1;case W.SHORT:case W.SSHORT:return 2;case W.LONG:case W.SLONG:case W.FLOAT:case W.IFD:return 4;case W.RATIONAL:case W.SRATIONAL:case W.DOUBLE:case W.LONG8:case W.SLONG8:case W.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${n}`)}}function My(n){const e=n.GeoKeyDirectory;if(!e)return null;const t={};for(let r=4;r<=e[3]*4;r+=4){const i=j_[e[r]],s=e[r+1]?Mr[e[r+1]]:null,o=e[r+2],a=e[r+3];let c=null;if(!s)c=a;else{if(c=n[s],typeof c>"u"||c===null)throw new Error(`Could not get value of geoKey '${i}'.`);typeof c=="string"?c=c.substring(a,a+o-1):c.subarray&&(c=c.subarray(a,a+o),o===1&&(c=c[0]))}t[i]=c}return t}function Jt(n,e,t,r){let i=null,s=null;const o=ts(e);switch(e){case W.BYTE:case W.ASCII:case W.UNDEFINED:i=new Uint8Array(t),s=n.readUint8;break;case W.SBYTE:i=new Int8Array(t),s=n.readInt8;break;case W.SHORT:i=new Uint16Array(t),s=n.readUint16;break;case W.SSHORT:i=new Int16Array(t),s=n.readInt16;break;case W.LONG:case W.IFD:i=new Uint32Array(t),s=n.readUint32;break;case W.SLONG:i=new Int32Array(t),s=n.readInt32;break;case W.LONG8:case W.IFD8:i=new Array(t),s=n.readUint64;break;case W.SLONG8:i=new Array(t),s=n.readInt64;break;case W.RATIONAL:i=new Uint32Array(t*2),s=n.readUint32;break;case W.SRATIONAL:i=new Int32Array(t*2),s=n.readInt32;break;case W.FLOAT:i=new Float32Array(t),s=n.readFloat32;break;case W.DOUBLE:i=new Float64Array(t),s=n.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===W.RATIONAL||e===W.SRATIONAL)for(let a=0;a<t;a+=2)i[a]=s.call(n,r+a*o),i[a+1]=s.call(n,r+(a*o+4));else for(let a=0;a<t;++a)i[a]=s.call(n,r+a*o);return e===W.ASCII?new TextDecoder("utf-8").decode(i):i}class Ny{constructor(e,t,r){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=r}}class bn extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class Oc{async readRasters(e={}){const{window:t,width:r,height:i}=e;let{resX:s,resY:o,bbox:a}=e;const c=await this.getImage();let l=c;const u=await this.getImageCount(),h=c.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(r||i){if(t){const[g,p]=c.getOrigin(),[m,y]=c.getResolution();a=[g+t[0]*m,p+t[1]*y,g+t[2]*m,p+t[3]*y]}const d=a||h;if(r){if(s)throw new Error("Both width and resX passed");s=(d[2]-d[0])/r}if(i){if(o)throw new Error("Both width and resY passed");o=(d[3]-d[1])/i}}if(s||o){const d=[];for(let g=0;g<u;++g){const p=await this.getImage(g),{SubfileType:m,NewSubfileType:y}=p.fileDirectory;(g===0||m===2||y&1)&&d.push(p)}d.sort((g,p)=>g.getWidth()-p.getWidth());for(let g=0;g<d.length;++g){const p=d[g],m=(h[2]-h[0])/p.getWidth(),y=(h[3]-h[1])/p.getHeight();if(l=p,s&&s>m||o&&o>y)break}}let f=t;if(a){const[d,g]=c.getOrigin(),[p,m]=l.getResolution(c);f=[Math.round((a[0]-d)/p),Math.round((a[1]-g)/m),Math.round((a[2]-d)/p),Math.round((a[3]-g)/m)],f=[Math.min(f[0],f[2]),Math.min(f[1],f[3]),Math.max(f[0],f[2]),Math.max(f[1],f[3])]}return l.readRasters({...e,window:f})}}class fr extends Oc{constructor(e,t,r,i,s={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=r,this.firstIFDOffset=i,this.cache=s.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const r=this.bigTiff?4048:1024;return new uy((await this.source.fetch([{offset:e,length:typeof t<"u"?t:r}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,r=this.bigTiff?8:2;let i=await this.getSlice(e);const s=this.bigTiff?i.readUint64(e):i.readUint16(e),o=s*t+(this.bigTiff?16:6);i.covers(e,o)||(i=await this.getSlice(e,o));const a={};let c=e+(this.bigTiff?8:2);for(let h=0;h<s;c+=t,++h){const f=i.readUint16(c),d=i.readUint16(c+2),g=this.bigTiff?i.readUint64(c+4):i.readUint32(c+4);let p,m;const y=ts(d),_=c+(this.bigTiff?12:8);if(y*g<=(this.bigTiff?8:4))p=Jt(i,d,g,_);else{const E=i.readOffset(_),w=ts(d)*g;if(i.covers(E,w))p=Jt(i,d,g,E);else{const S=await this.getSlice(E,w);p=Jt(S,d,g,E)}}g===1&&$_.indexOf(f)===-1&&!(d===W.RATIONAL||d===W.SRATIONAL)?m=p[0]:m=p,a[Mr[f]]=m}const l=My(a),u=i.readOffset(e+r+t*s);return new Ny(a,l,u)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof bn?new bn(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new bn(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new Cc(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(r){if(r instanceof bn)t=!1;else throw r}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",r=t.length+100;let i=await this.getSlice(e,r);if(t===Jt(i,W.ASCII,t.length,e)){const o=Jt(i,W.ASCII,r,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>r&&(i=await this.getSlice(e,a));const c=Jt(i,W.ASCII,a,e);this.ghostValues={},c.split(`
`).filter(l=>l.length>0).map(l=>l.split("=")).forEach(([l,u])=>{this.ghostValues[l]=u})}return this.ghostValues}static async fromSource(e,t,r){const i=(await e.fetch([{offset:0,length:1024}],r))[0],s=new cy(i),o=s.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const c=s.getUint16(2,a);let l;if(c===42)l=!1;else if(c===43){if(l=!0,s.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const u=l?s.getUint64(8,a):s.getUint32(4,a);return new fr(e,a,l,u,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}class Dy extends Oc{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,r=0;for(let i=0;i<this.imageFiles.length;i++){const s=this.imageFiles[i];for(let o=0;o<this.imageCounts[i];o++){if(e===t){const a=await s.requestIFD(r);return new Cc(a.fileDirectory,a.geoKeyDirectory,s.dataView,s.littleEndian,s.cache,s.source)}t++,r++}r=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,r)=>t+r,0),this.imageCount}}async function Uy(n,e={},t){return fr.fromSource(es(n,e),t)}async function By(n,e){return fr.fromSource(Oy(n),e)}async function Gy(n,e=[],t={},r){const i=await fr.fromSource(es(n,t),r),s=await Promise.all(e.map(o=>fr.fromSource(es(o,t))));return new Dy(i,s)}function zy(n){return((n.fileDirectory.NewSubfileType||0)&4)===4}function ky(n,e){if(!n)return!1;if(n===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=Be;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const La="STATISTICS_MAXIMUM",Ia="STATISTICS_MINIMUM",Li=256;let Ii;function $y(){return Ii||(Ii=new fy),Ii}function Vy(n){try{return n.getBoundingBox(!0)}catch{return[0,0,n.getWidth(),n.getHeight()]}}function jy(n){try{return n.getOrigin().slice(0,2)}catch{return[0,n.getHeight()]}}function Xy(n,e){try{return n.getResolution(e)}catch{return[e.getWidth()/n.getWidth(),e.getHeight()/n.getHeight()]}}function Wy(n){const e=n.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=ne(t);if(!r){const i=Lo(e.ProjLinearUnitsGeoKey);i&&(r=new Io({code:t,units:i}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=ne(t);if(!r){const i=Lo(e.GeogAngularUnitsGeoKey);i&&(r=new Io({code:t,units:i}))}return r}return null}function Hy(n){return n.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=n.getImage(r);return Promise.all(t)})}function Zy(n,e){let t;return n.blob?t=By(n.blob):n.overviews?t=Gy(n.url,n.overviews,e):t=Uy(n.url,e),t.then(Hy)}function Ir(n,e,t,r,i){if(Array.isArray(n)){const s=n.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(r);throw i(o),o}for(let o=0;o<s;++o)Ir(n[o],e[o],t,r,i);return}if(e=e,Math.abs(n-e)>t*n)throw new Error(r)}function Yy(n){return n instanceof Int8Array?-128:n instanceof Int16Array?-32768:n instanceof Int32Array?-2147483648:n instanceof Float32Array?12e-39:0}function qy(n){return n instanceof Int8Array?127:n instanceof Uint8Array||n instanceof Uint8ClampedArray?255:n instanceof Int16Array?32767:n instanceof Uint16Array?65535:n instanceof Int32Array?2147483647:n instanceof Uint32Array?4294967295:n instanceof Float32Array?34e37:255}class fo extends an{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const r=this,i=new Array(t);for(let s=0;s<t;++s)i[s]=Zy(this.sourceInfo_[s],this.sourceOptions_);Promise.all(i).then(function(s){r.configure_(s)}).catch(function(s){Wr(s),r.error_=s,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const i=t[r],s=Wy(i);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const s=t[r].fileDirectory.ModelTransformation;if(s){const[o,a,c,l,u,h,f,d]=s,g=Vr(Vr([1/Math.sqrt(o*o+u*u),0,0,-1/Math.sqrt(a*a+h*h),l,d],[o,u,a,h,0,0]),[1,0,0,1,-l,-d]);this.transformMatrix=g,this.addAlpha_=!0;break}}}configure_(e){let t,r,i,s,o;const a=new Array(e.length),c=new Array(e.length),l=new Array(e.length);let u=0;const h=e.length;for(let m=0;m<h;++m){const y=[],_=[];e[m].forEach(P=>{zy(P)?_.push(P):y.push(P)});const E=y.length;if(_.length>0&&_.length!==E)throw new Error(`Expected one mask per image found ${_.length} masks and ${E} images`);let w,S;const T=new Array(E),v=new Array(E),L=new Array(E);c[m]=new Array(E),l[m]=new Array(E);for(let P=0;P<E;++P){const R=y[P],N=R.getGDALNoData();l[m][P]=R.getGDALMetadata(0),c[m][P]=N;const F=this.sourceInfo_[m].bands;a[m]=F?F.length:R.getSamplesPerPixel();const B=E-(P+1);w||(w=Vy(R)),S||(S=jy(R));const O=Xy(R,y[0]);L[B]=O[0];const U=[R.getTileWidth(),R.getTileHeight()];U[0]!==U[1]&&U[1]<Li&&(U[0]=Li,U[1]=Li),T[B]=U;const J=O[0]/Math.abs(O[1]);v[B]=[U[0],U[1]/J]}if(t?Je(t,w,t):t=w,!r)r=S;else{const P=`Origin mismatch for source ${m}, got [${S}] but expected [${r}]`;Ir(r,S,0,P,this.viewRejector)}if(!o)o=L,this.resolutionFactors_[m]=1;else{o.length-u>L.length&&(u=o.length-L.length);const P=o[o.length-1]/L[L.length-1];this.resolutionFactors_[m]=P;const R=L.map(F=>F*=P),N=`Resolution mismatch for source ${m}, got [${R}] but expected [${o}]`;Ir(o.slice(u,o.length),R,.02,N,this.viewRejector)}i?Ir(i.slice(u,i.length),v,.01,`Tile size mismatch for source ${m}`,this.viewRejector):i=v,s?Ir(s.slice(u,s.length),T,0,`Tile size mismatch for source ${m}`,this.viewRejector):s=T,this.sourceImagery_[m]=y.reverse(),this.sourceMasks_[m]=_.reverse()}for(let m=0,y=this.sourceImagery_.length;m<y;++m){const _=this.sourceImagery_[m];for(;_.length<o.length;)_.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=c,this.metadata_=l;e:for(let m=0;m<h;++m){if(this.sourceInfo_[m].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[m].length){this.addAlpha_=!0;break}const y=c[m],_=this.sourceInfo_[m].bands;if(_){for(let E=0;E<_.length;++E)if(y[_[E]-1]!==null){this.addAlpha_=!0;break e}continue}for(let E=0;E<y.length;++E)if(y[E]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let m=0;m<h;++m)f+=a[m];this.bandCount=f;const d=new ri({extent:t,minZoom:u,origin:r,resolutions:o,tileSizes:i});this.tileGrid=d,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const g=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let p=t;if(this.transformMatrix){const m=Xr(Pe(),this.transformMatrix.slice()),y=bh(_=>yt(m,_));p=cr(t,y)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:wh(Pt(p),this.projection),extent:Th(p,this.projection),zoom:g})}loadTile_(e,t,r,i){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),c=this.nodataValues_,l=this.sourceInfo_,u=$y();for(let h=0;h<o;++h){const f=l[h],d=this.resolutionFactors_[h],g=[Math.round(t*(s[0]*d)),Math.round(r*(s[1]*d)),Math.round((t+1)*(s[0]*d)),Math.round((r+1)*(s[1]*d))],p=this.sourceImagery_[h][e];let m;f.bands&&(m=f.bands.map(function(S){return S-1}));let y;"nodata"in f&&f.nodata!==null?y=f.nodata:m?y=m.map(function(S){return c[h][S]}):y=c[h];const _={window:g,width:s[0],height:s[1],samples:m,fillValue:y,pool:u,interleave:!1,signal:i.signal};ky(this.convertToRGB_,p)?a[h]=p.readRGB(_):a[h]=p.readRasters(_);const E=o+h,w=this.sourceMasks_[h][e];if(!w){a[E]=Promise.resolve(null);continue}a[E]=w.readRasters({window:g,width:s[0],height:s[1],samples:[0],pool:u,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(h){throw Wr(h),h})}composeTile_(e,t){const r=this.metadata_,i=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,c=this.nodataValues_,l=this.normalize_,u=this.addAlpha_,h=e[0]*e[1],f=h*o;let d;l?d=new Uint8Array(f):d=new Float32Array(f);let g=0;for(let p=0;p<h;++p){let m=u;for(let y=0;y<s;++y){const _=i[y];let E=_.min,w=_.max,S,T;if(l){const v=r[y][0];E===void 0&&(v&&Ia in v?E=parseFloat(v[Ia]):E=Yy(t[y][0])),w===void 0&&(v&&La in v?w=parseFloat(v[La]):w=qy(t[y][0])),S=255/(w-E),T=-E*S}for(let v=0;v<a[y];++v){const L=t[y][v][p];let P;if(l?P=me(S*L+T,0,255):P=L,!u)d[g]=P;else{let R=_.nodata;if(R===void 0){let F;_.bands?F=_.bands[v]-1:F=v,R=c[y][F]}const N=isNaN(R);(!N&&L!==R||N&&!isNaN(L))&&(m=!1,d[g]=P)}g++}if(!m){const v=s+y,L=t[v];L&&!L[0][p]&&(m=!0)}}u&&(m||(d[g]=255),g++)}return d}}fo.prototype.getView;const Ky="https://tile.googleapis.com/v1/createSession",Jy="https://tile.googleapis.com/v1/2dtiles",Qy="https://tile.googleapis.com/tile/v1/viewport",e0=22;class t0 extends bt{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const r={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(r.imageFormat=e.imageFormat),e.scale&&(r.scale=e.scale),t&&(r.highDpi=!0),e.layerTypes&&(r.layerTypes=e.layerTypes),e.styles&&(r.styles=e.styles),e.overlay===!0&&(r.overlay=!0),e.apiOptions&&(r.apiOptions=e.apiOptions),this.sessionTokenRequest_=r,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_,this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=Ky+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},r=await this.fetchSessionToken(e,t);if(!r.ok){try{const h=await r.json();this.error_=new Error(h.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const i=await r.json(),s=this.getTilePixelRatio(1),o=[i.tileWidth/s,i.tileHeight/s];this.tileGrid=Jr({extent:Kr(this.getProjection()),maxZoom:e0,tileSize:o});const a=i.session;this.sessionTokenValue_=a;const c=this.apiKey_;this.tileUrlFunction=function(h,f,d){const g=h[0],p=h[1],m=h[2];return`${Jy}/${g}/${p}/${m}?session=${a}&key=${c}`};const l=parseInt(i.expiry,10)*1e3,u=Math.max(l-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),u),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[At.ANIMATING]||e.viewHints[At.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,r]=Co(Uh(e.extent),e.viewState.projection),[i,s]=Co(Bh(e.extent),e.viewState.projection),c=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${r}&east=${i}&west=${t}`;if(this.previousViewportExtent_==c)return this.previousViewportAttribution_;this.previousViewportExtent_=c;const l=this.sessionTokenValue_,u=this.apiKey_,h=`${Qy}?session=${l}&key=${u}&${c}`;return this.previousViewportAttribution_=await fetch(h).then(f=>f.json()).then(f=>f.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let Mc=class extends us{constructor(e,t,r,i,s,o,a){super(t,r,i,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==Y.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const r=Lt(t[0],t[1]);return r.drawImage(e,0,0),this.zoomifyImage_=r.canvas,r.canvas}return e}};class r0 extends bt{constructor(e){const t=e.size,r=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",i=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],c=e.tileSize||Gi;let l=c*i;switch(r){case"default":for(;s>l||o>l;)a.push([Math.ceil(s/l),Math.ceil(o/l)]),l+=l;break;case"truncated":let T=s,v=o;for(;T>l||v>l;)a.push([Math.ceil(T/l),Math.ceil(v/l)]),T>>=1,v>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const u=[i],h=[0];for(let T=1,v=a.length;T<v;T++)u.push(i<<T),h.push(a[T-1][0]*a[T-1][1]+h[T-1]);u.reverse();const f=new ri({tileSize:c,extent:e.extent||[0,-o,s,0],resolutions:u});let d=e.url;d&&!d.includes("{TileGroup}")&&!d.includes("{tileIndex}")&&(d+="{TileGroup}/{z}-{x}-{y}.jpg");const g=ll(d);let p=c*i;function m(T){return function(v,L,P){if(!v)return;const R=v[0],N=v[1],F=v[2],B=N+F*a[R][0],O=(B+h[R])/p|0,U={z:R,x:N,y:F,tileIndex:B,TileGroup:"TileGroup"+O};return T.replace(/\{(\w+?)\}/g,function(J,k){return U[k]})}}const y=ps(g.map(m)),_=Mc.bind(null,Qe(c*i));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:i,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:_,tileGrid:f,tileUrlFunction:y,transition:e.transition}),this.zDirection=e.zDirection;const E=f.getTileCoordForCoordAndResolution(Pt(f.getExtent()),u[u.length-1]),w=y(E,1,null),S=new Image;S.addEventListener("error",()=>{p=c,this.changed()}),S.src=w}}function Rr(n){return n.toLocaleString("en",{maximumFractionDigits:10})}class n0 extends bt{constructor(e){const t=e||{};let r=t.url||"";r=r+(r.lastIndexOf("/")===r.length-1||r===""?"":"/");const i=t.version||be.VERSION2,s=t.sizes||[],o=t.size;We(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],c=o[1],l=t.tileSize,u=t.tilePixelRatio||1,h=t.format||"jpg",f=t.quality||(t.version==be.VERSION1?"native":"default");let d=t.resolutions||[];const g=t.supports||[],p=t.extent||[0,-c,a,0],m=s!=null&&Array.isArray(s)&&s.length>0,y=l!==void 0&&(typeof l=="number"&&Number.isInteger(l)&&l>0||Array.isArray(l)&&l.length>0),_=g!=null&&Array.isArray(g)&&(g.includes("regionByPx")||g.includes("regionByPct"))&&(g.includes("sizeByWh")||g.includes("sizeByH")||g.includes("sizeByW")||g.includes("sizeByPct"));let E,w,S;if(d.sort(function(P,R){return R-P}),y||_)if(l!=null&&(typeof l=="number"&&Number.isInteger(l)&&l>0?(E=l,w=l):Array.isArray(l)&&l.length>0&&((l.length==1||l[1]==null&&Number.isInteger(l[0]))&&(E=l[0],w=l[0]),l.length==2&&(Number.isInteger(l[0])&&Number.isInteger(l[1])?(E=l[0],w=l[1]):l[0]==null&&Number.isInteger(l[1])&&(E=l[1],w=l[1])))),(E===void 0||w===void 0)&&(E=Gi,w=Gi),d.length==0){S=Math.max(Math.ceil(Math.log(a/E)/Math.LN2),Math.ceil(Math.log(c/w)/Math.LN2));for(let P=S;P>=0;P--)d.push(Math.pow(2,P))}else{const P=Math.max(...d);S=Math.round(Math.log(P)/Math.LN2)}else if(E=a,w=c,d=[],m){s.sort(function(R,N){return R[0]-N[0]}),S=-1;const P=[];for(let R=0;R<s.length;R++){const N=a/s[R][0];if(d.length>0&&d[d.length-1]==N){P.push(R);continue}d.push(N),S++}if(P.length>0)for(let R=0;R<P.length;R++)s.splice(P[R]-R,1)}else d.push(1),s.push([a,c]),S=0;const T=new ri({tileSize:[E,w],extent:p,origin:ki(p),resolutions:d}),v=function(P,R,N){let F,B;const O=P[0];if(O>S)return;const U=P[1],J=P[2],k=d[O];if(!(U===void 0||J===void 0||k===void 0||U<0||Math.ceil(a/k/E)<=U||J<0||Math.ceil(c/k/w)<=J)){if(_||y){const H=U*E*k,Q=J*w*k;let te=E*k,he=w*k,_e=E,fe=w;if(H+te>a&&(te=a-H),Q+he>c&&(he=c-Q),H+E*k>a&&(_e=Math.floor((a-H+k-1)/k)),Q+w*k>c&&(fe=Math.floor((c-Q+k-1)/k)),H==0&&te==a&&Q==0&&he==c)F="full";else if(!_||g.includes("regionByPx"))F=H+","+Q+","+te+","+he;else if(g.includes("regionByPct")){const Ee=Rr(H/a*100),Re=Rr(Q/c*100),we=Rr(te/a*100),Ie=Rr(he/c*100);F="pct:"+Ee+","+Re+","+we+","+Ie}i==be.VERSION3&&(!_||g.includes("sizeByWh"))?B=_e+","+fe:!_||g.includes("sizeByW")?B=_e+",":g.includes("sizeByH")?B=","+fe:g.includes("sizeByWh")?B=_e+","+fe:g.includes("sizeByPct")&&(B="pct:"+Rr(100/k))}else if(F="full",m){const H=s[O][0],Q=s[O][1];i==be.VERSION3?H==a&&Q==c?B="max":B=H+","+Q:H==a?B="full":B=H+","}else B=i==be.VERSION3?"max":"full";return r+F+"/"+B+"/0/"+f+"."+h}},L=Mc.bind(null,Qe(l||256).map(function(P){return P*u}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:L,tileGrid:T,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:v,transition:t.transition}),this.zDirection=t.zDirection}}function Nc(n,e,t,r,i,s){const o=i.getCode().split(/:(?=\d+$)/).pop(),a=t/r,c=[Oo(Ae(e)/a,Ro),Oo(et(e)/a,Ro)];s.SIZE=c[0]+","+c[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*r:90*r);const l=n.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return On(l,s)}function Dc(n){const e=n.load?n.load:mr,t=ne(n.projection||"EPSG:3857"),r=n.ratio??1.5,i=n.crossOrigin??null;return function(s,o,a){a=n.hidpi?a:1;const c={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(c,n.params),s=cl(s,o,a,r);const l=Nc(n.url,s,o,a,t,c),u=new Image;return u.crossOrigin=i,e(u,l).then(h=>{const f=Ae(s)/h.width*a;return{image:h,extent:s,resolution:f,pixelRatio:a}})}}class i0 extends jt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:ms,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,i){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==i)&&(this.loaderProjection_=i,this.loader=Dc({crossOrigin:this.crossOrigin_,params:this.params_,projection:i,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),mr(s))})),super.getImageInternal(e,t,r,i))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class s0 extends jt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,r,i){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==r&&Nn(s.getExtent(),e))return s;e=e.slice(),xl(e,this.ratio_);const o=Ae(e)/t,a=et(e)/t,c=[o*r,a*r],l=this.canvasFunction_.call(this,e,t,r,c,i);return l&&(s=new As(e,t,r,l)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function o0(n,e,t,r){const i=Ae(n),s=et(n),o=e[0],a=e[1],c=.0254/r;return a*i>o*s?i*t/(o*c):s*t/(a*c)}function a0(n,e,t,r,i,s,o){const a=o0(t,r,s,o),c=Pt(t),l={OPERATION:i?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(r[0]),SETDISPLAYHEIGHT:Math.round(r[1]),SETVIEWSCALE:a,SETVIEWCENTERX:c[0],SETVIEWCENTERY:c[1]};return Object.assign(l,e),On(n,l)}function Uc(n){const e=n.load||mr,t=n.useOverlay??!1,r=n.metersPerUnit||1,i=n.displayDpi||96,s=n.ratio??1,o=n.crossOrigin??null;return function(a,c,l){const u=new Image;u.crossOrigin=o,a=cl(a,c,l,s);const h=Ae(a)/c,f=et(a)/c,d=[h*l,f*l],g=a0(n.url,n.params,a,d,t,r,i);return e(u,g).then(p=>({image:p,extent:a,pixelRatio:l}))}}class l0 extends jt{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:ms,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,i){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==i)&&(this.loaderProjection_=i,this.loader=Uc({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),mr(s))})),super.getImageInternal(e,t,r,i))}getImageLoadFunction(){return this.imageLoadFunction_}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}function Bc(n){const e=n.load||mr,t=n.imageExtent,r=n.crossOrigin??null;return()=>{const i=new Image;return i.crossOrigin=r,e(i,n.url).then(s=>{const o=Ae(t)/s.width,a=et(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class Gc extends jt{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,r=e.imageLoadFunction!==void 0?e.imageLoadFunction:ms;super({attributions:e.attributions,interpolate:e.interpolate,projection:ne(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new el(this.imageExtent_,void 0,1,Bc({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(i,s)=>(this.image.setImage(i),r(this.image,s),mr(i))})),this.image.addEventListener(De.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,r,i){return lr(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}const c0=new Error("Image failed to load");function zc(n,e,t,r,i){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=i.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(c0)),a.src=ul(n,e,t,r,i.maxY)})}function Ca(n){return function(e,t,r,i){const s=ju(n,e,t,r);return zc(s,e,t,r,i)}}function u0(n){return function(e,t,r,i){const s=n(e,t,r,i);return zc(s,e,t,r,i)}}function Fa(n){let e;if(Array.isArray(n))e=Ca(n);else if(typeof n=="string"){const t=ll(n);e=Ca(t)}else if(typeof n=="function")e=u0(n);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let Oa=0;function Ma(n){return Array.isArray(n)?n.join(`
`):typeof n=="string"?n:(++Oa,"url-function-key-"+Oa)}class kc extends an{constructor(e){e=e||{};let t=e.loader,r;e.url&&(t=Fa(e.url),r=Ma(e.url));const i=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:r,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:i,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=Fa(e);this.setLoader(t),this.setKey(Ma(e)),this.getState()!=="ready"&&this.setState("ready")}}function go(n,e,t,r){const i=document.createElement("script"),s="olc_"+ce(e);function o(){delete window[s],i.parentNode.removeChild(i)}i.async=!0,i.src=n+(n.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(c){clearTimeout(a),o(),e(c)},document.head.appendChild(i)}class h0 extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class f0 extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function $c(n){return new Promise(function(e,t){function r(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let c;try{c=JSON.parse(a.responseText)}catch(l){const u="Error parsing response text as JSON: "+l.message;t(new Error(u));return}e(c);return}t(new h0(a))}function i(o){t(new f0(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",r),s.addEventListener("error",i),s.open("GET",n),s.setRequestHeader("Accept","application/json"),s.send()})}function Vc(n,e){return e.includes("://")?e:new URL(e,n).href}const d0={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},g0={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function jc(n,e){if(!e.length)return n;const t=new URL(n,"file:/");if(t.pathname.split("/").includes("collections"))return Wr('The "collections" query parameter cannot be added to collection endpoints'),n;const r=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",r);const i=n.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${i}?${s}`}function p0(n,e,t){let r,i;for(let s=0;s<n.length;++s){const o=n[s];if(o.rel==="item"){if(o.type===e){r=o.href;break}(d0[o.type]||!i&&o.type.startsWith("image/"))&&(i=o.href)}}if(!r)if(i)r=i;else throw new Error('Could not find "item" link');return t&&(r=jc(r,t)),r}function m0(n,e,t,r){let i,s;const o={};for(let a=0;a<n.length;++a){const c=n[a];if(o[c.type]=c.href,c.rel==="item"){if(c.type===e){i=c.href;break}g0[c.type]&&(s=c.href)}}if(!i&&t)for(let a=0;a<t.length;++a){const c=t[a];if(o[c]){i=o[c];break}}if(!i)if(s)i=s;else throw new Error('Could not find "item" link');return r&&(i=jc(i,r)),i}function Na(n,e,t,r){let i=n.projection;if(!i&&(typeof e.crs=="string"?i=ne(e.crs):"uri"in e.crs&&(i=ne(e.crs.uri)),!i))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(T=>T.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):i.getAxisOrientation()).startsWith("en"),c=e.tileMatrices,l={};for(let T=0;T<c.length;++T){const v=c[T];l[v.id]=v}const u={},h=[];if(r)for(let T=0;T<r.length;++T){const v=r[T],L=v.tileMatrix;h.push(L),u[L]=v}else for(let T=0;T<c.length;++T){const v=c[T].id;h.push(v)}const f=h.length,d=new Array(f),g=new Array(f),p=new Array(f),m=new Array(f),y=[-1/0,-1/0,1/0,1/0];for(let T=0;T<f;++T){const v=h[T],L=l[v],P=L.pointOfOrigin;a?d[T]=[P[1],P[0]]:d[T]=P,g[T]=L.cellSize,p[T]=[L.matrixWidth,L.matrixHeight],m[T]=[L.tileWidth,L.tileHeight];const R=u[v];if(R){const N=L.cellSize*L.tileWidth,F=d[T][0]+R.minTileCol*N,B=d[T][0]+(R.maxTileCol+1)*N,O=L.cellSize*L.tileHeight,U=L.cornerOfOrigin==="bottomLeft";let J,k;U?(J=d[T][1]+R.minTileRow*O,k=d[T][1]+(R.maxTileRow+1)*O):(J=d[T][1]-(R.maxTileRow+1)*O,k=d[T][1]-R.minTileRow*O),Je(y,[F,J,B,k],y)}}const _=new ri({origins:d,resolutions:g,sizes:p,tileSizes:m,extent:r?y:void 0}),E=n.context,w=n.url;function S(T,v,L){if(!T)return;const P=h[T[0]],R=l[P],N=R.cornerOfOrigin==="bottomLeft",F={tileMatrix:P,tileCol:T[1],tileRow:N?-T[2]-1:T[2]};if(r){const O=u[R.id];if(F.tileCol<O.minTileCol||F.tileCol>O.maxTileCol||F.tileRow<O.minTileRow||F.tileRow>O.maxTileRow)return}Object.assign(F,E);const B=t.replace(/\{(\w+?)\}/g,function(O,U){return F[U]});return Vc(w,B)}return{grid:_,projection:i,urlTemplate:t,urlFunction:S}}function _0(n,e){const t=e.tileMatrixSetLimits;let r;if(e.dataType==="map")r=p0(e.links,n.mediaType,n.collections);else if(e.dataType==="vector")r=m0(e.links,n.mediaType,n.supportedMediaTypes,n.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return Na(n,e.tileMatrixSet,r,t);const i=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!i)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=i.href,o=Vc(n.url,s);return $c(o).then(function(a){return Na(n,a,r,t)})}function Xc(n){return $c(n.url).then(function(e){return _0(n,e)})}class y0 extends bt{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};Xc(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Wr(e),this.setState("error")}}class E0 extends ni{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};Xc(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Wr(e),this.setState("error")}}function Wc(n){return function(e){const t=e.buffers,r=e.meta,i=e.imageOps,s=e.width,o=e.height,a=t.length,c=t[0].byteLength;if(i){const f=new Array(a);for(let g=0;g<a;++g)f[g]=new ImageData(new Uint8ClampedArray(t[g]),s,o);return n(f,r).data.buffer}const l=new Uint8ClampedArray(c),u=new Array(a),h=new Array(a);for(let f=0;f<a;++f)u[f]=new Uint8ClampedArray(t[f]),h[f]=[0,0,0,0];for(let f=0;f<c;f+=4){for(let g=0;g<a;++g){const p=u[g];h[g][0]=p[f],h[g][1]=p[f+1],h[g][2]=p[f+2],h[g][3]=p[f+3]}const d=n(h,r);l[f]=d[0],l[f+1]=d[1],l[f+2]=d[2],l[f+3]=d[3]}return l.buffer}}function x0(n,e){const r=Object.keys(n.lib||{}).map(function(s){return"const "+s+" = "+n.lib[s].toString()+";"}).concat(["const __minion__ = ("+Wc.toString()+")(",n.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),i=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(r.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return i.addEventListener("message",e),i}function b0(n,e){const t=Wc(n.operation);let r=!1;return{postMessage:function(i){setTimeout(function(){r||e({data:{buffer:t(i),meta:i.meta}})},0)},terminate:function(){r=!0}}}class T0 extends El{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const r=new Array(t);if(t)for(let i=0;i<t;++i)r[i]=x0(e,this.onWorkerMessage_.bind(this,i));else r[0]=b0(e,this.onWorkerMessage_.bind(this,0));this.workers_=r,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,r){this.enqueue_({inputs:e,meta:t,callback:r}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,r=e.inputs[0].height,i=e.inputs.map(function(c){return c.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:i,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},i);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let c=0;c<s;++c){const l=c*a,u=[];for(let h=0,f=i.length;h<f;++h)u.push(i[h].slice(l,l+a));this.workers_[c].postMessage({buffers:u,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},u)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let r,i;if(t===1)r=new Uint8ClampedArray(this.dataLookup_[0].buffer),i=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;r=new Uint8ClampedArray(s),i=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const c=this.dataLookup_[a].buffer,l=a*o;r.set(new Uint8ClampedArray(c),l),i[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(r,e.inputs[0].width,e.inputs[0].height),i),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const Da={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class Ua extends bl{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class Hc extends jt{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=R0(e.sources);const t=this.changed.bind(this);for(let r=0,i=this.layers_.length;r<i;++r)this.layers_[r].addEventListener(De.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new Xu(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:Pe(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:S0(this.layers_),pixelRatio:1,pixelToCoordinateTransform:Pe(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:ce(this),renderTargets:{}},this.setAttributions(function(r){var s;const i=[];for(let o=0,a=e.sources.length;o<a;++o){const c=e.sources[o],l=c instanceof _s?c:c.getSource();if(!l)continue;const u=(s=l.getAttributions())==null?void 0:s(r);typeof u=="string"?i.push(u):u!==void 0&&i.push(...u)}return i}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new T0({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const i=Object.assign({},this.frameState_);i.viewState=Object.assign({},i.viewState);const s=Pt(e);i.size[0]=Math.ceil(Ae(e)/t),i.size[1]=Math.ceil(et(e)/t),i.extent=[s[0]-i.size[0]*t/2,s[1]-i.size[1]*t/2,s[0]+i.size[0]*t/2,s[1]+i.size[1]*t/2],i.time=Date.now();const o=i.viewState;return o.center=s,o.projection=r,o.resolution=t,i}allSourcesReady_(){let e=!0,t;for(let r=0,i=this.layers_.length;r<i;++r)if(t=this.layers_[r].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,r,i){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,i);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!Hr(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=w0(this.layers_[s],e);if(o)r[s]=o;else return}const i={};this.dispatchEvent(new Ua(Da.BEFOREOPERATIONS,e,i)),this.processor_.process(r,i,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,r,i){if(t||!r)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!Hr(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const c=Math.round(Ae(s)/o),l=Math.round(et(s)/o);a=Lt(c,l),this.renderedImageCanvas_=new As(s,o,1,a.canvas)}a.putImageData(r,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new Ua(Da.AFTEROPERATIONS,e,i))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let r=0,i=this.layers_.length;r<i&&(t=this.layers_[r].getSource().getResolutions(e),!t);++r);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}Hc.prototype.dispose;let Nt=null;function w0(n,e){const t=n.getRenderer();if(!t)throw new Error("Unsupported layer type: "+n);if(!t.prepareFrame(e))return null;const r=e.size[0],i=e.size[1];if(r===0||i===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===r&&o.height===i)return o.getContext("2d").getImageData(0,0,r,i)}if(!Nt)Nt=Lt(r,i,void 0,{willReadFrequently:!0});else{const a=Nt.canvas;a.width!==r||a.height!==i?Nt=Lt(r,i,void 0,{willReadFrequently:!0}):Nt.clearRect(0,0,r,i)}return Nt.drawImage(o,0,0,r,i),Nt.getImageData(0,0,r,i)}function S0(n){return n.map(function(e){return e.getLayerState()})}function R0(n){const e=n.length,t=new Array(e);for(let r=0;r<e;++r)t[r]=v0(n[r]);return t}function v0(n){let e;return n instanceof _s?n instanceof ti?e=new Fn({source:n}):n instanceof jt&&(e=new gs({source:n})):e=n,e}const P0='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',A0='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',L0='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',I0={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},C0={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class F0 extends $r{constructor(e){const t=e.layer.indexOf("-"),r=t==-1?e.layer:e.layer.slice(0,t),i=C0[r]||{minZoom:0,maxZoom:20,retina:!0},s=I0[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=i.retina&&e.retina?"@2x":"",c=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,l=[P0,A0,Wu];e.layer.startsWith("stamen_")&&l.splice(1,0,L0),super({attributions:l,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:i.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:i.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:c,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class O0 extends bt{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=en(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const r in this.params_)t[e++]=r+"-"+this.params_[r];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,r,i,s,o){const a=this.urls;if(!a)return;let c;if(a.length==1)c=a[0];else{const l=Gh(Hu(e),a.length);c=a[l]}return Nc(c,r,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),i,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,r){let i=this.getTileGrid();if(i||(i=this.getTileGridForProjection(r)),i.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=i.getTileCoordExtent(e,this.tmpExtent_);let o=Qe(i.getTileSize(e[0]),this.tmpSize);t!=1&&(o=Zu(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,r,a)}}class M0 extends kc{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",r=e.source;super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:r!==void 0?r.getWrapX():void 0});const i=()=>{var o;this.projection=e.projection!==void 0?ne(e.projection):r!==void 0?r.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:r!==void 0?r.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:r!==void 0?r.zDirection:this.zDirection,r instanceof an&&(this.transformMatrix=((o=r.transformMatrix)==null?void 0:o.slice())||null);const s=this.tileGrid;s&&this.setTileSizes(s.getResolutions().map((a,c)=>Qe(s.getTileSize(c)).map(l=>Math.max(Math.floor(l),1)))),this.setLoader((a,c,l,u)=>{const h=ul(t,a,c,l,u.maxY),[f,d]=this.getTileSize(a),g=Lt(f,d);return g.strokeStyle="grey",g.strokeRect(.5,.5,f+.5,d+.5),g.fillStyle="grey",g.strokeStyle="white",g.textAlign="center",g.textBaseline="middle",g.font="24px sans-serif",g.lineWidth=4,g.strokeText(h,f/2,d/2,f),g.fillText(h,f/2,d/2,f),g.canvas}),this.setState("ready")};if(r===void 0||r.getState()==="ready")i();else{const s=()=>{r.getState()==="ready"&&(r.removeEventListener(De.CHANGE,s),i())};r.addEventListener(De.CHANGE,s)}}}class Zc extends bt{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:ne("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)go(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=ne("EPSG:4326"),r=this.getProjection();let i;if(e.bounds!==void 0){const l=ws(t,r);i=cr(e.bounds,l)}const s=Kr(r),o=e.minzoom||0,a=e.maxzoom||22,c=Jr({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=c,this.tileUrlFunction=hl(e.tiles,c),e.attribution&&!this.getAttributions()){const l=i!==void 0?i:s;this.setAttributions(function(u){return lr(l,u.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}class N0 extends qu{constructor(e,t,r,i,s,o){super(e,t),this.src_=r,this.extent_=i,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),r=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),i=this.grid_[Math.floor((1-r)*this.grid_.length)];if(typeof i!="string")return null;let s=i.charCodeAt(Math.floor(t*i.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,r){this.state==Y.EMPTY&&r===!0?(this.state=Y.IDLE,zh(this,De.CHANGE,i=>{t(this.getData(e))}),this.loadInternal_()):r===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=Y.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=Y.LOADED,this.changed()}loadInternal_(){if(this.state==Y.IDLE)if(this.state=Y.LOADING,this.jsonp_)go(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(r)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(Y.EMPTY)}}class D0 extends ti{constructor(e){if(super({projection:ne("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=Yu,this.template_=void 0,this.jsonp_=e.jsonp||!1,e.url)if(this.jsonp_)go(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,r,i){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s);this.getTile(o[0],o[1],o[2],1,this.getProjection()).forDataAtCoordinate(e,r,i)}else i===!0?setTimeout(function(){r(null)},0):r(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=ne("EPSG:4326"),r=this.getProjection();let i;if(e.bounds!==void 0){const u=ws(t,r);i=cr(e.bounds,u)}const s=Kr(r),o=e.minzoom||0,a=e.maxzoom||22,c=Jr({extent:s,maxZoom:a,minZoom:o});this.tileGrid=c,this.template_=e.template;const l=e.grids;if(!l){this.setState("error");return}if(this.tileUrlFunction_=hl(l,c),e.attribution){const u=i!==void 0?i:s;this.setAttributions(function(h){return lr(u,h.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,r,i,s){const o=[e,t,r],a=this.getTileCoordForTileUrlFunction(o,s),c=this.tileUrlFunction_(a,i,s);return new N0(o,c!==void 0?Y.IDLE:Y.EMPTY,c!==void 0?c:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_)}}function U0(n,e){const t=new il(32),r=n.getExtent();return function(i,s){t.expireCache(),r&&(i=Je(r,i));const o=n.getZForResolution(s),a=[];return n.forEachTileCoord(i,o,c=>{const l=c.toString();if(!t.containsKey(l)){const u=e(c);t.set(l,u)}a.push(t.get(l))}),a}}const B0=Object.freeze(Object.defineProperty({__proto__:null,BingMaps:qm,CartoDB:Km,Cluster:Jm,DataTile:an,GeoTIFF:fo,Google:t0,IIIF:n0,Image:jt,ImageArcGISRest:i0,ImageCanvas:s0,ImageMapGuide:l0,ImageStatic:Gc,ImageTile:kc,ImageWMS:Ku,OGCMapTile:y0,OGCVectorTile:E0,OSM:Ju,Raster:Hc,Source:_s,StadiaMaps:F0,Tile:ti,TileArcGISRest:O0,TileDebug:M0,TileImage:bt,TileJSON:Zc,TileWMS:fl,UTFGrid:D0,UrlTile:Qu,Vector:qr,VectorTile:ni,WMTS:dl,XYZ:$r,Zoomify:r0,createArcGISRestLoader:Dc,createMapGuideLoader:Uc,createStaticLoader:Bc,createWMSLoader:eh,sourcesFromTileGrid:U0},Symbol.toStringTag,{value:"Module"}));class Yc extends Hh{constructor(e,t=null,r={},i=[]){super(e,t,r,i)}getAll(){return[]}}class G0 extends Zh{constructor(e,t=null){super(e,t)}}class z0 extends Yc{constructor(e,t=null){const r={collections:i=>i.map(s=>new Ll(s))};super(e,t,r)}getObjectType(){return"CollectionCollection"}getAll(){return this.collections}isCollectionCollection(){return!0}toGeoJSON(){return{type:"FeatureCollection",features:this.collections.map(t=>t.toGeoJSON()).filter(t=>t!==null)}}getBoundingBox(){return Pl(this.getBoundingBoxes())}getBoundingBoxes(){return this.collections.map(e=>e.getBoundingBox())}getTemporalExtent(){return Al(this.getTemporalExtents())}getTemporalExtents(){return this.collections.map(e=>e.getTemporalExtent())}}class k0 extends Yc{constructor(e,t=null){const r={features:i=>i.map(s=>new Il(s))};super(e,t,r)}getObjectType(){return"ItemCollection"}getAll(){return this.features}toGeoJSON(){return this.toJSON()}getBoundingBox(){return Pl(this.getBoundingBoxes())}getBoundingBoxes(){return this.features.map(e=>e.getBoundingBox())}getTemporalExtent(){return Al(this.getTemporalExtents())}getTemporalExtents(){return this.features.map(e=>e.getTemporalExtent())}}function $0(n,e=!0,t=!1){return e&&(n=Yh.stac(n,t)),n.type==="Feature"?new Il(n):n.type==="FeatureCollection"?new k0(n):n.type==="Collection"||!n.type&&typeof n.extent<"u"&&typeof n.license<"u"?new Ll(n):!n.type&&Array.isArray(n.collections)?new z0(n):new G0(n)}window.eoxMapAdvancedOlFormats=Xp;var Ne=(n,e,t)=>new Promise((r,i)=>{var s=c=>{try{a(t.next(c))}catch(l){i(l)}},o=c=>{try{a(t.throw(c))}catch(l){i(l)}},a=c=>c.done?r(c.value):Promise.resolve(c.value).then(s,o);a((t=t.apply(n,e)).next())}),$e=Uint8Array,Nr=Uint16Array,V0=Int32Array,qc=new $e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Kc=new $e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),j0=new $e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Jc=function(n,e){for(var t=new Nr(31),r=0;r<31;++r)t[r]=e+=1<<n[r-1];for(var i=new V0(t[30]),r=1;r<30;++r)for(var s=t[r];s<t[r+1];++s)i[s]=s-t[r]<<5|r;return{b:t,r:i}},Qc=Jc(qc,2),eu=Qc.b,X0=Qc.r;eu[28]=258,X0[258]=28;var W0=Jc(Kc,0),H0=W0.b,tu=new Nr(32768);for(ae=0;ae<32768;++ae)ft=(ae&43690)>>1|(ae&21845)<<1,ft=(ft&52428)>>2|(ft&13107)<<2,ft=(ft&61680)>>4|(ft&3855)<<4,tu[ae]=((ft&65280)>>8|(ft&255)<<8)>>1;var ft,ae,Dr=function(n,e,t){for(var r=n.length,i=0,s=new Nr(e);i<r;++i)n[i]&&++s[n[i]-1];var o=new Nr(e);for(i=1;i<e;++i)o[i]=o[i-1]+s[i-1]<<1;var a;{a=new Nr(1<<e);var c=15-e;for(i=0;i<r;++i)if(n[i])for(var l=i<<4|n[i],u=e-n[i],h=o[n[i]-1]++<<u,f=h|(1<<u)-1;h<=f;++h)a[tu[h]>>c]=l}return a},cn=new $e(288);for(ae=0;ae<144;++ae)cn[ae]=8;var ae;for(ae=144;ae<256;++ae)cn[ae]=9;var ae;for(ae=256;ae<280;++ae)cn[ae]=7;var ae;for(ae=280;ae<288;++ae)cn[ae]=8;var ae,ru=new $e(32);for(ae=0;ae<32;++ae)ru[ae]=5;var ae,Z0=Dr(cn,9),Y0=Dr(ru,5),Ci=function(n){for(var e=n[0],t=1;t<n.length;++t)n[t]>e&&(e=n[t]);return e},Ze=function(n,e,t){var r=e/8|0;return(n[r]|n[r+1]<<8)>>(e&7)&t},Fi=function(n,e){var t=e/8|0;return(n[t]|n[t+1]<<8|n[t+2]<<16)>>(e&7)},q0=function(n){return(n+7)/8|0},K0=function(n,e,t){(t==null||t>n.length)&&(t=n.length);var r=new $e(t-e);return r.set(n.subarray(e,t)),r},J0=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],ke=function(n,e,t){var r=new Error(e||J0[n]);if(r.code=n,Error.captureStackTrace&&Error.captureStackTrace(r,ke),!t)throw r;return r},po=function(n,e,t,r){var i=n.length,s=0;if(!i||e.f&&!e.l)return t||new $e(0);var o=!t||e.i!=2,a=e.i;t||(t=new $e(i*3));var c=function(ht){var fn=t.length;if(ht>fn){var dn=new $e(Math.max(fn*2,ht));dn.set(t),t=dn}},l=e.f||0,u=e.p||0,h=e.b||0,f=e.l,d=e.d,g=e.m,p=e.n,m=i*8;do{if(!f){l=Ze(n,u,1);var y=Ze(n,u+1,3);if(u+=3,y)if(y==1)f=Z0,d=Y0,g=9,p=5;else if(y==2){var S=Ze(n,u,31)+257,T=Ze(n,u+10,15)+4,v=S+Ze(n,u+5,31)+1;u+=14;for(var L=new $e(v),P=new $e(19),R=0;R<T;++R)P[j0[R]]=Ze(n,u+R*3,7);u+=T*3;for(var N=Ci(P),F=(1<<N)-1,B=Dr(P,N),R=0;R<v;){var O=B[Ze(n,u,F)];u+=O&15;var _=O>>4;if(_<16)L[R++]=_;else{var U=0,J=0;for(_==16?(J=3+Ze(n,u,3),u+=2,U=L[R-1]):_==17?(J=3+Ze(n,u,7),u+=3):_==18&&(J=11+Ze(n,u,127),u+=7);J--;)L[R++]=U}}var k=L.subarray(0,S),H=L.subarray(S);g=Ci(k),p=Ci(H),f=Dr(k,g),d=Dr(H,p)}else ke(1);else{var _=q0(u)+4,E=n[_-4]|n[_-3]<<8,w=_+E;if(w>i){a&&ke(0);break}o&&c(h+E),t.set(n.subarray(_,w),h),e.b=h+=E,e.p=u=w*8,e.f=l;continue}if(u>m){a&&ke(0);break}}o&&c(h+131072);for(var Q=(1<<g)-1,te=(1<<p)-1,he=u;;he=u){var U=f[Fi(n,u)&Q],_e=U>>4;if(u+=U&15,u>m){a&&ke(0);break}if(U||ke(2),_e<256)t[h++]=_e;else if(_e==256){he=u,f=null;break}else{var fe=_e-254;if(_e>264){var R=_e-257,Ee=qc[R];fe=Ze(n,u,(1<<Ee)-1)+eu[R],u+=Ee}var Re=d[Fi(n,u)&te],we=Re>>4;Re||ke(3),u+=Re&15;var H=H0[we];if(we>3){var Ee=Kc[we];H+=Fi(n,u)&(1<<Ee)-1,u+=Ee}if(u>m){a&&ke(0);break}o&&c(h+131072);var Ie=h+fe;if(h<H){var Wt=s-H,Ht=Math.min(H,Ie);for(Wt+h<0&&ke(3);h<Ht;++h)t[h]=r[Wt+h]}for(;h<Ie;h+=4)t[h]=t[h-H],t[h+1]=t[h+1-H],t[h+2]=t[h+2-H],t[h+3]=t[h+3-H];h=Ie}}e.l=f,e.p=he,e.b=h,e.f=l,f&&(l=1,e.m=g,e.d=d,e.n=p)}while(!l);return h==t.length?t:K0(t,0,h)},Q0=new $e(0),eE=function(n){(n[0]!=31||n[1]!=139||n[2]!=8)&&ke(6,"invalid gzip data");var e=n[3],t=10;e&4&&(t+=(n[10]|n[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!n[t++]);return t+(e&2)},tE=function(n){var e=n.length;return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0},rE=function(n,e){return((n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31)&&ke(6,"invalid zlib data"),(n[1]>>5&1)==1&&ke(6,"invalid zlib data: "+(n[1]&32?"need":"unexpected")+" dictionary"),(n[1]>>3&4)+2};function nE(n,e){return po(n,{i:2},e,e)}function iE(n,e){var t=eE(n);return t+8>n.length&&ke(6,"invalid gzip data"),po(n.subarray(t,-8),{i:2},new $e(tE(n)),e)}function sE(n,e){return po(n.subarray(rE(n),-4),{i:2},e,e)}function rs(n,e){return n[0]==31&&n[1]==139&&n[2]==8?iE(n,e):(n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31?nE(n,e):sE(n,e)}var oE=typeof TextDecoder<"u"&&new TextDecoder,aE=0;try{oE.decode(Q0,{stream:!0}),aE=1}catch{}var nu=(n,e)=>n*Math.pow(2,e),vr=(n,e)=>Math.floor(n/Math.pow(2,e)),Xn=(n,e)=>nu(n.getUint16(e+1,!0),8)+n.getUint8(e),iu=(n,e)=>nu(n.getUint32(e+2,!0),16)+n.getUint16(e,!0),lE=(n,e,t,r,i)=>{if(n!=r.getUint8(i))return n-r.getUint8(i);const s=Xn(r,i+1);if(e!=s)return e-s;const o=Xn(r,i+4);return t!=o?t-o:0},cE=(n,e,t,r)=>{const i=su(n,e|128,t,r);return i?{z:e,x:t,y:r,offset:i[0],length:i[1],is_dir:!0}:null},Ba=(n,e,t,r)=>{const i=su(n,e,t,r);return i?{z:e,x:t,y:r,offset:i[0],length:i[1],is_dir:!1}:null},su=(n,e,t,r)=>{let i=0,s=n.byteLength/17-1;for(;i<=s;){const o=s+i>>1,a=lE(e,t,r,n,o*17);if(a>0)i=o+1;else if(a<0)s=o-1;else return[iu(n,o*17+7),n.getUint32(o*17+13,!0)]}return null},uE=(n,e)=>n.is_dir&&!e.is_dir?1:!n.is_dir&&e.is_dir?-1:n.z!==e.z?n.z-e.z:n.x!==e.x?n.x-e.x:n.y-e.y,ou=(n,e)=>{const t=n.getUint8(e*17);return{z:t&127,x:Xn(n,e*17+1),y:Xn(n,e*17+4),offset:iu(n,e*17+7),length:n.getUint32(e*17+13,!0),is_dir:t>>7===1}},Ga=n=>{const e=[],t=new DataView(n);for(let r=0;r<t.byteLength/17;r++)e.push(ou(t,r));return hE(e)},hE=n=>{n.sort(uE);const e=new ArrayBuffer(17*n.length),t=new Uint8Array(e);for(let r=0;r<n.length;r++){const i=n[r];let s=i.z;i.is_dir&&(s=s|128),t[r*17]=s,t[r*17+1]=i.x&255,t[r*17+2]=i.x>>8&255,t[r*17+3]=i.x>>16&255,t[r*17+4]=i.y&255,t[r*17+5]=i.y>>8&255,t[r*17+6]=i.y>>16&255,t[r*17+7]=i.offset&255,t[r*17+8]=vr(i.offset,8)&255,t[r*17+9]=vr(i.offset,16)&255,t[r*17+10]=vr(i.offset,24)&255,t[r*17+11]=vr(i.offset,32)&255,t[r*17+12]=vr(i.offset,48)&255,t[r*17+13]=i.length&255,t[r*17+14]=i.length>>8&255,t[r*17+15]=i.length>>16&255,t[r*17+16]=i.length>>24&255}return e},fE=(n,e)=>{if(n.byteLength<17)return null;const t=n.byteLength/17,r=ou(n,t-1);if(r.is_dir){const i=r.z,s=e.z-i,o=Math.trunc(e.x/(1<<s)),a=Math.trunc(e.y/(1<<s));return{z:i,x:o,y:a}}return null};function dE(n){return Ne(this,null,function*(){const e=yield n.getBytes(0,512e3),t=new DataView(e.data),r=t.getUint32(4,!0),i=t.getUint16(8,!0),s=new TextDecoder("utf-8"),o=JSON.parse(s.decode(new DataView(e.data,10,r)));let a=0;o.compression==="gzip"&&(a=2);let c=0;"minzoom"in o&&(c=+o.minzoom);let l=0;"maxzoom"in o&&(l=+o.maxzoom);let u=0,h=0,f=0,d=-180,g=-85,p=180,m=85;if(o.bounds){const _=o.bounds.split(",");d=+_[0],g=+_[1],p=+_[2],m=+_[3]}if(o.center){const _=o.center.split(",");u=+_[0],h=+_[1],f=+_[2]}return{specVersion:t.getUint16(2,!0),rootDirectoryOffset:10+r,rootDirectoryLength:i*17,jsonMetadataOffset:10,jsonMetadataLength:r,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:a,tileType:1,minZoom:c,maxZoom:l,minLon:d,minLat:g,maxLon:p,maxLat:m,centerZoom:f,centerLon:u,centerLat:h,etag:e.etag}})}function gE(n,e,t,r,i,s,o){return Ne(this,null,function*(){let a=yield t.getArrayBuffer(e,n.rootDirectoryOffset,n.rootDirectoryLength,n);n.specVersion===1&&(a=Ga(a));const c=Ba(new DataView(a),r,i,s);if(c){let h=(yield e.getBytes(c.offset,c.length,o)).data;const f=new DataView(h);return f.getUint8(0)==31&&f.getUint8(1)==139&&(h=rs(new Uint8Array(h))),{data:h}}const l=fE(new DataView(a),{z:r,x:i,y:s});if(l){const u=cE(new DataView(a),l.z,l.x,l.y);if(u){let h=yield t.getArrayBuffer(e,u.offset,u.length,n);n.specVersion===1&&(h=Ga(h));const f=Ba(new DataView(h),r,i,s);if(f){let g=(yield e.getBytes(f.offset,f.length,o)).data;const p=new DataView(g);return p.getUint8(0)==31&&p.getUint8(1)==139&&(g=rs(new Uint8Array(g))),{data:g}}}}})}var au={getHeader:dE,getZxy:gE};function Qt(n,e){return(e>>>0)*4294967296+(n>>>0)}function pE(n,e){const t=e.buf;let r,i;if(i=t[e.pos++],r=(i&112)>>4,i<128||(i=t[e.pos++],r|=(i&127)<<3,i<128)||(i=t[e.pos++],r|=(i&127)<<10,i<128)||(i=t[e.pos++],r|=(i&127)<<17,i<128)||(i=t[e.pos++],r|=(i&127)<<24,i<128)||(i=t[e.pos++],r|=(i&1)<<31,i<128))return Qt(n,r);throw new Error("Expected varint not more than 10 bytes")}function Pr(n){const e=n.buf;let t,r;return r=e[n.pos++],t=r&127,r<128||(r=e[n.pos++],t|=(r&127)<<7,r<128)||(r=e[n.pos++],t|=(r&127)<<14,r<128)||(r=e[n.pos++],t|=(r&127)<<21,r<128)?t:(r=e[n.pos],t|=(r&15)<<28,pE(t,n))}function mE(n,e,t,r){if(r==0){t==1&&(e[0]=n-1-e[0],e[1]=n-1-e[1]);const i=e[0];e[0]=e[1],e[1]=i}}var _E=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function yE(n,e,t){if(n>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(e>Math.pow(2,n)-1||t>Math.pow(2,n)-1)throw Error("tile x/y outside zoom level bounds");const r=_E[n],i=Math.pow(2,n);let s=0,o=0,a=0;const c=[e,t];let l=i/2;for(;l>0;)s=(c[0]&l)>0?1:0,o=(c[1]&l)>0?1:0,a+=l*l*(3*s^o),mE(l,c,s,o),l=l/2;return r+a}function lu(n,e){return Ne(this,null,function*(){if(e===1||e===0)return n;if(e===2){if(typeof globalThis.DecompressionStream>"u")return rs(new Uint8Array(n));{let r=new Response(n).body.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(r).arrayBuffer()}}else throw Error("Compression method not supported")})}var rr=(n=>(n[n.Unknown=0]="Unknown",n[n.Mvt=1]="Mvt",n[n.Png=2]="Png",n[n.Jpeg=3]="Jpeg",n[n.Webp=4]="Webp",n[n.Avif=5]="Avif",n))(rr||{}),EE=127;function xE(n,e){let t=0,r=n.length-1;for(;t<=r;){const i=r+t>>1,s=e-n[i].tileId;if(s>0)t=i+1;else if(s<0)r=i-1;else return n[i]}return r>=0&&(n[r].runLength===0||e-n[r].tileId<n[r].runLength)?n[r]:null}var bE=class{constructor(n,e=new Headers){this.url=n,this.customHeaders=e}getKey(){return this.url}setHeaders(n){this.customHeaders=n}getBytes(n,e,t){return Ne(this,null,function*(){let r;t||(r=new AbortController,t=r.signal);const i=new Headers(this.customHeaders);i.set("Range","bytes="+n+"-"+(n+e-1));let s=yield fetch(this.url,{signal:t,headers:i});if(s.status===416&&n===0){const c=s.headers.get("Content-Range");if(!c||!c.startsWith("bytes */"))throw Error("Missing content-length on 416 response");const l=+c.substr(8);s=yield fetch(this.url,{signal:t,headers:{Range:"bytes=0-"+(l-1)}})}if(s.status>=300)throw Error("Bad response code: "+s.status);const o=s.headers.get("Content-Length");if(s.status===200&&(!o||+o>e))throw r&&r.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield s.arrayBuffer(),etag:s.headers.get("ETag")||void 0,cacheControl:s.headers.get("Cache-Control")||void 0,expires:s.headers.get("Expires")||void 0}})}};function Ye(n,e){const t=n.getUint32(e+4,!0),r=n.getUint32(e+0,!0);return t*Math.pow(2,32)+r}function TE(n,e){const t=new DataView(n),r=t.getUint8(7);if(r>3)throw Error(`Archive is spec version ${r} but this library supports up to spec version 3`);return{specVersion:r,rootDirectoryOffset:Ye(t,8),rootDirectoryLength:Ye(t,16),jsonMetadataOffset:Ye(t,24),jsonMetadataLength:Ye(t,32),leafDirectoryOffset:Ye(t,40),leafDirectoryLength:Ye(t,48),tileDataOffset:Ye(t,56),tileDataLength:Ye(t,64),numAddressedTiles:Ye(t,72),numTileEntries:Ye(t,80),numTileContents:Ye(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}function cu(n){const e={buf:new Uint8Array(n),pos:0},t=Pr(e),r=[];let i=0;for(let s=0;s<t;s++){const o=Pr(e);r.push({tileId:i+o,offset:0,length:0,runLength:1}),i+=o}for(let s=0;s<t;s++)r[s].runLength=Pr(e);for(let s=0;s<t;s++)r[s].length=Pr(e);for(let s=0;s<t;s++){const o=Pr(e);o===0&&s>0?r[s].offset=r[s-1].offset+r[s-1].length:r[s].offset=o-1}return r}function wE(n){const e=new DataView(n);return e.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):e.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var sr=class extends Error{};function SE(n,e,t,r){return Ne(this,null,function*(){const i=yield n.getBytes(0,16384);if(new DataView(i.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(wE(i.data)<3)return[yield au.getHeader(n)];const o=i.data.slice(0,EE);let a=i.etag;r&&i.etag!=r&&(console.warn("ETag conflict detected; your HTTP server might not support content-based ETag headers. ETags disabled for "+n.getKey()),a=void 0);const c=TE(o,a);if(t){const l=i.data.slice(c.rootDirectoryOffset,c.rootDirectoryOffset+c.rootDirectoryLength),u=n.getKey()+"|"+(c.etag||"")+"|"+c.rootDirectoryOffset+"|"+c.rootDirectoryLength,h=cu(yield e(l,c.internalCompression));return[c,[u,h.length,h]]}return[c,void 0]})}function RE(n,e,t,r,i){return Ne(this,null,function*(){const s=yield n.getBytes(t,r);if(i.etag&&i.etag!==s.etag)throw new sr(s.etag);const o=yield e(s.data,i.internalCompression),a=cu(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}var vE=class{constructor(n=100,e=!0,t=lu){this.cache=new Map,this.maxCacheEntries=n,this.counter=1,this.prefetch=e,this.decompress=t}getHeader(n,e){return Ne(this,null,function*(){const t=n.getKey();if(this.cache.has(t))return this.cache.get(t).lastUsed=this.counter++,yield this.cache.get(t).data;const r=new Promise((i,s)=>{SE(n,this.decompress,this.prefetch,e).then(o=>{o[1]&&this.cache.set(o[1][0],{lastUsed:this.counter++,data:Promise.resolve(o[1][2])}),i(o[0]),this.prune()}).catch(o=>{s(o)})});return this.cache.set(t,{lastUsed:this.counter++,data:r}),r})}getDirectory(n,e,t,r){return Ne(this,null,function*(){const i=n.getKey()+"|"+(r.etag||"")+"|"+e+"|"+t;if(this.cache.has(i))return this.cache.get(i).lastUsed=this.counter++,yield this.cache.get(i).data;const s=new Promise((o,a)=>{RE(n,this.decompress,e,t,r).then(c=>{o(c),this.prune()}).catch(c=>{a(c)})});return this.cache.set(i,{lastUsed:this.counter++,data:s}),s})}getArrayBuffer(n,e,t,r){return Ne(this,null,function*(){const i=n.getKey()+"|"+(r.etag||"")+"|"+e+"|"+t;if(this.cache.has(i))return this.cache.get(i).lastUsed=this.counter++,yield this.cache.get(i).data;const s=new Promise((o,a)=>{n.getBytes(e,t).then(c=>{if(r.etag&&r.etag!==c.etag)throw new sr(c.etag);o(c.data),this.cache.has(i),this.prune()}).catch(c=>{a(c)})});return this.cache.set(i,{lastUsed:this.counter++,data:s}),s})}prune(){if(this.cache.size>=this.maxCacheEntries){let n=1/0,e;this.cache.forEach((t,r)=>{t.lastUsed<n&&(n=t.lastUsed,e=r)}),e&&this.cache.delete(e)}}invalidate(n,e){return Ne(this,null,function*(){this.cache.delete(n.getKey()),yield this.getHeader(n,e)})}},mo=class{constructor(n,e,t){typeof n=="string"?this.source=new bE(n):this.source=n,t?this.decompress=t:this.decompress=lu,e?this.cache=e:this.cache=new vE}getHeader(){return Ne(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(n,e,t,r){return Ne(this,null,function*(){const i=yE(n,e,t),s=yield this.cache.getHeader(this.source);if(s.specVersion<3)return au.getZxy(s,this.source,this.cache,n,e,t,r);if(n<s.minZoom||n>s.maxZoom)return;let o=s.rootDirectoryOffset,a=s.rootDirectoryLength;for(let c=0;c<=3;c++){const l=yield this.cache.getDirectory(this.source,o,a,s),u=xE(l,i);if(u)if(u.runLength>0){const h=yield this.source.getBytes(s.tileDataOffset+u.offset,u.length,r);if(s.etag&&s.etag!==h.etag)throw new sr(h.etag);return{data:yield this.decompress(h.data,s.tileCompression),cacheControl:h.cacheControl,expires:h.expires}}else o=s.leafDirectoryOffset+u.offset,a=u.length;else return}throw Error("Maximum directory depth exceeded")})}getZxy(n,e,t,r){return Ne(this,null,function*(){try{return yield this.getZxyAttempt(n,e,t,r)}catch(i){if(i instanceof sr)return this.cache.invalidate(this.source,i.message),yield this.getZxyAttempt(n,e,t,r);throw i}})}getMetadataAttempt(){return Ne(this,null,function*(){const n=yield this.cache.getHeader(this.source),e=yield this.source.getBytes(n.jsonMetadataOffset,n.jsonMetadataLength);if(n.etag&&n.etag!==e.etag)throw new sr(e.etag);const t=yield this.decompress(e.data,n.internalCompression),r=new TextDecoder("utf-8");return JSON.parse(r.decode(t))})}getMetadata(){return Ne(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(n){if(n instanceof sr)return this.cache.invalidate(this.source,n.message),yield this.getMetadataAttempt();throw n}})}};class PE extends bl{constructor(e){super(De.ERROR),this.error=e}}class ge{constructor(e){this.name=e}toString(){return this.name}}ge.GeoTIFF=new ge("GeoTIFF");ge.ImageStatic=new ge("ImageStatic");ge.PMTilesRaster=new ge("PMTilesRaster");ge.PMTilesVector=new ge("PMTilesVector");ge.TileJSON=new ge("TileJSON");ge.TileWMS=new ge("TileWMS");ge.WMTS=new ge("WMTS");ge.XYZ=new ge("XYZ");class za extends an{constructor(t){super({...t,state:"loading"});ie(this,"loadImage",t=>new Promise((r,i)=>{const s=new Image;s.addEventListener("load",()=>r(s)),s.addEventListener("error",()=>i(new Error("load failed"))),s.src=t}));const r=new mo(t.url);r.getHeader().then(i=>{this.tileGrid.minZoom=i.minZoom,this.tileGrid.maxZoom=i.maxZoom,this.setLoader(async(s,o,a)=>{const c=await r.getZxy(s,o,a),l=URL.createObjectURL(new Blob([c.data])),u=await this.loadImage(l);return URL.revokeObjectURL(l),u}),this.setState("ready")})}}class AE extends ni{constructor(t){super({...t,state:"loading",url:"pmtiles://"+t.url+"/{z}/{x}/{y}",format:new nl});ie(this,"tileLoadFunction",(t,r)=>{const i=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=r.match(i),o=+s[2],a=+s[3],c=+s[4];t.setLoader((l,u,h)=>{t.setState(Y.LOADING),this.pmtiles_.getZxy(o,a,c).then(f=>{if(f){const d=t.getFormat();t.setFeatures(d.readFeatures(f.data,{extent:l,featureProjection:h})),t.setState(Y.LOADED)}else t.setFeatures([]),t.setState(Y.EMPTY)}).catch(f=>{t.setFeatures([]),t.setState(Y.ERROR)})})});this.pmtiles_=new mo(t.url),this.pmtiles_.getHeader().then(r=>{this.tileGrid.minZoom=r.minZoom,this.tileGrid.maxZoom=r.maxZoom,this.setTileLoadFunction(this.tileLoadFunction),this.setState("ready")})}}const LE=new Cr({fill:new Ni({color:"rgba(255,255,255,0.4)"}),stroke:new Br({color:"#3399CC",width:3})}),IE=new Cr({stroke:new Br({color:"#ff9933",width:1})});function CE(n,e){const t={url:n.getAbsoluteUrl()};let r=null;n.getBands().length===1&&(r=0);const{minimum:i,maximum:s}=n.getMinMaxValues(r);typeof i=="number"&&(t.min=i),typeof s=="number"&&(t.max=s);const o=n.getNoDataValues(r);return o.length>0&&(t.nodata=o[0]),e.length>0&&(t.bands=e),t}async function ka(n,e=void 0){let t=e;if(th()){const r=n.getMetadata("proj:epsg");if(r)try{t=await rh(r)}catch{}}return t}function $a(n,e){const t=n.clone();return e.hasOnlyBounds()||t.setFill(null),t}function FE(n){let e=n.href;if(e.includes("{s}"))if(Array.isArray(n["href:servers"])&&n["href:servers"].length>0){const t=Math.random()*n["href:servers"].length|0;e=e.replace("{s}",n["href:servers"][t])}else return null;return e}async function OE(n){try{const e=new URL(n);e.searchParams.set("service","wmts"),e.searchParams.set("request","GetCapabilities");const t=await fetch(e);return new zs().read(await t.text())}catch{return null}}class _o extends wl{constructor(e){const t={};if(["opacity","visible","zIndex","minResolution","maxResolution","minZoom","maxZoom","properties"].forEach(r=>t[r]=e[r]),super(t),this.getSourceOptions_=e.getSourceOptions,this.data_,this.assets_=null,this.bands_=[],this.crossOrigin_=e.crossOrigin||null,this.displayFootprint_=e.displayFootprint!==!1,this.displayGeoTiffByDefault_=!!e.displayGeoTiffByDefault,this.displayPreview_=!!e.displayPreview,this.displayOverview_=e.displayOverview!==!1,this.displayWebMapLink_=e.displayWebMapLink||!1,this.buildTileUrlTemplate_=e.buildTileUrlTemplate||null,this.useTileLayerAsFallback_=e.useTileLayerAsFallback||!1,this.boundsStyle_=e.boundsStyle||LE,this.collectionStyle_=e.collectionStyle||IE,this.boundsLayer_=null,e.data){try{this.configure_(e.data,e.url,e.assets,e.bands)}catch(r){this.handleError_(r)}return}if(!e.url)throw new Error("Either url or data must be provided");fetch(e.url).then(r=>r.json()).then(r=>this.configure_(r,e.url,e.assets,e.bands)).catch(r=>this.handleError_(r))}getBoundsLayer(){return this.boundsLayer_}handleError_(e){this.dispatchEvent(new PE(e))}configure_(e,t=null,r=null,i=[]){e instanceof yi||e instanceof qh?this.data_=e:this.data_=$0(e),t&&t.includes("://")&&this.data_.setAbsoluteUrl(t),this.bands_=i,this.boundsLayer_=this.addFootprint_();const s=()=>{this.boundsLayer_&&this.boundsLayer_.setStyle($a(this.boundsStyle_,this))};this.getLayers().on("add",s),this.getLayers().on("remove",s),this.setAssets(r).then(()=>this.dispatchEvent("assetsready")).catch(o=>this.handleError_(o)),this.dispatchEvent("sourceready")}async addApiCollection_(){const e=this.getData().getAll().map(t=>{const r=new _o({data:t,crossOrigin:this.crossOrigin_,boundsStyle:this.collectionStyle_,displayGeoTiffByDefault:this.displayGeoTiffByDefault_,displayOverview:this.displayOverview_,displayPreview:this.displayPreview_,displayFootprint:this.displayFootprint_});return this.addLayer_(r),r});return await Promise.all(e)}async addStacAssets_(){let e=this.getAssets();if(e===null){e=[];const r=this.getData().getDefaultGeoTIFF(!0,!this.displayGeoTiffByDefault_);if(r)e.push(r);else{const i=this.getData().getThumbnails().filter(s=>!Array.isArray(s.roles)||!s.roles.includes("example"));i.length>0&&e.push(i[0])}}const t=e.map(r=>this.addImagery_(r));return await Promise.all(t)}async addImagery_(e){if(e){if(e.isGeoTIFF())return await this.addGeoTiff_(e);if(e.canBrowserDisplayImage())return await this.addThumbnail_(e)}}async addThumbnail_(e){if(!this.displayPreview_)return;let t={url:e.getAbsoluteUrl(),projection:await ka(e,"EPSG:4326"),imageExtent:e.getContext().getBoundingBox(),crossOrigin:this.crossOrigin_};this.getSourceOptions_&&(t=await this.getSourceOptions_(ge.ImageStatic,t,e));const r=new gs({source:new Gc(t)});return this.addLayer_(r,e),r}async addWebMapLinks_(){const e=this.getWebMapLinks();if(e.length>0)return await this.addLayerForLink(e[0])}async addLayerForLink(e){const t=FE(e);if(!t)return;const r={attributions:e.getMetadata("attribution")||this.data_.getMetadata("attribution"),crossOrigin:this.crossOrigin_,url:t},i=async(o,a)=>(this.getSourceOptions_&&(a=await this.getSourceOptions_(o,a,e)),a),s=[];switch(e.rel){case"pmtiles":const a=await new mo(r.url).getHeader();let c;switch(a.tileType){case rr.Mvt:c=new AE(await i(ge.PMTilesVector,r));break;case rr.Avif:case rr.Jpeg:case rr.Png:case rr.Webp:c=new za(await i(ge.PMTilesRaster,r));break;default:return}s.push(c);break;case"tilejson":s.push(new Zc(await i(ge.TileJSON,r)));break;case"wms":if(!Array.isArray(e["wms:layers"]))break;for(const h in e["wms:layers"]){const f=e["wms:layers"][h]||"";let d="";Array.isArray(e["wms:styles"])&&typeof e["wms:styles"][h]=="string"&&(d=e["wms:styles"][h]);const g=Object.assign({LAYERS:f,STYLES:d},e["wms:dimensions"]);typeof e["wms:transparent"]=="boolean"&&(g.TRANSPARENT=String(e["wms:transparent"])),typeof e.type=="string"&&e.type.startsWith("image/")&&(g.FORMAT=e.type);const p=await i(ge.TileWMS,Object.assign({},r,{params:g}));s.push(new fl(p))}break;case"wmts":const l=await OE(t);if(!l)return;const u=Array.isArray(e["wmts:layer"])?e["wmts:layer"]:[e["wmts:layer"]];for(const h of u){let f=Object.assign({},r,{layer:h});typeof e.type=="string"&&e.type.startsWith("image/")&&(f.format=e.type),f=await i(ge.WMTS,f),s.push(new dl(gl(l,f)))}break;case"xyz":s.push(new $r(await i(ge.XYZ,r)));break;default:return}return s.map(o=>{let a;return o instanceof ni?a=new al({source:o,declutter:!0}):o instanceof za?a=new jn({source:o}):a=new Fn({source:o}),this.addLayer_(a,e),a})}async addGeoTiff_(e){if(!this.displayOverview_)return;if(this.buildTileUrlTemplate_&&!this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);let r={sources:[CE(e,this.bands_)]};const i=await ka(e);i&&(r.projection=i),this.getSourceOptions_&&(r=await this.getSourceOptions_(ge.GeoTIFF,r,e));const s=async(o,a)=>(a&&this.getLayers().remove(a),await this.addTileLayerForImagery_(o));try{const o=new fo(r),a=new jn({source:o});if(this.useTileLayerAsFallback_){const c=()=>s(e,a);o.on("error",c),o.on("tileloaderror",c),o.on("change",()=>{o.getState()==="error"&&s(e,a)}),a.on("error",c),await o.getView()}return this.addLayer_(a,e),a}catch(o){if(this.useTileLayerAsFallback_)return await s(e,null);this.handleError_(o)}}async addTileLayerForImagery_(e){let t={crossOrigin:this.crossOrigin_,url:this.buildTileUrlTemplate_(e)};this.getSourceOptions_&&(t=await this.getSourceOptions_(ge.XYZ,t,e));const r=new Fn({source:new $r(t)});return this.addLayer_(r,e),r}addLayer_(e,t,r=0){e.set("stac",t),e.setZIndex(r),this.getLayers().push(e)}addFootprint_(){let e=null;const t=this.getData();if(t.isItemCollection()||t.isCollectionCollection()?e=Kh(t.getBoundingBox()):e=t.toGeoJSON(),e){const r=new xs,i=new qr({format:r,loader:(o,a,c)=>{const l=r.readFeatures(e,{featureProjection:c});i.addFeatures(l)}}),s=new ls({source:i,style:$a(this.boundsStyle_,this),visible:this.displayFootprint_});return s.set("bounds",!0),this.addLayer_(s,t,1),s}return null}async updateLayers_(){const e=this.getLayers();for(let r=e.getLength()-1;r>=0;r--){const s=e.item(r).get("stac");s&&(s.isLink()||s.isAsset())&&e.removeAt(r)}const t=this.getData();t.isItemCollection()||t.isCollectionCollection()?await this.addApiCollection_():(t.isItem()||t.isCollection())&&await this.addStacAssets_(),this.displayWebMapLink_&&(Array.isArray(this.displayWebMapLink_)||this.hasOnlyBounds())&&await this.addWebMapLinks_()}hasOnlyBounds(){const e=this.getBoundsLayer();return typeof this.getLayersArray().find(r=>r!==e)>"u"}getWebMapLinks(){let e=["xyz","tilejson","pmtiles","wmts","wms"];typeof this.displayWebMapLink_=="string"&&(e=[this.displayWebMapLink_]);let t=this.data_.getLinksWithRels(e);return Array.isArray(this.displayWebMapLink_)?t=this.displayWebMapLink_.map(r=>{if(typeof r=="string"){const i=t.find(s=>s.id===r);return i||null}return r}).filter(r=>!!r):t.sort((r,i)=>{const s=e.indexOf(r.rel),o=e.indexOf(i.rel);return s-o}),t}async setAssets(e){Array.isArray(e)?this.assets_=e.map(t=>typeof t=="string"?this.getData().getAsset(t):t instanceof yi?t:new yi(t)):this.assets_=null,await this.updateLayers_()}getData(){return this.data_}getAssets(){return this.assets_}getExtent(){if(!this.boundsLayer_)return;const e=this.boundsLayer_.getMapInternal();if(!e)return;const t=e.getView();if(!t)return;const r=this.getData();if(!r)return;const i=r.getBoundingBox();if(i)return _l(i,"EPSG:4326",t.getProjection())}}nh(ih);window.eoxMapAdvancedOlLayers={...Hm,STAC:_o};class ME extends bt{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,tilePixelRatio:e.tilePixelRatio,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection,wrapX:e.wrapX}),this.version_=e.version!==void 0?e.version:"1.0.0",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,fetch(e.url).then(t=>t.text()).then(t=>new window.DOMParser().parseFromString(t,"application/xml")).then(t=>{this.handleCapabilitiesResponse(t,e)})}handleCapabilitiesResponse(e,t){const i=new zs().read(e),s=gl(i,t);this.crossOrigin=s.crossOrigin,this.projection=s.projection,this.tileGrid=s.tileGrid,this.requestEncoding_=s.requestEncoding,this.matrixSet_=s.matrixSet,this.style_=s.style,this.format_=s.format,this.dimensions_=s.dimensions,this.setUrls(s.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=ps(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.setState("ready")}createFromWMTSTemplate(e){const t=this.requestEncoding_,r={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};t==="KVP"&&Object.assign(r,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=t==="KVP"?On(e,r):e.replace(/\{(\w+?)\}/g,(o,a)=>a.toLowerCase()in r?r[a.toLowerCase()]:o);const i=this.tileGrid,s=this.dimensions_;return function(o){if(!o)return;const a={TileMatrix:i.getMatrixId(o[0]),TileCol:o[1],TileRow:o[2]};Object.assign(a,s);let c=e;return t==="KVP"?c=On(c,a):c=c.replace(/\{(\w+?)\}/g,(l,u)=>a[u]),c}}}var K,Ce=((K={})[K.Unknown=0]="Unknown",K[K.Point=1]="Point",K[K.LineString=2]="LineString",K[K.Polygon=3]="Polygon",K[K.MultiPoint=4]="MultiPoint",K[K.MultiLineString=5]="MultiLineString",K[K.MultiPolygon=6]="MultiPolygon",K[K.GeometryCollection=7]="GeometryCollection",K[K.CircularString=8]="CircularString",K[K.CompoundCurve=9]="CompoundCurve",K[K.CurvePolygon=10]="CurvePolygon",K[K.MultiCurve=11]="MultiCurve",K[K.MultiSurface=12]="MultiSurface",K[K.Curve=13]="Curve",K[K.Surface=14]="Surface",K[K.PolyhedralSurface=15]="PolyhedralSurface",K[K.TIN=16]="TIN",K[K.Triangle=17]="Triangle",K);const Ar=4,Lr=4,un=4,wt=new Int32Array(2),Va=new Float32Array(wt.buffer),ja=new Float64Array(wt.buffer),Tn=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;var ns;(function(n){n[n.UTF8_BYTES=1]="UTF8_BYTES",n[n.UTF16_STRING=2]="UTF16_STRING"})(ns||(ns={}));class xt{constructor(e){this.bytes_=e,this.position_=0,this.text_decoder_=new TextDecoder}static allocate(e){return new xt(new Uint8Array(e))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(e){this.position_=e}capacity(){return this.bytes_.length}readInt8(e){return this.readUint8(e)<<24>>24}readUint8(e){return this.bytes_[e]}readInt16(e){return this.readUint16(e)<<16>>16}readUint16(e){return this.bytes_[e]|this.bytes_[e+1]<<8}readInt32(e){return this.bytes_[e]|this.bytes_[e+1]<<8|this.bytes_[e+2]<<16|this.bytes_[e+3]<<24}readUint32(e){return this.readInt32(e)>>>0}readInt64(e){return BigInt.asIntN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readUint64(e){return BigInt.asUintN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readFloat32(e){return wt[0]=this.readInt32(e),Va[0]}readFloat64(e){return wt[Tn?0:1]=this.readInt32(e),wt[Tn?1:0]=this.readInt32(e+4),ja[0]}writeInt8(e,t){this.bytes_[e]=t}writeUint8(e,t){this.bytes_[e]=t}writeInt16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeUint16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeInt32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeUint32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeInt64(e,t){this.writeInt32(e,Number(BigInt.asIntN(32,t))),this.writeInt32(e+4,Number(BigInt.asIntN(32,t>>BigInt(32))))}writeUint64(e,t){this.writeUint32(e,Number(BigInt.asUintN(32,t))),this.writeUint32(e+4,Number(BigInt.asUintN(32,t>>BigInt(32))))}writeFloat32(e,t){Va[0]=t,this.writeInt32(e,wt[0])}writeFloat64(e,t){ja[0]=t,this.writeInt32(e,wt[Tn?0:1]),this.writeInt32(e+4,wt[Tn?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+Ar+Lr)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let e="";for(let t=0;t<Lr;t++)e+=String.fromCharCode(this.readInt8(this.position_+Ar+t));return e}__offset(e,t){const r=e-this.readInt32(e);return t<this.readInt16(r)?this.readInt16(r+t):0}__union(e,t){return e.bb_pos=t+this.readInt32(t),e.bb=this,e}__string(e,t){e+=this.readInt32(e);const r=this.readInt32(e);e+=Ar;const i=this.bytes_.subarray(e,e+r);return t===ns.UTF8_BYTES?i:this.text_decoder_.decode(i)}__union_with_string(e,t){return typeof e=="string"?this.__string(t):this.__union(e,t)}__indirect(e){return e+this.readInt32(e)}__vector(e){return e+this.readInt32(e)+Ar}__vector_len(e){return this.readInt32(e+this.readInt32(e))}__has_identifier(e){if(e.length!=Lr)throw new Error("FlatBuffers: file identifier must be length "+Lr);for(let t=0;t<Lr;t++)if(e.charCodeAt(t)!=this.readInt8(this.position()+Ar+t))return!1;return!0}createScalarList(e,t){const r=[];for(let i=0;i<t;++i){const s=e(i);s!==null&&r.push(s)}return r}createObjList(e,t){const r=[];for(let i=0;i<t;++i){const s=e(i);s!==null&&r.push(s.unpack())}return r}}class Me{constructor(){ie(this,"bb",null);ie(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsGeometry(e,t){return(t||new Me).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsGeometry(e,t){return e.setPosition(e.position()+un),(t||new Me).__init(e.readInt32(e.position())+e.position(),e)}ends(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.readUint32(this.bb.__vector(this.bb_pos+t)+4*e):0}endsLength(){let e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__vector_len(this.bb_pos+e):0}endsArray(){let e=this.bb.__offset(this.bb_pos,4);return e?new Uint32Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}xy(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}xyLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}xyArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}z(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}zLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}zArray(){let e=this.bb.__offset(this.bb_pos,8);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}m(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}mLength(){let e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__vector_len(this.bb_pos+e):0}mArray(){let e=this.bb.__offset(this.bb_pos,10);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}t(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}tLength(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.__vector_len(this.bb_pos+e):0}tArray(){let e=this.bb.__offset(this.bb_pos,12);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}tm(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readUint64(this.bb.__vector(this.bb_pos+t)+8*e):BigInt(0)}tmLength(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.__vector_len(this.bb_pos+e):0}type(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readUint8(this.bb_pos+e):Ce.Unknown}parts(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Me).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}partsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}static startGeometry(e){e.startObject(8)}static addEnds(e,t){e.addFieldOffset(0,t,0)}static createEndsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addInt32(t[r]);return e.endVector()}static startEndsVector(e,t){e.startVector(4,t,4)}static addXy(e,t){e.addFieldOffset(1,t,0)}static createXyVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startXyVector(e,t){e.startVector(8,t,8)}static addZ(e,t){e.addFieldOffset(2,t,0)}static createZVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startZVector(e,t){e.startVector(8,t,8)}static addM(e,t){e.addFieldOffset(3,t,0)}static createMVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startMVector(e,t){e.startVector(8,t,8)}static addT(e,t){e.addFieldOffset(4,t,0)}static createTVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startTVector(e,t){e.startVector(8,t,8)}static addTm(e,t){e.addFieldOffset(5,t,0)}static createTmVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addInt64(t[r]);return e.endVector()}static startTmVector(e,t){e.startVector(8,t,8)}static addType(e,t){e.addFieldInt8(6,t,Ce.Unknown)}static addParts(e,t){e.addFieldOffset(7,t,0)}static createPartsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startPartsVector(e,t){e.startVector(4,t,4)}static endGeometry(e){return e.endObject()}static createGeometry(e,t,r,i,s,o,a,c,l){return Me.startGeometry(e),Me.addEnds(e,t),Me.addXy(e,r),Me.addZ(e,i),Me.addM(e,s),Me.addT(e,o),Me.addTm(e,a),Me.addType(e,c),Me.addParts(e,l),Me.endGeometry(e)}}function Oi(n,e){let t=[];for(let r=0;r<n.length;r+=2){let i=[n[r],n[r+1]];e&&i.push(e[r>>1]),t.push(i)}return t}function is(n,e){let t=e;if(t===Ce.Unknown&&(t=n.type()),t===Ce.GeometryCollection){let i=[];for(let s=0;s<n.partsLength();s++){let o=n.parts(s),a=o.type();i.push(is(o,a))}return{type:Ce[t],geometries:i}}if(t===Ce.MultiPolygon){let i=[];for(let s=0;s<n.partsLength();s++)i.push(is(n.parts(s),Ce.Polygon));return{type:Ce[t],coordinates:i.map(s=>s.coordinates)}}let r=function(i,s){let o=i.xyArray(),a=i.zArray();switch(s){case Ce.Point:{let c=Array.from(o);return a&&c.push(a[0]),c}case Ce.MultiPoint:case Ce.LineString:return Oi(o,a);case Ce.MultiLineString:case Ce.Polygon:return function(c,l,u){let h;if(!u||u.length===0)return[Oi(c,l)];let f=0,d=Array.from(u).map(g=>c.slice(f,f=g<<1));return l&&(f=0,h=Array.from(u).map(g=>l.slice(f,f=g))),d.map((g,p)=>Oi(g,h?h[p]:void 0))}(o,a,i.endsArray())}}(n,t);return{type:Ce[t],coordinates:r}}var se,ve=((se={})[se.Byte=0]="Byte",se[se.UByte=1]="UByte",se[se.Bool=2]="Bool",se[se.Short=3]="Short",se[se.UShort=4]="UShort",se[se.Int=5]="Int",se[se.UInt=6]="UInt",se[se.Long=7]="Long",se[se.ULong=8]="ULong",se[se.Float=9]="Float",se[se.Double=10]="Double",se[se.String=11]="String",se[se.Json=12]="Json",se[se.DateTime=13]="DateTime",se[se.Binary=14]="Binary",se);class Se{constructor(){ie(this,"bb",null);ie(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsColumn(e,t){return(t||new Se).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsColumn(e,t){return e.setPosition(e.position()+un),(t||new Se).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}type(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readUint8(this.bb_pos+e):ve.Byte}title(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}width(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.readInt32(this.bb_pos+e):-1}precision(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readInt32(this.bb_pos+e):-1}scale(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readInt32(this.bb_pos+e):-1}nullable(){let e=this.bb.__offset(this.bb_pos,18);return!e||!!this.bb.readInt8(this.bb_pos+e)}unique(){let e=this.bb.__offset(this.bb_pos,20);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}primaryKey(){let e=this.bb.__offset(this.bb_pos,22);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}metadata(e){let t=this.bb.__offset(this.bb_pos,24);return t?this.bb.__string(this.bb_pos+t,e):null}static startColumn(e){e.startObject(11)}static addName(e,t){e.addFieldOffset(0,t,0)}static addType(e,t){e.addFieldInt8(1,t,ve.Byte)}static addTitle(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWidth(e,t){e.addFieldInt32(4,t,-1)}static addPrecision(e,t){e.addFieldInt32(5,t,-1)}static addScale(e,t){e.addFieldInt32(6,t,-1)}static addNullable(e,t){e.addFieldInt8(7,+t,1)}static addUnique(e,t){e.addFieldInt8(8,+t,0)}static addPrimaryKey(e,t){e.addFieldInt8(9,+t,0)}static addMetadata(e,t){e.addFieldOffset(10,t,0)}static endColumn(e){let t=e.endObject();return e.requiredField(t,4),t}static createColumn(e,t,r,i,s,o,a,c,l,u,h,f){return Se.startColumn(e),Se.addName(e,t),Se.addType(e,r),Se.addTitle(e,i),Se.addDescription(e,s),Se.addWidth(e,o),Se.addPrecision(e,a),Se.addScale(e,c),Se.addNullable(e,l),Se.addUnique(e,u),Se.addPrimaryKey(e,h),Se.addMetadata(e,f),Se.endColumn(e)}}class qe{constructor(){ie(this,"bb",null);ie(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsFeature(e,t){return(t||new qe).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsFeature(e,t){return e.setPosition(e.position()+un),(t||new qe).__init(e.readInt32(e.position())+e.position(),e)}geometry(e){let t=this.bb.__offset(this.bb_pos,4);return t?(e||new Me).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}properties(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readUint8(this.bb.__vector(this.bb_pos+t)+e):0}propertiesLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}propertiesArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Uint8Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}columns(e,t){let r=this.bb.__offset(this.bb_pos,8);return r?(t||new Se).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}static startFeature(e){e.startObject(3)}static addGeometry(e,t){e.addFieldOffset(0,t,0)}static addProperties(e,t){e.addFieldOffset(1,t,0)}static createPropertiesVector(e,t){e.startVector(1,t.length,1);for(let r=t.length-1;r>=0;r--)e.addInt8(t[r]);return e.endVector()}static startPropertiesVector(e,t){e.startVector(1,t,1)}static addColumns(e,t){e.addFieldOffset(2,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static endFeature(e){return e.endObject()}static finishFeatureBuffer(e,t){e.finish(t)}static finishSizePrefixedFeatureBuffer(e,t){e.finish(t,void 0,!0)}static createFeature(e,t,r,i){return qe.startFeature(e),qe.addGeometry(e,t),qe.addProperties(e,r),qe.addColumns(e,i),qe.endFeature(e)}}new TextEncoder;let Xa=new TextDecoder;function NE(n,e){let t={};if(!e||e.length===0)return t;let r=n.propertiesArray();if(!r)return t;let i=new DataView(r.buffer,r.byteOffset),s=n.propertiesLength(),o=0;for(;o<s;){let a=i.getUint16(o,!0);o+=2;let c=e[a],l=c.name;switch(c.type){case ve.Bool:t[l]=!!i.getUint8(o),o+=1;break;case ve.Byte:t[l]=i.getInt8(o),o+=1;break;case ve.UByte:t[l]=i.getUint8(o),o+=1;break;case ve.Short:t[l]=i.getInt16(o,!0),o+=2;break;case ve.UShort:t[l]=i.getUint16(o,!0),o+=2;break;case ve.Int:t[l]=i.getInt32(o,!0),o+=4;break;case ve.UInt:t[l]=i.getUint32(o,!0),o+=4;break;case ve.Long:t[l]=Number(i.getBigInt64(o,!0)),o+=8;break;case ve.ULong:t[l]=Number(i.getBigUint64(o,!0)),o+=8;break;case ve.Float:t[l]=i.getFloat32(o,!0),o+=4;break;case ve.Double:t[l]=i.getFloat64(o,!0),o+=8;break;case ve.DateTime:case ve.String:{let u=i.getUint32(o,!0);o+=4,t[l]=Xa.decode(r.subarray(o,o+u)),o+=u;break}case ve.Json:{let u=i.getUint32(o,!0);o+=4;let h=Xa.decode(r.subarray(o,o+u));t[l]=JSON.parse(h),o+=u;break}case ve.Binary:{let u=i.getUint32(o,!0);o+=4,t[l]=r.subarray(o,o+u),o+=u;break}default:throw Error("Unknown type "+c.type)}}return t}function yo(n,e,t){let r=t.columns;return{type:"Feature",id:n,geometry:is(e.geometry(),t.geometryType),properties:NE(e,r)}}const Eo=new Uint8Array(0);function DE(){return this._source.cancel()}function UE(n,e){if(!n.length)return e;if(!e.length)return n;var t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function BE(){var n=this,e=n._array.subarray(n._index);return n._source.read().then(function(t){return n._array=Eo,n._index=0,t.done?e.length>0?{done:!1,value:e}:{done:!0,value:void 0}:{done:!1,value:UE(e,t.value)}})}function GE(n){if((n|=0)<0)throw new Error("invalid length");var e=this,t=this._array.length-this._index;if(this._index+n<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=n));var r=new Uint8Array(n);return r.set(this._array.subarray(this._index)),function i(){return e._source.read().then(function(s){return s.done?(e._array=Eo,e._index=0,t>0?r.subarray(0,t):null):t+s.value.length>=n?(e._array=s.value,e._index=n-t,r.set(s.value.subarray(0,n-t),t),r):(r.set(s.value,t),t+=s.value.length,i())})}()}function zE(n){return typeof n.slice=="function"?n:new di(typeof n.read=="function"?n:n.getReader())}function di(n){this._source=n,this._array=Eo,this._index=0}di.prototype.read=BE;di.prototype.slice=GE;di.prototype.cancel=DE;class Xe{constructor(){ie(this,"bb",null);ie(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsCrs(e,t){return(t||new Xe).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsCrs(e,t){return e.setPosition(e.position()+un),(t||new Xe).__init(e.readInt32(e.position())+e.position(),e)}org(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}code(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt32(this.bb_pos+e):0}name(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}wkt(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.__string(this.bb_pos+t,e):null}codeString(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.__string(this.bb_pos+t,e):null}static startCrs(e){e.startObject(6)}static addOrg(e,t){e.addFieldOffset(0,t,0)}static addCode(e,t){e.addFieldInt32(1,t,0)}static addName(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWkt(e,t){e.addFieldOffset(4,t,0)}static addCodeString(e,t){e.addFieldOffset(5,t,0)}static endCrs(e){return e.endObject()}static createCrs(e,t,r,i,s,o,a){return Xe.startCrs(e),Xe.addOrg(e,t),Xe.addCode(e,r),Xe.addName(e,i),Xe.addDescription(e,s),Xe.addWkt(e,o),Xe.addCodeString(e,a),Xe.endCrs(e)}}class Wn{constructor(){ie(this,"bb",null);ie(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsHeader(e,t){return(t||new Wn).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsHeader(e,t){return e.setPosition(e.position()+un),(t||new Wn).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}envelope(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}envelopeLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}envelopeArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}geometryType(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.readUint8(this.bb_pos+e):Ce.Unknown}hasZ(){let e=this.bb.__offset(this.bb_pos,10);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasM(){let e=this.bb.__offset(this.bb_pos,12);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasT(){let e=this.bb.__offset(this.bb_pos,14);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasTm(){let e=this.bb.__offset(this.bb_pos,16);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}columns(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Se).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}featuresCount(){let e=this.bb.__offset(this.bb_pos,20);return e?this.bb.readUint64(this.bb_pos+e):BigInt("0")}indexNodeSize(){let e=this.bb.__offset(this.bb_pos,22);return e?this.bb.readUint16(this.bb_pos+e):16}crs(e){let t=this.bb.__offset(this.bb_pos,24);return t?(e||new Xe).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}title(e){let t=this.bb.__offset(this.bb_pos,26);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,28);return t?this.bb.__string(this.bb_pos+t,e):null}metadata(e){let t=this.bb.__offset(this.bb_pos,30);return t?this.bb.__string(this.bb_pos+t,e):null}static startHeader(e){e.startObject(14)}static addName(e,t){e.addFieldOffset(0,t,0)}static addEnvelope(e,t){e.addFieldOffset(1,t,0)}static createEnvelopeVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startEnvelopeVector(e,t){e.startVector(8,t,8)}static addGeometryType(e,t){e.addFieldInt8(2,t,Ce.Unknown)}static addHasZ(e,t){e.addFieldInt8(3,+t,0)}static addHasM(e,t){e.addFieldInt8(4,+t,0)}static addHasT(e,t){e.addFieldInt8(5,+t,0)}static addHasTm(e,t){e.addFieldInt8(6,+t,0)}static addColumns(e,t){e.addFieldOffset(7,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static addFeaturesCount(e,t){e.addFieldInt64(8,t,BigInt("0"))}static addIndexNodeSize(e,t){e.addFieldInt16(9,t,16)}static addCrs(e,t){e.addFieldOffset(10,t,0)}static addTitle(e,t){e.addFieldOffset(11,t,0)}static addDescription(e,t){e.addFieldOffset(12,t,0)}static addMetadata(e,t){e.addFieldOffset(13,t,0)}static endHeader(e){return e.endObject()}static finishHeaderBuffer(e,t){e.finish(t)}static finishSizePrefixedHeaderBuffer(e,t){e.finish(t,void 0,!0)}}function xo(n){let e=Wn.getRootAsHeader(n),t=e.featuresCount(),r=e.indexNodeSize(),i=[];for(let a=0;a<e.columnsLength();a++){let c=e.columns(a);if(!c)throw Error("Column unexpectedly missing");if(!c.name())throw Error("Column name unexpectedly missing");i.push({name:c.name(),type:c.type(),title:c.title(),description:c.description(),width:c.width(),precision:c.precision(),scale:c.scale(),nullable:c.nullable(),unique:c.unique(),primary_key:c.primaryKey()})}let s=e.crs(),o=s?{org:s.org(),code:s.code(),name:s.name(),description:s.description(),wkt:s.wkt(),code_string:s.codeString()}:null;return{geometryType:e.geometryType(),columns:i,envelope:null,featuresCount:Number(t),indexNodeSize:r,crs:o,title:e.title(),description:e.description(),metadata:e.metadata()}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var ss=function(n,e){return ss=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])},ss(n,e)};function kE(n,e){ss(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function dr(n,e,t,r){function i(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{l(r.next(u))}catch(h){o(h)}}function c(u){try{l(r.throw(u))}catch(h){o(h)}}function l(u){u.done?s(u.value):i(u.value).then(a,c)}l((r=r.apply(n,[])).next())})}function Ct(n,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},r,i,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(u){return c([l,u])}}function c(l){if(r)throw new TypeError("Generator is already executing.");for(;t;)try{if(r=1,i&&(s=l[0]&2?i.return:l[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,l[1])).done)return s;switch(i=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,i=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(n,t)}catch(u){l=[6,u],i=0}finally{r=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Sr(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],r=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&r>=n.length&&(n=void 0),{value:n&&n[r++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Yr(n){return this instanceof Yr?(this.v=n,this):new Yr(n)}function $E(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),i,s=[];return i={},o("next"),o("throw"),o("return"),i[Symbol.asyncIterator]=function(){return this},i;function o(f){r[f]&&(i[f]=function(d){return new Promise(function(g,p){s.push([f,d,g,p])>1||a(f,d)})})}function a(f,d){try{c(r[f](d))}catch(g){h(s[0][3],g)}}function c(f){f.value instanceof Yr?Promise.resolve(f.value.v).then(l,u):h(s[0][2],f)}function l(f){a("next",f)}function u(f){a("throw",f)}function h(f,d){f(d),s.shift(),s.length&&a(s[0][0],s[0][1])}}var uu=function(n){kE(e,n);function e(t){var r=n.call(this,t)||this;return Object.defineProperty(r,"name",{value:"RepeaterOverflowError",enumerable:!1}),typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(r,r.constructor.prototype):r.__proto__=r.constructor.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(r,r.constructor),r}return e}(Error);(function(){function n(e){if(e<0)throw new RangeError("Capacity may not be less than 0");this._c=e,this._q=[]}return Object.defineProperty(n.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"full",{get:function(){return this._q.length>=this._c},enumerable:!1,configurable:!0}),n.prototype.add=function(e){if(this.full)throw new Error("Buffer full");this._q.push(e)},n.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},n})();(function(){function n(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(n.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),n.prototype.add=function(e){for(;this._q.length>=this._c;)this._q.shift();this._q.push(e)},n.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},n})();(function(){function n(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(n.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),n.prototype.add=function(e){this._q.length<this._c&&this._q.push(e)},n.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},n})();function os(n){n!=null&&typeof n.then=="function"&&n.then(Yn,Yn)}var Mi=0,Wa=1,Vt=2,Hn=3,as=4,Zn=1024,Yn=function(){};function ar(n){var e=n.err,t=Promise.resolve(n.execution).then(function(r){if(e!=null)throw e;return r});return n.err=void 0,n.execution=t.then(function(){},function(){}),n.pending===void 0?t:n.pending.then(function(){return t})}function Gt(n,e){var t=n.state>=Hn;return Promise.resolve(e).then(function(r){return!t&&n.state>=as?ar(n).then(function(i){return{value:i,done:!0}}):{value:r,done:t}})}function bo(n,e){var t,r;if(!(n.state>=Vt))if(n.state=Vt,n.onnext(),n.onstop(),n.err==null&&(n.err=e),n.pushes.length===0&&(typeof n.buffer>"u"||n.buffer.empty))Ur(n);else try{for(var i=Sr(n.pushes),s=i.next();!s.done;s=i.next()){var o=s.value;o.resolve()}}catch(a){t={error:a}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}}function Ur(n){var e,t;if(!(n.state>=Hn)){n.state<Vt&&bo(n),n.state=Hn,n.buffer=void 0;try{for(var r=Sr(n.nexts),i=r.next();!i.done;i=r.next()){var s=i.value,o=n.pending===void 0?ar(n):n.pending.then(function(){return ar(n)});s.resolve(Gt(n,o))}}catch(a){e={error:a}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}n.pushes=[],n.nexts=[]}}function Ha(n){n.state>=as||(n.state<Hn&&Ur(n),n.state=as)}function VE(n,e){if(os(e),n.pushes.length>=Zn)throw new uu("No more than "+Zn+" pending calls to push are allowed on a single repeater.");if(n.state>=Vt)return Promise.resolve(void 0);var t=n.pending===void 0?Promise.resolve(e):n.pending.then(function(){return e});t=t.catch(function(c){n.state<Vt&&(n.err=c),Ha(n)});var r;if(n.nexts.length){var i=n.nexts.shift();i.resolve(Gt(n,t)),n.nexts.length?r=Promise.resolve(n.nexts[0].value):typeof n.buffer<"u"&&!n.buffer.full?r=Promise.resolve(void 0):r=new Promise(function(c){return n.onnext=c})}else typeof n.buffer<"u"&&!n.buffer.full?(n.buffer.add(t),r=Promise.resolve(void 0)):r=new Promise(function(c){return n.pushes.push({resolve:c,value:t})});var s=!0,o={},a=r.catch(function(c){if(s)throw c});return o.then=function(c,l){return s=!1,Promise.prototype.then.call(r,c,l)},o.catch=function(c){return s=!1,Promise.prototype.catch.call(r,c)},o.finally=r.finally.bind(r),n.pending=t.then(function(){return a}).catch(function(c){n.err=c,Ha(n)}),o}function jE(n){var e=bo.bind(null,n),t=new Promise(function(r){return n.onstop=r});return e.then=t.then.bind(t),e.catch=t.catch.bind(t),e.finally=t.finally.bind(t),e}function XE(n){if(!(n.state>=Wa)){n.state=Wa;var e=VE.bind(null,n),t=jE(n);n.execution=new Promise(function(r){return r(n.executor(e,t))}),n.execution.catch(function(){return bo(n)})}}var wn=new WeakMap,hn=function(){function n(e,t){wn.set(this,{executor:e,buffer:t,err:void 0,state:Mi,pushes:[],nexts:[],pending:void 0,execution:void 0,onnext:Yn,onstop:Yn})}return n.prototype.next=function(e){os(e);var t=wn.get(this);if(t===void 0)throw new Error("WeakMap error");if(t.nexts.length>=Zn)throw new uu("No more than "+Zn+" pending calls to next are allowed on a single repeater.");if(t.state<=Mi&&XE(t),t.onnext(e),typeof t.buffer<"u"&&!t.buffer.empty){var r=Gt(t,t.buffer.remove());if(t.pushes.length){var i=t.pushes.shift();t.buffer.add(i.value),t.onnext=i.resolve}return r}else if(t.pushes.length){var s=t.pushes.shift();return t.onnext=s.resolve,Gt(t,s.value)}else if(t.state>=Vt)return Ur(t),Gt(t,ar(t));return new Promise(function(o){return t.nexts.push({resolve:o,value:e})})},n.prototype.return=function(e){os(e);var t=wn.get(this);if(t===void 0)throw new Error("WeakMap error");return Ur(t),t.execution=Promise.resolve(t.execution).then(function(){return e}),Gt(t,ar(t))},n.prototype.throw=function(e){var t=wn.get(this);if(t===void 0)throw new Error("WeakMap error");return t.state<=Mi||t.state>=Vt||typeof t.buffer<"u"&&!t.buffer.empty?(Ur(t),t.err==null&&(t.err=e),Gt(t,ar(t))):this.next(Promise.reject(e))},n.prototype[Symbol.asyncIterator]=function(){return this},n.race=WE,n.merge=HE,n.zip=ZE,n.latest=YE,n}();function gi(n,e){var t,r,i=[],s=function(l){l!=null&&typeof l[Symbol.asyncIterator]=="function"?i.push(l[Symbol.asyncIterator]()):l!=null&&typeof l[Symbol.iterator]=="function"?i.push(l[Symbol.iterator]()):i.push(function(){return $E(this,arguments,function(){return Ct(this,function(f){switch(f.label){case 0:return e.yieldValues?[4,Yr(l)]:[3,3];case 1:return[4,f.sent()];case 2:f.sent(),f.label=3;case 3:return e.returnValues?[4,Yr(l)]:[3,5];case 4:return[2,f.sent()];case 5:return[2]}})})}())};try{for(var o=Sr(n),a=o.next();!a.done;a=o.next()){var c=a.value;s(c)}}catch(l){t={error:l}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return i}function WE(n){var e=this,t=gi(n,{returnValues:!0});return new hn(function(r,i){return dr(e,void 0,void 0,function(){var s,o,a,c,l,u;return Ct(this,function(h){switch(h.label){case 0:if(!t.length)return i(),[2];o=!1,i.then(function(){s(),o=!0}),h.label=1;case 1:h.trys.push([1,,5,7]),c=void 0,l=0,u=function(){var f,d,g,p,m,y;return Ct(this,function(_){switch(_.label){case 0:f=l;try{for(d=(m=void 0,Sr(t)),g=d.next();!g.done;g=d.next())p=g.value,Promise.resolve(p.next()).then(function(E){E.done?(i(),a===void 0&&(a=E)):l===f&&(l++,s(E))},function(E){return i(E)})}catch(E){m={error:E}}finally{try{g&&!g.done&&(y=d.return)&&y.call(d)}finally{if(m)throw m.error}}return[4,new Promise(function(E){return s=E})];case 1:return c=_.sent(),c===void 0?[3,3]:[4,r(c.value)];case 2:_.sent(),_.label=3;case 3:return[2]}})},h.label=2;case 2:return o?[3,4]:[5,u()];case 3:return h.sent(),[3,2];case 4:return[2,a&&a.value];case 5:return i(),[4,Promise.race(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}function HE(n){var e=this,t=gi(n,{yieldValues:!0});return new hn(function(r,i){return dr(e,void 0,void 0,function(){var s,o,a,c=this;return Ct(this,function(l){switch(l.label){case 0:if(!t.length)return i(),[2];s=[],o=!1,i.then(function(){var u,h;o=!0;try{for(var f=Sr(s),d=f.next();!d.done;d=f.next()){var g=d.value;g()}}catch(p){u={error:p}}finally{try{d&&!d.done&&(h=f.return)&&h.call(f)}finally{if(u)throw u.error}}}),l.label=1;case 1:return l.trys.push([1,,3,4]),[4,Promise.all(t.map(function(u,h){return dr(c,void 0,void 0,function(){var f,d;return Ct(this,function(g){switch(g.label){case 0:g.trys.push([0,,6,9]),g.label=1;case 1:return o?[3,5]:(Promise.resolve(u.next()).then(function(p){return s[h](p)},function(p){return i(p)}),[4,new Promise(function(p){s[h]=p})]);case 2:return f=g.sent(),f===void 0?[3,4]:f.done?(a=f,[2]):[4,r(f.value)];case 3:g.sent(),g.label=4;case 4:return[3,1];case 5:return[3,9];case 6:return d=u.return,d?[4,u.return()]:[3,8];case 7:d=g.sent(),g.label=8;case 8:return[7];case 9:return[2]}})})}))];case 2:return l.sent(),[2,a&&a.value];case 3:return i(),[7];case 4:return[2]}})})})}function ZE(n){var e=this,t=gi(n,{returnValues:!0});return new hn(function(r,i){return dr(e,void 0,void 0,function(){var s,o,a,c;return Ct(this,function(l){switch(l.label){case 0:if(!t.length)return i(),[2,[]];o=!1,i.then(function(){s(),o=!0}),l.label=1;case 1:l.trys.push([1,,6,8]),l.label=2;case 2:return o?[3,5]:(Promise.all(t.map(function(u){return u.next()})).then(function(u){return s(u)},function(u){return i(u)}),[4,new Promise(function(u){return s=u})]);case 3:return a=l.sent(),a===void 0?[2]:(c=a.map(function(u){return u.value}),a.some(function(u){return u.done})?[2,c]:[4,r(c)]);case 4:return l.sent(),[3,2];case 5:return[3,8];case 6:return i(),[4,Promise.all(t.map(function(u){return u.return&&u.return()}))];case 7:return l.sent(),[7];case 8:return[2]}})})})}function YE(n){var e=this,t=gi(n,{yieldValues:!0,returnValues:!0});return new hn(function(r,i){return dr(e,void 0,void 0,function(){var s,o,a,c,l,u=this;return Ct(this,function(h){switch(h.label){case 0:if(!t.length)return i(),[2,[]];o=[],a=!1,i.then(function(){var f,d;s();try{for(var g=Sr(o),p=g.next();!p.done;p=g.next()){var m=p.value;m()}}catch(y){f={error:y}}finally{try{p&&!p.done&&(d=g.return)&&d.call(g)}finally{if(f)throw f.error}}a=!0}),h.label=1;case 1:return h.trys.push([1,,5,7]),Promise.all(t.map(function(f){return f.next()})).then(function(f){return s(f)},function(f){return i(f)}),[4,new Promise(function(f){return s=f})];case 2:return c=h.sent(),c===void 0?[2]:(l=c.map(function(f){return f.value}),c.every(function(f){return f.done})?[2,l]:[4,r(l.slice())]);case 3:return h.sent(),[4,Promise.all(t.map(function(f,d){return dr(u,void 0,void 0,function(){var g;return Ct(this,function(p){switch(p.label){case 0:if(c[d].done)return[2,c[d].value];p.label=1;case 1:return a?[3,4]:(Promise.resolve(f.next()).then(function(m){return o[d](m)},function(m){return i(m)}),[4,new Promise(function(m){return o[d]=m})]);case 2:return g=p.sent(),g===void 0?[2,c[d].value]:g.done?[2,g.value]:(l[d]=g.value,[4,r(l.slice())]);case 3:return p.sent(),[3,1];case 4:return[2]}})})}))];case 4:return[2,h.sent()];case 5:return i(),[4,Promise.all(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}const Kn=class Kn{constructor(){ie(this,"_extraRequestThreshold",262144)}extraRequestThreshold(){return this._extraRequestThreshold}setExtraRequestThreshold(e){if(e<0)throw Error("extraRequestThreshold cannot be negative");this._extraRequestThreshold=e}};ie(Kn,"global",new Kn);let qn=Kn;const qE=40,KE=16;function To(n,e){e=Math.min(Math.max(+e,2),65535);let t=n,r=t;do r+=t=Math.ceil(t/e);while(t!==1);return 40*r}function JE(n,e){if(e<2)throw Error("Node size must be at least 2");if(n===0)throw Error("Number of items must be greater than 0");let t=n,r=t,i=[t];do r+=t=Math.ceil(t/e),i.push(t);while(t!==1);let s=[];for(let a of(t=r,i))s.push(t-a),t-=a;let o=[];for(let a=0;a<i.length;a++)o.push([s[a],s[a]+i[a]]);return o}async function*QE(n,e,t,r){class i{constructor(d,g){ie(this,"_level");ie(this,"nodes");this._level=g,this.nodes=d}level(){return this._level}startNodeIdx(){return this.nodes[0]}endNodeIdx(){return this.nodes[1]}extendEndNodeIdx(d){this.nodes[1]=d}toString(){return`[NodeRange level: ${this._level}, nodes: ${this.nodes[0]}-${this.nodes[1]}]`}}let{minX:s,minY:o,maxX:a,maxY:c}=t,l=JE(n,e),u=l[0][0],h=[new i([0,1],l.length-1)];for(;h.length!=0;){let f=h.shift(),d=f.startNodeIdx(),g=d>=u,p=(()=>{let[,_]=l[f.level()],E=Math.min(f.endNodeIdx()+e,_);return g&&E<_?E+1:E})(),m=p-d,y=new DataView(await r(40*d,40*m));for(let _=d;_<p;_++){let E=_-d,w=40*E;if(a<y.getFloat64(w+0,!0)||c<y.getFloat64(w+8,!0)||s>y.getFloat64(w+16,!0)||o>y.getFloat64(w+24,!0))continue;let S=y.getBigUint64(w+32,!0);if(g){let P=(()=>{if(!(_<n-1))return null;{let N=(E+1)*40;return y.getBigUint64(N+32,!0)-S}})(),R=_-u;yield[Number(S),R,Number(P)];continue}let T=qn.global.extraRequestThreshold()/40,v=h[h.length-1];if(v!==void 0&&v.level()==f.level()-1&&S<v.endNodeIdx()+T){v.extendEndNodeIdx(Number(S));continue}let L=(()=>{let P=f.level()-1;return new i([Number(S),Number(S)+1],P)})();v!==void 0&&(v.level(),L.level()),h.push(L)}}}const zt=new Uint8Array([102,103,98,3,102,103,98,0]),pt=4;class wo{constructor(e,t,r,i,s){ie(this,"headerClient");ie(this,"header");ie(this,"headerLength");ie(this,"indexLength");ie(this,"nocache");this.headerClient=e,this.header=t,this.headerLength=r,this.indexLength=i,this.nocache=s}static async open(e,t){let r,i=new Za(e,t),s=2024+(()=>{let l,u=0;for(l=0;l<3;l++)u+=KE**l*qE;return u})();if(!new Uint8Array(await i.getRange(0,8,s,"header")).subarray(0,3).every((l,u)=>zt[u]===l))throw Error("Not a FlatGeobuf file");if((r=new DataView(await i.getRange(8,4,s,"header")).getUint32(0,!0))>10485760||r<8)throw Error("Invalid header size");let o=await i.getRange(12,r,s,"header"),a=xo(new xt(new Uint8Array(o))),c=To(a.featuresCount,a.indexNodeSize);return new wo(i,a,r,c,t)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=this.headerClient,i=async function(c,l){return r.getRange(t+c,l,0,"index")},s=[],o=[];for await(let c of QE(this.header.featuresCount,this.header.indexNodeSize,e,i)){let[l,u]=c,[,,h]=c;if(h||(h=4),o.length==0){o.push([l,h,u]);continue}let f=o[o.length-1];l-(f[0]+f[1])>qn.global.extraRequestThreshold()&&(s.push(o),o=[]),o.push([l,h,u])}this.headerClient.logUsage("header+index"),o.length>0&&s.push(o);let a=s.flatMap(c=>this.readFeatureBatch(c,this.nocache));yield*hn.merge(a)}lengthBeforeTree(){return zt.length+pt+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}buildFeatureClient(e){return new Za(this.headerClient.httpClient,e)}async*readFeatureBatch(e,t){let[r]=e[0],[i,s]=e[e.length-1],o=this.buildFeatureClient(t),a=i+s-r;for(let[c,,l]of e){let u=await this.readFeature(o,c,a);yield{id:l,feature:u},a=0}o.logUsage("feature")}async readFeature(e,t,r){let i,s=t+this.lengthBeforeFeatures();i=new DataView(await e.getRange(s,4,r,"feature length")).getUint32(0,!0);let o=new Uint8Array(await e.getRange(s+4,i,r,"feature data")),a=new Uint8Array(i+pt);a.set(o,pt);let c=new xt(a);return c.setPosition(pt),qe.getRootAsFeature(c)}}class Za{constructor(e,t){ie(this,"httpClient");ie(this,"bytesEverUsed",0);ie(this,"bytesEverFetched",0);ie(this,"buffer",new ArrayBuffer(0));ie(this,"head",0);if(typeof e=="string")this.httpClient=new Ya(e,t);else if(e instanceof Ya)this.httpClient=e;else throw Error("Unknown source ")}async getRange(e,t,r,i){this.bytesEverUsed+=t;let s=e-this.head,o=s+t;if(s>=0&&o<=this.buffer.byteLength)return this.buffer.slice(s,o);let a=Math.max(t,r);return this.bytesEverFetched+=a,this.buffer=await this.httpClient.getRange(e,a,i),this.head=e,this.buffer.slice(0,t)}logUsage(e){e.split(" ")[0],(100*this.bytesEverUsed/this.bytesEverFetched).toFixed(2)}}class Ya{constructor(e,t){ie(this,"url");ie(this,"nocache");ie(this,"requestsEverMade",0);ie(this,"bytesEverRequested",0);this.url=e,this.nocache=t}async getRange(e,t,r){this.requestsEverMade+=1,this.bytesEverRequested+=t;let i={Range:`bytes=${e}-${e+t-1}`};return this.nocache&&(i["Cache-Control"]="no-cache, no-store"),await(await fetch(this.url,{headers:i})).arrayBuffer()}}function ex(n,e,t){if(!n.subarray(0,3).every((u,h)=>zt[h]===u))throw Error("Not a FlatGeobuf file");let r=new xt(n),i=r.readUint32(zt.length);r.setPosition(zt.length+pt);let s=xo(r),o=zt.length+pt+i,{indexNodeSize:a,featuresCount:c}=s;a>0&&(o+=To(c,a));let l=[];for(;o<r.capacity();){let u=r.readUint32(o);r.setPosition(o+pt);let h=qe.getRootAsFeature(r);l.push(e(l.length,h,s)),o+=pt+u}return l}async function*tx(n,e,t){let r,i=zE(n),s=async d=>await i.slice(d),o=new Uint8Array(await s(8));if(!o.subarray(0,3).every((d,g)=>zt[g]===d))throw Error("Not a FlatGeobuf file");o=new Uint8Array(await s(4));let a=new xt(o),c=a.readUint32(0);o=new Uint8Array(await s(c));let l=xo(a=new xt(o)),{indexNodeSize:u,featuresCount:h}=l;if(u>0){let d=To(h,u);await s(d)}let f=0;for(;r=await nx(s,l,e,f++);)yield r}async function*rx(n,e,t,r,i=!1){let s=await wo.open(n,i);for await(let o of s.selectBbox(e))yield t(o.id,o.feature,s.header)}async function nx(n,e,t,r){let i=new Uint8Array(await n(4,"feature length"));if(i.byteLength===0)return;let s=new xt(i),o=s.readUint32(0);i=new Uint8Array(await n(o,"feature data"));let a=new Uint8Array(o+4);return a.set(i,4),(s=new xt(a)).setPosition(pt),t(r,qe.getRootAsFeature(s),e)}function ix(n,e){return{type:"FeatureCollection",features:ex(n,yo)}}function sx(n,e){return tx(n,yo)}function ox(n,e,t,r=!1){return rx(n,e,yo,t,r)}function ax(n,e,t,r=!1){return n instanceof Uint8Array?ix(n):n instanceof ReadableStream?sx(n):ox(n,e,t,r)}const qa=new xs({featureProjection:"EPSG:3857"});class lx extends qr{constructor(e){super({url:e.url,attributions:e.attributions,wrapX:e.wrapX,format:qa,strategy:sh}),this.ressourceURL=e.url,super.setLoader(this.loader)}fgbBoundingBox(e,t){const r=_l(e,t.getCode(),"EPSG:4326");return{minX:r[0],minY:r[1],maxX:r[2],maxY:r[3]}}async loader(e,t,r,i,s){const o=this.fgbBoundingBox(e,r);try{if(o.minX!==-1/0){const a=[],c=ax(this.ressourceURL,o);for await(const l of c){const u=qa.readFeature(l);a.push(u)}super.clear(),super.addFeatures(a),i(a)}}catch{s()}}}window.eoxMapAdvancedOlSources={...B0,WMTSCapabilities:ME,FlatGeoBuf:lx};let Sn=null;const cx=(n,e)=>{const t=r=>{var a;const i=r.map,s=(a=n.value)==null?void 0:a.lonLatCenter,o=i==null?void 0:i.getView().getZoom();s&&!Number.isNaN(s[0])&&!Number.isNaN(s[1])&&!Number.isNaN(o)&&(e.value=[s[0],s[1],o],Fr.value&&(Fr.value=!1))};Rl(()=>{var r,i;(i=(r=n.value)==null?void 0:r.map)==null||i.on("moveend",t)}),vl(()=>{var r,i;(i=(r=n.value)==null?void 0:r.map)==null||i.un("moveend",t)})},Ka=async(n,e,t)=>{Bt.debug("Creating layers config",n,e,t);const r=[],i={type:"Group",properties:{id:"AnalysisGroup",title:"Data Layers",layerControlExpand:!0},layers:[]};for(const h of e){let f;t?f=await h.createLayersJson(new Date(t)):f=await h.createLayersJson(),f.forEach(d=>{d.properties.layerControlExpand=!0,d.properties.layerControlToolsExpand=!0}),i.layers.push(...f)}r.push(i);const s=await Go.getIndicatorLayers(n),o=Go.getGeoDBLayer(e);o&&i.layers.unshift(o);const a={type:"Group",properties:{id:"BaseLayersGroup",title:"Base Layers"},layers:[]},c=s.filter(h=>h.properties.group==="baselayer");if(c.length){let h=0,f=0;for(let d=0;d<c.length;d++){const g=c[d];"visible"in g.properties||(g.properties.visible=!1),g.properties.visible&&(h++,f=d)}h===0&&(c[0].properties.visible=!0),h>0&&c.forEach((d,g)=>{g!==f?d.properties.visible=!1:d.properties.visible=!0}),a.layers.push(...c),a.layers.forEach(d=>{d.properties.layerControlExclusive=!0})}else a.layers.push({type:"Tile",properties:{id:"osm",title:"Background",layerControlExclusive:!0},source:{type:"OSM"}});a.layers.length&&r.push(a);const l={type:"Group",properties:{id:"OverlayGroup",title:"Overlay Layers"},layers:[]},u=s.filter(h=>h.properties.group==="overlay");return u.length&&(l.layers.push(...u),r.unshift(l)),r},Ja=(n,e,t,r,i,s,o)=>{Bt.debug("InitMap",n.value,e.value,t.values,r.value);const a=of(af),c=Wh([e,r],async([l,u],[h,f])=>{var d,g,p,m,y,_,E,w,S,T,v,L;if(l){Bt.debug("Selected Indicator watch triggered",l,u),((d=n==null?void 0:n.value)==null?void 0:d.id)==="main"&&Sn!==null&&((g=n==null?void 0:n.value)==null||g.map.setView(Sn),Sn=null);let P=[];const R=(l==null?void 0:l.id)===(h==null?void 0:h.id)&&u!==f,{selectedCompareStac:N}=Vi(ji());if(((p=n==null?void 0:n.value)==null?void 0:p.id)==="main"?await sf(l):N.value!==null&&(Sn=((m=n==null?void 0:n.value)==null?void 0:m.map.getView())??null,n.value.sync=s.value),R){P=await Ka(l,t,u),Bt.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(P))),i.value=P,await Uo(()=>{a.emit("time:updated",i.value)});return}P=await Ka(l,t,r.value);let F=null;const B=(_=(y=l==null?void 0:l.extent)==null?void 0:y.temporal)==null?void 0:_.interval;if(B&&B.length>0&&B[0].length>1&&(F=new Date(B[0][1]),Bt.debug("Indicator load: found stac extent, setting time to latest value",F)),F!==null&&F.toISOString()!==r.value&&(r.value=F.toISOString()),o&&((E=n==null?void 0:n.value)==null?void 0:E.id)==="main"&&(w=l.extent)!=null&&w.spatial.bbox&&!Fr.value){const O=(S=l.extent)==null?void 0:S.spatial.bbox[0],U=[(O==null?void 0:O[0])>-180?O==null?void 0:O[0]:-180,(O==null?void 0:O[1])>-90?O==null?void 0:O[1]:-90,(O==null?void 0:O[2])<180?O==null?void 0:O[2]:180,(O==null?void 0:O[3])<90?O==null?void 0:O[3]:90],J=(L=n.value)==null?void 0:L.transformExtent(U,"EPSG:4326",(v=(T=n.value)==null?void 0:T.map)==null?void 0:v.getView().getProjection());n.value.zoomExtent=J}Fr.value&&(Fr.value=!1),Bt.debug("Assigned layers",JSON.parse(JSON.stringify(P))),i.value=P,await Uo(()=>{var O;(O=n.value)==null||O.updateComplete.then(()=>{a.emit("layers:updated",i.value)})})}},{immediate:!0});vl(()=>{c()})},Qa=(n,e)=>{ef(async()=>{const t=[];for(const r of n)t.push(...await r.getToolTipProperties());e.value=t,Bt.debug("Updated tooltip properties",e.value)})};function ux(n){return 3*n*n-2*n*n*n}const hx=[".enabled"],fx=[".center",".zoom",".layers"],dx=[".propertyTransform"],gx=[".layers"],px=[".propertyTransform"],mx={__name:"EodashMap",props:{enableCompare:{type:Boolean,default:!1},center:{type:Array,default:()=>[15,48]},zoom:{type:Number,default:4},zoomToExtent:{type:Boolean,default:!0}},setup(n){var y,_,E,w,S;const e=n,t=Zt([]),r=Zt([]),i={Attribution:{collapsible:!0}},s=Mo([((y=pn.value)==null?void 0:y[0])??((_=e.center)==null?void 0:_[0]),((E=pn.value)==null?void 0:E[1])??((w=e.center)==null?void 0:w[1])]),o=Mo(((S=pn.value)==null?void 0:S[2])??e.zoom),a=Zt([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),c=Zt([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),l={duration:1200,easing:ux},u=Zt(null),h=Zt(null),{selectedCompareStac:f}=Vi(ji()),d=_i(()=>e.enableCompare&&f.value?"":"first");cx(u,pn),Rl(()=>{const{selectedCompareStac:T,selectedStac:v}=Vi(ji());Jh.value=u.value,e.enableCompare&&(Qh.value=h.value),e.enableCompare&&(Ja(h,T,nf,Bo,c,u,!1),Qa(Ei,r)),Ja(u,v,Ei,Bo,a,h,e.zoomToExtent)}),Qa(Ei,t);const g=_i(()=>({visibility:t.value.length?"visible":"hidden"})),p=_i(()=>({visibility:r.value.length?"visible":"hidden"})),m=T=>{const v=T==="main"?t:r,L=T=="main"?tf:rf;return P=>{const R=JSON.parse($h.render(JSON.stringify(v.value),{...L.value??{}})),N=R==null?void 0:R.find(F=>F.id===P.key);if(N)return typeof P.value=="object"&&(P.value=JSON.stringify(P.value)),isNaN(Number(P.value))||(P.value=Number(P.value).toFixed(4).toString()),{key:N.title||N.id,value:P.value+" "+(N.appendix||"")}}};return(T,v)=>(Xh(),jh("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":d.value},[gn("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:u,id:"main",".animationOptions":l,".center":Do(s),".zoom":Do(o),".layers":a.value,".controls":i},[gn("eox-map-tooltip",{style:No(g.value),".propertyTransform":m("main")},null,44,dx)],40,fx),gn("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:h,".layers":c.value},[gn("eox-map-tooltip",{style:No(p.value),".propertyTransform":m("compare")},null,44,px)],40,gx)],40,hx))}},Ix=Object.freeze(Object.defineProperty({__proto__:null,default:mx},Symbol.toStringTag,{value:"Module"}));export{Ix as E,Px as L,Ax as a};
